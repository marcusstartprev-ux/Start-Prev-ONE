{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 21 - PREPARAR MENSAGEM DE ERRO (V2.1 - ID CORRIGIDO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 29/12/2025\n// \n// FUNCIONALIDADES:\n// âœ… Detecta automaticamente o tipo de erro\n// âœ… Fallbacks robustos para todos os campos\n// âœ… FormataÃ§Ã£o visual para Bitrix Chat\n// âœ… Link direto para o Deal\n// âœ… Timestamp do erro\n// âœ… Suporte a mÃºltiplos problemas\n// âœ… IdentificaÃ§Ã£o de faturas duplicadas\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡ÃƒO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CONFIG = {\n  CHAT_ERROS: 'chat282150',  // ERROS / DADOS DIVERGENTES NO BITRIX\n  URL_BITRIX: 'https://startprev.bitrix24.com.br',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// MAPA DE ERROS (cÃ³digo â†’ mensagem amigÃ¡vel)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst ERROS_MAP = {\n  // Erros de PDF/Arquivo\n  'PDF_NAO_ENCONTRADO': {\n    emoji: 'ğŸ“„',\n    titulo: 'PDF NÃƒO ENCONTRADO',\n    descricao: 'O campo de PDF do extrato estÃ¡ vazio no Deal.'\n  },\n  'PDF_INVALIDO': {\n    emoji: 'ğŸ“„',\n    titulo: 'PDF INVÃLIDO',\n    descricao: 'NÃ£o foi possÃ­vel processar o PDF anexado.'\n  },\n  'GEMINI_ERRO': {\n    emoji: 'ğŸ¤–',\n    titulo: 'ERRO NO GEMINI',\n    descricao: 'Falha ao extrair dados do PDF com IA.'\n  },\n  \n  // Erros de ValidaÃ§Ã£o\n  'CPF_DIVERGENTE': {\n    emoji: 'ğŸ†”',\n    titulo: 'CPF DIVERGENTE',\n    descricao: 'CPF do extrato nÃ£o confere com o CPF do Deal.'\n  },\n  'NB_DIVERGENTE': {\n    emoji: 'ğŸ”¢',\n    titulo: 'NB DIVERGENTE',\n    descricao: 'NÃºmero do BenefÃ­cio nÃ£o confere.'\n  },\n  'DADOS_DIVERGENTES': {\n    emoji: 'âš ï¸',\n    titulo: 'DADOS DIVERGENTES',\n    descricao: 'Dados do extrato nÃ£o conferem com o Deal.'\n  },\n  'EXTRATO_ANTIGO': {\n    emoji: 'ğŸ“…',\n    titulo: 'EXTRATO ANTIGO',\n    descricao: 'Este extrato jÃ¡ foi processado anteriormente.'\n  },\n  \n  // Erros de DuplicaÃ§Ã£o\n  'FATURAS_DUPLICADAS': {\n    emoji: 'ğŸ”„',\n    titulo: 'FATURAS JÃ EXISTEM',\n    descricao: 'JÃ¡ existem faturas criadas para este cliente.'\n  },\n  'COMPETENCIA_DUPLICADA': {\n    emoji: 'ğŸ”„',\n    titulo: 'COMPETÃŠNCIA DUPLICADA',\n    descricao: 'JÃ¡ existe fatura para esta competÃªncia.'\n  },\n  \n  // Erros de Sistema\n  'DEAL_ID_AUSENTE': {\n    emoji: 'ğŸš«',\n    titulo: 'DEAL ID AUSENTE',\n    descricao: 'Webhook chamado sem informar o Deal ID.'\n  },\n  'ERRO_BITRIX': {\n    emoji: 'ğŸ’¥',\n    titulo: 'ERRO NO BITRIX',\n    descricao: 'Falha na comunicaÃ§Ã£o com o Bitrix24.'\n  },\n  'ERRO_DESCONHECIDO': {\n    emoji: 'â“',\n    titulo: 'ERRO DESCONHECIDO',\n    descricao: 'Ocorreu um erro nÃ£o identificado.'\n  },\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES AUXILIARES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/**\n * Formata CPF para exibiÃ§Ã£o\n */\nconst formatarCPF = (cpf) => {\n  if (!cpf) return 'N/A';\n  const nums = String(cpf).replace(/\\D/g, '');\n  if (nums.length !== 11) return cpf;\n  return nums.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/, '$1.$2.$3-$4');\n};\n\n/**\n * Formata valor monetÃ¡rio\n */\nconst formatarMoeda = (valor) => {\n  if (!valor && valor !== 0) return 'N/A';\n  return `R$ ${Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;\n};\n\n/**\n * Formata data/hora atual\n */\nconst getTimestamp = () => {\n  return new Date().toLocaleString('pt-BR', { \n    timeZone: 'America/Sao_Paulo',\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n};\n\n/**\n * ObtÃ©m informaÃ§Ãµes do erro do mapa\n */\nconst getErroInfo = (tipoErro) => {\n  return ERROS_MAP[tipoErro] || ERROS_MAP['ERRO_DESCONHECIDO'];\n};\n\n/**\n * Extrai valor com fallbacks\n */\nconst getValue = (ctx, ...paths) => {\n  for (const path of paths) {\n    const keys = path.split('.');\n    let value = ctx;\n    for (const key of keys) {\n      value = value?.[key];\n      if (value === undefined || value === null) break;\n    }\n    if (value !== undefined && value !== null && value !== '') {\n      return value;\n    }\n  }\n  return null;\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ctx = $json;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 1. IDENTIFICAR TIPO DE ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet tipoErro = getValue(ctx, 'tipo_erro', 'alerta.codigo', 'erro_tipo') || 'ERRO_DESCONHECIDO';\nlet erroInfo = getErroInfo(tipoErro);\n\n// Verificar se Ã© erro de faturas duplicadas\nif (ctx.tem_faturas === true && !ctx.tipo_erro) {\n  tipoErro = 'FATURAS_DUPLICADAS';\n  erroInfo = getErroInfo(tipoErro);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 2. EXTRAIR DADOS DO CLIENTE\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst cliente = {\n  nome: getValue(ctx, 'nome_cliente', 'nome', 'resumo.nome', 'deal.TITLE') || 'N/A',\n  cpf: formatarCPF(getValue(ctx, 'cpf_cliente', 'cpf', 'resumo.cpf')),\n  nb: getValue(ctx, 'nb_cliente', 'nb', 'resumo.nb') || 'N/A',\n  dealId: getValue(ctx, 'deal_id') || 'N/A',\n  contactId: getValue(ctx, 'contact_id') || null,\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3. EXTRAIR DETALHES DO ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet detalhesErro = [];\n\n// Caso 1: Erro com alerta estruturado\nif (ctx.alerta?.mensagem) {\n  detalhesErro.push(ctx.alerta.mensagem);\n}\n\n// Caso 2: Erro com auditoria (mÃºltiplos problemas)\nif (ctx.auditoria?.problemas?.length > 0) {\n  for (const p of ctx.auditoria.problemas) {\n    detalhesErro.push(`${p.codigo}: ${p.mensagem}`);\n  }\n}\n\n// Caso 3: Mensagem de erro simples\nif (ctx.mensagem_erro) {\n  detalhesErro.push(ctx.mensagem_erro);\n}\n\n// Caso 4: Faturas duplicadas - mostrar stats\nif (tipoErro === 'FATURAS_DUPLICADAS' && ctx.stats_faturas) {\n  const stats = ctx.stats_faturas;\n  detalhesErro.push(`Total de faturas existentes: ${stats.total || 0}`);\n  detalhesErro.push(`Faturas pagas: ${stats.pagas || 0}`);\n  detalhesErro.push(`Faturas pendentes: ${stats.pendentes || 0}`);\n  detalhesErro.push(`Valor jÃ¡ cobrado: ${formatarMoeda(stats.valor_start_cobrado)}`);\n  \n  if (stats.competencias_existentes?.length > 0) {\n    detalhesErro.push(`CompetÃªncias: ${stats.competencias_existentes.join(', ')}`);\n  }\n}\n\n// Fallback se nÃ£o tiver detalhes\nif (detalhesErro.length === 0) {\n  detalhesErro.push(erroInfo.descricao);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 4. EXTRAIR TAGS DE ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet tagsErro = [];\nif (ctx.tags?.length > 0) {\n  tagsErro = ctx.tags.filter(t => t.startsWith('E_') || t.startsWith('ERRO_'));\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5. MONTAR MENSAGEM FORMATADA\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst emoji = ctx.alerta?.emoji || erroInfo.emoji || 'ğŸš¨';\nconst titulo = ctx.alerta?.titulo || erroInfo.titulo || 'ERRO NO FATURAMENTO';\n\nlet msg = '';\n\n// CabeÃ§alho\nmsg += `${emoji} [B]${titulo}[/B]\\n`;\nmsg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// Dados do Cliente\nmsg += `ğŸ‘¤ [B]Cliente:[/B] ${cliente.nome}\\n`;\nmsg += `ğŸ†” [B]CPF:[/B] ${cliente.cpf}\\n`;\nmsg += `ğŸ”¢ [B]NB:[/B] ${cliente.nb}\\n`;\nmsg += `ğŸ“‹ [B]Deal:[/B] #${cliente.dealId}\\n\\n`;\n\n// Detalhes do Erro\nmsg += `[B]ğŸ“Œ Detalhes:[/B]\\n`;\nfor (const detalhe of detalhesErro) {\n  msg += `â€¢ ${detalhe}\\n`;\n}\n\n// Tags (se existirem)\nif (tagsErro.length > 0) {\n  msg += `\\nğŸ·ï¸ [B]Tags:[/B] ${tagsErro.join(', ')}\\n`;\n}\n\n// Timestamp\nmsg += `\\nâ° ${getTimestamp()}\\n`;\n\n// Link para o Deal\nif (cliente.dealId !== 'N/A') {\n  msg += `\\nğŸ”— [URL=${CONFIG.URL_BITRIX}/crm/deal/details/${cliente.dealId}/]Ver negÃ³cio[/URL]`;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 6. RETORNO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nreturn { \n  DIALOG_ID: CONFIG.CHAT_ERROS,\n  MESSAGE: msg,\n  \n  // Dados extras para debug/log\n  _debug: {\n    tipo_erro: tipoErro,\n    deal_id: cliente.dealId,\n    timestamp: getTimestamp(),\n  }\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    7520,
    25568
  ],
  "id": "d34adc1e-b9ac-4b1b-88f0-cc81ae854bbf",
  "name": "ğŸ”§ NÃ“ 21 - PREPARAR MSG ERRO (Code)"
}