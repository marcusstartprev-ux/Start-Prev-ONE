{
  "parameters": {
    "jsCode": "// ═══════════════════════════════════════════════════════════════════════════════\n// NÓ 19 - PREPARAR DADOS PARA GOOGLE SHEETS (V23)\n// ═══════════════════════════════════════════════════════════════════════════════\n// FUNÇÃO: Formatar dados para append no Google Sheets\n// ENTRADA: Output do 15. Montar itens_criados (via 17 IF Warning)\n// SAÍDA: Array de linhas para a planilha MASTER\n// ═══════════════════════════════════════════════════════════════════════════════\n// \n// ATUALIZAÇÃO V23 (08/01/2026):\n// ✅ ORDEM DAS COLUNAS CORRIGIDA (igual à planilha)\n// ✅ Adicionada coluna bloqueia_calculo (faltava)\n// ✅ Captura invoice_id do nó 10 como fallback\n// ✅ Compatível com estrutura MASTER da planilha\n// ═══════════════════════════════════════════════════════════════════════════════\n\n// ═══ FUNÇÃO HELPER: Buscar nó com segurança ═══\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\nconst buscarTodosNo = (nomeNo) => {\n  try {\n    return $(nomeNo).all() || [];\n  } catch (e) {\n    return [];\n  }\n};\n\n// ═══ BUSCAR DADOS DOS NÓS ═══\nconst consolidado = buscarNo('15. Montar itens_criados') || $json || {};\nconst responsavelInfo = buscarNo('8C. Definir Responsável');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst relatorio = buscarNo('12. Gerar Relatório HTML');\nconst dados1B = buscarNo('1B. Inicializar');\n\n// ═══ CAPTURAR IDS DAS FATURAS DO NÓ 10 (FALLBACK) ═══\nconst resultadosNo10 = buscarTodosNo('10. Criar Fatura');\nconst idsFromNo10 = resultadosNo10.map(item => {\n  const invoiceId = item.json?.result?.item?.id;\n  return {\n    invoice_id: invoiceId,\n    link: invoiceId ? `https://startprev.bitrix24.com.br/crm/type/31/details/${invoiceId}/` : null,\n    title: item.json?.result?.item?.title || '',\n    parcela_extraida: (() => {\n      const match = (item.json?.result?.item?.title || '').match(/Parcela (\\d+)/i);\n      return match ? parseInt(match[1]) : null;\n    })()\n  };\n});\n\n// ═══ EXTRAIR DADOS ═══\nconst resumo = consolidado.resumo || normalizador.resumo || {};\nconst dadosBeneficio = normalizador.dados_beneficio || {};\nconst camposAtualizarDeal = consolidado.campos_atualizar_deal || normalizador.campos_atualizar_deal || {};\n\n// Alertas\nconst alertas = consolidado.alertas_lista || [];\nconst alertaMax = alertas.sort((a, b) => (b.severidade || 0) - (a.severidade || 0))[0] || {};\n\n// Faturas criadas\nconst criadas = consolidado.itens_criados || [];\nconst faturas = criadas.length > 0 ? criadas : [{ parcela: 0 }];\n\n// Responsável\nconst responsavel = responsavelInfo.responsavel || {};\n\n// Timestamp\nconst agora = new Date().toISOString();\n\n// Deal ID\nconst dealId = consolidado.deal_id || normalizador.deal_id || dados1B.deal_id || '';\n\n// ═══ GERAR LINHAS PARA A PLANILHA (ORDEM CORRETA!) ═══\nreturn faturas.map((f, index) => {\n  // Buscar invoice_id: primeiro do item, depois fallback do nó 10\n  let invoiceId = f.invoice_id;\n  let invoiceLink = f.link;\n  \n  if (!invoiceId && idsFromNo10.length > 0) {\n    // Tentar por índice\n    let idInfo = idsFromNo10[index];\n    // Ou tentar por parcela\n    if (!idInfo?.invoice_id && f.parcela) {\n      idInfo = idsFromNo10.find(i => i.parcela_extraida === f.parcela);\n    }\n    if (idInfo?.invoice_id) {\n      invoiceId = idInfo.invoice_id;\n      invoiceLink = idInfo.link;\n    }\n  }\n  \n  return {\n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 1-7: METADADOS\n    // ══════════════════════════════════════════════════════════════════════════\n    timestamp: agora,                                                    // 1\n    deal_id: dealId,                                                     // 2\n    cliente: consolidado.nome_cliente || resumo.nome || '',              // 3\n    versao: 'V23',                                                       // 4\n    tentativa: 1,                                                        // 5\n    status: consolidado.sucesso ? 'SUCESSO' : 'ERRO',                    // 6\n    severidade_max: alertaMax.severidade || 0,                           // 7\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 8-15: DADOS DO BENEFÍCIO\n    // ══════════════════════════════════════════════════════════════════════════\n    nb: consolidado.nb || resumo.nb || dadosBeneficio.nb || '',          // 8\n    nit: dadosBeneficio.nit || '',                                       // 9\n    cpf: consolidado.cpf || resumo.cpf || dadosBeneficio.cpf || '',      // 10\n    dib: dadosBeneficio.dib || '',                                       // 11\n    dip: dadosBeneficio.dip || '',                                       // 12\n    dcb: dadosBeneficio.dcb || '',                                       // 13\n    banco: dadosBeneficio.banco || '',                                   // 14\n    data_pdf: dadosBeneficio.data_atualizacao_extrato || '',             // 15\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 16-23: VALORES DO BENEFÍCIO\n    // ══════════════════════════════════════════════════════════════════════════\n    mr: consolidado.mr || resumo.mr || dadosBeneficio.mr || 0,           // 16\n    aliquota_inss: dadosBeneficio.aliquota_inss_efetiva || 0,            // 17\n    desconto_inss: dadosBeneficio.desconto_inss || 0,                    // 18\n    liquido_mensal: dadosBeneficio.valor_liquido_mensal || 0,            // 19\n    valor_diario: dadosBeneficio.valor_diario || 0,                      // 20\n    total_beneficio: dadosBeneficio.valor_total_beneficio || \n                     resumo.total_120_dias || 0,                         // 21\n    dias_recebidos: 0,                                                   // 22\n    dias_restantes: dadosBeneficio.dias_restantes || 0,                  // 23\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 24-27: HONORÁRIOS START\n    // ══════════════════════════════════════════════════════════════════════════\n    valor_total_start: consolidado.honorarios_start || \n                       resumo.honorarios_start || \n                       dadosBeneficio.valor_total_start || 0,            // 24\n    percentual_start: 30,                                                // 25\n    saldo_inicial: resumo.honorarios_start || 0,                         // 26\n    saldo_final: consolidado.saldo_final || resumo.saldo_start_final || 0, // 27\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 28-37: DADOS DA PARCELA\n    // ══════════════════════════════════════════════════════════════════════════\n    parcela: f.parcela || 0,                                             // 28\n    competencia: f.competencia || dadosBeneficio.competencia_final || '', // 29\n    competencia_final: dadosBeneficio.competencia_final || '',           // 30\n    periodo: '',                                                         // 31\n    data_pagamento: f.data_inss || '',                                   // 32\n    valor_inss: f.valor_inss || 0,                                       // 33\n    valor_start: f.valor_start || 0,                                     // 34\n    valor_cliente: f.valor_cliente || 0,                                 // 35\n    aliquota_aplicada: f.aliquota || 0.3,                                // 36\n    regra_aplicada: f.regra || '',                                       // 37\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 38-40: RESPONSÁVEL E FLAGS\n    // ══════════════════════════════════════════════════════════════════════════\n    responsavel: responsavel.nome || '',                                 // 38\n    is_retroativo: f.is_retroativo || false,                             // 39\n    is_simulado: f.is_simulado || false,                                 // 40\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 41-45: ALERTAS (ANTES DOS INVOICES!)\n    // ══════════════════════════════════════════════════════════════════════════\n    tipo_alerta: alertaMax.tipo || '',                                   // 41\n    titulo_alerta: alertaMax.titulo || '',                               // 42\n    mensagem_alerta: alertaMax.mensagem || '',                           // 43\n    bloqueia: alertaMax.bloqueia || false,                               // 44\n    bloqueia_calculo: alertaMax.bloqueia_calculo || false,               // 45 ← NOVO!\n    \n    // ══════════════════════════════════════════════════════════════════════════\n    // COLUNAS 46-49: INVOICE E TOTAIS (DEPOIS DOS ALERTAS!)\n    // ══════════════════════════════════════════════════════════════════════════\n    invoice_id: invoiceId || '',                                         // 46\n    invoice_link: invoiceLink || '',                                     // 47\n    total_criadas: consolidado.total_criadas || 0,                       // 48\n    total_erros: consolidado.total_erros || 0                            // 49\n  };\n});"
  },
  "id": "e9cd65f0-0269-495f-828d-0e9d3efe5091",
  "name": "19. Preparar Sheets",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    10880,
    26272
  ]
}