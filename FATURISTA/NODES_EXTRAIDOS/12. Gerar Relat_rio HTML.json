{
  "parameters": {
    "mode": "runOnceForEachItem",
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 12 - GERAR RELATÃ“RIO HTML (V8 - ASAAS CAMELCASE FIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Mescla campos_invoice do 6D com fields do nÃ³ 9, adiciona HTML + ASAAS\n// ENTRADA: Output do 9C. Processar Resposta Asaas\n// SAÃDA: body completo com TODOS os campos + HTML + campos Asaas\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// CHANGELOG V8 (12/01/2026):\n// ğŸ”¥ FIX CRÃTICO: Campos Asaas agora usam ufCrm_ (camelCase) em vez de UF_CRM_\n//    - ANTES (V7): UF_CRM_SMART_INVOICE_1767292172702 âŒ (ignorado pelo Bitrix)\n//    - AGORA (V8): ufCrm_SMART_INVOICE_1767292172702 âœ… (aceito pelo Bitrix)\n// âœ… MANTÃ‰M: Tudo do V7 (mescla 6D + nÃ³ 9 + HTML + Asaas)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO DE BUSCA SEGURA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nome) => {\n  try {\n    return $(nome).first()?.json || null;\n  } catch (e) {\n    return null;\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PEGAR DADOS DE TODOS OS NÃ“S RELEVANTES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// NÃ³ 9C (anterior direto - tem body + dados do Asaas!)\nconst dadosNo9 = $json || {};\nconst bodyNo9 = dadosNo9.body || {};\nconst fieldsNo9 = bodyNo9.fields || {};\n\n// ğŸ”¥ V7: DADOS DO ASAAS (vindos do 9C)\nconst asaasPaymentId = dadosNo9.asaas_payment_id || '';\nconst asaasBoletoUrl = dadosNo9.asaas_boleto_url || '';\nconst asaasInvoiceUrl = dadosNo9.asaas_invoice_url || '';\nconst asaasNossoNumero = dadosNo9.asaas_nosso_numero || '';\nconst asaasStatus = dadosNo9.asaas_status || '';\nconst asaasCustomerId = dadosNo9.asaas_customer_id || '';\n\n// NÃ³ 6D (tem campos_invoice com valores corretos do Deal!)\nconst dados6D = buscarNo('6D. Revisor de Calculos') || {};\nconst camposInvoice6D = dados6D.campos_invoice || {};\n\n// NÃ³ 1B (deal_id, cpf, nb)\nconst dados1B = buscarNo('1B. Inicializar') || {};\n\n// BUSCAR DEAL (tem os valores reais dos campos)\nconst dadosBuscarDeal = buscarNo('BUSCAR DEAL') || {};\nconst dealData = dadosBuscarDeal.result || dadosBuscarDeal || {};\n\n// Se nÃ£o tem body do nÃ³ 9, algo estÃ¡ errado\nif (!bodyNo9.entityTypeId) {\n  return {\n    ...dadosNo9,\n    _erro_no12: 'Body nÃ£o encontrado do nÃ³ 9',\n    _debug: { bodyNo9, fieldsNo9 }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS PARA O HTML\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dealId = dados1B.deal_id || dadosNo9.anti_dup?.deal_id || 0;\nconst resumo = dados6D.resumo || dadosNo9.resumo || {};\nconst faturas_criar = dados6D.faturas_criar || [];\nconst status = dados6D.ok ? 'SUCESSO' : (dados6D.gravidade_maxima || 'OK');\nconst auditoria = dados6D.auditoria || dadosNo9.auditoria || {};\nconst tags = dados6D.tags || dadosNo9.tags || [];\nconst debug = dadosNo9.debug || {};\n\n// Dados do benefÃ­cio\nconst nomeCliente = resumo.nome || dados1B.nome || 'Cliente';\nconst cpf = resumo.cpf_formatado || resumo.cpf || '';\nconst nb = resumo.nb_formatado || resumo.nb || '';\nconst nit = resumo.nit || '';\nconst dib = resumo.dib || '';\nconst dcb = resumo.dcb || '';\nconst dip = resumo.dip || '';\nconst competencia = debug.competencia || resumo.competencia || '';\n\nconst mr = resumo.mr || 0;\nconst mrFormatado = resumo.mr_formatado || `R$ ${Number(mr).toFixed(2).replace('.', ',')}`;\nconst totalBeneficio = resumo.total_120_dias || 0;\nconst totalBeneficioFormatado = `R$ ${Number(totalBeneficio).toFixed(2).replace('.', ',')}`;\n\nconst honorariosStart = resumo.honorarios_start || resumo.total_start || 0;\nconst honorariosStartFormatado = `R$ ${Number(honorariosStart).toFixed(2).replace('.', ',')}`;\nconst saldoFinal = resumo.saldo_start_final || 0;\nconst saldoFinalFormatado = `R$ ${Number(saldoFinal).toFixed(2).replace('.', ',')}`;\n\n// Dados da parcela atual (do debug do nÃ³ 9)\nconst parcelaAtual = debug.parcela || 1;\nconst totalParcelas = debug.total_parcelas || faturas_criar.length || 1;\nconst valorInss = debug.valor_inss || 0;\nconst valorStart = debug.valor_start || 0;\nconst valorCliente = debug.valor_cliente || 0;\nconst aliquotaStart = debug.aliquota_start || '';\nconst regra = debug.regra || '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HELPERS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst formatarMoeda = (valor) => {\n  const num = typeof valor === 'number' ? valor : parseFloat(valor) || 0;\n  return `R$ ${num.toFixed(2).replace('.', ',')}`;\n};\n\nconst formatarCPF = (cpf) => {\n  const nums = String(cpf).replace(/\\D/g, '');\n  if (nums.length !== 11) return cpf;\n  return `${nums.slice(0,3)}.${nums.slice(3,6)}.${nums.slice(6,9)}-${nums.slice(9)}`;\n};\n\nconst formatarData = (data) => {\n  if (!data) return '-';\n  const str = String(data);\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    const [y, m, d] = str.split('T')[0].split('-');\n    return `${d}/${m}/${y}`;\n  }\n  return str;\n};\n\nconst calcularProgresso = () => {\n  if (honorariosStart <= 0) return 100;\n  const cobrado = honorariosStart - saldoFinal;\n  return Math.min(100, Math.round((cobrado / honorariosStart) * 100));\n};\n\n// Destaques\nconst destaques = [];\nif (saldoFinal <= 0 || regra?.includes('QUIT') || regra?.includes('COBRA_TUDO')) {\n  destaques.push({ emoji: 'ğŸ¯', texto: 'QUITAÃ‡ÃƒO', cor: '#27AE60' });\n}\nif (mr >= 3000) {\n  destaques.push({ emoji: 'â­', texto: 'ALTO VALOR', cor: '#F4D03F' });\n}\n// ğŸ”¥ V7: Mostrar se tem boleto Asaas\nif (asaasPaymentId) {\n  destaques.push({ emoji: 'ğŸ«', texto: 'BOLETO ASAAS', cor: '#2E86AB' });\n}\ndestaques.push({ emoji: 'ğŸ¤–', texto: 'AUTOMÃTICO', cor: '#5D6D7E' });\n\nconst gerarBadges = () => destaques.map(d => \n  `<span style=\"display:inline-block;background:${d.cor}20;color:${d.cor};padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin:2px;\">${d.emoji} ${d.texto}</span>`\n).join(' ');\n\nconst gerarTags = () => {\n  if (tags.length === 0) return '';\n  return tags.slice(0, 8).map(tag => {\n    let cor = '#5D6D7E';\n    if (tag.startsWith('E_')) cor = '#E74C3C';\n    else if (tag.startsWith('A_')) cor = '#F39C12';\n    else if (tag.startsWith('OK_')) cor = '#27AE60';\n    return `<span style=\"background:${cor}15;color:${cor};padding:2px 6px;border-radius:3px;font-size:9px;margin:1px;\">${tag}</span>`;\n  }).join(' ');\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// GERAR HTML\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst progresso = calcularProgresso();\nconst timestamp = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });\nconst statusEmoji = status === 'SUCESSO' ? 'âœ…' : status === 'ALERTA' ? 'âš ï¸' : 'âŒ';\nconst statusCor = status === 'SUCESSO' ? '#27AE60' : status === 'ALERTA' ? '#F39C12' : '#E74C3C';\nconst urlDeal = `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`;\n\n// ğŸ”¥ V7: SeÃ§Ã£o do boleto no HTML (se tiver)\nconst secaoBoleto = asaasPaymentId ? `\n  <div class=\"s\">\n    <div class=\"st\">ğŸ« Boleto Asaas</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">ID Asaas</span><span class=\"fv d\">${asaasPaymentId}</span></div>\n      <div class=\"f\"><span class=\"fl\">Status</span><span class=\"fv\">${asaasStatus || 'PENDING'}</span></div>\n      <div class=\"f\"><span class=\"fl\">Nosso NÃºmero</span><span class=\"fv\">${asaasNossoNumero || '-'}</span></div>\n      <div class=\"f\"><span class=\"fl\">Link Boleto</span><span class=\"fv\"><a href=\"${asaasBoletoUrl}\" target=\"_blank\" style=\"color:#2E86AB\">ğŸ“„ PDF</a></span></div>\n    </div>\n  </div>\n` : '';\n\nconst html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Fatura ${parcelaAtual}/${totalParcelas} - ${nomeCliente}</title>\n  <style>\n    *{margin:0;padding:0;box-sizing:border-box}\n    body{font-family:'Segoe UI',Arial,sans-serif;background:#F4F6F7;padding:12px;color:#5D6D7E;font-size:12px}\n    .c{max-width:700px;margin:0 auto;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow:hidden}\n    .h{background:linear-gradient(135deg,#1A5276,#2E86AB);color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}\n    .h h1{font-size:16px;margin-bottom:3px}\n    .h .sub{font-size:11px;opacity:0.9}\n    .badge{background:#27AE60;color:#fff;padding:5px 10px;border-radius:12px;font-size:11px;font-weight:600}\n    .s{padding:12px 15px;border-bottom:1px solid #AEB6BF}\n    .st{color:#1A5276;font-size:13px;font-weight:600;margin-bottom:10px;padding-bottom:5px;border-bottom:2px solid #F4D03F;display:inline-block}\n    .g{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}\n    .g4{grid-template-columns:repeat(4,1fr)}\n    .f{display:flex;flex-direction:column}\n    .fl{font-size:9px;color:#AEB6BF;text-transform:uppercase;margin-bottom:2px}\n    .fv{font-size:12px;color:#5D6D7E;font-weight:500}\n    .fv.d{color:#2E86AB;font-weight:600}\n    .fv.m{color:#27AE60;font-weight:600}\n    .ds{text-align:center;padding:8px;background:#F4F6F7;border-radius:5px;margin:8px 0}\n    .pb{margin:10px 0}\n    .pbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px}\n    .pbr{height:6px;background:#AEB6BF;border-radius:3px;overflow:hidden}\n    .pbf{height:100%;background:linear-gradient(90deg,#2E86AB,#27AE60);border-radius:3px}\n    .tot{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;padding-top:10px;border-top:2px solid #AEB6BF}\n    .ti{text-align:center;padding:10px;background:#F4F6F7;border-radius:5px}\n    .ti label{font-size:9px;color:#5D6D7E;text-transform:uppercase}\n    .ti .v{font-size:14px;font-weight:700;margin-top:3px}\n    .ti .v.ve{color:#27AE60}\n    .ti .v.vm{color:#E74C3C}\n    .ti .v.az{color:#2E86AB}\n    .tg{margin-top:8px}\n    .ft{background:#5D6D7E;color:#fff;padding:10px 15px;font-size:10px;text-align:center}\n    .ft a{color:#F4D03F;text-decoration:none}\n    @media(max-width:500px){.g,.g4{grid-template-columns:1fr}.tot{grid-template-columns:1fr}}\n  </style>\n</head>\n<body>\n<div class=\"c\">\n  <div class=\"h\">\n    <div>\n      <h1>ğŸ“‹ Fatura ${parcelaAtual}/${totalParcelas}</h1>\n      <div class=\"sub\">Start Assessoria - Workflow AutomÃ¡tico</div>\n    </div>\n    <div style=\"text-align:right\">\n      <span class=\"badge\">${statusEmoji} ${status}</span>\n      <div style=\"font-size:10px;margin-top:5px\">Deal #${dealId}</div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ‘¤ BeneficiÃ¡rio</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">Nome</span><span class=\"fv d\">${nomeCliente}</span></div>\n      <div class=\"f\"><span class=\"fl\">CPF</span><span class=\"fv\">${formatarCPF(cpf)}</span></div>\n      <div class=\"f\"><span class=\"fl\">NB</span><span class=\"fv\">${nb || '-'}</span></div>\n      <div class=\"f\"><span class=\"fl\">NIT</span><span class=\"fv\">${nit || '-'}</span></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ“… Datas</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">DIB</span><span class=\"fv\">${formatarData(dib)}</span></div>\n      <div class=\"f\"><span class=\"fl\">DCB</span><span class=\"fv\">${formatarData(dcb)}</span></div>\n      <div class=\"f\"><span class=\"fl\">DIP</span><span class=\"fv\">${formatarData(dip)}</span></div>\n      <div class=\"f\"><span class=\"fl\">CompetÃªncia</span><span class=\"fv\">${competencia || '-'}</span></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ’° Valores desta Parcela</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">Valor INSS</span><span class=\"fv m\">${formatarMoeda(valorInss)}</span></div>\n      <div class=\"f\"><span class=\"fl\">Valor Start</span><span class=\"fv m\">${formatarMoeda(valorStart)}</span></div>\n      <div class=\"f\"><span class=\"fl\">Valor Cliente</span><span class=\"fv m\">${formatarMoeda(valorCliente)}</span></div>\n      <div class=\"f\"><span class=\"fl\">AlÃ­quota</span><span class=\"fv\">${aliquotaStart || '30%'}</span></div>\n    </div>\n    <div class=\"ds\">${gerarBadges()}</div>\n    <div class=\"pb\">\n      <div class=\"pbl\"><span>Progresso CobranÃ§a</span><span>${progresso}%</span></div>\n      <div class=\"pbr\"><div class=\"pbf\" style=\"width:${progresso}%\"></div></div>\n    </div>\n  </div>\n\n  ${secaoBoleto}\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ“Š Resumo Geral (120 dias)</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">MR Bruto</span><span class=\"fv m\">${mrFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">Total BenefÃ­cio</span><span class=\"fv m\">${totalBeneficioFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">HonorÃ¡rios Start</span><span class=\"fv m\">${honorariosStartFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">Saldo Restante</span><span class=\"fv m\">${saldoFinalFormatado}</span></div>\n    </div>\n    <div class=\"tot\">\n      <div class=\"ti\"><label>Total BenefÃ­cio</label><div class=\"v az\">${totalBeneficioFormatado}</div></div>\n      <div class=\"ti\"><label>HonorÃ¡rios Start</label><div class=\"v vm\">${honorariosStartFormatado}</div></div>\n      <div class=\"ti\"><label>Saldo Restante</label><div class=\"v ${saldoFinal <= 0 ? 've' : 'vm'}\">${saldoFinalFormatado}</div></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ” Auditoria</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">Problemas</span><span class=\"fv\">${auditoria.total_problemas || 0}</span></div>\n      <div class=\"f\"><span class=\"fl\">Alertas</span><span class=\"fv\">${auditoria.total_alertas || 0}</span></div>\n    </div>\n    <div class=\"tg\">${gerarTags()}</div>\n  </div>\n\n  <div class=\"ft\">\n    ğŸ“… ${timestamp} | <a href=\"${urlDeal}\" target=\"_blank\">Abrir Deal #${dealId}</a> | Regra: ${regra || '-'} | Faturista v8\n  </div>\n</div>\n</body>\n</html>`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ CRÃTICO V8: IDs DOS CAMPOS ASAAS EM CAMELCASE!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// V7 usava UF_CRM_ (uppercase) - Bitrix IGNORAVA esses campos!\n// V8 usa ufCrm_ (camelCase) - Bitrix ACEITA esses campos!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ğŸ”¥ V8 FIX: CAMELCASE para Smart Process (entityTypeId 31)!\nconst CI_ASAAS_ID = 'ufCrm_SMART_INVOICE_1767292172702';     // âœ… camelCase\nconst CI_BOLETO_URL = 'ufCrm_SMART_INVOICE_1767292205661';   // âœ… camelCase\n\n// 1. ComeÃ§ar com campos_invoice do 6D (tem dn_mamae, dn_filho, etc.)\n// 2. Sobrescrever com fields do nÃ³ 9 (tem campos especÃ­ficos da parcela)\n// 3. Adicionar o HTML\n// 4. ğŸ”¥ V8: Adicionar campos do Asaas COM CAMELCASE!\n\nconst fieldsMesclados = {\n  // ğŸ”¥ PRIMEIRO: Campos do 6D (valores do Deal - dn_mamae, dn_filho, etc.)\n  ...camposInvoice6D,\n  \n  // ğŸ”¥ SEGUNDO: Campos do nÃ³ 9 (sobrescreve se conflitar - sÃ£o mais especÃ­ficos da parcela)\n  ...fieldsNo9,\n  \n  // ğŸ”¥ TERCEIRO: HTML do relatÃ³rio\n  'ufCrm_SMART_INVOICE_1767832451': html,\n  \n  // ğŸ”¥ QUARTO (V8): Campos do Asaas COM CAMELCASE!\n  [CI_ASAAS_ID]: asaasPaymentId,\n  [CI_BOLETO_URL]: asaasBoletoUrl,\n};\n\n// Limpar campos vazios/undefined\nconst fieldsLimpos = {};\nfor (const [key, value] of Object.entries(fieldsMesclados)) {\n  if (value !== null && value !== undefined && value !== '' && value !== 'null') {\n    fieldsLimpos[key] = value;\n  }\n}\n\n// Montar body atualizado\nconst bodyAtualizado = {\n  entityTypeId: bodyNo9.entityTypeId || 31,\n  fields: fieldsLimpos\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNAR - BODY COMPLETO COM TODOS OS CAMPOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn {\n  // ğŸ”¥ CRÃTICO: body para o nÃ³ 10 usar!\n  body: bodyAtualizado,\n  \n  // Manter todos os outros campos do nÃ³ 9\n  anti_dup: dadosNo9.anti_dup,\n  pular: dadosNo9.pular,\n  permitido_criar: dadosNo9.permitido_criar,\n  status: dadosNo9.status,\n  debug: dadosNo9.debug,\n  resumo: dadosNo9.resumo,\n  auditoria: dadosNo9.auditoria,\n  tags: dadosNo9.tags,\n  versao: dadosNo9.versao,\n  \n  // ğŸ”¥ V7: Passar dados do Asaas adiante (para outros nÃ³s que precisem)\n  asaas_payment_id: asaasPaymentId,\n  asaas_boleto_url: asaasBoletoUrl,\n  asaas_invoice_url: asaasInvoiceUrl,\n  asaas_nosso_numero: asaasNossoNumero,\n  asaas_status: asaasStatus,\n  asaas_customer_id: asaasCustomerId,\n  \n  // Debug V8\n  _no12_debug: {\n    versao: 'V8',\n    fix_aplicado: 'CAMELCASE para campos Asaas',\n    campos_do_6D: Object.keys(camposInvoice6D).length,\n    campos_do_no9: Object.keys(fieldsNo9).length,\n    campos_mesclados: Object.keys(fieldsLimpos).length,\n    html_adicionado: true,\n    html_tamanho: html.length,\n    campo_html_id: 'ufCrm_SMART_INVOICE_1767832451',\n    \n    // ğŸ”¥ V8: Status dos campos Asaas COM IDs CORRETOS\n    asaas: {\n      payment_id: asaasPaymentId || 'NÃƒO ENCONTRADO',\n      boleto_url: asaasBoletoUrl || 'NÃƒO ENCONTRADO',\n      invoice_url: asaasInvoiceUrl || 'NÃƒO ENCONTRADO',\n      nosso_numero: asaasNossoNumero || '-',\n      status: asaasStatus || '-',\n      customer_id: asaasCustomerId || '-',\n      campo_id_usado: CI_ASAAS_ID,       // ufCrm_ (camelCase) âœ…\n      campo_url_usado: CI_BOLETO_URL,    // ufCrm_ (camelCase) âœ…\n      adicionado_ao_body: !!asaasPaymentId,\n      formato_corrigido: 'V8 usa ufCrm_ em vez de UF_CRM_'\n    },\n    \n    // Verificar campos crÃ­ticos\n    campos_verificados: {\n      asaas_id: fieldsLimpos[CI_ASAAS_ID] ? 'âœ…' : 'âŒ',\n      boleto_url: fieldsLimpos[CI_BOLETO_URL] ? 'âœ…' : 'âŒ',\n      html: fieldsLimpos['ufCrm_SMART_INVOICE_1767832451'] ? 'âœ…' : 'âŒ',\n    },\n    \n    // Prova do fix\n    prova_fix: {\n      v7_errado: 'UF_CRM_SMART_INVOICE_1767292172702',\n      v8_correto: CI_ASAAS_ID,\n      campo_presente_no_body: !!fieldsLimpos[CI_ASAAS_ID]\n    },\n    \n    fontes: {\n      '6D': !!dados6D.campos_invoice,\n      'no9_body': !!bodyNo9.entityTypeId,\n      '1B': !!dados1B.deal_id,\n      'BUSCAR_DEAL': Object.keys(dealData).length > 0,\n      '9C_asaas': !!asaasPaymentId\n    }\n  }\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    7968,
    26128
  ],
  "id": "16c4832c-0a58-4936-8dc5-bf1f8018c4ff",
  "name": "12. Gerar RelatÃ³rio HTML"
}