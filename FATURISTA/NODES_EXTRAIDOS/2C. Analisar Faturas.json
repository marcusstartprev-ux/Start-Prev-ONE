{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 2C - ANALISAR FATURAS (V2.2 - BUSCA DEAL + IDs CORRIGIDOS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 31/01/2026\n// \n// CORREÃ‡Ã•ES V2.2:\n// âœ… Busca dados do Deal do nÃ³ \"BUSCAR DEAL\" (nÃ£o apenas do ctx)\n// âœ… IDs dos campos CORRIGIDOS (faltava underscore: ufCrm_XXXXX)\n// âœ… ValidaÃ§Ã£o de CPF com mensagem clara\n// âœ… Mensagem especÃ­fica sobre competÃªncias duplicadas\n// âœ… Links Ãºteis no retorno de erro\n//\n// MANTIDO DA V2.1:\n// âœ… Flag tem_faturas para IF posterior\n// âœ… Mapeamento por COMPETÃŠNCIA (mais confiÃ¡vel)\n// âœ… SeparaÃ§Ã£o por STATUS (pagas, pendentes, canceladas)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// IDs DOS CAMPOS - SMART INVOICE (CORRIGIDOS 31/01/2026)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CI = {\n  // IdentificaÃ§Ã£o\n  cpf:              'ufCrm_652439CFE551C',\n  nb:               'ufCrm_6790DAD756E3C',\n  \n  // Valores\n  valor_start:      'ufCrm_652439D9202B3',    // Valor Previsto (Start)\n  valor_inss:       'ufCrm_652439D8D6B8E',    // Valor INSS da parcela\n  valor_cliente:    'ufCrm_652439D915311',    // Valor que fica com cliente\n  \n  // Datas\n  data_inss:        'ufCrm_652439D8B3207',    // Data pagamento INSS\n  \n  // CompetÃªncia/Parcela\n  competencia:      'ufCrm_691B6450B46E3',    // \"12/2025\"\n  parcela_numero:   'ufCrm_652439D8E9608',    // 1, 2, 3...\n  parcela_formato:  'ufCrm_652439D8CDB53',    // \"1/3\", \"2/3\"\n  \n  // Controle\n  saldo_restante:   'ufCrm_69442F27CCFB3',    // Saldo Start apÃ³s esta fatura\n  regra_aplicada:   'ufCrm_69442F5F762AD',    // PROGRESSIVO_45, COBRA_TUDO, etc\n};\n\n// IDs alternativos (formato com underscore maiÃºsculo - API pode retornar assim)\nconst CI_ALT = {\n  cpf:              'UF_CRM_652439CFE551C',\n  nb:               'UF_CRM_6790DAD756E3C',\n  valor_start:      'UF_CRM_652439D9202B3',\n  valor_inss:       'UF_CRM_652439D8D6B8E',\n  valor_cliente:    'UF_CRM_652439D915311',\n  data_inss:        'UF_CRM_652439D8B3207',\n  competencia:      'UF_CRM_691B6450B46E3',\n  parcela_numero:   'UF_CRM_652439D8E9608',\n  parcela_formato:  'UF_CRM_652439D8CDB53',\n  saldo_restante:   'UF_CRM_69442F27CCFB3',\n  regra_aplicada:   'UF_CRM_69442F5F762AD',\n};\n\n// IDs dos campos do DEAL\nconst CD = {\n  cpf:              'UF_CRM_5F7DD07B0ADB5',\n  nb:               'UF_CRM_1737470444334',\n  mr_cliente:       'UF_CRM_1741726157749',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡Ã•ES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CONFIG = {\n  // Stages da Smart Invoice (ajustar conforme seu Bitrix)\n  STAGES_PAGAS: ['DT31_2:P', 'DT31_2:WON', 'PAID', 'P'],\n  STAGES_CANCELADAS: ['DT31_2:FAIL', 'DT31_2:LOSE', 'CANCELED', 'F'],\n  STAGES_PENDENTES: ['DT31_2:N', 'DT31_2:NEW', 'DT31_2:PREPARATION', 'NEW', 'N'],\n  \n  // Valor mÃ­nimo para considerar fatura vÃ¡lida\n  VALOR_MINIMO: 0.01,\n  \n  // VersÃ£o\n  VERSAO: 'V2.2',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES AUXILIARES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/**\n * Normaliza CPF/NIT para apenas nÃºmeros\n */\nconst normalizarDocumento = (valor) => {\n  if (!valor) return null;\n  const nums = String(valor).replace(/\\D/g, '');\n  return nums.length >= 11 ? nums : null;\n};\n\n/**\n * Parse de valor monetÃ¡rio (aceita vÃ¡rios formatos)\n */\nconst parseValor = (valor) => {\n  if (valor === null || valor === undefined) return 0;\n  if (typeof valor === 'number') return valor;\n  \n  let str = String(valor).trim();\n  \n  // Formato Bitrix money: \"1518|BRL\"\n  if (str.includes('|')) {\n    str = str.split('|')[0];\n  }\n  \n  str = str.replace(/[R$\\s]/gi, '');\n  \n  if (str.includes('.') && str.includes(',')) {\n    const lastDot = str.lastIndexOf('.');\n    const lastComma = str.lastIndexOf(',');\n    if (lastComma > lastDot) {\n      str = str.replace(/\\./g, '').replace(',', '.');\n    } else {\n      str = str.replace(/,/g, '');\n    }\n  } else if (str.includes(',')) {\n    str = str.replace(',', '.');\n  }\n  \n  const num = parseFloat(str);\n  return Number.isFinite(num) ? Math.floor(num * 100) / 100 : 0;\n};\n\n/**\n * Pega campo da fatura (tenta ambos formatos de ID)\n */\nconst getCampo = (fatura, campo) => {\n  return fatura[CI[campo]] || fatura[CI_ALT[campo]] || null;\n};\n\n/**\n * Cria chave Ãºnica para anti-duplicaÃ§Ã£o\n */\nconst criarChaveUnica = (cpf, nb, competencia) => {\n  const cpfNorm = normalizarDocumento(cpf);\n  if (!cpfNorm || !competencia) return null;\n  return `${cpfNorm}|${nb || 'SEM_NB'}|${competencia}`;\n};\n\n/**\n * Determina status da fatura\n */\nconst getStatusFatura = (stageId) => {\n  if (!stageId) return 'DESCONHECIDO';\n  const stage = String(stageId).toUpperCase();\n  \n  if (CONFIG.STAGES_PAGAS.some(s => stage.includes(s))) return 'PAGA';\n  if (CONFIG.STAGES_CANCELADAS.some(s => stage.includes(s))) return 'CANCELADA';\n  if (CONFIG.STAGES_PENDENTES.some(s => stage.includes(s))) return 'PENDENTE';\n  \n  return 'OUTRO';\n};\n\n/**\n * Cria objeto de alerta padronizado\n */\nconst criarAlerta = (tipo, emoji, titulo, mensagem, severidade = 1, bloqueia = false) => ({\n  tipo,\n  emoji,\n  titulo,\n  mensagem,\n  severidade,\n  bloqueia,\n});\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// INÃCIO DO PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n// Contexto do 1B. Inicializar (dados vÃªm do webhook)\nconst ctx = $('1B. Inicializar').first()?.json || {};\n\n// ðŸ”§ V2.2: Buscar dados do Deal do nÃ³ \"BUSCAR DEAL\"\nconst dealResult = $('BUSCAR DEAL').first()?.json?.result || {};\n\n// Faturas retornadas pelo nÃ³ 2B (crm.item.list)\n// Smart Invoice retorna em { result: { items: [...] } }\nlet faturas = [];\nif (Array.isArray($json?.result?.items)) {\n  faturas = $json.result.items;\n} else if (Array.isArray($json?.result)) {\n  faturas = $json.result;\n} else if (Array.isArray($json?.items)) {\n  faturas = $json.items;\n} else if (Array.isArray($json)) {\n  faturas = $json;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// DADOS DO DEAL (PRIORIZA NÃ“ \"BUSCAR DEAL\", FALLBACK PARA CTX)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst deal = {\n  id: Number(ctx.deal_id) || Number(dealResult.ID) || 0,\n  titulo: dealResult.TITLE || ctx.nome || ctx.nome_cliente || 'Cliente',\n  cpf: normalizarDocumento(dealResult[CD.cpf] || ctx.cpf),\n  nb: dealResult[CD.nb] || ctx.nb || null,\n  contact_id: dealResult.CONTACT_ID || ctx.contact_id || null,\n  mr_cliente: parseValor(dealResult[CD.mr_cliente] || ctx.mr),\n  file_id: ctx.file_id || null,\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// VALIDAÃ‡ÃƒO: CPF Ã‰ OBRIGATÃ“RIO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!deal.cpf) {\n  return {\n    erro: true,\n    tipo_erro: 'CPF_AUSENTE',\n    deal_id: deal.id,\n    file_id: deal.file_id,\n    alerta: criarAlerta(\n      'CRITICO',\n      'ðŸš¨',\n      'CPF NÃƒO INFORMADO',\n      `Deal ${deal.id}: Campo CPF nÃ£o enviado ou invÃ¡lido (vazio). O CPF Ã© necessÃ¡rio para verificar faturas existentes.`,\n      3,\n      true\n    ),\n    links: {\n      deal: `https://startprev.bitrix24.com.br/crm/deal/details/${deal.id}/`,\n    },\n    execucao: {\n      inicio: new Date(inicio).toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio,\n    },\n    \n    // Passar dados mesmo com erro (para nÃ£o quebrar fluxo)\n    cpf_cliente: null,\n    cpf: null,\n    nome_cliente: deal.titulo,\n    contact_id: deal.contact_id,\n    nb_cliente: deal.nb,\n    mr_cliente: deal.mr_cliente,\n    \n    // Flags mesmo com erro\n    tem_faturas: faturas.length > 0,\n    tem_faturas_ativas: false,\n    tem_faturas_pendentes: false,\n    \n    // Stats bÃ¡sicas das faturas encontradas\n    stats_faturas: {\n      total: faturas.length,\n      pagas: 0,\n      pendentes: 0,\n      canceladas: 0,\n      valor_start_cobrado: 0,\n      valor_start_pago: 0,\n      valor_start_pendente: 0,\n      ultima_parcela: 0,\n      ultima_competencia: null,\n      competencias_existentes: [],\n    },\n    \n    // Mapas vazios\n    faturas_existentes: {\n      todas: [],\n      pagas: [],\n      pendentes: [],\n      por_competencia: {},\n      por_data_inss: {},\n      por_chave_unica: {},\n    },\n    \n    saldo_start_ja_cobrado: 0,\n    \n    _debug_2c: {\n      deal_id: deal.id,\n      deal_cpf: null,\n      deal_nb: deal.nb,\n      deal_result_cpf: dealResult[CD.cpf],\n      ctx_cpf: ctx.cpf,\n      faturas_encontradas: faturas.length,\n      motivo_erro: 'CPF nÃ£o encontrado nem no Deal nem no contexto',\n    },\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESSAR FATURAS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst resultado = {\n  // Arrays\n  todas: [],\n  pagas: [],\n  pendentes: [],\n  canceladas: [],\n  \n  // Mapas para anti-duplicaÃ§Ã£o\n  por_competencia: {},\n  por_data_inss: {},\n  por_chave_unica: {},\n  \n  // Totais\n  totais: {\n    quantidade: 0,\n    quantidade_pagas: 0,\n    quantidade_pendentes: 0,\n    quantidade_canceladas: 0,\n    valor_start_total: 0,\n    valor_start_pago: 0,\n    valor_start_pendente: 0,\n    valor_inss_total: 0,\n  },\n  \n  // Controle\n  competencias_existentes: [],\n  ultima_parcela: 0,\n  ultima_competencia: null,\n};\n\nfor (const inv of faturas) {\n  // Extrair dados da fatura\n  const fatura = {\n    id: inv.id || inv.ID || inv.Id || null,\n    titulo: inv.title || inv.TITLE || null,\n    stage_id: inv.stageId || inv.STAGE_ID || inv.STATUS_ID || null,\n    \n    // Campos customizados\n    cpf: normalizarDocumento(getCampo(inv, 'cpf')),\n    nb: getCampo(inv, 'nb'),\n    valor_start: parseValor(getCampo(inv, 'valor_start')),\n    valor_inss: parseValor(getCampo(inv, 'valor_inss')),\n    valor_cliente: parseValor(getCampo(inv, 'valor_cliente')),\n    data_inss: getCampo(inv, 'data_inss'),\n    competencia: getCampo(inv, 'competencia'),\n    parcela_numero: parseInt(getCampo(inv, 'parcela_numero')) || 0,\n    parcela_formato: getCampo(inv, 'parcela_formato'),\n    saldo_restante: parseValor(getCampo(inv, 'saldo_restante')),\n    regra_aplicada: getCampo(inv, 'regra_aplicada'),\n  };\n  \n  // Determinar status\n  fatura.status = getStatusFatura(fatura.stage_id);\n  \n  // Adicionar Ã  lista geral\n  resultado.todas.push(fatura);\n  resultado.totais.quantidade++;\n  \n  // Separar por status\n  switch (fatura.status) {\n    case 'PAGA':\n      resultado.pagas.push(fatura);\n      resultado.totais.quantidade_pagas++;\n      resultado.totais.valor_start_pago += fatura.valor_start;\n      break;\n    case 'PENDENTE':\n      resultado.pendentes.push(fatura);\n      resultado.totais.quantidade_pendentes++;\n      resultado.totais.valor_start_pendente += fatura.valor_start;\n      break;\n    case 'CANCELADA':\n      resultado.canceladas.push(fatura);\n      resultado.totais.quantidade_canceladas++;\n      break;\n  }\n  \n  // Somar totais (exceto canceladas)\n  if (fatura.status !== 'CANCELADA') {\n    resultado.totais.valor_start_total += fatura.valor_start;\n    resultado.totais.valor_inss_total += fatura.valor_inss;\n  }\n  \n  // Mapear por COMPETÃŠNCIA (principal para anti-duplicaÃ§Ã£o)\n  if (fatura.competencia) {\n    if (!resultado.por_competencia[fatura.competencia]) {\n      resultado.por_competencia[fatura.competencia] = [];\n    }\n    resultado.por_competencia[fatura.competencia].push(fatura);\n    \n    // Lista de competÃªncias existentes\n    if (!resultado.competencias_existentes.includes(fatura.competencia)) {\n      resultado.competencias_existentes.push(fatura.competencia);\n    }\n  }\n  \n  // Mapear por DATA INSS (backup)\n  if (fatura.data_inss) {\n    if (!resultado.por_data_inss[fatura.data_inss]) {\n      resultado.por_data_inss[fatura.data_inss] = [];\n    }\n    resultado.por_data_inss[fatura.data_inss].push(fatura);\n  }\n  \n  // Mapear por CHAVE ÃšNICA (CPF+NB+COMPETÃŠNCIA)\n  const chave = criarChaveUnica(fatura.cpf || deal.cpf, fatura.nb || deal.nb, fatura.competencia);\n  if (chave) {\n    if (!resultado.por_chave_unica[chave]) {\n      resultado.por_chave_unica[chave] = [];\n    }\n    resultado.por_chave_unica[chave].push(fatura);\n  }\n  \n  // Rastrear Ãºltima parcela\n  if (fatura.parcela_numero > resultado.ultima_parcela) {\n    resultado.ultima_parcela = fatura.parcela_numero;\n    resultado.ultima_competencia = fatura.competencia;\n  }\n}\n\n// Truncar totais para 2 casas\nresultado.totais.valor_start_total = Math.floor(resultado.totais.valor_start_total * 100) / 100;\nresultado.totais.valor_start_pago = Math.floor(resultado.totais.valor_start_pago * 100) / 100;\nresultado.totais.valor_start_pendente = Math.floor(resultado.totais.valor_start_pendente * 100) / 100;\nresultado.totais.valor_inss_total = Math.floor(resultado.totais.valor_inss_total * 100) / 100;\n\n// Ordenar competÃªncias\nresultado.competencias_existentes.sort();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FLAGS DE CONTROLE (PARA IF POSTERIOR)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst flags = {\n  // Principal: TEM FATURAS?\n  tem_faturas: resultado.totais.quantidade > 0,\n  tem_faturas_ativas: (resultado.totais.quantidade_pagas + resultado.totais.quantidade_pendentes) > 0,\n  tem_faturas_pendentes: resultado.totais.quantidade_pendentes > 0,\n  tem_faturas_pagas: resultado.totais.quantidade_pagas > 0,\n  \n  // Saldo\n  saldo_start_ja_cobrado: resultado.totais.valor_start_total,\n  saldo_start_ja_pago: resultado.totais.valor_start_pago,\n  saldo_start_pendente: resultado.totais.valor_start_pendente,\n  \n  // Pode criar mais faturas?\n  pode_criar_novas: true, // SerÃ¡ validado nos prÃ³ximos nÃ³s\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// LOG PARA DEBUG\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst log = {\n  deal_id: deal.id,\n  deal_cpf: deal.cpf,\n  deal_nb: deal.nb,\n  deal_titulo: deal.titulo,\n  deal_mr: deal.mr_cliente,\n  faturas_encontradas: resultado.totais.quantidade,\n  faturas_pagas: resultado.totais.quantidade_pagas,\n  faturas_pendentes: resultado.totais.quantidade_pendentes,\n  faturas_canceladas: resultado.totais.quantidade_canceladas,\n  valor_start_ja_cobrado: resultado.totais.valor_start_total,\n  competencias: resultado.competencias_existentes,\n  ultima_parcela: resultado.ultima_parcela,\n  fonte_cpf: dealResult[CD.cpf] ? 'BUSCAR_DEAL' : (ctx.cpf ? 'CTX' : 'NENHUMA'),\n};\n\nconsole.log('[2C] AnÃ¡lise de Faturas V2.2:', JSON.stringify(log, null, 2));\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// RETORNO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nreturn {\n  // Manter contexto anterior\n  ...ctx,\n  \n  // Metadados da execuÃ§Ã£o\n  _no: '2C',\n  _versao: CONFIG.VERSAO,\n  _timestamp: new Date().toISOString(),\n  _tempo_ms: Date.now() - inicio,\n  \n  // Dados do Deal (OBRIGATÃ“RIO para nÃ³s seguintes)\n  deal_id: deal.id,\n  cpf_cliente: deal.cpf,\n  cpf: deal.cpf,\n  nome_cliente: deal.titulo,\n  contact_id: deal.contact_id,\n  nb_cliente: deal.nb,\n  mr_cliente: deal.mr_cliente,\n  file_id: deal.file_id,\n  \n  // FLAGS PARA IF (principais)\n  tem_faturas: flags.tem_faturas,\n  tem_faturas_ativas: flags.tem_faturas_ativas,\n  tem_faturas_pendentes: flags.tem_faturas_pendentes,\n  \n  // EstatÃ­sticas\n  stats_faturas: {\n    total: resultado.totais.quantidade,\n    pagas: resultado.totais.quantidade_pagas,\n    pendentes: resultado.totais.quantidade_pendentes,\n    canceladas: resultado.totais.quantidade_canceladas,\n    valor_start_cobrado: resultado.totais.valor_start_total,\n    valor_start_pago: resultado.totais.valor_start_pago,\n    valor_start_pendente: resultado.totais.valor_start_pendente,\n    ultima_parcela: resultado.ultima_parcela,\n    ultima_competencia: resultado.ultima_competencia,\n    competencias_existentes: resultado.competencias_existentes,\n  },\n  \n  // Mapas para anti-duplicaÃ§Ã£o (usados no NÃ³ 12)\n  faturas_existentes: {\n    todas: resultado.todas,\n    pagas: resultado.pagas,\n    pendentes: resultado.pendentes,\n    por_competencia: resultado.por_competencia,\n    por_data_inss: resultado.por_data_inss,\n    por_chave_unica: resultado.por_chave_unica,\n  },\n  \n  // Saldo Start (para cÃ¡lculos)\n  saldo_start_ja_cobrado: resultado.totais.valor_start_total,\n  \n  // Debug\n  _debug_2c: log,\n};"
  },
  "id": "3ce5f24c-a90d-4922-8dd7-3ee4cdae14eb",
  "name": "2C. Analisar Faturas",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    4384,
    26000
  ]
}