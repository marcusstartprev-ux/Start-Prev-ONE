{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6D â€” REVISOR DE CÃLCULOS (V5.8)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Validar TUDO, consolidar tags, decidir ok/erro\n// ENTRADA: 5 inputs do Merge 1 (Gemini, 6A, 6B, 6C, BUSCAR DEAL)\n// SAÃDA: ok: true/false + auditoria completa + dados para prÃ³ximo nÃ³\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// CHANGELOG V5.7 (08/01/2026):\n// ğŸ”¥ CORREÃ‡ÃƒO CRÃTICA: ValidaÃ§Ã£o PDF vs Deal separada!\n//    - cpfPDF (do Gemini/6A) vs cpfDeal (do Deal/1B)\n//    - nbPDF (do Gemini/6A) vs nbDeal (do Deal/1B)\n// ğŸ”¥ NOVO: Erros especÃ­ficos E_CPF_PDF_DIFERENTE_DEAL e E_NB_PDF_DIFERENTE_DEAL\n// âœ… MANTÃ‰M: contact_id e assessor no output (v5.6)\n// âœ… MANTÃ‰M: Tudo do V5.5 (92 campos, mapeamento completo)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ BUSCAR CADA INPUT DO MERGE EXPLICITAMENTE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados6B = buscarNo('6B.Calculo do INSS');\nconst dados6A = buscarNo('6A. Calculo do Historico de credito (PDF)');\nconst dadosGemini = buscarNo('5. Gemini Extrair2');\nconst dados1B = buscarNo('1B. Inicializar');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.4: BUSCAR DEAL DO ARRAY DE INPUTS DO MERGE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// O Merge junta vÃ¡rios inputs em um array. O Deal vem no item que tem \"result\"\n// Precisamos iterar para encontrar o item correto!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Primeiro tenta buscar do nÃ³ BUSCAR DEAL diretamente\nlet dealData = {};\nconst dadosBuscarDealDireto = buscarNo('BUSCAR DEAL');\nif (dadosBuscarDealDireto && dadosBuscarDealDireto.result) {\n  dealData = dadosBuscarDealDireto.result;\n} else {\n  // Se nÃ£o encontrou, procura no array de inputs o item que tem \"result\"\n  const todosInputs = $input.all();\n  for (const item of todosInputs) {\n    if (item.json && item.json.result && item.json.result.ID) {\n      dealData = item.json.result;\n      break;\n    }\n  }\n}\n\n// Fallback: se ainda vazio, tenta pegar do primeiro input (compatibilidade)\nif (Object.keys(dealData).length === 0) {\n  const primeiroInput = $input.first()?.json || {};\n  if (primeiroInput.result) {\n    dealData = primeiroInput.result;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DEAL â†’ INVOICE (IDs corretos de cada entidade)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// IDs dos campos no DEAL\nconst CD = {\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // MAPEAMENTO COMPLETO DO DEAL - BASEADO NA PLANILHA OFICIAL\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  // 1. IDENTIFICAÃ‡ÃƒO\n  cpf: 'UF_CRM_5F7DD07B0ADB5',\n  rg: 'UF_CRM_5F7DD07B11C33',\n  nit: 'UF_CRM_1766282969',\n  nb: 'UF_CRM_1737470444334',\n  nome_filho: 'UF_CRM_1699462600794',\n  categoria: 'UF_CRM_5F7DD07B0295D',\n  \n  // 2. BENEFÃCIO (Datas)\n  dib: 'UF_CRM_1765928945',\n  dip: 'UF_CRM_1766439387',\n  dcb: 'UF_CRM_1748433331869',\n  dn_mamae: 'UF_CRM_1602615428011',\n  dn_filho: 'UF_CRM_5F7DD07B1997D',\n  dn_certidao: 'UF_CRM_1714741602233',\n  data_dnv: 'UF_CRM_1742827283535',\n  data_requerimento: 'UF_CRM_6094054C7C1C8',\n  data_concessao: 'UF_CRM_1602256897805',\n  \n  // 3. BENEFÃCIO (Valores)\n  mr_cliente: 'UF_CRM_1741726157749',\n  valor_total_beneficio: 'UF_CRM_1742841962002',\n  aliquota_mr: 'UF_CRM_1742841855608',\n  \n  // 5. FATURAMENTO (Parcela)\n  valor_inss: 'UF_CRM_1634158430224',\n  valor_cliente: 'UF_CRM_1634828809106',\n  valor_previsto: 'UF_CRM_1635261498013',\n  valor_recebido: 'UF_CRM_1633535814529',\n  parcela_numero: 'UF_CRM_1634158972573',\n  qtd_parcelas: 'UF_CRM_1625253358741',\n  \n  // 8. BANCO\n  banco: 'UF_CRM_1603216440272',\n  endereco_banco: 'UF_CRM_1603216499370',\n  agencia_banco: 'UF_CRM_1762558313',\n  \n  // 9. CONTROLE / ANÃLISE\n  justificativa_direito: 'UF_CRM_1765636941',\n  data_rodagem: 'UF_CRM_1764270308863',\n  rodagem_comentario: 'UF_CRM_1764270260617',\n  \n  // 10. GESTÃƒO\n  assessor: 'UF_CRM_5F7DD07AEC035',\n  ultimo_relacionador: 'UF_CRM_1688072257656',\n  ddd_cliente: 'UF_CRM_659C48C5F0594',\n  data_reclamacao: 'UF_CRM_1704738513559',\n  data_qualificacao: 'UF_CRM_65E74D984ED3C',\n  data_recuperacao: 'UF_CRM_1713804709729',\n  data_encerramento: 'UF_CRM_663007E42D75E',\n  data_reentrada: 'UF_CRM_1615653096667',\n\n\n\n  \n  // CAMPOS EXTRAS (da planilha - linhas 71-92)\n  data_conversao: 'UF_CRM_5F7DD07B204FD',\n  data_certidao: 'UF_CRM_1674755625727',\n  data_consulta: 'UF_CRM_1602256877083',\n  data_contato: 'UF_CRM_1650915373840',\n  data_prox_contato: 'UF_CRM_1650915411107',\n  data_sem_direito: 'UF_CRM_1649701660322',\n  data_indeferimento: 'UF_CRM_1620315580',\n  data_quebra_contrato: 'UF_CRM_1737722079155',\n  relacionador_quebra: 'UF_CRM_1737722166447',\n  relacionador_sem_direito: 'UF_CRM_1737722233583',\n  recurso: 'UF_CRM_1759219838803',\n  senha: 'UF_CRM_1602257200479',\n  sugestao_senha: 'UF_CRM_5FDA4FCE92DAA',\n  telefone_2: 'UF_CRM_606C6C98B68A7',\n  telefone_3: 'UF_CRM_606C6C9A00D10',\n  sine: 'UF_CRM_1751375841241',\n  data_envio_recurso: 'UF_CRM_1759220050331',\n\n  // 11. DARF (NOVO)\n  necessita_darf: 'UF_CRM_1650375670632', // NECESSITA DE DARF? (Sim! Start irÃ¡ pagar!)\n  valor_darf:     'UF_CRM_69416D0451D4A', // VALOR DA DARF\n\n\n\n};\n\n// IDs dos campos na INVOICE (Smart Process - entityTypeId 31)\nconst CI = {\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // MAPEAMENTO COMPLETO DA INVOICE - BASEADO NA PLANILHA OFICIAL\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  // 1. IDENTIFICAÃ‡ÃƒO\n  cpf: 'UF_CRM_652439CFE551C',\n  rg: 'UF_CRM_652439D00A9CF',\n  nit: 'UF_CRM_6947602572F0A',\n  nb: 'UF_CRM_6790DAD756E3C',\n  nome_filho: 'UF_CRM_65BD5488EC8E9',\n  categoria: 'UF_CRM_652439D03479D',\n  \n  // 2. BENEFÃCIO (Datas)\n  dib: 'UF_CRM_69442F085B2CD',\n  dip: 'UF_CRM_683860072DEB8',\n  dcb: 'UF_CRM_6838600845561',\n  dn_mamae: 'UF_CRM_652439D0138A5',\n  dn_filho: 'UF_CRM_652439D021438',\n  dn_certidao: 'UF_CRM_66351141F40C7',\n  data_dnv: 'UF_CRM_67E17F1C70EAF',\n  data_requerimento: 'UF_CRM_652439D3530AB',\n  data_concessao: 'UF_CRM_652439D157BA8',\n  \n  // 3. BENEFÃCIO (Valores)\n  mr_cliente: 'UF_CRM_67D19072D84A8',\n  valor_diario: 'UF_CRM_69442F466791E',\n  valor_liquido_mensal: 'UF_CRM_69442F4D0909D',\n  valor_total_beneficio: 'UF_CRM_69442F535C91B',\n  valor_restante_inss: 'UF_CRM_69442F3A581C2',\n  aliquota_mr: 'UF_CRM_67E1B184633ED',\n  especie_beneficio: 'UF_CRM_69442F6570BDB',\n  \n  // 4. HONORÃRIOS START\n  valor_total_start: 'UF_CRM_69442F217FB9D',\n  saldo_restante_start: 'UF_CRM_69442F27CCFB3',\n  aliquota_start: 'UF_CRM_69442F596A782',\n  regra_aplicada: 'UF_CRM_69442F5F762AD',\n  \n  // 5. FATURAMENTO (Parcela)\n  valor_inss: 'UF_CRM_652439D8D6B8E',\n  valor_cliente: 'UF_CRM_652439D915311',\n  valor_previsto: 'UF_CRM_652439D9202B3',\n  parcela_numero: 'UF_CRM_652439D8E9608',\n  parcela_formato: 'UF_CRM_652439D8CDB53',\n  qtd_parcelas: 'UF_CRM_67E1AD2860054',\n  \n  // 6. EXTRATO / COMPETÃŠNCIA\n  competencia: 'UF_CRM_691B6450B46E3',\n  competencia_final: 'UF_CRM_69442F0E9A95A',\n  periodo: 'UF_CRM_691B64560A17F',\n  ultima_comp_valida: 'UF_CRM_693D7DE5148DB',\n  credito_invalidado: 'UF_CRM_691B6467F11F2',\n  dias_ja_recebidos: 'UF_CRM_69442F2E321C4',\n  dias_restantes: 'UF_CRM_69442F3449D22',\n  \n  // 7. DATAS OPERACIONAIS\n  data_inss: 'UF_CRM_652439D8B3207',\n  data_pagamento_extrato: 'UF_CRM_691B64616C2C9',\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',\n  \n  // 8. BANCO\n  banco: 'UF_CRM_652439D194A06',\n  endereco_banco: 'UF_CRM_652439D1A53FA',\n  agencia_banco: 'UF_CRM_691225FDDDBE4',\n  \n  // 9. CONTROLE / ANÃLISE\n  justificativa_direito: 'UF_CRM_693D7BBC3E5D3',\n  resultado_analise: 'UF_CRM_693D7CB58EBD2',\n  data_rodagem: 'UF_CRM_6929FDA3C8A79',\n  rodagem_comentario: 'UF_CRM_6929FD9E9A95D',\n  direito_ate: 'UF_CRM_679781AAB3B1D',\n  \n  // 10. GESTÃƒO\n  assessor: 'UF_CRM_681E47094F79F',  // ğŸ”¥ V5.6: ID DO ASSESSOR NA INVOICE!\n  ultimo_relacionador: 'UF_CRM_65BD5488EC8E9',\n  ddd_cliente: 'UF_CRM_65BD5489DF3A2',\n  data_reclamacao: 'UF_CRM_65BD5489C89AD',\n  data_qualificacao: 'UF_CRM_65E777E2A0CED',\n  data_recuperacao: 'UF_CRM_662699414BCF0',\n  data_encerramento: 'UF_CRM_6631460FD3BB4',\n  data_reentrada: 'UF_CRM_678EADB02E460',\n  \n  // CAMPOS EXTRAS (da planilha - linhas 71-92)\n  data_conversao: 'UF_CRM_652439D0CF19F',\n  data_calculo: 'UF_CRM_69442F14E544C',\n  data_certidao: 'UF_CRM_652439DA75EFF',\n  data_consulta: 'UF_CRM_652439D14CF3D',\n  data_acordo: 'UF_CRM_652439DB85203',\n  data_contato: 'UF_CRM_652439D9B26DF',\n  data_sem_direito: 'UF_CRM_66ACE094C0195',\n  data_pagamento: 'UF_CRM_652439D8BD582',\n  data_indeferimento: 'UF_CRM_652439D3E866C',\n  data_recebimento: 'UF_CRM_652439D1B26E2',\n  desconto: 'UF_CRM_6838600A5C767',\n  data_quebra_contrato: 'UF_CRM_6793A405B3FC1',\n  relacionador_quebra: 'UF_CRM_6793A4065BECA',\n  relacionador_sem_direito: 'UF_CRM_6793A40701BCB',\n  recurso: 'UF_CRM_68DD552A351D0',\n  senha: 'UF_CRM_652439D16254A',\n  sugestao_senha: 'UF_CRM_652439D23E905',\n  telefone_2: 'UF_CRM_652439D28D353',\n  telefone_3: 'UF_CRM_652439D298A88',\n  sine: 'UF_CRM_6883D4B47136F',\n  data_envio_recurso: 'UF_CRM_68DD552F3DD02',\n  \n  // ğŸ”¥ V5.6: ASAAS\n  asaas_id: 'UF_CRM_SMART_INVOICE_1767292172702',\n  boleto_url: 'UF_CRM_SMART_INVOICE_1767292205661',\n\n  // 11. DARF (NOVO)\n  necessita_darf: 'UF_CRM_652439D99106D', // NECESSITA DE DARF? (na INVOICE)\n  valor_darf:     'UF_CRM_695C0F05B6DD0', // VALOR DA DARF (na INVOICE)\n\n\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.6: EXTRAIR CONTACT_ID E ASSESSOR DO DEAL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst contactId = dealData.CONTACT_ID || dealData.contact_id || null;\nconst assessorDeal = dealData[CD.assessor] || dealData.UF_CRM_5F7DD07AEC035 || null;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONSOLIDAR DADOS DOS DIFERENTES NÃ“S\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ctx = dados6C;\nconst resumo = ctx.resumo || dados6B.resumo || {};\nconst dados = ctx.dados || dados6B.dados || {};\nconst parcelas = dados.parcelas || [];\nconst deal = dados.deal || ctx.deal || dados6B.deal || dados6A.deal || {};\nconst config = dados.config || {};\n\nconst creditos_originais = dados.creditos_originais || dados6B.dados?.creditos || dados6A.creditos || [];\nconst parcelas_projetadas = dados.parcelas_projetadas_originais || [];\nconst primeiroCredito = creditos_originais[0] || {};\n\n// ğŸ”¥ V5.9: Buscar tags do 6A v7.1 (vem em .tags, nÃ£o em .info)\n// O 6A v7.1 envia tags como objetos {codigo, severidade, mensagem}\nconst tags_6a_raw = dados6A.tags || dados6A.info || [];\n// Converter severidade CRIT â†’ CRITICO (6A usa CRIT, 6D espera CRITICO)\nconst tags_6a = tags_6a_raw.map(t => {\n  if (typeof t === 'object' && t.severidade === 'CRIT') {\n    return { ...t, severidade: 'CRITICO' };\n  }\n  return typeof t === 'string' ? t : (t.codigo || t);\n});\n\n// ğŸ”¥ V5.9: Processar tags do 6B v6.5 (usa \"nivel\" em vez de \"severidade\")\nconst tags_6b_raw = dados6B.tags || dados6B.tags_sucesso || [];\nconst tags_6b = tags_6b_raw.map(t => {\n  if (typeof t === 'object' && t.nivel === 'CRITICO') {\n    return { ...t, severidade: 'CRITICO' };\n  }\n  return typeof t === 'string' ? t : (t.tag || t.codigo || t);\n});\n\n// ğŸ”¥ V5.9: Processar tags do 6C\nconst tags_6c_raw = ctx.tags || ctx.tags_sucesso || [];\nconst tags_6c = tags_6c_raw.map(t => {\n  if (typeof t === 'object') {\n    let sev = t.severidade || t.nivel || 'INFO';\n    if (sev === 'CRIT') sev = 'CRITICO';\n    return { ...t, severidade: sev };\n  }\n  return typeof t === 'string' ? t : (t.tag || t.codigo || t);\n});\nconst alertas_6a = dados6A.alertas || [];\nconst alertas_6b = dados6B.alertas || [];\nconst alertas_6c = ctx.alertas || [];\n\nconst campos_deal_6C = ctx.campos_deal || dados6B.campos_deal || dados6A.campos_deal || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.1: CAMPOS_INVOICE_BASE DO 6C (TEM DIB, NIT, DCB DO PDF!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst campos_invoice_6C = ctx.campos_invoice_base || dados6B.campos_invoice_base || dados6A.campos_invoice_base || {};\n\nconst CAMPOS_DEAL_IDS = ctx.CAMPOS_DEAL_IDS || dados6B.CAMPOS_DEAL_IDS || dados6A.CAMPOS_DEAL_IDS || {};\nconst CAMPOS_INVOICE_IDS = ctx.CAMPOS_INVOICE_IDS || dados6B.CAMPOS_INVOICE_IDS || dados6A.CAMPOS_INVOICE_IDS || {};\nconst CAMPOS_EXTRAS = ctx.CAMPOS_EXTRAS || dados6B.CAMPOS_EXTRAS || dados6A.CAMPOS_EXTRAS || {};\n\nconst faturas_existentes_obj = ctx.faturas_existentes || dados6A.faturas_existentes || { todas: [] };\nconst faturas_existentes = faturas_existentes_obj.todas || [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO 1B (FONTE ÃšNICA E CONFIÃVEL PARA CPF/NB DO NEGÃ“CIO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cpfNegocio = dados1B.cpf || '';\nconst cpfNegocioFmt = dados1B.cpf_formatado || '';\nconst nbNegocio = dados1B.nb || '';\nconst nbNegocioFmt = dados1B.nb_formatado || '';\nconst nomeCliente = dados1B.nome || resumo.nome || '';\nconst dealId = dados1B.deal_id || resumo.deal_id || '';\n\n// â•â•â• HELPERS â•â•â•\nconst tr = (v) => Math.floor(v * 100) / 100;\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.8: NORMALIZADORES ROBUSTOS PARA CPF E NB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst soDigitos = (v) => {\n  if (v === null || v === undefined) return '';\n  return String(v).replace(/\\D/g, '').trim();\n};\n\nconst normalizarCPF = (cpf) => {\n  if (!cpf) return '';\n  // Remove TUDO que nÃ£o Ã© nÃºmero\n  const digits = String(cpf).replace(/\\D/g, '');\n  // CPF deve ter 11 dÃ­gitos - preenche zeros Ã  esquerda se necessÃ¡rio\n  if (digits.length === 0) return '';\n  if (digits.length <= 11) return digits.padStart(11, '0');\n  // Se tiver mais de 11, pega os Ãºltimos 11 (caso tenha prefixo estranho)\n  return digits.slice(-11);\n};\n\nconst normalizarNB = (nb) => {\n  if (!nb) return '';\n  // Remove TUDO que nÃ£o Ã© nÃºmero\n  const digits = String(nb).replace(/\\D/g, '');\n  if (digits.length === 0) return '';\n  // NB geralmente tem 10 dÃ­gitos, mas pode variar\n  return digits;\n};\nconst pv = (v) => {\n  if (v === null || v === undefined || v === '') return 0;\n  if (typeof v === 'number') return v;\n  const s = String(v).replace(/[^\\d,.\\-]/g, '').replace(',', '.');\n  return parseFloat(s) || 0;\n};\n\nconst formatarCPF = (cpf) => {\n  const d = soDigitos(cpf);\n  if (d.length !== 11) return cpf || '';\n  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;\n};\n\nconst formatarNB = (nb) => {\n  const d = soDigitos(nb);\n  if (d.length < 9) return nb || '';\n  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;\n};\n\nconst parseData = (data) => {\n  if (!data) return null;\n  const str = String(data).trim();\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    return new Date(str.split('T')[0]);\n  }\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(str)) {\n    const [d, m, y] = str.split('/');\n    return new Date(`${y}-${m}-${d}`);\n  }\n  return null;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DEFINIÃ‡ÃƒO DOS 7 CAMPOS CRÃTICOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CAMPOS_CRITICOS = {\n  nit: { id: CI.nit, nome: 'NIT', tag: 'A_CAMPO_NIT_VAZIO' },\n  dib: { id: CI.dib, nome: 'DIB', tag: 'A_CAMPO_DIB_VAZIO' },\n  dcb: { id: CI.dcb, nome: 'DCB', tag: 'A_CAMPO_DCB_VAZIO' },\n  dip: { id: CI.dip, nome: 'DIP', tag: 'A_CAMPO_DIP_VAZIO' },\n  competencia: { id: CI.competencia, nome: 'CompetÃªncia', tag: 'A_CAMPO_COMPETENCIA_VAZIO' },\n  data_atualizacao_extrato: { id: CI.data_atualizacao_extrato, nome: 'Data AtualizaÃ§Ã£o Extrato', tag: 'A_CAMPO_STATUS_VAZIO' },\n  endereco_banco: { id: CI.endereco_banco, nome: 'EndereÃ§o Banco', tag: 'A_CAMPO_BANCO_VAZIO' }\n};\n\n// â•â•â• ESTRUTURAS DE AUDITORIA â•â•â•\nconst problemas = [];\nconst alertas = [];\nconst tags = [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 0ï¸âƒ£ VALIDAÃ‡ÃƒO DE ERROS DOS NÃ“S ANTERIORES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (dados6A.ok === false || dados6A.erro) {\n  problemas.push({\n    codigo: 'ERRO_6A',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6A: ${dados6A.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar extraÃ§Ã£o do Extrato pelo Gemini'\n  });\n  tags.push('E_ERRO_6A');\n}\n\nif (dados6B.ok === false || dados6B.erro) {\n  problemas.push({\n    codigo: 'ERRO_6B',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6B: ${dados6B.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar cÃ¡lculo INSS no 6B'\n  });\n  tags.push('E_ERRO_6B');\n}\n\nif (dados6C.ok === false || dados6C.erro) {\n  problemas.push({\n    codigo: 'ERRO_6C',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6C: ${dados6C.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar distribuiÃ§Ã£o de parcelas no 6C'\n  });\n  tags.push('E_ERRO_6C');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1ï¸âƒ£ ğŸ”¥ V5.7: VALIDAÃ‡Ã•ES DE IDENTIFICAÃ‡ÃƒO - PDF vs DEAL SEPARADOS!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â• CPF DO PDF (extraÃ­do pelo Gemini) â•â•â•\nconst cpfPDF = normalizarCPF(\n  dadosGemini.identificacao?.cpf ||\n  dados6A.cliente?.cpf ||\n  resumo.cpf ||\n  campos_invoice_6C[CI.cpf] ||\n  ''\n);\nconst cpfPDFFmt = formatarCPF(cpfPDF);\n\n// â•â•â• CPF DO DEAL (cadastrado no Bitrix) â•â•â•\nconst cpfDeal = normalizarCPF(\n  dealData[CD.cpf] ||\n  dados1B.cpf ||\n  ''\n);\nconst cpfDealFmt = formatarCPF(cpfDeal);\n\n// â•â•â• VALIDAÃ‡ÃƒO 1: CPF existe no PDF? â•â•â•\nif (!cpfPDF) {\n  problemas.push({\n    codigo: 'CPF_PDF_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'CPF nÃ£o encontrado no Extrato PDF',\n    pode_retry: true,\n    acao: 'Verificar se o Gemini extraiu o CPF corretamente'\n  });\n  tags.push('E_CPF_PDF_AUSENTE');\n}\n\n// â•â•â• VALIDAÃ‡ÃƒO 2: CPF existe no Deal? â•â•â•\nif (!cpfDeal) {\n  problemas.push({\n    codigo: 'CPF_DEAL_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'CPF nÃ£o encontrado no Deal/NegÃ³cio',\n    pode_retry: false,\n    acao: 'Verificar se o Deal tem CPF cadastrado'\n  });\n  tags.push('E_CPF_DEAL_AUSENTE');\n}\n\n// â•â•â• ğŸ”¥ VALIDAÃ‡ÃƒO 3: PDF vs DEAL - O EXTRATO Ã‰ DO CLIENTE CERTO? â•â•â•\nif (cpfPDF && cpfDeal && cpfPDF !== cpfDeal) {\n  problemas.push({\n    codigo: 'CPF_PDF_DIFERENTE_DEAL',\n    gravidade: 'CRITICO',\n    mensagem: `âš ï¸ EXTRATO ERRADO! CPF do PDF (${cpfPDFFmt}) â‰  CPF do Deal (${cpfDealFmt})`,\n    pode_retry: false,\n    acao: 'O Extrato PDF NÃƒO pertence a este cliente! Verificar se enviou o arquivo correto.'\n  });\n  tags.push('E_CPF_PDF_DIFERENTE_DEAL');\n}\n\nif (cpfPDF && cpfDeal && cpfPDF === cpfDeal) {\n  tags.push('OK_CPF_PDF_IGUAL_DEAL');\n}\n\n// â•â•â• NB DO PDF (extraÃ­do pelo Gemini) â•â•â•\nconst nbPDF = normalizarNB(\n  dadosGemini.beneficio?.nb ||\n  dados6A.beneficio?.nb ||\n  dados6B.dados?.calendario_info?.nb ||\n  resumo.nb ||\n  campos_invoice_6C[CI.nb] ||\n  ''\n);\nconst nbPDFFmt = formatarNB(nbPDF);\n\n// â•â•â• NB DO DEAL (cadastrado no Bitrix) â•â•â•\nconst nbDeal = normalizarNB(\n  dealData[CD.nb] ||\n  dados1B.nb ||\n  ''\n);\nconst nbDealFmt = formatarNB(nbDeal);\n\n// â•â•â• VALIDAÃ‡ÃƒO 4: NB existe no PDF? â•â•â•\nif (!nbPDF) {\n  problemas.push({\n    codigo: 'NB_PDF_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'NÃºmero do BenefÃ­cio (NB) nÃ£o encontrado no Extrato PDF',\n    pode_retry: true,\n    acao: 'Verificar se o Gemini extraiu o NB corretamente'\n  });\n  tags.push('E_NB_PDF_AUSENTE');\n}\n\n// â•â•â• VALIDAÃ‡ÃƒO 5: NB existe no Deal? â•â•â•\nif (!nbDeal) {\n  alertas.push({\n    codigo: 'NB_DEAL_AUSENTE',\n    gravidade: 'ALERTA',\n    mensagem: 'NB nÃ£o encontrado no Deal (pode ser primeiro processamento)',\n  });\n  tags.push('A_NB_DEAL_AUSENTE');\n}\n\n// â•â•â• ğŸ”¥ VALIDAÃ‡ÃƒO 6: PDF vs DEAL - O BENEFÃCIO Ã‰ O CORRETO? â•â•â•\nif (nbPDF && nbDeal && nbPDF !== nbDeal) {\n  problemas.push({\n    codigo: 'NB_PDF_DIFERENTE_DEAL',\n    gravidade: 'CRITICO',\n    mensagem: `âš ï¸ BENEFÃCIO ERRADO! NB do PDF (${nbPDFFmt}) â‰  NB do Deal (${nbDealFmt})`,\n    pode_retry: false,\n    acao: 'O Extrato PDF Ã© de outro benefÃ­cio! Verificar se enviou o arquivo correto.'\n  });\n  tags.push('E_NB_PDF_DIFERENTE_DEAL');\n}\n\nif (nbPDF && nbDeal && nbPDF === nbDeal) {\n  tags.push('OK_NB_PDF_IGUAL_DEAL');\n}\n\n// â•â•â• CPF FINAL PARA USO (prioriza PDF, depois Deal) â•â•â•\nconst cpfFinal = cpfPDF || cpfDeal;\nconst cpfFinalFmt = formatarCPF(cpfFinal);\n\n// â•â•â• NB FINAL PARA USO (prioriza PDF, depois Deal) â•â•â•\nconst nbFinal = nbPDF || nbDeal;\nconst nbFinalFmt = formatarNB(nbFinal);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.3ï¸âƒ£ VALIDAÃ‡ÃƒO DE MR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst mr = pv(\n  dadosGemini.beneficio?.mr ||         // ğŸ”¥ V5.7: PDF primeiro!\n  dados6A.beneficio?.mr ||\n  dados6B.dados?.beneficio?.mr ||\n  resumo.mr || \n  campos_invoice_6C[CI.mr_cliente] ||\n  dealData[CD.mr_cliente] ||\n  0\n);\n\nif (!mr || mr <= 0) {\n  problemas.push({\n    codigo: 'MR_INVALIDO',\n    gravidade: 'CRITICO',\n    mensagem: `MÃ©dia de RemuneraÃ§Ã£o invÃ¡lida: ${mr}`,\n    pode_retry: true,\n    acao: 'Verificar extraÃ§Ã£o do MR no Gemini'\n  });\n  tags.push('E_MR_INVALIDO');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.5ï¸âƒ£ VALIDAÃ‡ÃƒO DE DATAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dib = \n  campos_invoice_6C[CI.dib] ||         // ğŸ”¥ Prioridade: 6C (vem do PDF)\n  dadosGemini.beneficio?.dib ||\n  dados6A.beneficio?.dib ||\n  dealData[CD.dib] ||\n  resumo.dib || \n  '';\n\nconst dcb = \n  campos_invoice_6C[CI.dcb] ||         // ğŸ”¥ Prioridade: 6C (vem do PDF)\n  dadosGemini.beneficio?.dcb ||\n  dados6A.beneficio?.dcb ||\n  dealData[CD.dcb] ||\n  resumo.dcb || \n  '';\n\nconst dibDate = parseData(dib);\nconst dcbDate = parseData(dcb);\n\nif (dib && !dibDate) {\n  problemas.push({\n    codigo: 'DIB_INVALIDA',\n    gravidade: 'GRAVE',\n    mensagem: `DIB com formato invÃ¡lido: ${dib}`,\n    pode_retry: true,\n    acao: 'Verificar formato da DIB no extrato'\n  });\n  tags.push('E_DIB_INVALIDA');\n}\n\nif (dcb && !dcbDate) {\n  problemas.push({\n    codigo: 'DCB_INVALIDA',\n    gravidade: 'GRAVE',\n    mensagem: `DCB com formato invÃ¡lido: ${dcb}`,\n    pode_retry: true,\n    acao: 'Verificar formato da DCB no extrato'\n  });\n  tags.push('E_DCB_INVALIDA');\n}\n\nif (dibDate && dcbDate && dcbDate < dibDate) {\n  problemas.push({\n    codigo: 'DATAS_INCONSISTENTES',\n    gravidade: 'CRITICO',\n    mensagem: `DCB (${dcb}) Ã© anterior Ã  DIB (${dib})`,\n    pode_retry: false,\n    acao: 'Datas do benefÃ­cio estÃ£o invertidas!'\n  });\n  tags.push('E_DATAS_INCONSISTENTES');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.6ï¸âƒ£ VALIDAÃ‡ÃƒO DE PARCELAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (parcelas.length === 0) {\n  problemas.push({\n    codigo: 'ZERO_PARCELAS',\n    gravidade: 'CRITICO',\n    mensagem: 'Nenhuma parcela foi gerada pelo cÃ¡lculo',\n    pode_retry: true,\n    acao: 'Verificar se o 6B/6C geraram parcelas corretamente'\n  });\n  tags.push('E_ZERO_PARCELAS');\n}\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.7ï¸âƒ£ ğŸ”¥ NOVO: DARF (Start paga) â€” validaÃ§Ã£o + tags + rateio informativo\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst normalizarTexto = (v) => (v ?? '').toString().trim().toLowerCase();\n\nconst necessitaDarfRaw =\n  dealData?.[CD.necessita_darf] ??\n  campos_invoice_6C?.[CI.necessita_darf] ??\n  '';\n\nconst valorDarfTotal = pv(\n  dealData?.[CD.valor_darf] ??\n  campos_invoice_6C?.[CI.valor_darf] ??\n  0\n);\n\n// CritÃ©rio â€œStart pagaâ€ (robusto: aceita variaÃ§Ãµes)\nconst startPagaDarf = (() => {\n  const t = normalizarTexto(necessitaDarfRaw);\n  if (t.includes('start') && (t.includes('pagar') || t.includes('irÃ¡') || t.includes('vai'))) return true;\n  if (t === normalizarTexto('Sim! Start irÃ¡ pagar!')) return true;\n  return false;\n})();\n\n// Parcelas que a Start recebe = parcelas com valor_start > 0\nconst parcelasStartRecebe = (parcelas || []).filter(p => pv(p.valor_start) > 0);\nconst qtdParcelasStartRecebe = parcelasStartRecebe.length;\n\n// Gera tags/alertas\nif (startPagaDarf) {\n  tags.push('OK_DARF_START_PAGA');\n\n  if (!valorDarfTotal || valorDarfTotal <= 0) {\n    alertas.push({\n      codigo: 'DARF_SEM_VALOR',\n      gravidade: 'ALERTA',\n      mensagem: `Deal marcado como \"Start paga DARF\", mas Valor DARF estÃ¡ vazio/zero.`,\n    });\n    tags.push('A_DARF_SEM_VALOR');\n  } else {\n    tags.push('OK_DARF_EXISTE');\n    tags.push(`OK_DARF_TOTAL_${tr(valorDarfTotal).toFixed(2).replace('.', ',')}`);\n\n    if (qtdParcelasStartRecebe <= 0) {\n      problemas.push({\n        codigo: 'DARF_SEM_PARCELAS_START',\n        gravidade: 'GRAVE',\n        mensagem: `Start paga DARF (R$ ${tr(valorDarfTotal).toFixed(2).replace('.', ',')}), mas nÃ£o hÃ¡ parcelas em que a Start recebe (valor_start > 0).`,\n        pode_retry: false,\n        acao: 'Verificar cÃ¡lculo do 6C: valor_start nas parcelas ou regra aplicada.'\n      });\n      tags.push('E_DARF_SEM_PARCELAS_START');\n    } else {\n      tags.push(`OK_DARF_PARCELAS_START_${qtdParcelasStartRecebe}`);\n\n      const valorDarfPorParcela = tr(valorDarfTotal / qtdParcelasStartRecebe);\n      tags.push(`INFO_DARF_POR_PARCELA_${valorDarfPorParcela.toFixed(2).replace('.', ',')}`);\n\n      // Se o 6C jÃ¡ tiver colocado â€œvalor_darf_extraâ€ na parcela, valida soma\n      const somaDarfNasParcelas = tr(parcelasStartRecebe.reduce((acc, p) => acc + pv(p.valor_darf_rateado), 0));\n      const diffDarf = Math.abs(somaDarfNasParcelas - tr(valorDarfTotal));\n\n      if (somaDarfNasParcelas > 0) {\n        if (diffDarf > 0.02) {\n          alertas.push({\n            codigo: 'DARF_RATEIO_DIVERGENTE',\n            gravidade: 'ALERTA',\n            mensagem: `Soma do rateio DARF nas parcelas (${somaDarfNasParcelas}) â‰  Valor DARF total (${tr(valorDarfTotal)})`,\n            valor_total: tr(valorDarfTotal),\n            soma_rateio: somaDarfNasParcelas,\n            diff: tr(diffDarf),\n          });\n          tags.push('A_DARF_RATEIO_DIVERGENTE');\n        } else {\n          tags.push('OK_DARF_RATEIO_BATE');\n        }\n      } else {\n        tags.push('INFO_DARF_SEM_RATEIO_NAS_PARCELAS');\n      }\n    }\n  }\n} else {\n  tags.push('OK_DARF_NAO_APLICA');\n}\n\n// Guardar no resumo final (para debug/Bitrix)\nconst darfResumo = {\n  start_paga_darf: startPagaDarf,\n  necessita_darf_raw: necessitaDarfRaw || null,\n  valor_darf_total: tr(valorDarfTotal),\n  qtd_parcelas_start_recebe: qtdParcelasStartRecebe,\n  valor_darf_por_parcela_aprox: (startPagaDarf && valorDarfTotal > 0 && qtdParcelasStartRecebe > 0)\n    ? tr(valorDarfTotal / qtdParcelasStartRecebe)\n    : 0\n};\n\n\n\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2ï¸âƒ£ VALIDAÃ‡Ã•ES MATEMÃTICAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst total_120_dias = pv(resumo.total_120_dias);\nconst honorarios_start = pv(resumo.honorarios_start);\n// v5.9: HonorÃ¡rios podem ser truncados (sem centavos), tolerÃ¢ncia aumentada para R$ 1,00\nconst honorarios_esperado = Math.floor(total_120_dias * 0.30);\nif (total_120_dias > 0) {\n  const diff_honorarios = Math.abs(honorarios_start - honorarios_esperado);\n  \n  if (diff_honorarios > 1.00) {\n    alertas.push({\n      codigo: 'HONORARIOS_DIVERGENTE',\n      gravidade: 'ALERTA',\n      mensagem: `HonorÃ¡rios (${honorarios_start}) â‰  30% (${honorarios_esperado})`,\n      valor_calculado: honorarios_start,\n      valor_esperado: honorarios_esperado\n    });\n    tags.push('A_HONORARIOS_DIVERGENTE');\n  } else {\n    tags.push('OK_HONORARIOS_30_PERCENT');\n  }\n}\n\nconst total_start = pv(resumo.total_start);\nconst total_cliente = pv(resumo.total_cliente);\nconst soma_parcelas = parcelas.reduce((acc, p) => acc + pv(p.valor_parcela), 0);\nconst soma_calculada = tr(total_start + total_cliente);\nconst soma_parcelas_tr = tr(soma_parcelas);\n\nif (parcelas.length > 0) {\n  const diff_soma = Math.abs(soma_calculada - soma_parcelas_tr);\n  \n  if (diff_soma > 0.02) {\n    problemas.push({\n      codigo: 'SOMA_NAO_BATE',\n      gravidade: 'GRAVE',\n      mensagem: `Start(${total_start}) + Cliente(${total_cliente}) = ${soma_calculada} â‰  Î£parcelas(${soma_parcelas_tr})`,\n      pode_retry: false\n    });\n    tags.push('E_SOMA_NAO_BATE');\n  } else {\n    tags.push('OK_SOMA_BATE');\n  }\n}\n\n// 2.3 FAIXAS\nconst getFaixaEsperada = (valor) => {\n  if (valor >= 2000) return { aliquota: 0.45, nome: 'FAIXA_45' };\n  if (valor >= 1500) return { aliquota: 0.40, nome: 'FAIXA_40' };\n  if (valor >= 700)  return { aliquota: 0.35, nome: 'FAIXA_35' };\n  return { aliquota: 0.30, nome: 'FAIXA_30' };\n};\n\nlet faixas_ok = true;\nfor (const p of parcelas) {\n  const valor = pv(p.valor_parcela);\n  const aliquota_aplicada = pv(p.aliquota_aplicada);\n  const regra = p.regra_aplicada;\n  \n  if (regra === 'QUITACAO' || regra === 'QUITADO' || aliquota_aplicada === null) continue;\n  \n  const esperada = getFaixaEsperada(valor);\n  \n  if (Math.abs(aliquota_aplicada - esperada.aliquota) > 0.001) {\n    problemas.push({\n      codigo: 'FAIXA_INCORRETA',\n      gravidade: 'GRAVE',\n      mensagem: `Parcela ${p.numero}: valor ${valor} deveria ter ${esperada.nome}`,\n      pode_retry: false\n    });\n    tags.push(`E_FAIXA_P${p.numero}`);\n    faixas_ok = false;\n  }\n}\n\nif (faixas_ok && parcelas.length > 0) tags.push('OK_FAIXAS_CORRETAS');\n\n// 2.4 QUITAÃ‡ÃƒO\nlet quitacao_ok = true;\n\nfor (let i = 0; i < parcelas.length; i++) {\n  const p = parcelas[i];\n  const regra = p.regra_aplicada;\n  const saldo_antes = pv(p.saldo_start_antes);\n  const valor_parcela = pv(p.valor_parcela);\n  const limite_quitacao = tr(valor_parcela * 0.50);\n  \n  if (regra !== 'QUITACAO' && regra !== 'QUITADO' && saldo_antes > 0 && saldo_antes <= limite_quitacao) {\n    alertas.push({\n      codigo: 'QUITACAO_POSSIVEL',\n      gravidade: 'ALERTA',\n      mensagem: `Parcela ${p.numero}: Saldo (${saldo_antes}) <= 50% (${limite_quitacao})`\n    });\n    tags.push(`A_QUITACAO_POSSIVEL_P${p.numero}`);\n  }\n  \n  if (regra === 'QUITACAO') {\n    const saldo_depois = pv(p.saldo_start_depois);\n    if (saldo_depois !== 0) {\n      problemas.push({\n        codigo: 'QUITACAO_SALDO_NAO_ZEROU',\n        gravidade: 'GRAVE',\n        mensagem: `Parcela ${p.numero}: QuitaÃ§Ã£o mas saldo nÃ£o zerou`,\n        pode_retry: false\n      });\n      tags.push(`E_QUITACAO_P${p.numero}`);\n      quitacao_ok = false;\n    }\n  }\n}\n\nif (quitacao_ok && parcelas.length > 0) tags.push('OK_QUITACAO_VERIFICADA');\n\n// 2.5 REGRA 50%\nlet regra_50_ok = true;\n\nfor (const p of parcelas) {\n  const valor_parcela = pv(p.valor_parcela);\n  const valor_cliente = pv(p.valor_cliente);\n  const minimo_cliente = tr(valor_parcela * 0.50);\n  \n  if (valor_cliente < minimo_cliente - 0.01) {\n    problemas.push({\n      codigo: 'REGRA_50_VIOLADA',\n      gravidade: 'CRITICO',\n      mensagem: `Parcela ${p.numero}: Cliente (${valor_cliente}) < 50% (${minimo_cliente})`,\n      pode_retry: false\n    });\n    tags.push(`E_REGRA50_P${p.numero}`);\n    regra_50_ok = false;\n  }\n}\n\nif (regra_50_ok && parcelas.length > 0) tags.push('OK_REGRA_50_TODAS');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3ï¸âƒ£ DUPLICIDADE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst parcelas_novas = [];\nconst parcelas_duplicadas = [];\n\nfor (const p of parcelas) {\n  \n  \n  const duplicada = faturas_existentes.some(f => {\n    return f.parcela === p.numero || f.data_pagamento === p.data_pagamento;\n  });\n  \n  if (duplicada) {\n    parcelas_duplicadas.push(p);\n  } else {\n    parcelas_novas.push(p);\n  }\n}\n\nif (parcelas_duplicadas.length > 0) {\n  problemas.push({\n    codigo: 'FATURA_DUPLICADA',\n    gravidade: 'CRITICO',\n    mensagem: `${parcelas_duplicadas.length} fatura(s) jÃ¡ existe(m)!`,\n    pode_retry: false,\n    acao: 'Verificar se este Extrato jÃ¡ foi processado'\n  });\n  tags.push('E_FATURA_DUPLICADA');\n}\n\nif (parcelas_novas.length === 0 && parcelas.some(p => pv(p.valor_start) > 0)) {\n  tags.push('E_TODAS_DUPLICADAS');\n}\n\nif (parcelas_novas.length > 0 && parcelas_duplicadas.length === 0) {\n  tags.push(`OK_PARCELAS_NOVAS_${parcelas_novas.length}`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4ï¸âƒ£ CONSOLIDAÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tem_critico = problemas.some(p => p.gravidade === 'CRITICO');\nconst tem_grave = problemas.some(p => p.gravidade === 'GRAVE');\nconst tem_alerta = alertas.length > 0;\n\nconst tentativa_atual = dados6A.tentativa || dados1B.tentativa || 1;\nconst max_tentativas = 2;\nconst problemas_reprocessaveis = problemas.filter(p => p.pode_retry === true);\nconst pode_reprocessar = problemas_reprocessaveis.length > 0 && \n                         problemas_reprocessaveis.length === problemas.length &&\n                         tentativa_atual < max_tentativas;\n\nconst ok = !tem_critico && !tem_grave;\n\nconst gravidade_maxima = tem_critico ? 'CRITICO' \n                       : tem_grave ? 'GRAVE' \n                       : tem_alerta ? 'ALERTA'\n                       : 'OK';\n\nconst faturas_criar = ok ? parcelas_novas.map(p => ({\n  parcela: p.numero,\n  data_pagamento: p.data_pagamento,\n  data_pagamento_formatada: p.data_pagamento_formatada,\n  valor_inss: pv(p.valor_parcela),\n  valor_start: pv(p.valor_start),\n  valor_cliente: pv(p.valor_cliente),\n  aliquota: p.aliquota_efetiva,\n  regra: p.regra_aplicada,\n  competencia: p.competencia || `Parcela ${p.numero}`,\n  origem: p.origem,\n  saldo_start_depois: pv(p.saldo_start_depois)\n})) : [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5ï¸âƒ£ ğŸ”¥ V5.1/V5.3: CONSTRUIR campos_invoice\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst competencia_credito = primeiroCredito.competencia || '';\nconst banco_credito = primeiroCredito.pagamento?.banco || dados6A.beneficio?.banco || '';\n\n// â•â•â• CAMPOS DO DEAL (para atualizar o Deal) â•â•â•\nconst campos_deal = {\n  ...campos_deal_6C,\n  [CAMPOS_EXTRAS.data_calculo_inv || 'UF_CRM_69442F14E544C']: new Date().toISOString().split('T')[0]\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.1/V5.3: CAMPOS DA INVOICE - USAR 6C COMO BASE + DEAL DO MERGE!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1ï¸âƒ£ COMEÃ‡AR COM campos_invoice_6C (tem DIB, NIT, DCB, banco, etc. do PDF!)\nconst campos_invoice = { ...campos_invoice_6C };\n\n// 2ï¸âƒ£ Helper para adicionar campo se nÃ£o existir\nconst adicionarSeFaltando = (idInvoice, valorDeal, valorFallback = '') => {\n  if (campos_invoice[idInvoice] && campos_invoice[idInvoice] !== '') {\n    return;\n  }\n  if (valorDeal && valorDeal !== '') {\n    campos_invoice[idInvoice] = valorDeal;\n    return;\n  }\n  if (valorFallback && valorFallback !== '') {\n    campos_invoice[idInvoice] = valorFallback;\n  }\n};\n\n// â•â•â• CAMPOS EXCLUSIVOS DO DEAL (nÃ£o vÃªm do PDF) â•â•â•\nadicionarSeFaltando(CI.dn_mamae, dealData[CD.dn_mamae]);\nadicionarSeFaltando(CI.dn_filho, dealData[CD.dn_filho]);\nadicionarSeFaltando(CI.dn_certidao, dealData[CD.dn_certidao]);\nadicionarSeFaltando(CI.data_dnv, dealData[CD.data_dnv]);\nadicionarSeFaltando(CI.data_requerimento, dealData[CD.data_requerimento]);\nadicionarSeFaltando(CI.data_concessao, dealData[CD.data_concessao]);\nadicionarSeFaltando(CI.nome_filho, dealData[CD.nome_filho]);\nadicionarSeFaltando(CI.categoria, dealData[CD.categoria]);\nadicionarSeFaltando(CI.rg, dealData[CD.rg]);\nadicionarSeFaltando(CI.telefone_2, dealData[CD.telefone_2]);\nadicionarSeFaltando(CI.telefone_3, dealData[CD.telefone_3]);\nadicionarSeFaltando(CI.senha, dealData[CD.senha]);\nadicionarSeFaltando(CI.ddd_cliente, dealData[CD.ddd_cliente]);\nadicionarSeFaltando(CI.ultimo_relacionador, dealData[CD.ultimo_relacionador]);\n\n// â•â•â• CAMPOS EXTRAS DA PLANILHA (v5.5) â•â•â•\nadicionarSeFaltando(CI.sugestao_senha, dealData[CD.sugestao_senha]);\nadicionarSeFaltando(CI.data_reclamacao, dealData[CD.data_reclamacao]);\nadicionarSeFaltando(CI.data_qualificacao, dealData[CD.data_qualificacao]);\nadicionarSeFaltando(CI.data_recuperacao, dealData[CD.data_recuperacao]);\nadicionarSeFaltando(CI.data_encerramento, dealData[CD.data_encerramento]);\nadicionarSeFaltando(CI.data_reentrada, dealData[CD.data_reentrada]);\nadicionarSeFaltando(CI.data_conversao, dealData[CD.data_conversao]);\nadicionarSeFaltando(CI.data_certidao, dealData[CD.data_certidao]);\nadicionarSeFaltando(CI.data_consulta, dealData[CD.data_consulta]);\nadicionarSeFaltando(CI.data_contato, dealData[CD.data_contato]);\nadicionarSeFaltando(CI.data_sem_direito, dealData[CD.data_sem_direito]);\nadicionarSeFaltando(CI.data_indeferimento, dealData[CD.data_indeferimento]);\nadicionarSeFaltando(CI.data_quebra_contrato, dealData[CD.data_quebra_contrato]);\nadicionarSeFaltando(CI.relacionador_quebra, dealData[CD.relacionador_quebra]);\nadicionarSeFaltando(CI.relacionador_sem_direito, dealData[CD.relacionador_sem_direito]);\nadicionarSeFaltando(CI.recurso, dealData[CD.recurso]);\nadicionarSeFaltando(CI.sine, dealData[CD.sine]);\nadicionarSeFaltando(CI.data_envio_recurso, dealData[CD.data_envio_recurso]);\nadicionarSeFaltando(CI.justificativa_direito, dealData[CD.justificativa_direito]);\nadicionarSeFaltando(CI.data_rodagem, dealData[CD.data_rodagem]);\nadicionarSeFaltando(CI.rodagem_comentario, dealData[CD.rodagem_comentario]);\nadicionarSeFaltando(CI.banco, dealData[CD.banco]);\nadicionarSeFaltando(CI.agencia_banco, dealData[CD.agencia_banco]);\n\n// ğŸ”¥ V5.6: ASSESSOR (mapeamento Deal â†’ Invoice)\nadicionarSeFaltando(CI.assessor, assessorDeal);\n\n// â•â•â• CAMPOS QUE PODEM VIR DO PDF OU DO DEAL â•â•â•\nadicionarSeFaltando(CI.cpf, null, cpfFinalFmt || cpfFinal);\nadicionarSeFaltando(CI.nb, null, nbFinalFmt || nbFinal);\nadicionarSeFaltando(CI.dib, dealData[CD.dib], dib);\nadicionarSeFaltando(CI.dip, dealData[CD.dip]);\nadicionarSeFaltando(CI.dcb, dealData[CD.dcb], dcb);\nadicionarSeFaltando(CI.nit, dealData[CD.nit], resumo.nit);\nadicionarSeFaltando(CI.mr_cliente, null, mr);\nadicionarSeFaltando(CI.valor_total_beneficio, dealData[CD.valor_total_beneficio], resumo.total_120_dias);\nadicionarSeFaltando(CI.aliquota_mr, dealData[CD.aliquota_mr]);\nadicionarSeFaltando(CI.qtd_parcelas, dealData[CD.qtd_parcelas], parcelas.length);\nadicionarSeFaltando(CI.endereco_banco, dealData[CD.endereco_banco], banco_credito);\n\n// â•â•â• CAMPOS ESPECÃFICOS DO EXTRATO â•â•â•\nadicionarSeFaltando(CI.competencia, null, competencia_credito);\nadicionarSeFaltando(CI.data_atualizacao_extrato, null, resumo.data_extrato || new Date().toISOString().split('T')[0]);\n\n// â•â•â• DARF (NOVO) â•â•â•\nadicionarSeFaltando(CI.necessita_darf, dealData[CD.necessita_darf]);\nadicionarSeFaltando(CI.valor_darf, dealData[CD.valor_darf]);\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// LIMPAR CAMPOS VAZIOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst campos_deal_limpo = {};\nfor (const [k, v] of Object.entries(campos_deal)) {\n  if (v !== null && v !== undefined && v !== '' && v !== 0) {\n    campos_deal_limpo[k] = v;\n  }\n}\n\nconst campos_invoice_limpo = {};\nfor (const [k, v] of Object.entries(campos_invoice)) {\n  if (v !== null && v !== undefined && v !== '' && v !== 0 && v !== 'null') {\n    campos_invoice_limpo[k] = v;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VALIDAÃ‡ÃƒO DOS 7 CAMPOS CRÃTICOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst campos_criticos_status = {};\nconst campos_vazios = [];\nconst campos_preenchidos = [];\n\nfor (const [chave, configCampo] of Object.entries(CAMPOS_CRITICOS)) {\n  const valor = campos_invoice_limpo[configCampo.id];\n  const preenchido = valor !== null && valor !== undefined && valor !== '';\n  \n  campos_criticos_status[chave] = {\n    id: configCampo.id,\n    nome: configCampo.nome,\n    valor: valor || null,\n    preenchido\n  };\n  \n  if (preenchido) {\n    campos_preenchidos.push(chave);\n  } else {\n    campos_vazios.push(chave);\n    tags.push(configCampo.tag);\n    \n    alertas.push({\n      codigo: `CAMPO_CRITICO_VAZIO_${chave.toUpperCase()}`,\n      gravidade: 'ALERTA',\n      mensagem: `Campo ${configCampo.nome} estÃ¡ vazio`,\n      campo: chave,\n      id_bitrix: configCampo.id\n    });\n  }\n}\n\nif (campos_vazios.length === 0) {\n  tags.push('OK_7_CAMPOS_CRITICOS_PREENCHIDOS');\n} else if (campos_vazios.length <= 2) {\n  tags.push(`A_${campos_vazios.length}_CAMPOS_CRITICOS_VAZIOS`);\n} else {\n  tags.push(`E_${campos_vazios.length}_CAMPOS_CRITICOS_VAZIOS`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6ï¸âƒ£ MENSAGEM BITRIX\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet mensagem_bitrix = '';\n\nif (gravidade_maxima === 'OK') {\n  mensagem_bitrix = `âœ… Auditoria OK | ${faturas_criar.length} fatura(s) | ${campos_preenchidos.length}/7 campos`;\n} else if (gravidade_maxima === 'ALERTA') {\n  mensagem_bitrix = `âš ï¸ Auditoria com ${alertas.length} alerta(s) | ${faturas_criar.length} fatura(s)`;\n} else {\n  // ğŸ”¥ V5.7: Mensagens mais claras para PDF divergente\n  const errosPDFDivergente = problemas.filter(p => \n    p.codigo === 'CPF_PDF_DIFERENTE_DEAL' || p.codigo === 'NB_PDF_DIFERENTE_DEAL'\n  );\n  \n  if (errosPDFDivergente.length > 0) {\n    mensagem_bitrix = `âŒ EXTRATO ERRADO! PDF nÃ£o pertence a este cliente. Verificar arquivo enviado.`;\n  } else {\n    mensagem_bitrix = `âŒ ${gravidade_maxima} | ${problemas.length} problema(s): ${problemas.map(p => p.codigo).join(', ')}`;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 7ï¸âƒ£ RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tags_final = [...new Set([...tags_6a, ...tags_6b, ...tags_6c, ...tags])];\n\nreturn {\n  _no: '6D',\n  _versao: '5.7',\n  _timestamp: new Date().toISOString(),\n  _tempo_ms: Date.now() - inicio,\n  \n  ok,\n  pode_reprocessar,\n  gravidade_maxima,\n  mensagem_bitrix,\n  tags: tags_final,\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ”¥ V5.6: CONTACT_ID E ASSESSOR NO OUTPUT!\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  contact_id: contactId,\n  assessor: assessorDeal,\n  \n  auditoria: {\n    total_problemas: problemas.length,\n    total_alertas: alertas.length,\n    problemas,\n    alertas,\n    \n    validacoes: {\n      cpf_ok: !problemas.some(p => p.codigo.includes('CPF')),\n      nb_ok: !problemas.some(p => p.codigo.includes('NB')),\n      mr_ok: !problemas.some(p => p.codigo === 'MR_INVALIDO'),\n      datas_ok: !problemas.some(p => p.codigo.includes('DATAS')),\n      parcelas_ok: !problemas.some(p => p.codigo === 'ZERO_PARCELAS'),\n      honorarios_ok: !alertas.some(a => a.codigo === 'HONORARIOS_DIVERGENTE'),\n      soma_ok: !problemas.some(p => p.codigo === 'SOMA_NAO_BATE'),\n      faixas_ok: !problemas.some(p => p.codigo === 'FAIXA_INCORRETA'),\n      quitacao_ok: !problemas.some(p => p.codigo.includes('QUITACAO')),\n      regra_50_ok: !problemas.some(p => p.codigo === 'REGRA_50_VIOLADA'),\n      duplicidade_ok: !problemas.some(p => p.codigo === 'FATURA_DUPLICADA'),\n      nos_anteriores_ok: !problemas.some(p => p.codigo.startsWith('ERRO_6')),\n      // ğŸ”¥ V5.7: Novas validaÃ§Ãµes\n      pdf_vs_deal_cpf_ok: !problemas.some(p => p.codigo === 'CPF_PDF_DIFERENTE_DEAL'),\n      pdf_vs_deal_nb_ok: !problemas.some(p => p.codigo === 'NB_PDF_DIFERENTE_DEAL'),\n            darf_ok: !problemas.some(p => p.codigo === 'DARF_SEM_PARCELAS_START'),\n\n    },\n    \n    campos_criticos: {\n      total: 7,\n      preenchidos: campos_preenchidos.length,\n      vazios: campos_vazios.length,\n      status: campos_criticos_status,\n      lista_vazios: campos_vazios,\n      lista_preenchidos: campos_preenchidos\n    },\n    \n    duplicidade: {\n      total_parcelas: parcelas.length,\n      parcelas_novas: parcelas_novas.length,\n      parcelas_duplicadas: parcelas_duplicadas.length,\n      parcelas_criar: faturas_criar.length\n    }\n  },\n  \n  resumo: {\n    nome: nomeCliente || resumo.nome || '',\n    // ğŸ”¥ V5.7: CPFs e NBs separados para debug\n    cpf: cpfFinal,\n    cpf_formatado: cpfFinalFmt,\n    cpf_pdf: cpfPDFFmt,\n    cpf_deal: cpfDealFmt,\n    cpf_match: cpfPDF === cpfDeal,\n    nb: nbFinal,\n    nb_formatado: nbFinalFmt,\n    nb_pdf: nbPDFFmt,\n    nb_deal: nbDealFmt,\n    nb_match: nbPDF === nbDeal,\n    mr: mr,\n    mr_formatado: resumo.mr_formatado || `R$ ${mr.toFixed(2).replace('.', ',')}`,\n    dib: dib,\n    dcb: dcb,\n    deal_id: dealId,\n    darf: darfResumo,\n    ...resumo\n  },\n  \n  dados: dados,\n  faturas_criar,\n  \n  faturas_duplicadas: parcelas_duplicadas.map(p => ({\n    parcela: p.numero,\n    data_pagamento: p.data_pagamento,\n    valor_start: pv(p.valor_start)\n  })),\n  \n  // â•â•â• CAMPOS PARA BITRIX â•â•â•\n  campos_deal: campos_deal_limpo,\n  campos_invoice: campos_invoice_limpo,\n  \n  // IDs de referÃªncia\n  CAMPOS_DEAL_IDS: CD,\n  CAMPOS_INVOICE_IDS: CI,\n  CAMPOS_EXTRAS,\n  \n  // ğŸ”¥ V5.7: Debug com informaÃ§Ãµes da validaÃ§Ã£o PDF vs Deal\n  _debug: {\n    versao: '5.7',\n    correcao_principal: 'ValidaÃ§Ã£o PDF vs Deal SEPARADA! CPF e NB do PDF comparados com Deal.',\n    problema_anterior: 'Estava comparando Deal vs 1B, nÃ£o PDF vs Deal',\n    \n    // ğŸ”¥ V5.7: ValidaÃ§Ã£o PDF vs Deal\n    validacao_pdf_vs_deal: {\n      cpf: {\n        pdf: cpfPDFFmt || 'NÃƒO ENCONTRADO',\n        deal: cpfDealFmt || 'NÃƒO ENCONTRADO',\n        match: cpfPDF && cpfDeal ? (cpfPDF === cpfDeal ? 'âœ… OK' : 'âŒ DIVERGENTE') : 'âš ï¸ INCOMPLETO',\n        fontes_pdf: [\n          dadosGemini.identificacao?.cpf ? 'Gemini.identificacao.cpf' : null,\n          dados6A.cliente?.cpf ? '6A.cliente.cpf' : null,\n          resumo.cpf ? 'resumo.cpf' : null,\n          campos_invoice_6C[CI.cpf] ? 'campos_invoice_6C' : null,\n        ].filter(Boolean),\n        fontes_deal: [\n          dealData[CD.cpf] ? 'dealData[CD.cpf]' : null,\n          dados1B.cpf ? '1B.cpf' : null,\n        ].filter(Boolean),\n      },\n      nb: {\n        pdf: nbPDFFmt || 'NÃƒO ENCONTRADO',\n        deal: nbDealFmt || 'NÃƒO ENCONTRADO',\n        match: nbPDF && nbDeal ? (nbPDF === nbDeal ? 'âœ… OK' : 'âŒ DIVERGENTE') : 'âš ï¸ INCOMPLETO',\n        fontes_pdf: [\n          dadosGemini.beneficio?.nb ? 'Gemini.beneficio.nb' : null,\n          dados6A.beneficio?.nb ? '6A.beneficio.nb' : null,\n          dados6B.dados?.calendario_info?.nb ? '6B.calendario_info.nb' : null,\n          resumo.nb ? 'resumo.nb' : null,\n          campos_invoice_6C[CI.nb] ? 'campos_invoice_6C' : null,\n        ].filter(Boolean),\n        fontes_deal: [\n          dealData[CD.nb] ? 'dealData[CD.nb]' : null,\n          dados1B.nb ? '1B.nb' : null,\n        ].filter(Boolean),\n      }\n    },\n    \n    // V5.6: Contact e Assessor\n    contact_id_fonte: contactId ? 'dealData.CONTACT_ID' : 'NÃƒO ENCONTRADO',\n    assessor_fonte: assessorDeal ? `dealData[${CD.assessor}]` : 'NÃƒO ENCONTRADO',\n    \n    fontes: {\n      mr: {\n        gemini: dadosGemini.beneficio?.mr || 'VAZIO',\n        dados6A: dados6A.beneficio?.mr || 'VAZIO',\n        dados6B: dados6B.dados?.beneficio?.mr || 'VAZIO',\n        resumo: resumo.mr || 'VAZIO',\n        dealData: dealData[CD.mr_cliente] || 'VAZIO',\n        usado: mr || 0\n      },\n      contact_id: {\n        dealData_CONTACT_ID: dealData.CONTACT_ID || 'VAZIO',\n        usado: contactId || 'NÃƒO ENCONTRADO'\n      },\n      assessor: {\n        dealData: dealData[CD.assessor] || 'VAZIO',\n        usado: assessorDeal || 'NÃƒO ENCONTRADO'\n      },\n      categoria: {\n        dealData: dealData[CD.categoria] || 'VAZIO',\n        usado: campos_invoice_limpo[CI.categoria] || 'NÃƒO PREENCHIDO'\n      }\n    },\n    \n    deal_data_encontrado: Object.keys(dealData).length > 0,\n    total_campos_deal_data: Object.keys(dealData).length,\n    deal_id_encontrado: dealData.ID || dealData.id || 'NÃƒO ENCONTRADO',\n    campos_6c_recebidos: Object.keys(campos_invoice_6C).length,\n    campos_invoice_final: Object.keys(campos_invoice_limpo).length,\n    \n    inputs_encontrados: {\n      '6C': !!dados6C.resumo,\n      '6B': !!dados6B.resumo,\n      '6A': !!dados6A.cliente,\n      'Gemini': !!dadosGemini.identificacao,\n      '1B': !!dados1B.deal_id,\n      'BUSCAR_DEAL (via array)': Object.keys(dealData).length > 0\n    }\n  },\n  \n  deal_id: dealId,\n  deal: deal,\n  tentativa: tentativa_atual,\n  max_tentativas\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    6624,
    26224
  ],
  "id": "0d29cd56-39ba-47d8-9976-eefa4e2fdac3",
  "name": "6D. Revisor de Calculos"
}