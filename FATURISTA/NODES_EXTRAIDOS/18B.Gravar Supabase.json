{
  "parameters": {
    "jsCode": "// ═══════════════════════════════════════════════════════════════════════════════\n// NÓ 18B - PREPARAR DADOS SUPABASE (V5 - MULTI-CAMINHO)\n// ═══════════════════════════════════════════════════════════════════════════════\n// Detecta se veio do fluxo de SUCESSO ou ERRO e monta dados adequadamente\n// ═══════════════════════════════════════════════════════════════════════════════\n\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\nconst parseDate = (d) => {\n  if (!d) return null;\n  if (d instanceof Date) return d.toISOString().split('T')[0];\n  if (typeof d === 'string' && d.includes('/')) {\n    const partes = d.split('/');\n    if (partes.length === 3) {\n      const [dia, mes, ano] = partes;\n      return `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`;\n    }\n  }\n  return d;\n};\n\nconst somenteNumeros = (v) => v ? String(v).replace(/\\D/g, '') : null;\n\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || null;\n  } catch (e) {\n    return null;\n  }\n};\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// 1. DETECTAR ORIGEM (SUCESSO vs ERRO)\n// ═══════════════════════════════════════════════════════════════════════════════\nconst dados21B = buscarNo('21b preparar msg erro');\nconst dados22 = buscarNo('22. Chat Erro');\nconst dados15 = buscarNo('15. Montar itens_criados');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados6A = buscarNo('6A. Calculo do Historico de credito (PDF)');\nconst dados6B = buscarNo('6B.Calculo do INSS');\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\nconst dadosBuscarDeal = buscarNo('BUSCAR DEAL');\nconst dados13A = buscarNo('13A. IF Pular');\n\n// Detectar qual caminho\nconst isErro21B = dados21B && (dados21B.MESSAGE || dados21B.erro || dados21B.tipo_erro);\nconst isErro22 = dados22 && (dados22.erro || dados22.message);\nconst isSucesso = dados15 && (dados15.itens_criados || dados15.total_criadas > 0);\nconst isPular = dados13A && dados13A.pular === true;\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// 2. DEFINIR STATUS E MENSAGEM\n// ═══════════════════════════════════════════════════════════════════════════════\nlet status = 'SUCESSO';\nlet ok = true;\nlet gravidade = null;\nlet tipoErro = null;\nlet mensagemErro = null;\nlet mensagemLog = '';\n\nif (isErro21B) {\n  status = 'ERRO';\n  ok = false;\n  gravidade = dados21B.GRAVIDADE || dados21B.gravidade || 'ALTA';\n  tipoErro = dados21B.TIPO_ERRO || dados21B.tipo_erro || 'ERRO_PROCESSAMENTO';\n  mensagemErro = dados21B.MESSAGE || dados21B.mensagem || 'Erro no processamento';\n  mensagemLog = `[ERRO] ${tipoErro}: ${mensagemErro}`;\n} else if (isErro22) {\n  status = 'ERRO';\n  ok = false;\n  gravidade = 'ALTA';\n  tipoErro = dados22.tipo_erro || 'ERRO_CHAT';\n  mensagemErro = dados22.message || dados22.erro || 'Erro capturado no chat';\n  mensagemLog = `[ERRO] ${mensagemErro}`;\n} else if (isPular) {\n  status = 'PULADO';\n  ok = true;\n  gravidade = null;\n  tipoErro = null;\n  mensagemErro = null;\n  mensagemLog = 'Execução pulada conforme regra';\n} else if (isSucesso) {\n  const totalCriadas = dados15.total_criadas || 0;\n  const totalErros = dados15.total_erros || 0;\n  \n  if (totalErros > 0 && totalCriadas === 0) {\n    status = 'ERRO';\n    ok = false;\n    tipoErro = 'ERRO_CRIACAO_FATURAS';\n    mensagemErro = `Todas as ${totalErros} fatura(s) falharam`;\n    mensagemLog = mensagemErro;\n  } else if (totalErros > 0) {\n    status = 'PARCIAL';\n    ok = true;\n    mensagemLog = `${totalCriadas} criada(s), ${totalErros} erro(s)`;\n  } else {\n    status = 'SUCESSO';\n    ok = true;\n    mensagemLog = `${totalCriadas} fatura(s) criada(s) com sucesso`;\n  }\n} else {\n  // Fallback - não identificou caminho claro\n  status = 'INDEFINIDO';\n  ok = false;\n  tipoErro = 'CAMINHO_NAO_IDENTIFICADO';\n  mensagemErro = 'Não foi possível identificar o resultado da execução';\n  mensagemLog = mensagemErro;\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// 3. EXTRAIR DADOS BÁSICOS (funciona em qualquer caminho)\n// ═══════════════════════════════════════════════════════════════════════════════\nconst dealData = dadosBuscarDeal || dados1B || {};\nconst dealId = dados15?.deal_id || dados21B?.deal_id || dados1B?.deal_id || dealData.deal_id || 0;\n\nconst execucaoId = dados1B?.execucao?.id || \n  dados21B?.execucao_id ||\n  `${dealId}_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;\n\nconst cpfRaw = dados15?.cpf || dados21B?.cpf || dados1B?.cpf || dealData.cpf || '';\nconst nbRaw = dados15?.nb || dados21B?.nb || dados1B?.nb || dealData.nb || '';\nconst nomeCliente = dados15?.nome_cliente || dados21B?.nome_cliente || dados1B?.nome || dealData.nome || 'Não identificado';\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// 4. EXTRAIR DADOS COMPLETOS (só se existirem - caminho sucesso)\n// ═══════════════════════════════════════════════════════════════════════════════\nconst resumo = dados15?.resumo || dados6D?.resumo || {};\nconst dadosBeneficio = dados6A?.dados || dados6D?.dados?.deal || {};\nconst darf = dados15?.darf || {};\nconst asaas = dados15?.asaas || dados9C || {};\n\n// Parcelas (só existe no sucesso)\nconst itensCriados = dados15?.itens_criados || [];\nconst parcelas = itensCriados.map((f, idx) => ({\n  parcela_numero: f.parcela || (idx + 1),\n  invoice_id: f.invoice_id || null,\n  competencia: f.competencia,\n  data_pagamento_inss: parseDate(f.data_inss),\n  valor_inss: tr(f.valor_inss),\n  valor_start: tr(f.valor_start),\n  valor_cliente: tr(f.valor_cliente),\n  regra_aplicada: f.regra,\n  saldo_depois: tr(f.saldo_restante_start)\n}));\n\n// Tags e alertas\nlet tags = dados15?.tags || dados21B?.tags || [];\nlet alertas = dados15?.alertas_lista || dados21B?.alertas || [];\n\n// Adicionar tag de erro se for erro\nif (!ok && tipoErro) {\n  tags = [...tags, `ERRO:${tipoErro}`];\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// 5. RETORNO COM DADOS PARA OS 2 NÓS SUPABASE\n// ═══════════════════════════════════════════════════════════════════════════════\nreturn {\n  // Passar dados originais (se existirem)\n  ...(dados15 || {}),\n  \n  // Flag para debug\n  _origem: isErro21B ? '21B_ERRO' : isErro22 ? '22_ERRO' : isPular ? '13A_PULAR' : isSucesso ? 'SUCESSO' : 'INDEFINIDO',\n  _versao_18B: 'V5',\n  \n  // Dados para o nó Supabase (faturista_execucoes)\n  supabase_execucao: {\n    execucao_id: execucaoId,\n    deal_id: dealId,\n    cpf: somenteNumeros(cpfRaw),\n    cpf_formatado: cpfRaw,\n    nome_cliente: nomeCliente,\n    contact_id: dados1B?.contact_id || null,\n    nb: somenteNumeros(nbRaw),\n    nb_formatado: nbRaw,\n    nit: dadosBeneficio.nit || dados1B?.nit || null,\n    especie: dadosBeneficio.especie || '80',\n    banco: dadosBeneficio.banco || null,\n    agencia: dadosBeneficio.agencia || null,\n    dib: parseDate(dadosBeneficio.dib || resumo.dib),\n    dcb: parseDate(dadosBeneficio.dcb || resumo.dcb),\n    dip: parseDate(dadosBeneficio.dip || resumo.dip),\n    data_extrato: parseDate(dados6A?.data_extrato || dados21B?.data_extrato),\n    mr: tr(resumo.mr || dados15?.mr),\n    desconto_inss: tr(resumo.desconto_inss || dados6B?.desconto_inss),\n    valor_liquido_mensal: tr(resumo.valor_liquido_mensal),\n    valor_total_beneficio: tr(resumo.total_120_dias),\n    aliquota_inss_efetiva: resumo.aliquota_inss || null,\n    honorarios_start: tr(resumo.honorarios_start || dados15?.honorarios_start),\n    saldo_inicial: tr(resumo.saldo_start_inicial),\n    saldo_final: tr(resumo.saldo_start_final || dados15?.saldo_final),\n    aliquota_start: resumo.aliquota_honorarios || null,\n    regra_aplicada: resumo.regra_aplicada || null,\n    tem_darf: darf.tem_darf || false,\n    valor_darf: tr(darf.valor_total),\n    qtd_parcelas_darf: darf.qtd_parcelas || null,\n    tem_boleto: asaas.tem_boleto || false,\n    asaas_customer_id: asaas.customer_id || null,\n    asaas_payment_id: asaas.payment_id || null,\n    asaas_boleto_url: asaas.boleto_url || null,\n    asaas_vencimento: parseDate(asaas.vencimento),\n    \n    // ═══ CAMPOS DE STATUS (CRÍTICOS!) ═══\n    status: status,\n    ok: ok,\n    gravidade: gravidade,\n    tipo_erro: tipoErro,\n    mensagem_erro: mensagemErro,\n    \n    // ═══ CONTADORES ═══\n    qtd_faturas_criadas: dados15?.total_criadas || 0,\n    qtd_faturas_erro: dados15?.total_erros || 0,\n    qtd_faturas_duplicadas: dados15?.total_puladas || 0,\n    ids_invoices: dados15?.ids_invoices || [],\n    \n    // ═══ METADADOS ═══\n    versao_workflow: dados1B?.versao || 'V1',\n    tentativa: dados1B?.tentativa || 1,\n    duracao_ms: dados1B?.duracao_ms || null,\n    file_id: dados1B?.file_id || dados21B?.file_id || null,\n    \n    // ═══ DADOS ESTRUTURADOS ═══\n    tags: tags,\n    alertas: alertas,\n    parcelas: parcelas.length > 0 ? parcelas : null,\n    campos_deal: dados15?.campos_deal || dados21B?.campos_deal || null,\n    campos_invoice: dados15?.campos_invoice || null,\n    resumo: Object.keys(resumo).length > 0 ? resumo : null,\n    \n    link_deal: `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`\n  },\n  \n  // Dados para o nó Supabase (execucoes_log)\n  supabase_log: {\n    workflow: 'faturista',\n    execucao_id: execucaoId,\n    deal_id: dealId,\n    cpf: somenteNumeros(cpfRaw),\n    nome_cliente: nomeCliente,\n    status: status,\n    ok: ok,\n    mensagem: mensagemLog,\n    duracao_ms: dados1B?.duracao_ms || null,\n    versao: dados1B?.versao || 'V1',\n    ano_mes: new Date().toISOString().slice(0, 7) // formato: 2026-01\n  }\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    10208,
    26272
  ],
  "id": "9e22b735-8df2-45ec-8dad-cb35ef640b46",
  "name": "18B.Gravar Supabase"
}