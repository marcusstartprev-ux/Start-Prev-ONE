{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 9 - PREPARAR FATURA (V25 - COMPLETO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Prepara faturas prontas para crm.item.add (Invoice entityTypeId=31)\n// ENTRADA: Output do 6D via $input.first().json\n// SAÃDA: Array de items com body completo para HTTP Request\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// CHANGELOG V25 (08/01/2026):\n// ğŸ”¥ NOVO: Copia TODOS os campos do campos_invoice do 6D automaticamente\n// ğŸ”¥ NOVO: Converte IDs de UF_CRM_ para ufCrm_ (formato crm.item.add)\n// âœ… MANTÃ‰M: Fallbacks para campos crÃ­ticos (resumo, dados, deal)\n// âœ… MANTÃ‰M: Debug detalhado de campos crÃ­ticos\n// âœ… MANTÃ‰M: Mapeamento CI completo (70+ campos)\n// âœ… MANTÃ‰M: Toda lÃ³gica de preparaÃ§Ã£o de faturas\n// âœ… MANTÃ‰M: Mapeamento banco Deal â†’ Invoice\n// \n// VANTAGEM V25:\n// - Qualquer campo novo no 6D vai automaticamente para a Invoice\n// - MAS mantÃ©m seguranÃ§a com fallbacks se campos_invoice estiver incompleto\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO BANCO DEAL â†’ INVOICE (enum IDs diferentes!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst BANCO_DEAL_TO_INVOICE = {\n  '7137': '25',   // 001 - BB\n  '7139': '27',   // 033 - Santander\n  '7141': '29',   // 104 - Caixa\n  '7143': '31',   // 237 - Bradesco\n  '7145': '33',   // 341 - ItaÃº\n  '7147': '35',   // 756 - Sicoob\n  '433': '33',    // ItaÃº (cÃ³digo antigo)\n  '4530': '29',   // Caixa\n  '4532': '25',   // BB\n  '4534': '27',   // Santander\n  '4544': '35',   // Sicredi/Sicoob\n  '4556': '35',   // Sicoob\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO OFICIAL COMPLETO - IDs DA INVOICE (entityTypeId = 31)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CI = {\n  // â”€â”€â”€ 1. IDENTIFICAÃ‡ÃƒO â”€â”€â”€\n  cpf: 'ufCrm_652439CFE551C',\n  rg: 'ufCrm_652439D00A9CF',\n  nit: 'ufCrm_6947602572F0A',\n  nb: 'ufCrm_6790DAD756E3C',\n  nome_filho: 'ufCrm_65BD5488EC8E9',\n  categoria: 'ufCrm_652439D03479D',\n  \n  // â”€â”€â”€ 2. BENEFÃCIO (Datas) â”€â”€â”€\n  dib: 'ufCrm_69442F085B2CD',\n  dip: 'ufCrm_683860072DEB8',\n  dcb: 'ufCrm_6838600845561',\n  dn_mamae: 'ufCrm_652439D0138A5',\n  dn_filho: 'ufCrm_652439D021438',\n  dn_certidao: 'ufCrm_66351141F40C7',\n  data_dnv: 'ufCrm_67E17F1C70EAF',\n  data_requerimento: 'ufCrm_652439D3530AB',\n  data_concessao: 'ufCrm_652439D157BA8',\n  \n  // â”€â”€â”€ 3. BENEFÃCIO (Valores) â”€â”€â”€\n  mr_cliente: 'ufCrm_652439D00A9CF',\n  mr_cliente_money: 'ufCrm_67D19072D84A8',\n  valor_diario: 'ufCrm_69442F466791E',\n  valor_liquido_mensal: 'ufCrm_69442F4D0909D',\n  valor_total_beneficio: 'ufCrm_69442F535C91B',\n  valor_total_beneficio_120d: 'ufCrm_69442F535C91B',\n  valor_total_beneficio_alt: 'ufCrm_67E1AD2AC8BEB',\n  valor_restante_inss: 'ufCrm_69442F3A581C2',\n  aliquota_mr: 'ufCrm_67E1B184633ED',\n  especie_beneficio: 'ufCrm_69442F6570BDB',\n  \n  // â”€â”€â”€ 4. HONORÃRIOS START â”€â”€â”€\n  valor_total_start: 'ufCrm_69442F217FB9D',\n  valor_total_start_30: 'ufCrm_69442F217FB9D',\n  saldo_restante_start: 'ufCrm_69442F27CCFB3',\n  aliquota_start: 'ufCrm_69442F596A782',\n  aliquota_start_aplicada: 'ufCrm_69442F596A782',\n  regra_aplicada: 'ufCrm_69442F5F762AD',\n  \n  // â”€â”€â”€ 5. FATURAMENTO (Parcela) â”€â”€â”€\n  valor_inss: 'ufCrm_652439D8D6B8E',\n  valor_cliente: 'ufCrm_652439D915311',\n  valor_previsto: 'ufCrm_652439D9202B3',\n  parcela_numero: 'ufCrm_652439D8CDB53',\n  parcela_atual: 'ufCrm_652439D8E9608',\n  parcela_formato: 'ufCrm_652439D8CDB53',\n  qtd_parcelas: 'ufCrm_67E1AD2860054',\n  quantidade_parcelas: 'ufCrm_67E1AD2860054',\n  valor_darf: 'ufCrm_6941BDC604550',\n  \n  // â”€â”€â”€ 6. EXTRATO / COMPETÃŠNCIA â”€â”€â”€\n  competencia: 'ufCrm_691B6450B46E3',\n  competencia_final: 'ufCrm_69442F0E9A95A',\n  compet_final: 'ufCrm_69442F0E9A95A',\n  compet_final_extrato: 'ufCrm_691B6474BE0F7',\n  periodo: 'ufCrm_691B64560A17F',\n  ultima_comp_valida: 'ufCrm_693D7DE5148DB',\n  ultima_competencia_valida: 'ufCrm_693D7DE5148DB',\n  credito_invalidado: 'ufCrm_691B6467F11F2',\n  dias_ja_recebidos: 'ufCrm_69442F2E321C4',\n  dias_restantes: 'ufCrm_69442F3449D22',\n  dias_restantes_cliente: 'ufCrm_69442F3449D22',\n  \n  // â”€â”€â”€ 7. DATAS OPERACIONAIS â”€â”€â”€\n  data_inss: 'ufCrm_652439D8B3207',\n  data_pagamento_extrato: 'ufCrm_691B64616C2C9',\n  data_atualizacao_extrato: 'ufCrm_691B646EC01BF',\n  status_extrato: 'ufCrm_691B646EC01BF',\n  \n  // â”€â”€â”€ 8. BANCO â”€â”€â”€\n  banco: 'ufCrm_652439D194A06',\n  endereco_banco: 'ufCrm_652439D1A53FA',\n  agencia_banco: 'ufCrm_691225FDDDBE4',\n  \n  // â”€â”€â”€ 9. CONTROLE / ANÃLISE â”€â”€â”€\n  justificativa_direito: 'ufCrm_693D7BBC3E5D3',\n  resultado_analise: 'ufCrm_693D7CB58EBD2',\n  data_rodagem: 'ufCrm_6929FDA3C8A79',\n  rodagem_comentario: 'ufCrm_6929FD9E9A95D',\n  direito_ate: 'ufCrm_679781AAB3B1D',\n  \n  // â”€â”€â”€ 10. GESTÃƒO â”€â”€â”€\n  ultimo_relacionador: 'ufCrm_65BD5488EC8E9',\n  ddd_cliente: 'ufCrm_65BD5489DF3A2',\n  data_reclamacao: 'ufCrm_65BD5489C89AD',\n  data_qualificacao: 'ufCrm_65E777E2A0CED',\n  data_recuperacao: 'ufCrm_662699414BCF0',\n  data_encerramento: 'ufCrm_6631460FD3BB4',\n  data_reentrada: 'ufCrm_678EADB02E460',\n  \n  // â”€â”€â”€ 11. CAMPOS EXTRAS â”€â”€â”€\n  data_conversao: 'ufCrm_652439D0CF19F',\n  data_calculo: 'ufCrm_69442F14E544C',\n  data_certidao: 'ufCrm_652439DA75EFF',\n  data_consulta: 'ufCrm_652439D14CF3D',\n  data_acordo: 'ufCrm_652439DB85203',\n  data_contato: 'ufCrm_652439D9B26DF',\n  data_sem_direito: 'ufCrm_66ACE094C0195',\n  data_pagamento: 'ufCrm_652439D8BD582',\n  data_indeferimento: 'ufCrm_652439D3E866C',\n  data_recebimento: 'ufCrm_652439D1B26E2',\n  desconto: 'ufCrm_6838600A5C767',\n  data_quebra_contrato: 'ufCrm_6793A405B3FC1',\n  relacionador_quebra: 'ufCrm_6793A4065BECA',\n  relacionador_sem_direito: 'ufCrm_6793A40701BCB',\n  recurso: 'ufCrm_68DD552A351D0',\n  senha: 'ufCrm_652439D16254A',\n  sugestao_senha: 'ufCrm_652439D23E905',\n  telefone_2: 'ufCrm_652439D28D353',\n  telefone_3: 'ufCrm_652439D298A88',\n  sine: 'ufCrm_6883D4B47136F',\n  data_envio_recurso: 'ufCrm_68DD552F3DD02',\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HELPERS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst tr = (v) => Math.floor(v * 100) / 100;\n\nconst pv = (v) => {\n  if (v === null || v === undefined || v === '') return 0;\n  if (typeof v === 'number') return v;\n  const s = String(v).replace(/[^\\d,.\\\\-]/g, '').replace(',', '.');\n  return parseFloat(s) || 0;\n};\n\nconst formatarData = (data) => {\n  if (!data) return null;\n  const str = String(data);\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    return str.includes('T') ? str : `${str}T03:00:00+03:00`;\n  }\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(str)) {\n    const [d, m, y] = str.split('/');\n    return `${y}-${m}-${d}T03:00:00+03:00`;\n  }\n  return str;\n};\n\nconst formatarMoney = (valor) => {\n  const num = typeof valor === 'number' ? valor : parseFloat(valor) || 0;\n  return `${num}|BRL`;\n};\n\nconst limparCamposVazios = (obj) => {\n  const limpo = {};\n  for (const [key, value] of Object.entries(obj)) {\n    if (value !== null && value !== undefined && value !== '' && value !== 'null') {\n      limpo[key] = value;\n    }\n  }\n  return limpo;\n};\n\nconst soDigitos = (v) => v ? String(v).replace(/\\D/g, '') : '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: CONVERTER IDs DE UF_CRM_ PARA ufCrm_ (formato crm.item.add)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst converterIdParaUfCrm = (id) => {\n  if (!id) return id;\n  const str = String(id);\n  if (str.startsWith('UF_CRM_')) {\n    return 'ufCrm_' + str.substring(7);\n  }\n  return str;\n};\n\nconst converterCamposInvoice = (campos) => {\n  const convertidos = {};\n  for (const [key, value] of Object.entries(campos)) {\n    const novaChave = converterIdParaUfCrm(key);\n    \n    // Formatar datas automaticamente (campos que contÃªm \"data\", \"dn_\", \"dib\", \"dcb\", \"dip\")\n    const keyLower = novaChave.toLowerCase();\n    if (keyLower.includes('data') || \n        keyLower.includes('dn_') ||\n        keyLower.includes('dib') ||\n        keyLower.includes('dcb') ||\n        keyLower.includes('dip')) {\n      convertidos[novaChave] = formatarData(value);\n    } else {\n      convertidos[novaChave] = value;\n    }\n  }\n  return convertidos;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: DADOS VÃŠM DO $input (OUTPUT DO 6D!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst ctx = $input.first().json || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: BUSCAR campos_invoice DO 6D E CONVERTER IDs\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst camposInvoiceOriginal = ctx.campos_invoice || {};\nconst camposInvoiceConvertidos = converterCamposInvoice(camposInvoiceOriginal);\n\n// Helper para buscar campo da Invoice (com fallback para diferentes formatos de ID)\nconst getCampoInvoice = (invoiceId) => {\n  // Tenta direto\n  let valor = camposInvoiceConvertidos[invoiceId];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  // Tenta com UF_CRM_ maiÃºsculo no original\n  const idMaiusculo = invoiceId.replace('ufCrm_', 'UF_CRM_');\n  valor = camposInvoiceOriginal[idMaiusculo];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  // Tenta com ufCrm_ no original\n  valor = camposInvoiceOriginal[invoiceId];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  return null;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DO CONTEXTO (OUTPUT DO 6D)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dealId = ctx.deal_id || 0;\nconst faturasCriar = ctx.faturas_criar || [];\nconst faturasDuplicadas = ctx.faturas_duplicadas || [];\nconst resumo = ctx.resumo || {};\nconst dados = ctx.dados || {};\nconst deal = ctx.deal || {};\nconst auditoria = ctx.auditoria || {};\nconst tags = ctx.tags || [];\nconst ok = ctx.ok;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 1 â€” ERRO CRÃTICO (6D retornou ok: false)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (ok === false) {\n  return [{\n    json: {\n      pular: true,\n      permitido_criar: false,\n      status: 'BLOQUEADO',\n      motivo: ctx.gravidade_maxima || 'ERRO_CALCULO',\n      deal_id: dealId,\n      mensagem: ctx.mensagem_bitrix || 'Erro no processamento do 6D',\n      problemas: auditoria.problemas || [],\n      _fonte_dados: '$input.first().json (6D)',\n      _versao: 'V25'\n    }\n  }];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 2 â€” SEM FATURAS PARA CRIAR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (faturasCriar.length === 0) {\n  return [{\n    json: {\n      pular: true,\n      permitido_criar: false,\n      status: 'SEM_FATURAS',\n      motivo: faturasDuplicadas.length > 0 ? 'TODAS_DUPLICADAS' : 'SALDO_ZERO_OU_QUITADO',\n      deal_id: dealId,\n      faturas_duplicadas: faturasDuplicadas.length,\n      saldo_final: resumo.saldo_start_final || 0,\n      _fonte_dados: '$input.first().json (6D)',\n      _versao: 'V25'\n    }\n  }];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS COMUNS - COM FALLBACKS PARA SEGURANÃ‡A\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Cliente\nconst nomeCliente = resumo.nome || dados.nome || deal.nome || 'Cliente';\nconst cpf = soDigitos(\n  getCampoInvoice(CI.cpf) || \n  resumo.cpf || \n  dados.cpf || \n  ''\n);\n\n// BenefÃ­cio - BUSCA COM FALLBACKS!\nconst nb = getCampoInvoice(CI.nb) || resumo.nb || dados.nb || '';\nconst nit = getCampoInvoice(CI.nit) || dados.nit || '';\nconst mr = pv(getCampoInvoice(CI.mr_cliente) || getCampoInvoice(CI.mr_cliente_money) || resumo.mr || dados.mr || 0);\n\n// Valores 120 dias - COM FALLBACKS!\nconst valorDiario = pv(getCampoInvoice(CI.valor_diario) || dados.valor_diario || 0);\nconst valorLiquidoMensal = pv(getCampoInvoice(CI.valor_liquido_mensal) || dados.valor_liquido_mensal || 0);\nconst valorTotalBeneficio = pv(getCampoInvoice(CI.valor_total_beneficio_120d) || resumo.total_120_dias || 0);\nconst valorTotalStart = pv(getCampoInvoice(CI.valor_total_start_30) || resumo.honorarios_start || 0);\nconst aliquotaMr = pv(getCampoInvoice(CI.aliquota_mr) || dados.aliquota_inss_efetiva || 0);\n\n// Datas do benefÃ­cio - COM FALLBACKS!\nconst dib = getCampoInvoice(CI.dib) || resumo.dib || dados.dib || '';\nconst dip = getCampoInvoice(CI.dip) || dados.dip || '';\nconst dcb = getCampoInvoice(CI.dcb) || resumo.dcb || dados.dcb || '';\nconst dataAtualizacaoExtrato = getCampoInvoice(CI.data_atualizacao_extrato) || getCampoInvoice(CI.status_extrato) || '';\n\n// Banco - COM FALLBACKS!\nconst bancoIdOriginal = getCampoInvoice(CI.banco) || null;\nconst bancoIdConvertido = BANCO_DEAL_TO_INVOICE[bancoIdOriginal] || bancoIdOriginal;\nconst enderecoBanco = getCampoInvoice(CI.endereco_banco) || dados.endereco_banco || '';\n\n// CompetÃªncias - COM FALLBACKS!\nconst competenciaInicial = getCampoInvoice(CI.competencia) || '';\nconst competFinalExtrato = getCampoInvoice(CI.compet_final) || getCampoInvoice(CI.compet_final_extrato) || '';\nconst periodo = getCampoInvoice(CI.periodo) || '';\nconst ultimaCompetenciaValida = getCampoInvoice(CI.ultima_competencia_valida) || '';\nconst diasRestantes = pv(getCampoInvoice(CI.dias_restantes_cliente) || 0);\n\n// EspÃ©cie\nconst especie = getCampoInvoice(CI.especie_beneficio) || '80';\n\n// AlÃ­quota e Regra\nconst aliquotaStartBase = getCampoInvoice(CI.aliquota_start_aplicada) || '';\nconst regraAplicadaBase = getCampoInvoice(CI.regra_aplicada) || '';\n\n// Dados pessoais do Deal (via campos_invoice do 6D) - COM FALLBACKS!\nconst dnMamae = getCampoInvoice(CI.dn_mamae) || '';\nconst dnFilho = getCampoInvoice(CI.dn_filho) || '';\nconst nomeFilho = getCampoInvoice(CI.nome_filho) || '';\nconst categoria = getCampoInvoice(CI.categoria) || '';\nconst rg = getCampoInvoice(CI.rg) || '';\nconst telefone2 = getCampoInvoice(CI.telefone_2) || '';\nconst telefone3 = getCampoInvoice(CI.telefone_3) || '';\nconst senha = getCampoInvoice(CI.senha) || '';\nconst dddCliente = getCampoInvoice(CI.ddd_cliente) || '';\nconst ultimoRelacionador = getCampoInvoice(CI.ultimo_relacionador) || '';\nconst dataConcessao = getCampoInvoice(CI.data_concessao) || '';\nconst dataRequerimento = getCampoInvoice(CI.data_requerimento) || '';\n\n// Total de parcelas\nconst totalParcelas = faturasCriar.length;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 3 â€” FATURAS VÃLIDAS: MONTAR BODY PARA CADA UMA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn faturasCriar.map((f, index) => {\n  \n  // â”€â”€â”€ DADOS DA PARCELA â”€â”€â”€\n  const parcela = f.parcela || index + 1;\n  const competencia = f.competencia_final || f.competencia || competenciaInicial || '';\n  const competenciaFinal = f.competencia_final || competencia;\n  const periodoFatura = f.periodo || periodo || '';\n  const dataInss = f.data_pagamento || f.data_inss || '';\n  \n  // â”€â”€â”€ VALORES DA PARCELA â”€â”€â”€\n  const valorInss = pv(f.valor_inss || f.valor_total_inss || 0);\n  const valorStart = pv(f.valor_start || 0);\n  const valorCliente = pv(f.valor_cliente || 0);\n  const saldoDepois = pv(f.saldo_start_depois || f.saldo_depois || 0);\n  \n  // â”€â”€â”€ ALÃQUOTA E REGRA â”€â”€â”€\n  const aliquotaStart = f.aliquota || f.aliquota_texto || aliquotaStartBase || '';\n  const regra = f.regra || regraAplicadaBase || '';\n  \n  // â”€â”€â”€ RESPONSÃVEL â”€â”€â”€\n  const responsavelId = f.responsavel_id || 178122;\n  \n  // â”€â”€â”€ TÃTULO â”€â”€â”€\n  const titulo = `SM ${nomeCliente} - Parcela ${parcela}/${totalParcelas} - ${competencia}`;\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ”¥ V25: MONTAR FIELDS - SPREAD AUTOMÃTICO + SOBRESCRITAS\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // 1. COPIA TUDO do campos_invoice convertido (79 campos do 6D!)\n  // 2. SOBRESCREVE campos especÃ­ficos da parcela\n  // 3. ADICIONA campos calculados com fallbacks\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  const fields = {\n    // â•â•â• 1. COPIAR TUDO DO 6D (79 campos automaticamente!) â•â•â•\n    ...camposInvoiceConvertidos,\n    \n    // â•â•â• 2. CAMPOS DO SISTEMA (obrigatÃ³rios) â•â•â•\n    title: titulo,\n    stageId: 'DT31_40:NEW',\n    categoryId: 2,\n    assignedById: responsavelId,\n    parentId2: dealId,\n    \n    // â•â•â• 3. IDENTIFICAÃ‡ÃƒO (com fallbacks) â•â•â•\n    [CI.cpf]: cpf,\n    [CI.nb]: nb,\n    [CI.nit]: nit,\n    [CI.mr_cliente]: String(mr),\n    [CI.mr_cliente_money]: formatarMoney(mr),\n    [CI.rg]: rg,\n    [CI.categoria]: categoria,\n    [CI.nome_filho]: nomeFilho,\n    \n    // â•â•â• 4. DADOS PESSOAIS (com fallbacks) â•â•â•\n    [CI.dn_mamae]: formatarData(dnMamae),\n    [CI.dn_filho]: formatarData(dnFilho),\n    [CI.telefone_2]: telefone2,\n    [CI.telefone_3]: telefone3,\n    [CI.senha]: senha,\n    [CI.ddd_cliente]: dddCliente,\n    [CI.ultimo_relacionador]: ultimoRelacionador,\n    \n    // â•â•â• 5. VALORES 120 DIAS (com fallbacks) â•â•â•\n    [CI.valor_total_beneficio_120d]: tr(valorTotalBeneficio),\n    [CI.valor_diario]: tr(valorDiario),\n    [CI.valor_total_start_30]: tr(valorTotalStart),\n    [CI.valor_liquido_mensal]: tr(valorLiquidoMensal),\n    [CI.valor_total_beneficio]: tr(valorTotalBeneficio),\n    [CI.valor_total_beneficio_alt]: tr(valorTotalBeneficio),\n    \n    // â•â•â• 6. PARCELA (especÃ­fico por fatura - SOBRESCREVE) â•â•â•\n    [CI.parcela_numero]: `${parcela}/${totalParcelas}`,\n    [CI.parcela_atual]: String(parcela),\n    [CI.quantidade_parcelas]: String(totalParcelas),\n    [CI.valor_inss]: String(tr(valorInss)),\n    [CI.valor_cliente]: String(tr(valorCliente)),\n    [CI.valor_previsto]: String(tr(valorStart)),\n    [CI.valor_restante_inss]: tr(saldoDepois),\n    \n    // â•â•â• 7. ALÃQUOTAS E REGRAS (podem variar por parcela) â•â•â•\n    [CI.aliquota_mr]: tr(aliquotaMr * 100),\n    [CI.aliquota_start_aplicada]: aliquotaStart,\n    [CI.regra_aplicada]: regra,\n    [CI.saldo_restante_start]: tr(saldoDepois),\n    \n    // â•â•â• 8. COMPETÃŠNCIAS (variam por parcela - SOBRESCREVE) â•â•â•\n    [CI.competencia]: competencia,\n    [CI.periodo]: periodoFatura,\n    [CI.compet_final]: competenciaFinal,\n    [CI.compet_final_extrato]: competFinalExtrato,\n    [CI.ultima_competencia_valida]: ultimaCompetenciaValida,\n    [CI.dias_restantes_cliente]: String(diasRestantes),\n    \n    // â•â•â• 9. DATAS (com formataÃ§Ã£o) â•â•â•\n    [CI.data_inss]: formatarData(dataInss),\n    [CI.dib]: formatarData(dib),\n    [CI.dcb]: formatarData(dcb),\n    [CI.dip]: formatarData(dip),\n    [CI.data_concessao]: formatarData(dataConcessao),\n    [CI.data_requerimento]: formatarData(dataRequerimento),\n    [CI.data_atualizacao_extrato]: formatarData(dataAtualizacaoExtrato),\n    \n    // â•â•â• 10. BANCO (ID convertido) â•â•â•\n    [CI.banco]: bancoIdConvertido,\n    [CI.endereco_banco]: enderecoBanco,\n    \n    // â•â•â• 11. ESPÃ‰CIE â•â•â•\n    [CI.especie_beneficio]: especie,\n    \n    // â•â•â• 12. DARF â•â•â•\n    [CI.valor_darf]: 0,\n  };\n  \n  // â”€â”€â”€ LIMPAR CAMPOS VAZIOS â”€â”€â”€\n  const fieldsLimpos = limparCamposVazios(fields);\n  \n  // â”€â”€â”€ DEBUG DETALHADO DOS CAMPOS CRÃTICOS â”€â”€â”€\n  const debugCamposCriticos = {\n    cpf: { valor: cpf, fonte: cpf ? 'campos_invoice/fallback' : 'VAZIO' },\n    nit: { valor: nit, fonte: nit ? 'campos_invoice/fallback' : 'VAZIO' },\n    nb: { valor: nb, fonte: nb ? 'campos_invoice/fallback' : 'VAZIO' },\n    dib: { valor: dib, fonte: dib ? 'campos_invoice/fallback' : 'VAZIO' },\n    dcb: { valor: dcb, fonte: dcb ? 'campos_invoice/fallback' : 'VAZIO' },\n    dip: { valor: dip, fonte: dip ? 'campos_invoice/fallback' : 'VAZIO' },\n    mr: { valor: mr, fonte: mr ? 'campos_invoice/fallback' : 'VAZIO' },\n    endereco_banco: { valor: enderecoBanco, fonte: enderecoBanco ? 'campos_invoice/fallback' : 'VAZIO' },\n    banco_id: { original: bancoIdOriginal, convertido: bancoIdConvertido },\n    dn_mamae: { valor: dnMamae, fonte: dnMamae ? 'campos_invoice' : 'VAZIO' },\n    dn_filho: { valor: dnFilho, fonte: dnFilho ? 'campos_invoice' : 'VAZIO' },\n    categoria: { valor: categoria, fonte: categoria ? 'campos_invoice' : 'VAZIO' },\n    senha: { valor: senha ? '***' : 'VAZIO', fonte: senha ? 'campos_invoice' : 'VAZIO' },\n    rg: { valor: rg, fonte: rg ? 'campos_invoice' : 'VAZIO' },\n    telefone_2: { valor: telefone2, fonte: telefone2 ? 'campos_invoice' : 'VAZIO' },\n    telefone_3: { valor: telefone3, fonte: telefone3 ? 'campos_invoice' : 'VAZIO' },\n    ddd_cliente: { valor: dddCliente, fonte: dddCliente ? 'campos_invoice' : 'VAZIO' },\n    ultimo_relacionador: { valor: ultimoRelacionador, fonte: ultimoRelacionador ? 'campos_invoice' : 'VAZIO' },\n  };\n  \n  // â”€â”€â”€ DEBUG GERAL â”€â”€â”€\n  const debugGeral = {\n    parcela: parcela,\n    total_parcelas: totalParcelas,\n    competencia: competencia,\n    valor_inss: valorInss,\n    valor_start: valorStart,\n    valor_cliente: valorCliente,\n    aliquota_start: aliquotaStart,\n    regra: regra,\n    saldo_depois: saldoDepois,\n    \n    // EstatÃ­sticas de campos\n    campos_6d_original: Object.keys(camposInvoiceOriginal).length,\n    campos_6d_convertidos: Object.keys(camposInvoiceConvertidos).length,\n    campos_finais: Object.keys(fieldsLimpos).length,\n    \n    // Exemplo de conversÃ£o\n    conversao_exemplo: {\n      original: 'UF_CRM_652439CFE551C',\n      convertido: 'ufCrm_652439CFE551C'\n    },\n    \n    fonte_dados: '$input.first().json (6D) + spread automÃ¡tico + fallbacks',\n    campos_criticos: debugCamposCriticos\n  };\n  \n  // â”€â”€â”€ RETORNAR ITEM â”€â”€â”€\n  return {\n    json: {\n      body: {\n        entityTypeId: 31,\n        fields: fieldsLimpos\n      },\n      \n      anti_dup: {\n        deal_id: dealId,\n        parcela: parcela,\n        competencia: competencia,\n        data_inss: dataInss,\n        titulo: titulo\n      },\n      \n      pular: false,\n      permitido_criar: true,\n      status: 'CRIAR_FATURA',\n      \n      debug: debugGeral,\n      resumo: resumo,\n      auditoria: auditoria,\n      tags: tags,\n      \n      _versao: 'V25'\n    }\n  };\n});"
  },
  "id": "c775b9a1-d646-4f58-9460-caf398f3aed1",
  "name": "9. Preparar Fatura",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    7744,
    26128
  ]
}