{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 21B â€” PREPARAR MENSAGEM DE ERRO (V2.0)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MELHORIAS V2:\n// âœ… Busca detalhes de erro de TODOS os nÃ³s (6A, 6B, 6C, 6D)\n// âœ… Mostra valores especÃ­ficos que causaram o erro\n// âœ… Compara valores lado a lado (extrato vs negÃ³cio)\n// âœ… Mensagens mais claras e acionÃ¡veis\n// âœ… Debug detalhado para investigaÃ§Ã£o\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DE TODOS OS NÃ“S ANTERIORES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1B - ConfiguraÃ§Ã£o inicial\nconst dados1B = (() => {\n  try { return $('1B. Inicializar').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6A - ExtraÃ§Ã£o Gemini\nconst dados6A = (() => {\n  try { return $('6A. Gemini ExtraÃ§Ã£o').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6B - CÃ¡lculo INSS\nconst dados6B = (() => {\n  try { return $('6B. CÃ¡lculo INSS').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6C - DistribuiÃ§Ã£o Parcelas\nconst dados6C = (() => {\n  try { return $('6C. Distribuir Parcelas').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6D - ValidaÃ§Ã£o (input atual)\nconst dados6D = $json || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR INFORMAÃ‡Ã•ES DO ERRO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Identificar qual nÃ³ gerou o erro\nconst identificarFonteErro = () => {\n  // Ordem de prioridade: 6A â†’ 6B â†’ 6C â†’ 6D\n  if (dados6A.ok === false || dados6A.erro) return { no: '6A', dados: dados6A };\n  if (dados6B.ok === false || dados6B.erro) return { no: '6B', dados: dados6B };\n  if (dados6C.ok === false || dados6C.erro) return { no: '6C', dados: dados6C };\n  if (dados6D.ok === false || dados6D.erro) return { no: '6D', dados: dados6D };\n  return { no: '6D', dados: dados6D };\n};\n\nconst fonteErro = identificarFonteErro();\nconst dadosErro = fonteErro.dados;\nconst noErro = fonteErro.no;\n\n// Extrair detalhes do erro\nconst erro = dadosErro.erro || {};\nconst erroTag = erro.tag || erro.codigo || '';\nconst erroMensagem = erro.mensagem || erro.msg || '';\nconst erroDetalhes = erro.detalhes || {};\n\n// Tags e resumo do 6D\nconst tags = dados6D.tags || [];\nconst resumo = dados6D.resumo || dadosErro.resumo || {};\nconst auditoria = dados6D.auditoria || {};\nconst problemas = auditoria.problemas || [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO NEGÃ“CIO E CLIENTE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config1B = dados1B.config || {};\nconst links1B = dados1B.links || {};\n\n// Dados do NegÃ³cio\nconst dealId = dados1B.deal_id || resumo.deal_id || dadosErro.deal_id || '';\nconst nomeCliente = dados1B.nome || resumo.nome || resumo.nome_cliente || 'Cliente';\nconst cpfNegocio = dados1B.cpf_formatado || dados1B.cpf || resumo.cpf_negocio || '';\nconst nbNegocio = dados1B.nb_formatado || dados1B.nb || resumo.nb_negocio || '';\n\n// Dados do Extrato (extraÃ­dos)\nconst cpfExtrato = resumo.cpf_extrato || resumo.cpf || dadosErro.cliente?.cpf || erroDetalhes.cpf_extrato || '';\nconst nbExtrato = resumo.nb_extrato || resumo.nb || dadosErro.beneficio?.nb || erroDetalhes.nb_extrato || '';\n\n// Chat e Links\nconst chatErro = config1B.chat_erro || 'chat282150';\nconst linkNegocio = links1B.deal || `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE TAGS â†’ MENSAGENS DETALHADAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst MENSAGENS_TAG = {\n  // â•â•â• ERROS CRÃTICOS - CPF â•â•â•\n  'E_CPF_EXTRATO_AUSENTE': {\n    icone: 'âŒ',\n    titulo: 'CPF NÃƒO ENCONTRADO NO EXTRATO',\n    getMensagem: (ctx) => `O Gemini nÃ£o conseguiu extrair o CPF do PDF.`,\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel. Se estiver ilegÃ­vel, solicitar novo extrato Ã  cliente.'\n  },\n  'E_CPF_DIVERGENTE': {\n    icone: 'âŒ',\n    titulo: 'CPF DO EXTRATO â‰  CPF DO NEGÃ“CIO',\n    getMensagem: (ctx) => `CPF Extrato: ${ctx.cpfExtrato || 'nÃ£o encontrado'}\\nCPF NegÃ³cio: ${ctx.cpfNegocio || 'nÃ£o cadastrado'}\\n\\nOs CPFs nÃ£o conferem!`,\n    getAcao: () => 'Este extrato pode ser de outra pessoa. Verificar se a cliente enviou o documento correto.'\n  },\n  'ERRO_CPF': {\n    icone: 'âŒ',\n    titulo: 'ERRO DE CPF',\n    getMensagem: (ctx) => `CPF Extrato: ${ctx.cpfExtrato || 'nÃ£o encontrado'}\\nCPF NegÃ³cio: ${ctx.cpfNegocio || 'nÃ£o cadastrado'}`,\n    getAcao: () => 'Verificar se o CPF estÃ¡ correto no negÃ³cio e no extrato.'\n  },\n\n  // â•â•â• ERROS CRÃTICOS - NB â•â•â•\n  'E_NB_AUSENTE': {\n    icone: 'âŒ',\n    titulo: 'NB NÃƒO ENCONTRADO NO EXTRATO',\n    getMensagem: (ctx) => `O NÃºmero do BenefÃ­cio nÃ£o foi encontrado no PDF.`,\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel e contÃ©m o NB.'\n  },\n  'E_NB_DIVERGENTE': {\n    icone: 'âŒ',\n    titulo: 'NB DO EXTRATO â‰  NB DO NEGÃ“CIO',\n    getMensagem: (ctx) => `NB Extrato: ${ctx.nbExtrato || 'nÃ£o encontrado'}\\nNB NegÃ³cio: ${ctx.nbNegocio || 'nÃ£o cadastrado'}\\n\\nOs NBs nÃ£o conferem!`,\n    getAcao: () => 'Este extrato Ã© de OUTRO benefÃ­cio! Verificar se a cliente tem mais de um benefÃ­cio ou enviou documento errado.'\n  },\n  'ERRO_NB': {\n    icone: 'âŒ',\n    titulo: 'ERRO NO NÃšMERO DO BENEFÃCIO',\n    getMensagem: (ctx) => `NB Extrato: ${ctx.nbExtrato || 'nÃ£o encontrado'}\\nNB NegÃ³cio: ${ctx.nbNegocio || 'nÃ£o cadastrado'}`,\n    getAcao: () => 'Verificar se o NB estÃ¡ correto.'\n  },\n\n  // â•â•â• ERROS CRÃTICOS - MR â•â•â•\n  'E_MR_INVALIDO': {\n    icone: 'âŒ',\n    titulo: 'MR INVÃLIDO OU ZERADO',\n    getMensagem: (ctx) => {\n      const mr = ctx.erroDetalhes?.mr_recebido || ctx.resumo?.mr || 'nÃ£o encontrado';\n      return `MÃ©dia de RemuneraÃ§Ã£o extraÃ­da: ${mr}\\n\\nValor invÃ¡lido para cÃ¡lculo.`;\n    },\n    getAcao: () => 'Verificar se o Gemini extraiu corretamente. O MR deve estar no extrato HISCREDI.'\n  },\n  'ERRO_MR': {\n    icone: 'âŒ',\n    titulo: 'ERRO NA MÃ‰DIA DE REMUNERAÃ‡ÃƒO',\n    getMensagem: (ctx) => {\n      const mr = ctx.erroDetalhes?.mr_recebido || 'nÃ£o encontrado';\n      return `MR recebido: ${mr}`;\n    },\n    getAcao: () => 'Verificar extraÃ§Ã£o do MR no extrato.'\n  },\n\n  // â•â•â• ERROS DE DATAS â•â•â•\n  'E_DATAS_INCONSISTENTES': {\n    icone: 'âŒ',\n    titulo: 'DATAS INVERTIDAS',\n    getMensagem: (ctx) => {\n      const dib = ctx.resumo?.dib || ctx.erroDetalhes?.dib || '?';\n      const dcb = ctx.resumo?.dcb || ctx.erroDetalhes?.dcb || '?';\n      return `DIB (inÃ­cio): ${dib}\\nDCB (fim): ${dcb}\\n\\nA DCB nÃ£o pode ser anterior Ã  DIB!`;\n    },\n    getAcao: () => 'Datas extraÃ­das incorretamente. Verificar extrato manualmente.'\n  },\n  'E_DIB_INVALIDA': {\n    icone: 'ğŸ”´',\n    titulo: 'DIB COM FORMATO INVÃLIDO',\n    getMensagem: (ctx) => `DIB extraÃ­da: ${ctx.erroDetalhes?.dib || 'formato invÃ¡lido'}`,\n    getAcao: () => 'Verificar se a DIB estÃ¡ legÃ­vel no PDF.'\n  },\n  'E_DCB_INVALIDA': {\n    icone: 'ğŸ”´',\n    titulo: 'DCB COM FORMATO INVÃLIDO',\n    getMensagem: (ctx) => `DCB extraÃ­da: ${ctx.erroDetalhes?.dcb || 'formato invÃ¡lido'}`,\n    getAcao: () => 'Verificar se a DCB estÃ¡ legÃ­vel no PDF.'\n  },\n\n  // â•â•â• ERROS DE PARCELAS â•â•â•\n  'E_ZERO_PARCELAS': {\n    icone: 'âŒ',\n    titulo: 'NENHUMA PARCELA GERADA',\n    getMensagem: (ctx) => `O cÃ¡lculo nÃ£o gerou nenhuma parcela.\\n\\nPossÃ­veis causas:\\n- BenefÃ­cio jÃ¡ quitado\\n- Datas inconsistentes\\n- Erro no cÃ¡lculo`,\n    getAcao: () => 'Verificar se o benefÃ­cio ainda tem parcelas pendentes.'\n  },\n  'E_FATURA_DUPLICADA': {\n    icone: 'âŒ',\n    titulo: 'FATURA JÃ EXISTE',\n    getMensagem: (ctx) => {\n      const comp = ctx.erroDetalhes?.competencia || '';\n      return comp ? `JÃ¡ existe fatura para competÃªncia ${comp}.` : 'JÃ¡ existem faturas para este benefÃ­cio.';\n    },\n    getAcao: () => 'Este extrato pode jÃ¡ ter sido processado. Verificar faturas existentes no negÃ³cio.'\n  },\n  'E_TODAS_DUPLICADAS': {\n    icone: 'âŒ',\n    titulo: 'TODAS AS PARCELAS JÃ EXISTEM',\n    getMensagem: (ctx) => `Todas as parcelas deste extrato jÃ¡ foram faturadas anteriormente.`,\n    getAcao: () => 'Este extrato jÃ¡ foi processado. Nenhuma aÃ§Ã£o necessÃ¡ria.'\n  },\n\n  // â•â•â• ERROS REGRA 50% â•â•â•\n  'E_REGRA50_P1': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 1', getMensagem: (ctx) => `Parcela 1 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P2': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 2', getMensagem: (ctx) => `Parcela 2 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P3': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 3', getMensagem: (ctx) => `Parcela 3 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P4': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 4', getMensagem: (ctx) => `Parcela 4 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n\n  // â•â•â• ERROS DE NÃ“S â•â•â•\n  'E_ERRO_6A': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA EXTRAÃ‡ÃƒO (NÃ“ 6A)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Gemini nÃ£o conseguiu processar o PDF';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'PDF pode estar ilegÃ­vel, corrompido ou em formato nÃ£o suportado. Solicitar novo extrato.'\n  },\n  'ERRO_6A': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA EXTRAÃ‡ÃƒO (NÃ“ 6A)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro na extraÃ§Ã£o';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel.'\n  },\n  'E_ERRO_6B': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NO CÃLCULO INSS (NÃ“ 6B)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro no cÃ¡lculo';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar logs do nÃ³ 6B no n8n.'\n  },\n  'E_ERRO_6C': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA DISTRIBUIÃ‡ÃƒO (NÃ“ 6C)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro na distribuiÃ§Ã£o';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar logs do nÃ³ 6C no n8n.'\n  },\n  'E_ERRO_NO_ANTERIOR': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO EM NÃ“ ANTERIOR',\n    getMensagem: (ctx) => {\n      return `NÃ³ com erro: ${ctx.noErro}\\nMensagem: ${ctx.erroMensagem || 'nÃ£o especificada'}`;\n    },\n    getAcao: () => 'Verificar logs do workflow no n8n.'\n  },\n  'ERRO_GEMINI': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NO GEMINI',\n    getMensagem: (ctx) => `O Gemini nÃ£o conseguiu processar o documento.\\n\\nDetalhes: ${ctx.erroMensagem || 'erro nÃ£o especificado'}`,\n    getAcao: () => 'PDF pode estar corrompido ou ilegÃ­vel. Solicitar novo extrato Ã  cliente.'\n  },\n  'ERRO_PDF': {\n    icone: 'ğŸ”´',\n    titulo: 'PDF INVÃLIDO',\n    getMensagem: (ctx) => `O arquivo PDF nÃ£o pÃ´de ser processado.`,\n    getAcao: () => 'Verificar se o arquivo Ã© um PDF vÃ¡lido e nÃ£o estÃ¡ corrompido.'\n  },\n  'ERRO_BITRIX': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO DE COMUNICAÃ‡ÃƒO COM BITRIX',\n    getMensagem: (ctx) => `Falha ao comunicar com o Bitrix24.\\n\\nDetalhes: ${ctx.erroMensagem || 'erro de conexÃ£o'}`,\n    getAcao: () => 'Pode ser instabilidade temporÃ¡ria. Tentar novamente em alguns minutos.'\n  },\n  'ERRO_PROJECAO': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO NA PROJEÃ‡ÃƒO DE PARCELAS',\n    getMensagem: (ctx) => `Detectado pulo de mÃªs na projeÃ§Ã£o.\\n\\nDetalhes: ${ctx.erroMensagem || 'continuidade quebrada'}`,\n    getAcao: () => 'Verificar lÃ³gica de projeÃ§Ã£o no nÃ³ 6B.'\n  },\n\n  // â•â•â• ERROS MATEMÃTICOS â•â•â•\n  'E_SOMA_NAO_BATE': {\n    icone: 'ğŸ”´',\n    titulo: 'SOMA DAS PARCELAS NÃƒO CONFERE',\n    getMensagem: (ctx) => {\n      const soma = ctx.erroDetalhes?.soma_calculada || '?';\n      const total = ctx.erroDetalhes?.total_esperado || '?';\n      return `Soma calculada: ${soma}\\nTotal esperado: ${total}`;\n    },\n    getAcao: () => 'Erro matemÃ¡tico no cÃ¡lculo. Verificar nÃ³ 6C.'\n  },\n\n  // â•â•â• ALERTAS â•â•â•\n  'A_CAMPO_NIT_VAZIO': { icone: 'âš ï¸', titulo: 'NIT VAZIO', getMensagem: () => 'Campo NIT nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_CAMPO_DIB_VAZIO': { icone: 'âš ï¸', titulo: 'DIB VAZIO', getMensagem: () => 'Campo DIB nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_CAMPO_DCB_VAZIO': { icone: 'âš ï¸', titulo: 'DCB VAZIO', getMensagem: () => 'Campo DCB nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_HONORARIOS_DIVERGENTE': { icone: 'âš ï¸', titulo: 'HONORÃRIOS â‰  30%', getMensagem: () => 'HonorÃ¡rios nÃ£o sÃ£o 30%.', getAcao: () => 'Pode ser acordo especial.' }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONTEXTO PARA MENSAGENS DINÃ‚MICAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst contexto = {\n  cpfExtrato,\n  cpfNegocio,\n  nbExtrato,\n  nbNegocio,\n  nomeCliente,\n  dealId,\n  noErro,\n  erroMensagem,\n  erroDetalhes,\n  resumo,\n  dados6A,\n  dados6B,\n  dados6C,\n  dados6D\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONSTRUIR MENSAGEM\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ğŸ”§ FIX V2.1: tags podem ser strings OU objetos com .codigo\nconst getTagCodigo = (t) => typeof t === 'string' ? t : (t?.codigo || '');\n\nconst gravidade = dados6D.gravidade_maxima || (erro.tag ? 'ERRO' : 'ALERTA');\n\nconst tagsErro = tags.filter(t => {\n  const cod = getTagCodigo(t);\n  return cod.startsWith('E_') || cod.startsWith('ERRO_') || cod.startsWith('TAG_');\n});\n\nconst tagsAlerta = tags.filter(t => {\n  const cod = getTagCodigo(t);\n  return cod.startsWith('A_');\n});\n\n// Se nÃ£o tem tags mas tem erro direto, usar a tag do erro\nlet tagsParaProcessar = tagsErro.length > 0 ? tagsErro : (erroTag ? [erroTag] : []);\n\nlet mensagem = '';\n\n// â•â•â• HEADER â•â•â•\nif (gravidade === 'CRITICO') {\n  mensagem += `ğŸš¨ ERRO CRÃTICO - FLUXO PARADO\\n`;\n} else if (gravidade === 'GRAVE' || tagsParaProcessar.length > 0) {\n  mensagem += `ğŸ”´ ERRO NO PROCESSAMENTO\\n`;\n} else {\n  mensagem += `âš ï¸ ALERTA NO PROCESSAMENTO\\n`;\n}\nmensagem += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\nmensagem += `ğŸ‘¤ Cliente: ${nomeCliente}\\n`;\nmensagem += `ğŸ“ NegÃ³cio: #${dealId}\\n`;\nmensagem += `ğŸ”§ NÃ³ com erro: ${noErro}\\n\\n`;\n\n// â•â•â• PROBLEMAS DETALHADOS â•â•â•\nif (tagsParaProcessar.length > 0) {\n  mensagem += `ğŸš¨ PROBLEMA(S) ENCONTRADO(S):\\n`;\n  mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  \n  for (const tag of tagsParaProcessar.slice(0, 3)) {\n    const info = MENSAGENS_TAG[tag];\n    \n    if (info) {\n      mensagem += `${info.icone} ${info.titulo}\\n\\n`;\n      mensagem += `${info.getMensagem(contexto)}\\n\\n`;\n      mensagem += `ğŸ‘‰ AÃ§Ã£o: ${info.getAcao()}\\n\\n`;\n    } else {\n      // Tag nÃ£o mapeada - mostrar cÃ³digo e detalhes disponÃ­veis\n      mensagem += `â“ ${tag}\\n`;\n      if (erroMensagem) mensagem += `Mensagem: ${erroMensagem}\\n`;\n      if (Object.keys(erroDetalhes).length > 0) {\n        mensagem += `Detalhes: ${JSON.stringify(erroDetalhes)}\\n`;\n      }\n      mensagem += `\\n`;\n    }\n    mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  }\n  \n  if (tagsParaProcessar.length > 3) {\n    mensagem += `... e mais ${tagsParaProcessar.length - 3} erro(s)\\n\\n`;\n  }\n} else if (erroMensagem) {\n  // Erro sem tag especÃ­fica\n  mensagem += `ğŸš¨ ERRO:\\n`;\n  mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  mensagem += `${erroMensagem}\\n\\n`;\n  if (Object.keys(erroDetalhes).length > 0) {\n    mensagem += `Detalhes: ${JSON.stringify(erroDetalhes, null, 2)}\\n\\n`;\n  }\n}\n\n// â•â•â• ALERTAS (se poucos erros) â•â•â•\nif (tagsAlerta.length > 0 && tagsParaProcessar.length <= 1) {\n  mensagem += `âš ï¸ ALERTAS:\\n`;\n  for (const tag of tagsAlerta.slice(0, 3)) {\n    const info = MENSAGENS_TAG[tag];\n    mensagem += info ? `  ${info.icone} ${info.titulo}\\n` : `  âš ï¸ ${tag}\\n`;\n  }\n  mensagem += `\\n`;\n}\n\n// â•â•â• COMPARAÃ‡ÃƒO CPF/NB (se relevante) â•â•â•\nconst temErroCPF = tagsParaProcessar.some(t => t.includes('CPF'));\nconst temErroNB = tagsParaProcessar.some(t => t.includes('NB'));\n\nif (!temErroCPF && !temErroNB && (cpfExtrato || nbExtrato)) {\n  mensagem += `ğŸ“‹ DADOS EXTRAÃDOS:\\n`;\n  if (cpfExtrato) mensagem += `  CPF: ${cpfExtrato} ${cpfExtrato === cpfNegocio?.replace(/\\D/g, '') ? 'âœ…' : 'âš ï¸'}\\n`;\n  if (nbExtrato) mensagem += `  NB: ${nbExtrato} ${nbExtrato === nbNegocio?.replace(/\\D/g, '') ? 'âœ…' : 'âš ï¸'}\\n`;\n  mensagem += `\\n`;\n}\n\n// â•â•â• LINK â•â•â•\nmensagem += `ğŸ”— ${linkNegocio}`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Campos para o 22. Chat Erro\n  MESSAGE: mensagem,\n  DIALOG_ID: chatErro,\n  \n  // Metadados\n  _no: '21B',\n  _versao: '2.0',\n  _timestamp: new Date().toISOString(),\n  \n  // Resumo do processamento\n  processamento: {\n    no_origem_erro: noErro,\n    erro_tag: erroTag,\n    erro_mensagem: erroMensagem,\n    total_tags: tags.length,\n    tags_erro: tagsParaProcessar.length,\n    tags_alerta: tagsAlerta.length,\n    gravidade,\n    tags_processadas: tagsParaProcessar.concat(tagsAlerta).slice(0, 10)\n  },\n  \n  // Dados extraÃ­dos (debug completo)\n  dados_extraidos: {\n    cliente: nomeCliente,\n    deal_id: dealId,\n    cpf_extrato: cpfExtrato,\n    cpf_negocio: cpfNegocio,\n    nb_extrato: nbExtrato,\n    nb_negocio: nbNegocio\n  },\n  \n  // Detalhes do erro (para investigaÃ§Ã£o)\n  erro_detalhes: {\n    fonte: noErro,\n    tag: erroTag,\n    mensagem: erroMensagem,\n    detalhes: erroDetalhes,\n    dados_no_erro: {\n      '6A_ok': dados6A.ok,\n      '6A_erro': dados6A.erro?.tag || null,\n      '6B_ok': dados6B.ok,\n      '6B_erro': dados6B.erro?.tag || null,\n      '6C_ok': dados6C.ok,\n      '6C_erro': dados6C.erro?.tag || null,\n      '6D_ok': dados6D.ok,\n      '6D_tags': tags.slice(0, 5)\n    }\n  },\n  \n  // Link\n  link_negocio: linkNegocio\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    7520,
    26320
  ],
  "id": "2aeea8b2-8566-42f8-bf05-a8bb9186025a",
  "name": "21b preparar msg erro"
}