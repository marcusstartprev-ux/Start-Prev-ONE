{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6A - ORGANIZAR DADOS DO PDF (v7.1 - SISTEMA DE TAGS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VersÃ£o: 7.1 - Sistema completo de TAGs com severidade\n// Data: 29/01/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// NOVIDADES v7.1:\n// âœ… Sistema de TAGs com 5 nÃ­veis de severidade (CRIT, ALTO, MEDIO, BAIXO, INFO)\n// âœ… Filosofia \"nunca bloquear\" - sempre passa adiante com TAGs\n// âœ… Resumo de TAGs por severidade no output\n// âœ… Flags tem_problemas_criticos e tem_problemas_altos\n// âœ… Todas as validaÃ§Ãµes geram TAGs padronizadas\n//\n// MANTIDO da v7.0:\n// âœ… IDs do DEAL corrigidos conforme Mapeamento_CORRETO_DEAL_INVOICE.xlsx\n// âœ… IDs da INVOICE corrigidos conforme Mapeamento_CORRETO_DEAL_INVOICE.xlsx\n// âœ… 38 campos no Deal, 57 campos na Invoice\n// âœ… 25 campos extras mapeados para uso futuro\n// âœ… Todos os IDs validados contra Bitrix24 API\n//\n// DOCUMENTOS SUPORTADOS:\n// âœ… EXTRATO_CREDITOS - HistÃ³rico de CrÃ©ditos INSS (faturamento)\n// âœ… PGMEI_DAS - ContribuiÃ§Ãµes MEI (carÃªncia/elegibilidade)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡Ã•ES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst CONFIG = {\n  DIAS_SALARIO_MATERNIDADE: 120,\n  LIMITE_DIAS_NOVA_PARCELA: 15,\n  VALOR_BAIXO_ALERTA: 100,\n  PERIODO_CURTO_ALERTA: 5,\n  MESES_CARENCIA_MEI: 10,\n  SALARIO_MINIMO_2025: 1518.00,\n  TETO_INSS_2025: 8157.41\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TIPOS DE DOCUMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst TIPO_DOC = {\n  EXTRATO_CREDITOS: 'EXTRATO_CREDITOS',\n  PGMEI_DAS: 'PGMEI_DAS',\n  DESCONHECIDO: 'DESCONHECIDO'\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// v7.1: SISTEMA DE SEVERIDADE DE TAGS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst SEVERIDADE = {\n  CRIT: 'CRIT',    // ðŸ”´ CrÃ­tico - pode pausar para intervenÃ§Ã£o\n  ALTO: 'ALTO',   // ðŸŸ  Alto - alerta forte, revisar manualmente\n  MEDIO: 'MEDIO', // ðŸŸ¡ MÃ©dio - alerta moderado\n  BAIXO: 'BAIXO', // ðŸŸ¢ Baixo - apenas registra\n  INFO: 'INFO'    // ðŸ”µ Info - log para auditoria\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DO DEAL (IDs Bitrix) - v7.0 CORRIGIDO\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// Total: 38 campos\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CD = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_5F7DD07B0ADB5',      // CPF\n  rg:                       'UF_CRM_5F7DD07B11C33',      // RG\n  nit:                      'UF_CRM_1766282969',         // NIT (EXTRATO DE PAGAMENTO)\n  nb:                       'UF_CRM_1737470444334',      // NÂº DO BENEFICIO\n  nome_filho:               'UF_CRM_1699462600794',      // NOME DO FILHO(A)\n  categoria:                'UF_CRM_5F7DD07B0295D',      // CATEGORIA\n  \n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_1765928945',         // Data de InÃ­cio do BenefÃ­cio (DIB)\n  dip:                      'UF_CRM_1766439387',         // Data de InÃ­cio do Pagamento (DIP)\n  dcb:                      'UF_CRM_1748433331869',      // Data de CessaÃ§Ã£o do BenefÃ­cio (DCB)\n  dn_mamae:                 'UF_CRM_1602615428011',      // DN MAMÃƒE\n  dn_filho:                 'UF_CRM_5F7DD07B1997D',      // DN FILHO(A)\n  dn_certidao:              'UF_CRM_1714741602233',      // DN CERTIDÃƒO\n  data_dnv:                 'UF_CRM_1742827283535',      // DATA DNV\n  data_requerimento:        'UF_CRM_6094054C7C1C8',      // DATA REQUERIMENTO\n  data_concessao:           'UF_CRM_1602256897805',      // DATA CONCESSÃƒO\n  \n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_1741726157749',      // MR Cliente (BRUTO DO BENEFICIO)\n  valor_total_beneficio:    'UF_CRM_1742841962002',      // Valor Total BenefÃ­cio (120d)\n  aliquota_mr:              'UF_CRM_1742841855608',      // AlÃ­quota MR\n  \n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_1634158430224',      // VALOR DO INSS\n  valor_cliente:            'UF_CRM_1634828809106',      // VALOR DA CLIENTE\n  valor_previsto:           'UF_CRM_1635261498013',      // VALOR PREVISTO\n  valor_recebido:           'UF_CRM_1633535814529',      // VALOR RECEBIDO\n  parcela_numero:           'UF_CRM_1634158972573',      // PARCELA NÂº (Atual)\n  qtd_parcelas:             'UF_CRM_1625253358741',      // QUANTIDADE DE PARCELAS\n  \n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_1603216440272',      // BANCO\n  endereco_banco:           'UF_CRM_1603216499370',      // EndereÃ§o do Banco\n  agencia_banco:            'UF_CRM_1762558313',         // AGÃŠNCIA DO BANCO\n  \n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_1765636941',         // Justificativa Direito\n  data_rodagem:             'UF_CRM_1764270308863',      // Data Rodagem\n  rodagem_comentario:       'UF_CRM_1764270260617',      // ComentÃ¡rio Rodagem\n  \n  // â•â•â• 10. GESTÃƒO â•â•â•\n  assessor:                 'UF_CRM_5F7DD07AEC035',      // ASSESSOR(A)\n  ultimo_relacionador:      'UF_CRM_1688072257656',      // Ãšltimo Relacionador\n  ddd_cliente:              'UF_CRM_659C48C5F0594',      // DDD Cliente\n  data_reclamacao:          'UF_CRM_1704738513559',      // Data ReclamaÃ§Ã£o\n  data_qualificacao:        'UF_CRM_65E74D984ED3C',      // Data QualificaÃ§Ã£o\n  data_recuperacao:         'UF_CRM_1713804709729',      // Data RecuperaÃ§Ã£o\n  data_encerramento:        'UF_CRM_663007E42D75E',      // (PERDIDA) - DATA DE ENCERRAMENTO PERSONALIZADO\n  data_reentrada:           'UF_CRM_1615653096667',      // Data Reentrada\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DA INVOICE (IDs Bitrix) - v7.0 CORRIGIDO\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// Total: 57 campos\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CI = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_652439CFE551C',      // CPF\n  rg:                       'UF_CRM_652439D00A9CF',      // RG\n  nit:                      'UF_CRM_6947602572F0A',      // NIT (EXTRATO DE PAGAMENTO)\n  nb:                       'UF_CRM_6790DAD756E3C',      // NÂº DO BENEFICIO\n  nome_filho:               'UF_CRM_65BD5488EC8E9',      // NOME DO FILHO(A)\n  categoria:                'UF_CRM_652439D03479D',      // CATEGORIA\n  \n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_69442F085B2CD',      // Data de InÃ­cio do BenefÃ­cio (DIB)\n  dip:                      'UF_CRM_683860072DEB8',      // Data de InÃ­cio do Pagamento (DIP)\n  dcb:                      'UF_CRM_6838600845561',      // Data de CessaÃ§Ã£o do BenefÃ­cio (DCB)\n  dn_mamae:                 'UF_CRM_652439D0138A5',      // DN MAMÃƒE\n  dn_filho:                 'UF_CRM_652439D021438',      // DN FILHO(A)\n  dn_certidao:              'UF_CRM_66351141F40C7',      // DN CERTIDÃƒO\n  data_dnv:                 'UF_CRM_67E17F1C70EAF',      // DATA DNV\n  data_requerimento:        'UF_CRM_652439D3530AB',      // DATA REQUERIMENTO\n  data_concessao:           'UF_CRM_652439D157BA8',      // DATA CONCESSÃƒO\n  \n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_67D19072D84A8',      // MR Cliente\n  valor_diario:             'UF_CRM_69442F466791E',      // Valor DiÃ¡rio\n  valor_liquido_mensal:     'UF_CRM_69442F4D0909D',      // Valor LÃ­quido Mensal\n  valor_total_beneficio:    'UF_CRM_69442F535C91B',      // Valor Total BenefÃ­cio (120d)\n  valor_restante_inss:      'UF_CRM_69442F3A581C2',      // Valor Restante INSS\n  aliquota_mr:              'UF_CRM_67E1B184633ED',      // AlÃ­quota MR\n  especie_beneficio:        'UF_CRM_69442F6570BDB',      // EspÃ©cie do BenefÃ­cio\n  \n  // â•â•â• 4. HONORÃRIOS START â•â•â•\n  valor_total_start:        'UF_CRM_69442F217FB9D',      // Valor Total Start (30%)\n  saldo_restante_start:     'UF_CRM_69442F27CCFB3',      // Saldo Restante Start\n  aliquota_start:           'UF_CRM_69442F596A782',      // AlÃ­quota Start\n  regra_aplicada:           'UF_CRM_69442F5F762AD',      // Regra Aplicada\n  \n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_652439D8D6B8E',      // VALOR DO INSS\n  valor_cliente:            'UF_CRM_652439D915311',      // VALOR DA CLIENTE\n  valor_previsto:           'UF_CRM_652439D9202B3',      // VALOR PREVISTO\n  parcela_numero:           'UF_CRM_652439D8E9608',      // PARCELA NÂº\n  parcela_formato:          'UF_CRM_652439D8CDB53',      // Ã€ Vista ou Parcelado\n  qtd_parcelas:             'UF_CRM_67E1AD2860054',      // QUANTIDADE DE PARCELAS\n  \n  // â•â•â• 6. EXTRATO / COMPETÃŠNCIA â•â•â•\n  competencia:              'UF_CRM_691B6450B46E3',      // CompetÃªncia\n  competencia_final:        'UF_CRM_69442F0E9A95A',      // CompetÃªncia Final\n  periodo:                  'UF_CRM_691B64560A17F',      // PerÃ­odo\n  ultima_comp_valida:       'UF_CRM_693D7DE5148DB',      // Ãšltima CompetÃªncia VÃ¡lida\n  credito_invalidado:       'UF_CRM_691B6467F11F2',      // CrÃ©dito Invalidado\n  dias_ja_recebidos:        'UF_CRM_69442F2E321C4',      // Dias JÃ¡ Recebidos\n  dias_restantes:           'UF_CRM_69442F3449D22',      // Dias Restantes\n  \n  // â•â•â• 7. DATAS OPERACIONAIS â•â•â•\n  data_inss:                'UF_CRM_652439D8B3207',      // DATA INSS\n  data_pagamento_extrato:   'UF_CRM_691B64616C2C9',      // Data Pagamento Extrato\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',      // Data AtualizaÃ§Ã£o Extrato\n  \n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_652439D194A06',      // BANCO\n  endereco_banco:           'UF_CRM_652439D1A53FA',      // EndereÃ§o do Banco\n  agencia_banco:            'UF_CRM_691225FDDDBE4',      // AGÃŠNCIA DO BANCO\n  \n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_693D7BBC3E5D3',      // Justificativa Direito\n  resultado_analise:        'UF_CRM_693D7CB58EBD2',      // Resultado AnÃ¡lise\n  data_rodagem:             'UF_CRM_6929FDA3C8A79',      // Data Rodagem\n  rodagem_comentario:       'UF_CRM_6929FD9E9A95D',      // ComentÃ¡rio Rodagem\n  direito_ate:              'UF_CRM_679781AAB3B1D',      // Direito AtÃ©\n  \n  // â•â•â• 10. GESTÃƒO â•â•â•\n  ultimo_relacionador:      'UF_CRM_65BD5488EC8E9',      // Ãšltimo Relacionador\n  ddd_cliente:              'UF_CRM_65BD5489DF3A2',      // DDD Cliente\n  data_reclamacao:          'UF_CRM_65BD5489C89AD',      // Data ReclamaÃ§Ã£o\n  data_qualificacao:        'UF_CRM_65E777E2A0CED',      // Data QualificaÃ§Ã£o\n  data_recuperacao:         'UF_CRM_662699414BCF0',      // Data RecuperaÃ§Ã£o\n  data_encerramento:        'UF_CRM_6631460FD3BB4',      // (PERDIDA) - DATA DE ENCERRAMENTO PERSONALIZADO\n  data_reentrada:           'UF_CRM_678EADB02E460',      // Data Reentrada\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CAMPOS EXTRAS - Mapeados para uso futuro\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CAMPOS_EXTRAS = {\n  // Deal\n  data_encerramento_sem_direito_deal: 'UF_CRM_663007E518A1E',  // (SEM DIREITO) - DATA DE ENCERRAMENTO\n  data_conversao_deal:                'UF_CRM_5F7DD07B204FD',  // DATA DE CONVERSÃƒO\n  data_certidao_deal:                 'UF_CRM_1674755625727',  // DATA CERTIDÃƒO\n  data_consulta_deal:                 'UF_CRM_1602256877083',  // Data da Consulta\n  data_contato_deal:                  'UF_CRM_1650915373840',  // DATA DO CONTATO\n  data_prox_contato_deal:             'UF_CRM_1650915411107',  // DATA DO PROXM CONTATO\n  data_sem_direito_deal:              'UF_CRM_1649701660322',  // DATA DE SEM DIREITO\n  data_indeferimento_deal:            'UF_CRM_1620315580',     // DATA DE INDEFERIMENTO\n  data_quebra_contrato_deal:          'UF_CRM_1737722079155',  // DATA QUEBRA DE CONTRATO\n  relacionador_quebra_deal:           'UF_CRM_1737722166447',  // RELACIONADOR ENVIO PARA QUEBRA\n  relacionador_sem_direito_deal:      'UF_CRM_1737722233583',  // RELACIONADOR ENVIO PARA SEM DIREITO\n  recurso_deal:                       'UF_CRM_1759219838803',  // Recurso\n  senha_deal:                         'UF_CRM_1602257200479',  // SENHA\n  sugestao_senha_deal:                'UF_CRM_5FDA4FCE92DAA',  // SugestÃ£o de senha\n  telefone_2_deal:                    'UF_CRM_606C6C98B68A7',  // TELEFONE - 2\n  telefone_3_deal:                    'UF_CRM_606C6C9A00D10',  // TELEFONE - 3\n  sine_deal:                          'UF_CRM_1751375841241',  // SINE\n  data_envio_recurso_deal:            'UF_CRM_1759220050331',  // Data Envio ao Recurso\n  \n  // Invoice\n  resultado_criacao_faturas_inv:      'UF_CRM_SMART_INVOICE_1767045330', // RESULTADO DA CRIAÃ‡ÃƒO AUT. DE FATURAS\n  data_conversao_inv:                 'UF_CRM_652439D0CF19F',  // DATA DE CONVERSÃƒO\n  data_calculo_inv:                   'UF_CRM_69442F14E544C',  // Data CÃ¡lculo\n  data_certidao_inv:                  'UF_CRM_652439DA75EFF',  // DATA CERTIDÃƒO\n  data_consulta_inv:                  'UF_CRM_652439D14CF3D',  // Data da Consulta\n  data_acordo_inv:                    'UF_CRM_652439DB85203',  // DATA DO ACORDO\n  data_contato_inv:                   'UF_CRM_652439D9B26DF',  // DATA DO CONTATO\n  data_sem_direito_inv:               'UF_CRM_66ACE094C0195',  // DATA DE SEM DIREITO\n  data_pagamento_inv:                 'UF_CRM_652439D8BD582',  // DATA DE PAGAMENTO\n  data_indeferimento_inv:             'UF_CRM_652439D3E866C',  // DATA DE INDEFERIMENTO\n  data_recebimento_inv:               'UF_CRM_652439D1B26E2',  // DATA DE RECEBIMENTO\n  desconto_inv:                       'UF_CRM_6838600A5C767',  // DESCONTO\n  data_quebra_contrato_inv:           'UF_CRM_6793A405B3FC1',  // DATA QUEBRA DE CONTRATO\n  relacionador_quebra_inv:            'UF_CRM_6793A4065BECA',  // RELACIONADOR ENVIO PARA QUEBRA\n  relacionador_sem_direito_inv:       'UF_CRM_6793A40701BCB',  // RELACIONADOR ENVIO PARA SEM DIREITO\n  recurso_inv:                        'UF_CRM_68DD552A351D0',  // Recurso\n  senha_inv:                          'UF_CRM_652439D16254A',  // SENHA\n  sugestao_senha_inv:                 'UF_CRM_652439D23E905',  // SugestÃ£o de senha\n  telefone_2_inv:                     'UF_CRM_652439D28D353',  // TELEFONE - 2\n  telefone_3_inv:                     'UF_CRM_652439D298A88',  // TELEFONE - 3\n  sine_inv:                           'UF_CRM_6883D4B47136F',  // SINE\n  data_envio_recurso_inv:             'UF_CRM_68DD552F3DD02',  // Data Envio ao Recurso\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TABELA DE CONVERSÃƒO BANCO TEXTO â†’ ENUM ID (para Invoice)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst BANCO_ENUM = {\n  'caixa': 4530,\n  'caixa economica': 4530,\n  'caixa econÃ´mica': 4530,\n  'cef': 4530,\n  '104': 4530,\n  'banco do brasil': 4532,\n  'bb': 4532,\n  '001': 4532,\n  'santander': 4534,\n  '033': 4534,\n  'banrisul': 4536,\n  'crefisa': 4538,\n  'bmg': 4540,\n  'agibank': 4542,\n  'sicredi': 4544,\n  'bancoob': 4546,\n  'banestes': 4548,\n  'acordo sem banco': 4550,\n  'banpara': 4552,\n  'banparÃ¡': 4552,\n  'banese': 4554,\n  'sicoob': 4556,\n  'brb': 6712,\n  'bradesco': 431,\n  '237': 431,\n  'itau': 433,\n  'itaÃº': 433,\n  '341': 433,\n  'mercantil': 435\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TABELAS DE NORMALIZAÃ‡ÃƒO DE STATUS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst MAPA_STATUS_CREDITO = {\n  'pagamento efetivado': 'PAGO',\n  'pagamento efetuado': 'PAGO',\n  'pago': 'PAGO',\n  'credito liberado': 'PAGO',\n  'crÃ©dito liberado': 'PAGO',\n  'liberado': 'PAGO',\n  'efetivado': 'PAGO',\n  'efetuado': 'PAGO',\n  'crÃ©dito nÃ£o retornado': 'PENDENTE',\n  'credito nÃ£o retornado': 'PENDENTE',\n  'credito nao retornado': 'PENDENTE',\n  'nÃ£o retornado': 'PENDENTE',\n  'nao retornado': 'PENDENTE',\n  'previsto': 'PENDENTE',\n  'bloqueado': 'CANCELADO',\n  'cancelado': 'CANCELADO',\n  'invalidado': 'CANCELADO',\n  'suspenso': 'CANCELADO'\n};\n\nconst MAPA_STATUS_MEI = {\n  'liquidado': 'PAGO',\n  'pago': 'PAGO',\n  'devedor': 'DEVEDOR',\n  'em atraso': 'DEVEDOR',\n  'a vencer': 'A_VENCER',\n  'pendente': 'A_VENCER'\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES UTILITÃRIAS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/** TRUNCAR - INSS usa truncamento, nÃ£o arredondamento! */\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\n/** Parse de valor brasileiro: \"R$ 1.518,00\" â†’ 1518.00 */\nfunction parseValorBR(valor) {\n  if (!valor) return 0;\n  if (typeof valor === 'number') return tr(valor);\n  const limpo = String(valor)\n    .replace(/R\\$\\s*/gi, '')\n    .replace(/\\./g, '')\n    .replace(',', '.')\n    .trim();\n  return tr(parseFloat(limpo) || 0);\n}\n\n/** Parse de data BR: \"01/10/2024\" â†’ \"2024-10-01\" */\nfunction parseDateBR(dataStr) {\n  if (!dataStr) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(dataStr)) {\n    return dataStr.substring(0, 10);\n  }\n  const match = dataStr.match(/(\\d{2})\\/(\\d{2})\\/(\\d{4})/);\n  if (match) {\n    return `${match[3]}-${match[2]}-${match[1]}`;\n  }\n  return null;\n}\n\n/** Formatar data para Bitrix */\nfunction formatDateBitrix(dataISO) {\n  if (!dataISO) return null;\n  return `${dataISO}T03:00:00+00:00`;\n}\n\n/** Formatar valor para campo money do Bitrix */\nfunction formatMoneyBitrix(valor) {\n  if (!valor && valor !== 0) return null;\n  return `${tr(valor)}|BRL`;\n}\n\n/** Parse de perÃ­odo: \"01/10/2024 a 31/10/2024\" â†’ { inicio, fim } */\nfunction parsePeriodo(periodoStr) {\n  if (!periodoStr) return { inicio: null, fim: null };\n  const partes = periodoStr.split(/\\s+a\\s+/i);\n  return {\n    inicio: parseDateBR(partes[0]?.trim()),\n    fim: parseDateBR(partes[1]?.trim() || partes[0]?.trim())\n  };\n}\n\n/** Limpa CPF/NIT: \"123.456.789-00\" â†’ \"12345678900\" */\nfunction limparDocumento(doc) {\n  if (!doc) return '';\n  return String(doc).replace(/\\D/g, '');\n}\n\n/** Normalizar competÃªncia: \"10/2024\" ou \"Outubro/2024\" â†’ \"10/2024\" */\nfunction normalizarCompetencia(comp) {\n  if (!comp) return null;\n  const match = comp.match(/(\\d{1,2})\\/(\\d{4})/);\n  if (match) {\n    return `${match[1].padStart(2, '0')}/${match[2]}`;\n  }\n  return comp;\n}\n\n/** Calcular diferenÃ§a em dias entre duas datas ISO (inclusivo) */\nfunction calcularDias(dataInicio, dataFim) {\n  if (!dataInicio || !dataFim) return 0;\n  const d1 = new Date(dataInicio);\n  const d2 = new Date(dataFim);\n  const diffTime = d2 - d1;\n  return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;\n}\n\n/** Normalizar status do crÃ©dito */\nfunction normalizarStatusCredito(statusOriginal) {\n  if (!statusOriginal) return 'PENDENTE';\n  const key = statusOriginal.toLowerCase().trim();\n  for (const [pattern, status] of Object.entries(MAPA_STATUS_CREDITO)) {\n    if (key.includes(pattern)) return status;\n  }\n  return 'PENDENTE';\n}\n\n/** Normalizar status MEI */\nfunction normalizarStatusMEI(statusOriginal) {\n  if (!statusOriginal) return 'A_VENCER';\n  const key = statusOriginal.toLowerCase().trim();\n  for (const [pattern, status] of Object.entries(MAPA_STATUS_MEI)) {\n    if (key.includes(pattern)) return status;\n  }\n  return 'A_VENCER';\n}\n\n/** Extrair mÃªs/ano de uma data ISO */\nfunction extrairMesAno(dataISO) {\n  if (!dataISO) return null;\n  return `${dataISO.substring(5, 7)}/${dataISO.substring(0, 4)}`;\n}\n\n/** Comparar competÃªncias: retorna -1, 0 ou 1 */\nfunction compararCompetencias(comp1, comp2) {\n  if (!comp1 || !comp2) return 0;\n  const [m1, a1] = comp1.split('/').map(Number);\n  const [m2, a2] = comp2.split('/').map(Number);\n  if (a1 !== a2) return a1 - a2;\n  return m1 - m2;\n}\n\n/** Gerar hash Ãºnico */\nfunction gerarHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(8, '0');\n}\n\n/** Converter nome do banco para enum ID */\nfunction bancoParaEnum(bancoTexto) {\n  if (!bancoTexto) return null;\n  const key = String(bancoTexto).toLowerCase().trim();\n  \n  if (BANCO_ENUM[key]) return BANCO_ENUM[key];\n  \n  for (const [pattern, enumId] of Object.entries(BANCO_ENUM)) {\n    if (key.includes(pattern) || pattern.includes(key)) {\n      return enumId;\n    }\n  }\n  \n  return null;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// v7.1: FUNÃ‡ÃƒO PARA CRIAR TAG PADRONIZADA\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction criarTag(codigo, severidade, mensagem, extras = {}) {\n  return {\n    codigo,\n    severidade,\n    mensagem,\n    timestamp: new Date().toISOString(),\n    ...extras\n  };\n}\n\n/** Calcular resumo de tags por severidade */\nfunction calcularResumoTags(tags) {\n  const resumo = {\n    crit: 0,\n    alto: 0,\n    medio: 0,\n    baixo: 0,\n    info: 0,\n    total: tags.length\n  };\n  \n  tags.forEach(tag => {\n    switch (tag.severidade) {\n      case SEVERIDADE.CRIT: resumo.crit++; break;\n      case SEVERIDADE.ALTO: resumo.alto++; break;\n      case SEVERIDADE.MEDIO: resumo.medio++; break;\n      case SEVERIDADE.BAIXO: resumo.baixo++; break;\n      case SEVERIDADE.INFO: resumo.info++; break;\n    }\n  });\n  \n  return resumo;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 1. BUSCAR CONTEXTO DOS NÃ“S ANTERIORES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ctxAnterior = $('2C. Analisar Faturas').first()?.json || \n                    $('2. Buscar Deal').first()?.json || \n                    {};\n\nconst deal = ctxAnterior.deal || ctxAnterior.result || {};\nconst deal_id = ctxAnterior.deal_id || deal.ID || $json.deal_id;\nconst faturas_existentes = ctxAnterior.faturas_existentes || {};\nconst tentativa = ctxAnterior.tentativa || 1;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 2. PARSE DA RESPOSTA DO GEMINI\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nlet dadosGemini = null;\nlet erroGemini = null;\n\ntry {\n  const textoGemini = $json.content?.parts?.[0]?.text ||\n                      $json.candidates?.[0]?.content?.parts?.[0]?.text ||\n                      $json[0]?.content?.parts?.[0]?.text ||\n                      $json[0]?.candidates?.[0]?.content?.parts?.[0]?.text ||\n                      $json.text || \n                      (typeof $json === 'string' ? $json : null);\n  \n  if (!textoGemini) {\n    throw new Error('Resposta do Gemini vazia ou em formato inesperado');\n  }\n  \n  let jsonLimpo = textoGemini\n    .replace(/```json\\n?/gi, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  const inicioJSON = jsonLimpo.indexOf('{');\n  const fimJSON = jsonLimpo.lastIndexOf('}');\n  \n  if (inicioJSON === -1 || fimJSON === -1) {\n    throw new Error('JSON nÃ£o encontrado na resposta do Gemini');\n  }\n  \n  jsonLimpo = jsonLimpo.substring(inicioJSON, fimJSON + 1);\n  dadosGemini = JSON.parse(jsonLimpo);\n  \n} catch (e) {\n  erroGemini = e.message;\n}\n\n// v7.1: Retorno de erro com sistema de TAGs\nif (erroGemini) {\n  const tags = [\n    criarTag('TAG_PARSE_GEMINI_ERRO', SEVERIDADE.CRIT, erroGemini, { pode_reprocessar: tentativa < 2 })\n  ];\n  const resumo_tags = calcularResumoTags(tags);\n  \n  return [{\n    json: {\n      _no: '6A',\n      _versao: '7.1',\n      _timestamp: new Date().toISOString(),\n      \n      ok: false,\n      tipo_documento: TIPO_DOC.DESCONHECIDO,\n      erro: {\n        tipo: 'PARSE_GEMINI',\n        mensagem: erroGemini,\n        pode_reprocessar: tentativa < 2\n      },\n      \n      // v7.1: Sistema de TAGs\n      tags,\n      resumo_tags,\n      tem_problemas_criticos: true,\n      tem_problemas_altos: false,\n      \n      deal_id,\n      deal,\n      faturas_existentes,\n      tentativa,\n      tempo_ms: Date.now() - inicio,\n      campos_deal: {},\n      campos_invoice_base: {}\n    }\n  }];\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3. DETECTAR TIPO DE DOCUMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction detectarTipoDocumento(dados) {\n  const temCNPJ = dados.cnpj || dados.CNPJ;\n  const temPGMEI = dados.tipo_documento?.toLowerCase().includes('pgmei') ||\n                   dados.tipo_documento?.toLowerCase().includes('das') ||\n                   dados.sistema?.toLowerCase().includes('pgmei');\n  const temContribuicoes = dados.contribuicoes || dados.Contribuicoes || \n                           dados.periodos_apuracao;\n  \n  const temNB = dados.beneficio?.nb || dados.NB || dados.numero_beneficio;\n  const temMR = dados.beneficio?.mr || dados.MR;\n  const temDIB = dados.beneficio?.dib || dados.DIB;\n  const temHistoricoCreditos = dados.historico_creditos || dados.Creditos || \n                               dados.Pagamentos;\n  \n  if (temCNPJ && (temPGMEI || temContribuicoes)) {\n    return TIPO_DOC.PGMEI_DAS;\n  }\n  \n  if (temNB || temMR || temDIB || temHistoricoCreditos) {\n    return TIPO_DOC.EXTRATO_CREDITOS;\n  }\n  \n  return TIPO_DOC.DESCONHECIDO;\n}\n\nconst tipoDocumento = detectarTipoDocumento(dadosGemini);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4A. PROCESSAR EXTRATO DE CRÃ‰DITOS INSS (v7.1 - COM SISTEMA DE TAGS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction processarExtratoCreditos(dados) {\n  // v7.1: Array unificado de TAGs\n  const tags = [];\n  \n  // Mantido da v7.0 para compatibilidade\n  const alertas = [];\n  const erros = [];\n  const info = [];\n  const tags_correcao = [];\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.1 IDENTIFICAÃ‡ÃƒO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const cliente = {\n    nome: dados.identificacao?.nome || dados.Nome || '',\n    cpf: limparDocumento(dados.identificacao?.cpf || dados.CPF),\n    nit: limparDocumento(dados.identificacao?.nit || dados.NIT)\n  };\n  \n  // v7.1: TAGs de identificaÃ§Ã£o\n  if (!cliente.cpf) {\n    tags.push(criarTag('TAG_CPF_AUSENTE', SEVERIDADE.CRIT, 'CPF nÃ£o extraÃ­do do PDF', { campo: 'cpf' }));\n    erros.push({ tipo: 'CPF_AUSENTE', mensagem: 'CPF nÃ£o encontrado no extrato', severidade: 'CRITICO' });\n  } else if (cliente.cpf.length !== 11) {\n    tags.push(criarTag('TAG_CPF_INVALIDO', SEVERIDADE.CRIT, `CPF com formato invÃ¡lido: ${cliente.cpf}`, { campo: 'cpf', valor: cliente.cpf }));\n    erros.push({ tipo: 'CPF_INVALIDO', mensagem: `CPF invÃ¡lido: ${cliente.cpf}`, severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_CPF_OK', SEVERIDADE.INFO, `CPF validado: ${cliente.cpf}`, { campo: 'cpf', valor: cliente.cpf }));\n  }\n  \n  if (!cliente.nit) {\n    tags.push(criarTag('TAG_NIT_AUSENTE', SEVERIDADE.ALTO, 'NIT nÃ£o extraÃ­do - necessÃ¡rio para calendÃ¡rio INSS', { campo: 'nit' }));\n  } else {\n    tags.push(criarTag('TAG_NIT_OK', SEVERIDADE.INFO, `NIT validado: ${cliente.nit}`, { campo: 'nit', valor: cliente.nit }));\n  }\n  \n  if (!cliente.nome) {\n    tags.push(criarTag('TAG_NOME_AUSENTE', SEVERIDADE.MEDIO, 'Nome nÃ£o extraÃ­do do PDF', { campo: 'nome' }));\n  } else {\n    tags.push(criarTag('TAG_NOME_OK', SEVERIDADE.INFO, `Nome: ${cliente.nome}`, { campo: 'nome', valor: cliente.nome }));\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.2 BENEFÃCIO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const beneficioRaw = dados.beneficio || dados.CreditosDoBeneficio || {};\n  \n  const mr = parseValorBR(beneficioRaw.mr || beneficioRaw.MR || dados.MR);\n  const dib = parseDateBR(beneficioRaw.dib || beneficioRaw.DIB || dados.DIB);\n  let dcb = parseDateBR(beneficioRaw.dcb || beneficioRaw.DCB || dados.DCB);\n  \n  let dip = parseDateBR(\n    beneficioRaw.dip || \n    beneficioRaw.DIP || \n    dados.DIP || \n    dados.dip ||\n    beneficioRaw.data_inicio_pagamento ||\n    dados.data_inicio_pagamento\n  );\n  \n  // v7.1: TAGs de NB\n  const nb = beneficioRaw.nb || beneficioRaw.NB || dados.NB || '';\n  if (!nb) {\n    tags.push(criarTag('TAG_NB_AUSENTE', SEVERIDADE.CRIT, 'NÃºmero do BenefÃ­cio nÃ£o extraÃ­do', { campo: 'nb' }));\n    erros.push({ tipo: 'NB_AUSENTE', mensagem: 'NÃºmero do BenefÃ­cio nÃ£o encontrado', severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_NB_OK', SEVERIDADE.INFO, `NB validado: ${nb}`, { campo: 'nb', valor: nb }));\n  }\n  \n  // v7.1: TAGs de MR\n  if (!mr || mr <= 0) {\n    tags.push(criarTag('TAG_MR_AUSENTE', SEVERIDADE.CRIT, 'MR nÃ£o extraÃ­da do PDF ou valor zero', { campo: 'mr', valor: mr }));\n    erros.push({ tipo: 'MR_INVALIDO', mensagem: `MR invÃ¡lido: ${mr}`, severidade: 'CRITICO' });\n  } else if (mr < CONFIG.SALARIO_MINIMO_2025) {\n    tags.push(criarTag('TAG_MR_ABAIXO_MINIMO', SEVERIDADE.ALTO, `MR (${mr}) abaixo do salÃ¡rio mÃ­nimo (${CONFIG.SALARIO_MINIMO_2025})`, { campo: 'mr', valor: mr, salario_minimo: CONFIG.SALARIO_MINIMO_2025 }));\n  } else if (mr > CONFIG.TETO_INSS_2025) {\n    tags.push(criarTag('TAG_MR_ACIMA_TETO', SEVERIDADE.MEDIO, `MR (${mr}) acima do teto INSS (${CONFIG.TETO_INSS_2025})`, { campo: 'mr', valor: mr, teto: CONFIG.TETO_INSS_2025 }));\n  } else {\n    tags.push(criarTag('TAG_MR_OK', SEVERIDADE.INFO, `MR validada: R$ ${mr}`, { campo: 'mr', valor: mr }));\n  }\n  \n  // v7.1: TAGs de DIB\n  if (!dib) {\n    tags.push(criarTag('TAG_DIB_AUSENTE', SEVERIDADE.CRIT, 'DIB nÃ£o extraÃ­da do PDF', { campo: 'dib' }));\n  } else {\n    const dibDate = new Date(dib);\n    const hoje = new Date();\n    if (dibDate > hoje) {\n      tags.push(criarTag('TAG_DIB_FUTURA', SEVERIDADE.ALTO, `DIB (${dib}) estÃ¡ no futuro`, { campo: 'dib', valor: dib }));\n    } else {\n      tags.push(criarTag('TAG_DIB_OK', SEVERIDADE.INFO, `DIB validada: ${dib}`, { campo: 'dib', valor: dib }));\n    }\n  }\n  \n  // Calcular DCB se nÃ£o veio (DIB + 120 dias)\n  if (!dcb && dib) {\n    const dibDate = new Date(dib);\n    dibDate.setDate(dibDate.getDate() + CONFIG.DIAS_SALARIO_MATERNIDADE - 1);\n    dcb = dibDate.toISOString().substring(0, 10);\n    tags.push(criarTag('TAG_DCB_CALCULADA', SEVERIDADE.INFO, `DCB calculada: ${dcb} (DIB + 119 dias)`, { campo: 'dcb', valor: dcb, calculado: true }));\n  } else if (dcb) {\n    tags.push(criarTag('TAG_DCB_OK', SEVERIDADE.INFO, `DCB validada: ${dcb}`, { campo: 'dcb', valor: dcb }));\n  } else {\n    tags.push(criarTag('TAG_DCB_AUSENTE', SEVERIDADE.MEDIO, 'DCB nÃ£o extraÃ­da e nÃ£o pode ser calculada (DIB ausente)', { campo: 'dcb' }));\n  }\n  \n  // Se DIP nÃ£o veio, usar DIB como fallback\n  if (!dip && dib) {\n    dip = dib;\n    tags.push(criarTag('TAG_DIP_FALLBACK_DIB', SEVERIDADE.INFO, `DIP usando DIB como fallback: ${dip}`, { campo: 'dip', valor: dip, fallback: true }));\n    info.push('INFO_DIP_FALLBACK_DIB');\n  } else if (dip) {\n    tags.push(criarTag('TAG_DIP_OK', SEVERIDADE.INFO, `DIP validada: ${dip}`, { campo: 'dip', valor: dip }));\n    info.push('INFO_DIP_EXTRAIDO_PDF');\n  } else {\n    tags.push(criarTag('TAG_DIP_AUSENTE', SEVERIDADE.MEDIO, 'DIP nÃ£o extraÃ­da e DIB tambÃ©m ausente', { campo: 'dip' }));\n    alertas.push({ tipo: 'DIP_NAO_EXTRAIDO', mensagem: 'DIP nÃ£o encontrado no PDF, usando DIB como fallback' });\n  }\n  \n  const dias_beneficio = dib && dcb ? calcularDias(dib, dcb) : CONFIG.DIAS_SALARIO_MATERNIDADE;\n  const valor_diario = tr(mr / 30);\n  \n  const bancoTexto = beneficioRaw.banco || \n                     dados.Banco || \n                     dados.banco ||\n                     beneficioRaw.meio_pagamento ||\n                     dados.meio_pagamento || '';\n  \n  const banco_enum = bancoParaEnum(bancoTexto);\n  \n  // v7.1: TAGs de Banco\n  if (!bancoTexto) {\n    tags.push(criarTag('TAG_BANCO_AUSENTE', SEVERIDADE.BAIXO, 'Banco nÃ£o extraÃ­do do PDF', { campo: 'banco' }));\n  } else if (!banco_enum) {\n    tags.push(criarTag('TAG_BANCO_NAO_MAPEADO', SEVERIDADE.BAIXO, `Banco '${bancoTexto}' nÃ£o mapeado para enum`, { campo: 'banco', valor: bancoTexto }));\n  } else {\n    tags.push(criarTag('TAG_BANCO_OK', SEVERIDADE.INFO, `Banco validado: ${bancoTexto} (enum: ${banco_enum})`, { campo: 'banco', valor: bancoTexto, enum_id: banco_enum }));\n  }\n  \n  const especie = beneficioRaw.especie || beneficioRaw.Especie || '80';\n  \n  // v7.1: TAG de EspÃ©cie\n  if (especie !== '80' && especie !== 80) {\n    tags.push(criarTag('TAG_ESPECIE_NAO_80', SEVERIDADE.ALTO, `EspÃ©cie (${especie}) nÃ£o Ã© SalÃ¡rio-Maternidade (80)`, { campo: 'especie', valor: especie }));\n  } else {\n    tags.push(criarTag('TAG_ESPECIE_OK', SEVERIDADE.INFO, 'EspÃ©cie validada: 80 - SalÃ¡rio-Maternidade', { campo: 'especie', valor: especie }));\n  }\n  \n  const beneficio = {\n    nb,\n    especie,\n    mr,\n    dib,\n    dip,\n    dcb,\n    dias_beneficio,\n    valor_diario,\n    banco: bancoTexto,\n    banco_enum\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.3 DADOS DO EXTRATO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const extrato = {\n    compet_inicial: normalizarCompetencia(dados.compet_inicial || dados.competencia_inicial),\n    compet_final: normalizarCompetencia(dados.compet_final || dados.competencia_final),\n    data_atualizacao: parseDateBR(dados.data_atualizacao)\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.4 PROCESSAR CRÃ‰DITOS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const creditosRaw = dados.historico_creditos || dados.Pagamentos || \n                      dados.Creditos || dados.creditos || [];\n  \n  // v7.1: TAG de crÃ©ditos\n  if (creditosRaw.length === 0) {\n    tags.push(criarTag('TAG_CREDITOS_VAZIO', SEVERIDADE.CRIT, 'Nenhum crÃ©dito extraÃ­do do PDF', { campo: 'creditos' }));\n  } else if (creditosRaw.length === 1) {\n    tags.push(criarTag('TAG_CREDITOS_UNICO', SEVERIDADE.INFO, 'Apenas 1 crÃ©dito no extrato', { campo: 'creditos', quantidade: 1 }));\n  } else if (creditosRaw.length > 6) {\n    tags.push(criarTag('TAG_CREDITOS_MUITOS', SEVERIDADE.MEDIO, `${creditosRaw.length} crÃ©ditos no extrato - verificar se correto`, { campo: 'creditos', quantidade: creditosRaw.length }));\n  } else {\n    tags.push(criarTag('TAG_CREDITOS_OK', SEVERIDADE.INFO, `${creditosRaw.length} crÃ©ditos extraÃ­dos`, { campo: 'creditos', quantidade: creditosRaw.length }));\n  }\n  \n  const creditos = creditosRaw.map((cred, index) => {\n    const periodo = parsePeriodo(cred.periodo || cred.Periodo);\n    const credId = index + 1;\n    \n    const diasCalculado = periodo.inicio && periodo.fim\n      ? calcularDias(periodo.inicio, periodo.fim)\n      : 0;\n\n    let diasInformado = (cred.dias !== undefined && cred.dias !== null) ? Number(cred.dias) : null;\n    if (Number.isNaN(diasInformado)) diasInformado = null;\n\n    let dias = diasCalculado;\n\n    // Se calculado deu <= 0 mas as datas existem, tentar corrigir invertendo\n    if (periodo.inicio && periodo.fim && diasCalculado <= 0) {\n      const tmp = periodo.inicio;\n      periodo.inicio = periodo.fim;\n      periodo.fim = tmp;\n\n      const diasRecalc = calcularDias(periodo.inicio, periodo.fim);\n      if (diasRecalc > 0) {\n        dias = diasRecalc;\n        if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n        tags.push(criarTag(`TAG_CRED${credId}_PERIODO_INVERTIDO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: perÃ­odo invertido, corrigido`, { credito_id: credId, dias_corrigido: dias }));\n        alertas.push({\n          tipo: 'DIAS_CORRIGIDOS_PERIODO_INVERTIDO',\n          mensagem: `CrÃ©dito #${credId}: perÃ­odo invertido no PDF/extraÃ§Ã£o. Dias recalculados para ${dias}.`,\n          credito_id: credId\n        });\n      }\n    }\n\n    // Se o Gemini informou dias e estÃ¡ diferente do calculado\n    if (diasInformado && diasInformado > 0 && diasCalculado > 0 && diasInformado !== diasCalculado) {\n      dias = diasCalculado;\n      if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_CORRIGIDO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: dias corrigido de ${diasInformado} para ${diasCalculado}`, { credito_id: credId, dias_informado: diasInformado, dias_calculado: diasCalculado }));\n      alertas.push({\n        tipo: 'DIAS_CORRIGIDOS_DIVERGENCIA',\n        mensagem: `CrÃ©dito #${credId}: dias informado (${diasInformado}) â‰  dias calculado (${diasCalculado}). Corrigido para ${diasCalculado}.`,\n        credito_id: credId,\n        dias_informado: diasInformado,\n        dias_calculado: diasCalculado\n      });\n    }\n\n    // Blindagem final: dias nunca negativo/zero se houver datas\n    if (periodo.inicio && periodo.fim && (!dias || dias <= 0)) {\n      dias = 1;\n      if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_MINIMO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: dias ajustado para 1 (mÃ­nimo)`, { credito_id: credId }));\n      alertas.push({\n        tipo: 'DIAS_CORRIGIDOS_MINIMO',\n        mensagem: `CrÃ©dito #${credId}: dias ficou invÃ¡lido. Ajustado para 1 (mÃ­nimo).`,\n        credito_id: credId\n      });\n    }\n    \n    // v7.1: TAG de dias do crÃ©dito\n    if (dias === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_ZERO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: dias = 0`, { credito_id: credId }));\n    } else if (dias > 31) {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_EXCEDE_MES`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: ${dias} dias (excede 1 mÃªs)`, { credito_id: credId, dias }));\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: ${dias} dias`, { credito_id: credId, dias }));\n    }\n\n    const valor_bruto = parseValorBR(cred.valor_bruto || cred.ValorBruto || cred.rubricas?.['101']);\n    const valor_liquido = parseValorBR(cred.valor_liquido || cred.ValorLiquido);\n    const desconto_inss = parseValorBR(cred.desconto_inss || cred.rubricas?.['206']);\n    const decimo_terceiro = parseValorBR(cred.decimo_terceiro || cred.rubricas?.['104']);\n    const arredondamento = parseValorBR(cred.arredondamento || cred.rubricas?.['137'] || cred.rubricas?.['215']);\n    \n    // v7.1: TAGs de valores do crÃ©dito\n    if (!valor_liquido || valor_liquido === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_AUSENTE`, SEVERIDADE.CRIT, `CrÃ©dito #${credId}: valor lÃ­quido nÃ£o extraÃ­do ou zero`, { credito_id: credId }));\n    } else if (valor_liquido < CONFIG.VALOR_BAIXO_ALERTA) {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_BAIXO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: valor baixo R$ ${valor_liquido}`, { credito_id: credId, valor: valor_liquido }));\n      alertas.push({ tipo: 'VALOR_BAIXO', mensagem: `CrÃ©dito #${credId} com valor baixo: R$ ${valor_liquido}`, credito_id: credId });\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: lÃ­quido R$ ${valor_liquido}`, { credito_id: credId, valor: valor_liquido }));\n    }\n    \n    if (!valor_bruto || valor_bruto === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_AUSENTE`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: valor bruto (rubrica 101) nÃ£o extraÃ­do`, { credito_id: credId }));\n    } else if (valor_bruto < valor_liquido) {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_MENOR_LIQUIDO`, SEVERIDADE.CRIT, `CrÃ©dito #${credId}: bruto (${valor_bruto}) < lÃ­quido (${valor_liquido})`, { credito_id: credId, bruto: valor_bruto, liquido: valor_liquido }));\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: bruto R$ ${valor_bruto}`, { credito_id: credId, valor: valor_bruto }));\n    }\n    \n    // v7.1: TAG de 13Âº salÃ¡rio\n    if (decimo_terceiro > 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_TEM_13`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: inclui 13Âº salÃ¡rio R$ ${decimo_terceiro}`, { credito_id: credId, valor: decimo_terceiro }));\n      alertas.push({ tipo: 'TEM_13_SALARIO', mensagem: `CrÃ©dito #${credId} inclui 13Âº salÃ¡rio: R$ ${decimo_terceiro}`, credito_id: credId });\n    }\n    \n    const statusOriginal = cred.status || cred.Ocorrencia || cred.ocorrencia || '';\n    const status = normalizarStatusCredito(statusOriginal);\n    const creditoInvalidado = cred.credito_invalidado === true || \n                               cred.credito_invalidado === 'Sim' ||\n                               cred.CreditoInvalidado === 'Sim';\n    \n    // v7.1: TAGs de status do crÃ©dito\n    if (!statusOriginal) {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_AUSENTE`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: status nÃ£o extraÃ­do - assumindo PENDENTE`, { credito_id: credId }));\n    } else if (status === 'PAGO') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_PAGO`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: jÃ¡ pago`, { credito_id: credId, status }));\n    } else if (status === 'PENDENTE') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_PENDENTE`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: pendente`, { credito_id: credId, status }));\n    } else if (status === 'CANCELADO') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_CANCELADO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: cancelado/invalidado`, { credito_id: credId, status }));\n    }\n    \n    if (creditoInvalidado) {\n      tags.push(criarTag(`TAG_CRED${credId}_INVALIDADO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: marcado como invalidado`, { credito_id: credId }));\n    }\n    \n    const bancoCred = cred.banco || cred.Banco || beneficio.banco;\n    \n    const ja_pago = status === 'PAGO';\n    const pode_faturar = status !== 'CANCELADO' && !creditoInvalidado;\n    const tem_13o = decimo_terceiro > 0;\n    \n    // v7.1: TAG de perÃ­odo curto\n    if (dias <= CONFIG.PERIODO_CURTO_ALERTA && dias > 0) {\n      alertas.push({ tipo: 'PERIODO_CURTO', mensagem: `CrÃ©dito #${credId} com apenas ${dias} dia(s)`, credito_id: credId });\n    }\n    \n    return {\n      id: credId,\n      competencia: normalizarCompetencia(cred.competencia || cred.Competencia),\n      periodo: cred.periodo || cred.Periodo || `${periodo.inicio} a ${periodo.fim}`,\n      periodo_inicio: periodo.inicio,\n      periodo_fim: periodo.fim,\n      dias,\n      \n      valores: {\n        bruto: valor_bruto || mr,\n        liquido: valor_liquido,\n        desconto_inss,\n        decimo_terceiro,\n        arredondamento\n      },\n      \n      pagamento: {\n        previsao: parseDateBR(cred.previsao_pagamento || cred.PrevisaoPagamento),\n        data: parseDateBR(cred.data_pagamento || cred.DataPagamento),\n        status,\n        status_original: statusOriginal,\n        banco: bancoCred,\n        banco_enum: bancoParaEnum(bancoCred)\n      },\n      \n      validade: {\n        inicio: parseDateBR(cred.validade_inicio || cred.ValidadeInicio),\n        fim: parseDateBR(cred.validade_fim || cred.ValidadeFim)\n      },\n      \n      origem: cred.origem || cred.Origem || '',\n      data_calculo: parseDateBR(cred.data_calculo || cred.DataCalculo),\n      \n      flags: {\n        ja_pago,\n        pode_faturar,\n        invalidado: creditoInvalidado,\n        tem_13o\n      }\n    };\n  });\n  \n  // Ordenar por perÃ­odo\n  creditos.sort((a, b) => {\n    const dataA = a.periodo_inicio || a.periodo_fim || '9999-12-31';\n    const dataB = b.periodo_inicio || b.periodo_fim || '9999-12-31';\n    return dataA.localeCompare(dataB);\n  });\n  \n  // Separar por status\n  const creditosValidos = creditos.filter(c => c.flags.pode_faturar);\n  const creditosPagos = creditos.filter(c => c.flags.ja_pago && c.flags.pode_faturar);\n  const creditosPendentes = creditos.filter(c => !c.flags.ja_pago && c.flags.pode_faturar);\n  const creditosInvalidos = creditos.filter(c => !c.flags.pode_faturar);\n\n  // Fallback/recalculo de competÃªncia inicial/final\n  const compPrimeira = creditosValidos[0]?.competencia || null;\n  const compUltima = creditosValidos[creditosValidos.length - 1]?.competencia || null;\n\n  if ((!extrato.compet_inicial && compPrimeira) || (!extrato.compet_final && compUltima)) {\n    const antesIni = extrato.compet_inicial;\n    const antesFim = extrato.compet_final;\n\n    if (!extrato.compet_inicial && compPrimeira) extrato.compet_inicial = compPrimeira;\n    if (!extrato.compet_final && compUltima) extrato.compet_final = compUltima;\n\n    if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n    tags.push(criarTag('TAG_COMP_AUTO_RECALCULADA', SEVERIDADE.MEDIO, `CompetÃªncia recalculada: ${extrato.compet_inicial} â†’ ${extrato.compet_final}`, { antes: { compet_inicial: antesIni, compet_final: antesFim }, depois: { compet_inicial: extrato.compet_inicial, compet_final: extrato.compet_final } }));\n    alertas.push({\n      tipo: 'COMP_RECALCULADA_FALLBACK',\n      mensagem: `CompetÃªncia inicial/final ausente. Recalculada a partir dos crÃ©ditos: ${extrato.compet_inicial} â†’ ${extrato.compet_final}.`,\n      antes: { compet_inicial: antesIni, compet_final: antesFim },\n      depois: { compet_inicial: extrato.compet_inicial, compet_final: extrato.compet_final }\n    });\n  } else {\n    if (compPrimeira && extrato.compet_inicial && compararCompetencias(extrato.compet_inicial, compPrimeira) !== 0) {\n      const antes = extrato.compet_inicial;\n      extrato.compet_inicial = compPrimeira;\n\n      if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n      tags.push(criarTag('TAG_COMP_INICIAL_CORRIGIDA', SEVERIDADE.MEDIO, `CompetÃªncia inicial corrigida de ${antes} para ${compPrimeira}`, { antes, depois: compPrimeira }));\n      alertas.push({\n        tipo: 'COMP_INICIAL_CORRIGIDA',\n        mensagem: `CompetÃªncia inicial divergente. Corrigida de ${antes} para ${compPrimeira} com base nos crÃ©ditos.`,\n        antes,\n        depois: compPrimeira\n      });\n    }\n\n    if (compUltima && extrato.compet_final && compararCompetencias(extrato.compet_final, compUltima) !== 0) {\n      const antes = extrato.compet_final;\n      extrato.compet_final = compUltima;\n\n      if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n      tags.push(criarTag('TAG_COMP_FINAL_CORRIGIDA', SEVERIDADE.MEDIO, `CompetÃªncia final corrigida de ${antes} para ${compUltima}`, { antes, depois: compUltima }));\n      alertas.push({\n        tipo: 'COMP_FINAL_CORRIGIDA',\n        mensagem: `CompetÃªncia final divergente. Corrigida de ${antes} para ${compUltima} com base nos crÃ©ditos.`,\n        antes,\n        depois: compUltima\n      });\n    }\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.5 VALIDAÃ‡Ã•ES DE CPF DEAL vs PDF\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const cpfBitrix = limparDocumento(deal[CD.cpf]);\n  if (cliente.cpf && cpfBitrix && cliente.cpf !== cpfBitrix) {\n    tags.push(criarTag('TAG_CPF_DIVERGENTE', SEVERIDADE.CRIT, `CPF PDF (${cliente.cpf}) â‰  Deal (${cpfBitrix})`, { campo: 'cpf', cpf_pdf: cliente.cpf, cpf_deal: cpfBitrix }));\n    erros.push({ \n      tipo: 'CPF_DIVERGENTE', \n      mensagem: `CPF PDF (${cliente.cpf}) â‰  Bitrix (${cpfBitrix})`,\n      severidade: 'CRITICO',\n      pode_reprocessar: false\n    });\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.6 ANÃLISE DE COBERTURA\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const dias_cobertos = creditosValidos.reduce((sum, c) => sum + c.dias, 0);\n  const dias_restantes = Math.max(0, beneficio.dias_beneficio - dias_cobertos);\n  const percentual_coberto = tr((dias_cobertos / beneficio.dias_beneficio) * 100);\n  \n  const primeiro_dia_coberto = creditosValidos.length > 0 ? creditosValidos[0].periodo_inicio : null;\n  const ultimo_dia_coberto = creditosValidos.length > 0 ? creditosValidos[creditosValidos.length - 1].periodo_fim : null;\n  \n  const cobertura_por_dias = dias_restantes <= CONFIG.LIMITE_DIAS_NOVA_PARCELA;\n  \n  const compFinalExtrato = extrato.compet_final || creditosValidos[creditosValidos.length - 1]?.competencia;\n  const mesDCB = extrairMesAno(beneficio.dcb);\n  const cobertura_por_competencia = compFinalExtrato && mesDCB ? compararCompetencias(compFinalExtrato, mesDCB) >= 0 : null;\n  \n  const cobertura_por_periodo = ultimo_dia_coberto && beneficio.dcb ? ultimo_dia_coberto >= beneficio.dcb : null;\n  \n  const metodos = [cobertura_por_dias, cobertura_por_competencia, cobertura_por_periodo].filter(m => m !== null);\n  const cobertura_completa = metodos.filter(m => m === true).length >= Math.ceil(metodos.length / 2);\n  const confianca = metodos.every(m => m === metodos[0]) ? 'ALTA' : 'MEDIA';\n  \n  // v7.1: TAGs de cobertura\n  if (cobertura_completa && confianca === 'ALTA') {\n    tags.push(criarTag('TAG_COBERTURA_COMPLETA_ALTA', SEVERIDADE.INFO, 'Cobertura completa - confianÃ§a ALTA', { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  } else if (cobertura_completa) {\n    tags.push(criarTag('TAG_COBERTURA_COMPLETA_MEDIA', SEVERIDADE.INFO, 'Cobertura completa - confianÃ§a MÃ‰DIA', { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  } else {\n    tags.push(criarTag('TAG_COBERTURA_INCOMPLETA', SEVERIDADE.INFO, `Cobertura ${percentual_coberto}% - ${dias_restantes} dias restantes`, { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  }\n  \n  // v7.1: TAG de dias totais\n  if (dias_cobertos > CONFIG.DIAS_SALARIO_MATERNIDADE) {\n    tags.push(criarTag('TAG_DIAS_EXCEDEM_120', SEVERIDADE.MEDIO, `Total de dias (${dias_cobertos}) excede 120`, { dias_cobertos }));\n  }\n  \n  const cobertura = {\n    dib: beneficio.dib,\n    dcb: beneficio.dcb,\n    dias_beneficio: beneficio.dias_beneficio,\n    primeiro_dia_coberto,\n    ultimo_dia_coberto,\n    dias_cobertos,\n    dias_restantes,\n    percentual: percentual_coberto,\n    validacoes: {\n      por_dias: { dias_restantes, limite: CONFIG.LIMITE_DIAS_NOVA_PARCELA, completa: cobertura_por_dias },\n      por_competencia: { extrato: compFinalExtrato, dcb: mesDCB, completa: cobertura_por_competencia },\n      por_periodo: { ultimo: ultimo_dia_coberto, dcb: beneficio.dcb, completa: cobertura_por_periodo }\n    },\n    cobertura_completa,\n    confianca,\n    vai_ter_mais_parcelas: !cobertura_completa\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.7 ANÃLISE DE PAGAMENTO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const pagamento = {\n    parcelas_total: creditosValidos.length,\n    parcelas_pagas: creditosPagos.length,\n    parcelas_pendentes: creditosPendentes.length,\n    valor_total: tr(creditosValidos.reduce((s, c) => s + c.valores.liquido, 0)),\n    valor_pago: tr(creditosPagos.reduce((s, c) => s + c.valores.liquido, 0)),\n    valor_pendente: tr(creditosPendentes.reduce((s, c) => s + c.valores.liquido, 0)),\n    dias_pagos: creditosPagos.reduce((s, c) => s + c.dias, 0),\n    dias_pendentes: creditosPendentes.reduce((s, c) => s + c.dias, 0),\n    pagamento_completo: creditosPendentes.length === 0 && cobertura_completa,\n    primeira_data_pagamento: creditosPagos[0]?.pagamento?.data || null\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.8 COMPETÃŠNCIAS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const competencias = {\n    primeira: creditosValidos[0]?.competencia || null,\n    ultima: creditosValidos[creditosValidos.length - 1]?.competencia || null,\n    lista: [...new Set(creditosValidos.map(c => c.competencia))].sort((a, b) => compararCompetencias(a, b))\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.9 CAMPOS PARA ATUALIZAR NO DEAL - v7.1 SEMPRE MONTA (filosofia nunca bloquear)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  // v7.1: Calcula se tem erro crÃ­tico MAS ainda assim monta os campos\n  const temErroCritico = erros.some(e => e.severidade === 'CRITICO');\n  const campos_deal = {};\n  \n  // v7.1: SEMPRE monta campos_deal (mesmo com erro crÃ­tico, para auditoria)\n  // â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\n  if (cliente.cpf) campos_deal[CD.cpf] = cliente.cpf;\n  if (cliente.nit) campos_deal[CD.nit] = cliente.nit;\n  if (beneficio.nb) campos_deal[CD.nb] = beneficio.nb;\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  if (beneficio.dib) campos_deal[CD.dib] = formatDateBitrix(beneficio.dib);\n  if (beneficio.dcb) campos_deal[CD.dcb] = formatDateBitrix(beneficio.dcb);\n  if (beneficio.dip) campos_deal[CD.dip] = formatDateBitrix(beneficio.dip);\n  \n  // â•â•â• VALORES â•â•â•\n  if (beneficio.mr) campos_deal[CD.mr_cliente] = formatMoneyBitrix(beneficio.mr);\n  if (pagamento.valor_total) campos_deal[CD.valor_total_beneficio] = pagamento.valor_total;\n  \n  // â•â•â• PARCELAS â•â•â•\n  campos_deal[CD.qtd_parcelas] = String(creditosValidos.length);\n  \n  // â•â•â• BANCO â•â•â•\n  if (beneficio.banco_enum) {\n    campos_deal[CD.banco] = beneficio.banco_enum;\n  }\n  if (beneficio.banco) {\n    campos_deal[CD.endereco_banco] = beneficio.banco;\n  }\n  \n  info.push(`INFO_CAMPOS_DEAL_${Object.keys(campos_deal).length}`);\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.10 CAMPOS BASE PARA INVOICE - v7.1 SEMPRE MONTA\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const campos_invoice_base = {};\n  \n  // v7.1: SEMPRE monta campos_invoice_base\n  // â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\n  if (cliente.cpf) campos_invoice_base[CI.cpf] = cliente.cpf;\n  if (cliente.nit) campos_invoice_base[CI.nit] = cliente.nit;\n  if (beneficio.nb) campos_invoice_base[CI.nb] = beneficio.nb;\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  if (beneficio.dib) campos_invoice_base[CI.dib] = formatDateBitrix(beneficio.dib);\n  if (beneficio.dcb) campos_invoice_base[CI.dcb] = formatDateBitrix(beneficio.dcb);\n  if (beneficio.dip) campos_invoice_base[CI.dip] = formatDateBitrix(beneficio.dip);\n  \n  // â•â•â• VALORES â•â•â•\n  if (beneficio.mr) campos_invoice_base[CI.mr_cliente] = formatMoneyBitrix(beneficio.mr);\n  if (beneficio.valor_diario) campos_invoice_base[CI.valor_diario] = beneficio.valor_diario;\n  \n  // â•â•â• COMPETÃŠNCIA â•â•â•\n  if (competencias.ultima) campos_invoice_base[CI.competencia_final] = competencias.ultima;\n  if (competencias.ultima) campos_invoice_base[CI.ultima_comp_valida] = competencias.ultima;\n  \n  // â•â•â• DIAS â•â•â•\n  campos_invoice_base[CI.dias_ja_recebidos] = cobertura.dias_cobertos;\n  campos_invoice_base[CI.dias_restantes] = cobertura.dias_restantes;\n  \n  // â•â•â• PARCELAS â•â•â•\n  campos_invoice_base[CI.qtd_parcelas] = String(creditosValidos.length);\n  \n  // â•â•â• BANCO â•â•â•\n  if (beneficio.banco_enum) {\n    campos_invoice_base[CI.banco] = beneficio.banco_enum;\n  }\n  if (beneficio.banco) {\n    campos_invoice_base[CI.endereco_banco] = beneficio.banco;\n  }\n  \n  // â•â•â• ESPÃ‰CIE â•â•â•\n  if (beneficio.especie) {\n    campos_invoice_base[CI.especie_beneficio] = beneficio.especie;\n  }\n  \n  info.push(`INFO_CAMPOS_INVOICE_${Object.keys(campos_invoice_base).length}`);\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.11 v7.1: CALCULAR RESUMO DE TAGS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const resumo_tags = calcularResumoTags(tags);\n  const tem_problemas_criticos = resumo_tags.crit > 0;\n  const tem_problemas_altos = resumo_tags.alto > 0;\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.12 RETORNO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  return {\n    tipo_documento: TIPO_DOC.EXTRATO_CREDITOS,\n    // v7.1: ok = false sÃ³ se tiver erro crÃ­tico, mas SEMPRE passa adiante\n    ok: !temErroCritico,\n    erro: temErroCritico ? erros[0] : null,\n    \n    cliente,\n    beneficio,\n    extrato,\n    \n    creditos: creditosValidos,\n    creditos_pagos: creditosPagos,\n    creditos_pendentes: creditosPendentes,\n    creditos_invalidos: creditosInvalidos,\n    \n    cobertura,\n    pagamento,\n    competencias,\n    \n    // v7.0: Dois mapeamentos separados (SEMPRE preenchidos na v7.1)\n    campos_deal,\n    campos_invoice_base,\n    \n    hash: gerarHash(`${cliente.cpf}-${beneficio.nb}-${extrato.data_atualizacao}-${creditos.length}`),\n\n    // v7.1: Sistema de TAGs\n    tags,\n    resumo_tags,\n    tem_problemas_criticos,\n    tem_problemas_altos,\n\n    // Mantido da v7.0 para compatibilidade\n    tags_correcao,\n    alertas,\n    erros,\n    info\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4B. PROCESSAR PGMEI / DAS (CONTRIBUIÃ‡Ã•ES MEI) - v7.1 COM TAGS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction processarPGMEI(dados) {\n  const tags = [];\n  const alertas = [];\n  const erros = [];\n  \n  const cliente = {\n    nome: dados.nome || dados.Nome || '',\n    cpf: limparDocumento(dados.cpf || dados.CPF),\n    cnpj: limparDocumento(dados.cnpj || dados.CNPJ)\n  };\n  \n  // v7.1: TAGs de identificaÃ§Ã£o PGMEI\n  if (!cliente.cnpj) {\n    tags.push(criarTag('TAG_CNPJ_AUSENTE', SEVERIDADE.CRIT, 'CNPJ nÃ£o encontrado', { campo: 'cnpj' }));\n    erros.push({ tipo: 'CNPJ_AUSENTE', mensagem: 'CNPJ nÃ£o encontrado', severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_CNPJ_OK', SEVERIDADE.INFO, `CNPJ validado: ${cliente.cnpj}`, { campo: 'cnpj', valor: cliente.cnpj }));\n  }\n  \n  const anoCalendario = dados.ano_calendario || dados.ano || new Date().getFullYear();\n  \n  const contribuicoesRaw = dados.contribuicoes || dados.Contribuicoes || dados.periodos_apuracao || [];\n  \n  const contribuicoes = contribuicoesRaw.map((contrib, index) => {\n    const statusOriginal = contrib.situacao || contrib.Situacao || '';\n    const status = normalizarStatusMEI(statusOriginal);\n    \n    return {\n      id: index + 1,\n      competencia: normalizarCompetencia(contrib.competencia || contrib.periodo),\n      apurado_beneficio: contrib.apurado_beneficio === true || contrib.apurado_beneficio === 'Sim' || contrib.ApuradoBeneficioINSS === 'Sim',\n      situacao: { status, status_original: statusOriginal },\n      valores: {\n        principal: parseValorBR(contrib.principal),\n        multa: parseValorBR(contrib.multa),\n        juros: parseValorBR(contrib.juros),\n        total: parseValorBR(contrib.total)\n      },\n      datas: {\n        vencimento: parseDateBR(contrib.vencimento),\n        acolhimento: parseDateBR(contrib.acolhimento)\n      },\n      flags: {\n        pago: status === 'PAGO',\n        em_atraso: status === 'DEVEDOR',\n        a_vencer: status === 'A_VENCER'\n      }\n    };\n  });\n  \n  contribuicoes.sort((a, b) => compararCompetencias(a.competencia, b.competencia));\n  \n  const pagas = contribuicoes.filter(c => c.flags.pago);\n  const devedoras = contribuicoes.filter(c => c.flags.em_atraso);\n  const aVencer = contribuicoes.filter(c => c.flags.a_vencer);\n  \n  const carenciaAtingida = pagas.length >= CONFIG.MESES_CARENCIA_MEI;\n  const mesesFaltantes = Math.max(0, CONFIG.MESES_CARENCIA_MEI - pagas.length);\n  \n  const debitoTotal = tr(devedoras.reduce((sum, c) => sum + c.valores.total, 0));\n  \n  // v7.1: TAGs de carÃªncia\n  if (!carenciaAtingida) {\n    tags.push(criarTag('TAG_CARENCIA_INSUFICIENTE', SEVERIDADE.ALTO, `CarÃªncia: ${pagas.length}/${CONFIG.MESES_CARENCIA_MEI} meses. Faltam ${mesesFaltantes}.`, { meses_pagos: pagas.length, meses_necessarios: CONFIG.MESES_CARENCIA_MEI, meses_faltantes: mesesFaltantes }));\n    alertas.push({ tipo: 'CARENCIA_INSUFICIENTE', mensagem: `CarÃªncia: ${pagas.length}/${CONFIG.MESES_CARENCIA_MEI} meses. Faltam ${mesesFaltantes}.` });\n  } else {\n    tags.push(criarTag('TAG_CARENCIA_OK', SEVERIDADE.INFO, `CarÃªncia atingida: ${pagas.length} meses`, { meses_pagos: pagas.length }));\n  }\n  \n  // v7.1: TAGs de dÃ©bitos\n  if (devedoras.length > 0) {\n    tags.push(criarTag('TAG_CONTRIBUICOES_ATRASADAS', SEVERIDADE.ALTO, `${devedoras.length} contribuiÃ§Ã£o(Ãµes) em atraso. DÃ©bito: R$ ${debitoTotal}`, { quantidade: devedoras.length, debito_total: debitoTotal }));\n    alertas.push({ tipo: 'CONTRIBUICOES_ATRASADAS', mensagem: `${devedoras.length} contribuiÃ§Ã£o(Ãµes) em atraso. DÃ©bito: R$ ${debitoTotal}` });\n  } else {\n    tags.push(criarTag('TAG_SEM_DEBITOS', SEVERIDADE.INFO, 'Sem contribuiÃ§Ãµes em atraso', {}));\n  }\n  \n  const analise = {\n    carencia: { meses_necessarios: CONFIG.MESES_CARENCIA_MEI, meses_pagos: pagas.length, meses_faltantes: mesesFaltantes, atingida: carenciaAtingida },\n    contribuicoes: { total: contribuicoes.length, pagas: pagas.length, devedoras: devedoras.length, a_vencer: aVencer.length },\n    debitos: { total: debitoTotal, quantidade: devedoras.length },\n    elegibilidade: { carencia_ok: carenciaAtingida, em_dia: devedoras.length === 0, pode_solicitar: carenciaAtingida }\n  };\n  \n  const temErroCritico = erros.some(e => e.severidade === 'CRITICO');\n  \n  // v7.1: Calcular resumo\n  const resumo_tags = calcularResumoTags(tags);\n  const tem_problemas_criticos = resumo_tags.crit > 0;\n  const tem_problemas_altos = resumo_tags.alto > 0;\n  \n  return {\n    tipo_documento: TIPO_DOC.PGMEI_DAS,\n    ok: !temErroCritico,\n    erro: temErroCritico ? erros[0] : null,\n    cliente,\n    ano_calendario: anoCalendario,\n    contribuicoes,\n    contribuicoes_pagas: pagas,\n    contribuicoes_devedoras: devedoras,\n    contribuicoes_a_vencer: aVencer,\n    analise,\n    hash: gerarHash(`${cliente.cnpj}-${anoCalendario}-${contribuicoes.length}`),\n    \n    // v7.1: Sistema de TAGs\n    tags,\n    resumo_tags,\n    tem_problemas_criticos,\n    tem_problemas_altos,\n    \n    alertas,\n    erros,\n    campos_deal: {},\n    campos_invoice_base: {}\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5. EXECUTAR PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nlet resultado;\n\nswitch (tipoDocumento) {\n  case TIPO_DOC.EXTRATO_CREDITOS:\n    resultado = processarExtratoCreditos(dadosGemini);\n    break;\n    \n  case TIPO_DOC.PGMEI_DAS:\n    resultado = processarPGMEI(dadosGemini);\n    break;\n    \n  default:\n    const tagsDesconhecido = [\n      criarTag('TAG_DOCUMENTO_NAO_RECONHECIDO', SEVERIDADE.CRIT, 'Tipo de documento nÃ£o reconhecido', {})\n    ];\n    resultado = {\n      tipo_documento: TIPO_DOC.DESCONHECIDO,\n      ok: false,\n      erro: {\n        tipo: 'DOCUMENTO_NAO_RECONHECIDO',\n        mensagem: 'Tipo de documento nÃ£o reconhecido. Esperado: Extrato de CrÃ©ditos INSS ou PGMEI/DAS.',\n        pode_reprocessar: false\n      },\n      tags: tagsDesconhecido,\n      resumo_tags: calcularResumoTags(tagsDesconhecido),\n      tem_problemas_criticos: true,\n      tem_problemas_altos: false,\n      alertas: [],\n      erros: [],\n      campos_deal: {},\n      campos_invoice_base: {}\n    };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 6. RETORNO FINAL\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst tempoExecucao = Date.now() - inicio;\n\nconsole.log(JSON.stringify({\n  no: '6A',\n  versao: '7.1',\n  tipo: tipoDocumento,\n  ok: resultado.ok,\n  tempo_ms: tempoExecucao,\n  campos_deal_count: Object.keys(resultado.campos_deal || {}).length,\n  campos_invoice_count: Object.keys(resultado.campos_invoice_base || {}).length,\n  tem_dip: !!resultado.beneficio?.dip,\n  // v7.1: Log de TAGs\n  tags_total: resultado.resumo_tags?.total || 0,\n  tags_criticas: resultado.resumo_tags?.crit || 0,\n  tags_altas: resultado.resumo_tags?.alto || 0\n}));\n\n// RETORNO NO FORMATO N8N\nreturn [{\n  json: {\n    // â•â•â• METADADOS â•â•â•\n    _no: '6A',\n    _versao: '7.1',\n    _timestamp: new Date().toISOString(),\n    _tempo_ms: tempoExecucao,\n    \n    // â•â•â• RESULTADO DO PROCESSAMENTO â•â•â•\n    ...resultado,\n    \n    // â•â•â• CONTEXTO PRESERVADO â•â•â•\n    deal_id,\n    deal,\n    faturas_existentes,\n    tentativa,\n    \n    // â•â•â• MAPEAMENTO DE CAMPOS (para debug e uso nos prÃ³ximos nÃ³s) â•â•â•\n    CAMPOS_DEAL_IDS: CD,\n    CAMPOS_INVOICE_IDS: CI,\n    CAMPOS_EXTRAS: CAMPOS_EXTRAS\n  }\n}];"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    5728,
    25936
  ],
  "id": "15c7a47a-1001-458f-9589-fe6e5c51e3c6",
  "name": "6A. Calculo do Historico de credito (PDF)"
}