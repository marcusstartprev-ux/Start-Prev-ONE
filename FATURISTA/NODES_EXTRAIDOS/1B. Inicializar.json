{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 1B - INICIALIZAR EXECUÃ‡ÃƒO (V19.2 - CORREÃ‡Ã•ES CRÃTICAS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 02/02/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// FUNÃ‡Ã•ES DESTE NÃ“:\n// âœ… 1. Extrair dados do webhook (deal_id, file_id)\n// âœ… 2. Extrair dados do BUSCAR DEAL (CPF, NB, MR, nome, etc.)\n// âœ… 3. Validar campos obrigatÃ³rios (fail fast)\n// âœ… 4. Normalizar dados (CPF, NB, MR, Nome)\n// âœ… 5. Centralizar configuraÃ§Ãµes (URLs, chats, tokens)\n// âœ… 6. Montar links prÃ©-formatados\n// âœ… 7. Criar contexto de execuÃ§Ã£o (rastreabilidade)\n//\n// CHANGELOG:\n// V19.2 (02/02/2026): ğŸ”§ FIX CRÃTICO - Deal ID e File ID do BUSCAR DEAL\n//                     - Deal ID: input.result.ID\n//                     - File ID: campo UF_CRM_1765924938 do Deal\n//                     - Nome webhook correto: '1. Webhook'\n// V19 (01/02/2026): ğŸ”§ CORREÃ‡ÃƒO CRÃTICA - Busca CPF/NB/MR do nÃ³ BUSCAR DEAL\n// V18 (02/01/2026): VersÃ£o completa com todas as melhorias\n// V17 (26/12/2025): VersÃ£o bÃ¡sica (sÃ³ deal_id)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1. CONFIGURAÃ‡Ã•ES CENTRALIZADAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// IMPORTANTE: Altere aqui se mudar domÃ­nio, token ou chats!\n\nconst CONFIG = {\n  // Bitrix24\n  BITRIX_DOMAIN: 'startprev.bitrix24.com.br',\n  BITRIX_USER_ID: '110798',\n  BITRIX_TOKEN: '2itn6qbjhoj6y42x',\n  \n  // Chats (Open Channels)\n  CHAT_SUCESSO: 'chat282584',\n  CHAT_ERRO: 'chat282150',\n  \n  // Smart Invoice\n  ENTITY_TYPE_ID_INVOICE: 31,\n  \n  // VersÃ£o\n  VERSAO: 'V19.2',\n  \n  // ValidaÃ§Ãµes\n  CPF_MIN_DIGITOS: 11,\n  NB_MIN_DIGITOS: 9,\n};\n\n// URLs derivadas (nÃ£o editar)\nCONFIG.BITRIX_REST = `https://${CONFIG.BITRIX_DOMAIN}/rest/${CONFIG.BITRIX_USER_ID}/${CONFIG.BITRIX_TOKEN}`;\nCONFIG.BITRIX_URL = `https://${CONFIG.BITRIX_DOMAIN}`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.1 IDs DOS CAMPOS DO DEAL (BITRIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CD = {\n  cpf:              'UF_CRM_5F7DD07B0ADB5',\n  nb:               'UF_CRM_1737470444334',\n  nit:              'UF_CRM_1766282969',\n  mr_cliente:       'UF_CRM_1741726157749',\n  categoria:        'UF_CRM_5F7DD07B0295D',\n  banco:            'UF_CRM_1603216440272',\n  endereco_banco:   'UF_CRM_1603216499370',\n  agencia_banco:    'UF_CRM_1762558313',\n  dn_mamae:         'UF_CRM_1602615428011',\n  dn_filho:         'UF_CRM_5F7DD07B1997D',\n  dib:              'UF_CRM_1765928945',\n  dip:              'UF_CRM_1766439387',\n  dcb:              'UF_CRM_1748433331869',\n  file_id:          'UF_CRM_1765924938',  // ğŸ”§ V19.2: Campo do File ID no Deal\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2. FUNÃ‡Ã•ES DE NORMALIZAÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n/**\n * Remove tudo que nÃ£o Ã© nÃºmero\n */\nconst somenteNumeros = (valor) => {\n  if (!valor) return '';\n  return String(valor).replace(/\\D/g, '');\n};\n\n/**\n * Normaliza CPF (remove formataÃ§Ã£o, valida tamanho)\n */\nconst normalizarCPF = (cpf) => {\n  const numeros = somenteNumeros(cpf);\n  if (numeros.length < CONFIG.CPF_MIN_DIGITOS) return null;\n  // Pega os Ãºltimos 11 dÃ­gitos (caso tenha zeros Ã  esquerda extras)\n  return numeros.slice(-11);\n};\n\n/**\n * Formata CPF para exibiÃ§Ã£o: 000.000.000-00\n */\nconst formatarCPF = (cpf) => {\n  const num = normalizarCPF(cpf);\n  if (!num || num.length !== 11) return cpf || '';\n  return `${num.slice(0,3)}.${num.slice(3,6)}.${num.slice(6,9)}-${num.slice(9)}`;\n};\n\n/**\n * Normaliza NB (remove formataÃ§Ã£o)\n */\nconst normalizarNB = (nb) => {\n  const numeros = somenteNumeros(nb);\n  if (numeros.length < CONFIG.NB_MIN_DIGITOS) return null;\n  return numeros;\n};\n\n/**\n * Formata NB para exibiÃ§Ã£o: 000.000.000-0\n */\nconst formatarNB = (nb) => {\n  const num = normalizarNB(nb);\n  if (!num || num.length < 10) return nb || '';\n  return `${num.slice(0,3)}.${num.slice(3,6)}.${num.slice(6,9)}-${num.slice(9)}`;\n};\n\n/**\n * Normaliza NIT (remove formataÃ§Ã£o)\n */\nconst normalizarNIT = (nit) => {\n  return somenteNumeros(nit) || null;\n};\n\n/**\n * Parse de valor monetÃ¡rio â†’ nÃºmero\n * Aceita: \"1518|BRL\", \"R$ 1.518,00\", \"1518.00\", \"1518,00\"\n */\nconst normalizarMR = (valor) => {\n  if (valor === null || valor === undefined) return null;\n  if (typeof valor === 'number') return Math.floor(valor * 100) / 100;\n  \n  let str = String(valor).trim();\n  \n  // Remove \"BRL\", \"R$\", espaÃ§os\n  str = str.replace(/\\|?BRL/gi, '').replace(/R\\$\\s*/gi, '').trim();\n  \n  // Trata formato brasileiro (1.234,56) vs americano (1,234.56)\n  if (str.includes('.') && str.includes(',')) {\n    const lastDot = str.lastIndexOf('.');\n    const lastComma = str.lastIndexOf(',');\n    if (lastComma > lastDot) {\n      // Formato brasileiro: 1.234,56\n      str = str.replace(/\\./g, '').replace(',', '.');\n    } else {\n      // Formato americano: 1,234.56\n      str = str.replace(/,/g, '');\n    }\n  } else if (str.includes(',')) {\n    str = str.replace(',', '.');\n  }\n  \n  const num = parseFloat(str);\n  return Number.isFinite(num) ? Math.floor(num * 100) / 100 : null;\n};\n\n/**\n * Normaliza nome (trim, capitalizaÃ§Ã£o)\n */\nconst normalizarNome = (nome) => {\n  if (!nome) return null;\n  \n  // Remove espaÃ§os extras\n  let n = String(nome).trim().replace(/\\s+/g, ' ');\n  \n  // Capitaliza cada palavra (exceto conectivos)\n  const conectivos = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  n = n.toLowerCase().split(' ').map((palavra, idx) => {\n    if (idx > 0 && conectivos.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n  \n  return n;\n};\n\n/**\n * Gera ID Ãºnico para esta execuÃ§Ã£o\n */\nconst gerarExecucaoId = (dealId) => {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8);\n  return `${dealId}_${timestamp}_${random}`;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3. EXTRAIR DADOS (MÃšLTIPLAS FONTES)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $json;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.0 BUSCAR DADOS DO DEAL (FONTE PRINCIPAL - V19.2)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ğŸ”§ V19.2: O input do 1B vem do BUSCAR DEAL, entÃ£o os dados estÃ£o em input.result\nconst dealResult = input.result || {};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.1 EXTRAIR DEAL_ID (mÃºltiplas fontes possÃ­veis)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet dealId = null;\n\n// ğŸ”§ V19.2: FONTE PRINCIPAL - input.result.ID (do BUSCAR DEAL)\nif (dealResult.ID) {\n  dealId = dealResult.ID;\n}\n\n// FONTE 2: Tentar via $() se nÃ£o achou\nif (!dealId) {\n  try {\n    const buscarDealNode = $('BUSCAR DEAL').first()?.json?.result;\n    if (buscarDealNode?.ID) {\n      dealId = buscarDealNode.ID;\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// FONTE 3: Webhook direto (fallback)\nif (!dealId) {\n  try {\n    const wh = $('1. Webhook').first()?.json || {};\n    const whQuery = wh.query || {};\n    const whBody = wh.body || {};\n    dealId = whQuery.deal_id || whBody.deal_id || wh.deal_id;\n    \n    // document_id[2] format\n    if (!dealId && whBody['document_id[2]']) {\n      dealId = String(whBody['document_id[2]']).replace('DEAL_', '');\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// Converter para nÃºmero\ndealId = dealId ? parseInt(String(dealId).replace(/\\D/g, '')) : null;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.2 EXTRAIR FILE_ID (mÃºltiplas fontes possÃ­veis)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet rawFileId = null;\n\n// ğŸ”§ V19.2: FONTE PRINCIPAL - Campo do Deal (UF_CRM_1765924938)\nrawFileId = dealResult[CD.file_id];\n\n// FONTE 2: Tentar via $() se nÃ£o achou\nif (!rawFileId) {\n  try {\n    const buscarDealNode = $('BUSCAR DEAL').first()?.json?.result;\n    if (buscarDealNode?.[CD.file_id]) {\n      rawFileId = buscarDealNode[CD.file_id];\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// FONTE 3: Webhook direto (fallback)\nif (!rawFileId) {\n  try {\n    const wh = $('1. Webhook').first()?.json || {};\n    const whQuery = wh.query || {};\n    const whBody = wh.body || {};\n    rawFileId = whQuery.file_id || whBody.file_id || wh.file_id;\n  } catch (e) { /* ignora */ }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.3 EXTRAIR OUTROS CAMPOS DO WEBHOOK (tentativa, recalcular, telefone)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet rawTentativa = null;\nlet rawRecalcular = null;\nlet rawTelefone = null;\n\ntry {\n  const wh = $('1. Webhook').first()?.json || {};\n  const whQuery = wh.query || {};\n  const whBody = wh.body || {};\n  \n  rawTentativa = whQuery.tentativa || whBody.tentativa || wh.tentativa;\n  rawRecalcular = whQuery.recalcular || whBody.recalcular || whQuery.recalcular_sempre || whBody.recalcular_sempre;\n  rawTelefone = whQuery.telefone || whBody.telefone || wh.telefone;\n} catch (e) { /* ignora */ }\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4. EXTRAIR DADOS DO DEAL (CAMPOS DO BITRIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst rawCPF = dealResult[CD.cpf];\nconst rawNB = dealResult[CD.nb];\nconst rawNIT = dealResult[CD.nit];\nconst rawMR = dealResult[CD.mr_cliente];\nconst rawNome = dealResult.TITLE;\nconst rawContactId = dealResult.CONTACT_ID;\nconst rawCategoria = dealResult[CD.categoria];\nconst rawBanco = dealResult[CD.banco];\nconst rawEnderecoBanco = dealResult[CD.endereco_banco];\nconst rawAgenciaBanco = dealResult[CD.agencia_banco];\nconst rawDnMamae = dealResult[CD.dn_mamae];\nconst rawDnFilho = dealResult[CD.dn_filho];\nconst rawDIB = dealResult[CD.dib];\nconst rawDIP = dealResult[CD.dip];\nconst rawDCB = dealResult[CD.dcb];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5. VALIDAÃ‡Ã•ES (FAIL FAST)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst erros = [];\nconst avisos = [];\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.1 VALIDAR DEAL_ID (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!dealId || dealId <= 0) {\n  return {\n    erro: true,\n    tipo_erro: 'DEAL_ID_AUSENTE',\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'DEAL ID NÃƒO INFORMADO',\n      mensagem: 'Webhook chamado sem Deal ID vÃ¡lido. Verifique a automaÃ§Ã£o que dispara o webhook.',\n      severidade: 3,\n      bloqueia: true\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      input_result_ID: input?.result?.ID,\n      input_keys: Object.keys(input || {}).slice(0, 10),\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.2 VALIDAR FILE_ID (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!rawFileId) {\n  return {\n    erro: true,\n    tipo_erro: 'FILE_ID_AUSENTE',\n    deal_id: dealId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'PDF NÃƒO INFORMADO',\n      mensagem: `Deal ${dealId}: Campo file_id nÃ£o encontrado. Verifique se o extrato foi anexado e se o campo UF_CRM_1765924938 estÃ¡ preenchido.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      campo_file_id: CD.file_id,\n      valor_no_deal: dealResult[CD.file_id],\n      deal_result_tem_dados: !!dealResult.ID,\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.3 VALIDAR BUSCAR DEAL (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!dealResult || !dealResult.ID) {\n  return {\n    erro: true,\n    tipo_erro: 'DEAL_NAO_ENCONTRADO',\n    deal_id: dealId,\n    file_id: rawFileId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'DEAL NÃƒO ENCONTRADO',\n      mensagem: `Deal ${dealId}: NÃ£o foi possÃ­vel buscar os dados do Deal no Bitrix. Verifique se o Deal existe e se a API estÃ¡ funcionando.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.4 VALIDAR CPF (OBRIGATÃ“RIO para buscar faturas)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst cpfNormalizado = normalizarCPF(rawCPF);\n\nif (!cpfNormalizado) {\n  return {\n    erro: true,\n    tipo_erro: 'CPF_AUSENTE_NO_DEAL',\n    deal_id: dealId,\n    file_id: rawFileId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'CPF NÃƒO PREENCHIDO NO DEAL',\n      mensagem: `Deal ${dealId}: Campo CPF nÃ£o estÃ¡ preenchido no Deal (${rawCPF || 'vazio'}). Preencha o CPF no Bitrix antes de faturar.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      campo_cpf: CD.cpf,\n      valor_bruto: rawCPF,\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.5 AVISOS (nÃ£o bloqueiam, mas registram)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!rawNB) {\n  avisos.push({ campo: 'nb', msg: 'NB nÃ£o preenchido no Deal - serÃ¡ extraÃ­do do PDF' });\n}\nif (!rawMR) {\n  avisos.push({ campo: 'mr', msg: 'MR nÃ£o preenchido no Deal - serÃ¡ extraÃ­do do PDF' });\n}\nif (!rawContactId) {\n  avisos.push({ campo: 'contact_id', msg: 'Contact ID nÃ£o vinculado - fatura pode nÃ£o vincular ao contato' });\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6. NORMALIZAR DADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dados = {\n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  cpf: cpfNormalizado,\n  cpf_formatado: formatarCPF(cpfNormalizado),\n  contact_id: rawContactId ? String(rawContactId) : null,\n  nome: normalizarNome(rawNome),\n  \n  // Arquivos\n  file_id: String(rawFileId),\n  disk_file_id: parseInt(rawFileId),\n  \n  // BenefÃ­cio\n  nb: normalizarNB(rawNB),\n  nb_formatado: formatarNB(rawNB),\n  nit: normalizarNIT(rawNIT),\n  mr: normalizarMR(rawMR),\n  mr_raw: rawMR, // MantÃ©m original para debug\n  \n  // Datas do benefÃ­cio\n  dib: rawDIB || null,\n  dip: rawDIP || null,\n  dcb: rawDCB || null,\n  dn_mamae: rawDnMamae || null,\n  dn_filho: rawDnFilho || null,\n  \n  // Banco\n  banco: rawBanco || null,\n  endereco_banco: rawEnderecoBanco || null,\n  agencia_banco: rawAgenciaBanco || null,\n  \n  // Categoria\n  categoria: rawCategoria || null,\n  \n  // Telefone (do webhook)\n  telefone: rawTelefone ? String(rawTelefone).trim() : null,\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 7. MONTAR LINKS PRÃ‰-FORMATADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst links = {\n  // Deal\n  deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`,\n  deal_edit: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/?init_mode=edit`,\n  \n  // Contato (se houver)\n  contact: dados.contact_id \n    ? `${CONFIG.BITRIX_URL}/crm/contact/details/${dados.contact_id}/` \n    : null,\n  \n  // Arquivo PDF\n  file: `${CONFIG.BITRIX_URL}/disk/showFile/${dados.file_id}/`,\n  \n  // Chats\n  chat_sucesso: `${CONFIG.BITRIX_URL}/online/?IM_DIALOG=${CONFIG.CHAT_SUCESSO}`,\n  chat_erro: `${CONFIG.BITRIX_URL}/online/?IM_DIALOG=${CONFIG.CHAT_ERRO}`,\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 8. CONTEXTO DE EXECUÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tentativa = parseInt(rawTentativa) || 1;\nconst isRetry = tentativa > 1;\nconst recalcularSempre = rawRecalcular === true || rawRecalcular === 'true' || rawRecalcular === '1';\n\nconst execucao = {\n  id: gerarExecucaoId(dealId),\n  inicio: new Date().toISOString(),\n  tentativa: tentativa,\n  is_retry: isRetry,\n  recalcular_sempre: recalcularSempre,\n  versao: CONFIG.VERSAO,\n  origem: isRetry ? 'retry' : 'webhook',\n  duracao_ms: Date.now() - inicio\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 9. LOG PARA DEBUG\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst log = {\n  deal_id: dealId,\n  cpf: dados.cpf_formatado,\n  file_id: dados.file_id,\n  nome: dados.nome,\n  nb: dados.nb_formatado,\n  mr: dados.mr,\n  tentativa: tentativa,\n  avisos: avisos.length,\n  versao: CONFIG.VERSAO,\n  fonte_deal_id: 'input.result.ID',\n  fonte_file_id: 'Deal[UF_CRM_1765924938]',\n};\n\nconsole.log('[1B] InicializaÃ§Ã£o V19.2:', JSON.stringify(log, null, 2));\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 10. RETORNO COMPLETO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // â•â•â• STATUS â•â•â•\n  erro: false,\n  validado: true,\n  \n  // â•â•â• METADADOS â•â•â•\n  _no: '1B',\n  _versao: CONFIG.VERSAO,\n  _timestamp: new Date().toISOString(),\n  \n  // â•â•â• IDENTIFICAÃ‡ÃƒO (NORMALIZADOS) â•â•â•\n  deal_id: dados.deal_id,\n  cpf: dados.cpf,\n  cpf_formatado: dados.cpf_formatado,\n  contact_id: dados.contact_id,\n  nome: dados.nome,\n  telefone: dados.telefone,\n  \n  // â•â•â• ARQUIVOS â•â•â•\n  file_id: dados.file_id,\n  disk_file_id: dados.disk_file_id,\n  \n  // â•â•â• BENEFÃCIO (NORMALIZADOS) â•â•â•\n  nb: dados.nb,\n  nb_formatado: dados.nb_formatado,\n  nit: dados.nit,\n  mr: dados.mr,\n  mr_raw: dados.mr_raw,\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  dib: dados.dib,\n  dip: dados.dip,\n  dcb: dados.dcb,\n  dn_mamae: dados.dn_mamae,\n  dn_filho: dados.dn_filho,\n  \n  // â•â•â• BANCO â•â•â•\n  banco: dados.banco,\n  endereco_banco: dados.endereco_banco,\n  agencia_banco: dados.agencia_banco,\n  \n  // â•â•â• CATEGORIA â•â•â•\n  categoria: dados.categoria,\n  \n  // â•â•â• CONFIGURAÃ‡Ã•ES CENTRALIZADAS â•â•â•\n  config: {\n    bitrix_url: CONFIG.BITRIX_URL,\n    bitrix_rest: CONFIG.BITRIX_REST,\n    chat_sucesso: CONFIG.CHAT_SUCESSO,\n    chat_erro: CONFIG.CHAT_ERRO,\n    entity_type_id_invoice: CONFIG.ENTITY_TYPE_ID_INVOICE,\n  },\n  \n  // â•â•â• IDs DOS CAMPOS (para outros nÃ³s usarem) â•â•â•\n  CAMPOS_DEAL: CD,\n  \n  // â•â•â• LINKS PRÃ‰-MONTADOS â•â•â•\n  links: links,\n  \n  // â•â•â• EXECUÃ‡ÃƒO â•â•â•\n  execucao: execucao,\n  \n  // â•â•â• COMPATIBILIDADE V17/V18 â•â•â•\n  tentativa: tentativa,\n  recalcular_sempre: recalcularSempre,\n  versao: CONFIG.VERSAO,\n  \n  // â•â•â• AVISOS (nÃ£o bloqueiam) â•â•â•\n  avisos: avisos,\n  alertas_lista: [], // SerÃ¡ preenchido por outros nÃ³s\n  destaques: [],     // SerÃ¡ preenchido por outros nÃ³s\n  \n  // â•â•â• DEBUG â•â•â•\n  _debug_1b: log\n};"
  },
  "id": "ba3bb24a-743e-4dd9-ad30-1d7b54378a66",
  "name": "1B. Inicializar",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    4032,
    26512
  ]
}