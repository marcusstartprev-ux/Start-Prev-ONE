{
  "parameters": {
    "mode": "runOnceForEachItem",
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 14 - PROCESSAR RESPOSTA FATURA (V23 - COM CAPTURA DE IDS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Processar resposta apÃ³s criaÃ§Ã£o das faturas\n// ENTRADA: Output do 13. Atualizar Deal (via 13A. IF Pular)\n// SAÃDA: Dados formatados para prÃ³ximos nÃ³s COM IDS DAS FATURAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// ATUALIZAÃ‡ÃƒO V23 (08/01/2026):\n// âœ… MANTÃ‰M TUDO DO V22-COMPATIVEL-ASAAS\n// âœ… ðŸ”¥ CAPTURA IDS DAS FATURAS DO NÃ“ 10 (Criar Fatura)\n// âœ… GERA LINKS CORRETOS PARA AS FATURAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a (nÃ£o quebra se nÃ£o existir)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\nconst buscarTodosNo = (nomeNo) => {\n  try {\n    return $(nomeNo).all() || [];\n  } catch (e) {\n    return [];\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ðŸ”¥ CAPTURAR IDS DAS FATURAS CRIADAS NO NÃ“ 10\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst resultadosNo10 = buscarTodosNo('10. Criar Fatura');\nconst idsFromNo10 = resultadosNo10.map(item => {\n  const invoiceId = item.json?.result?.item?.id;\n  return {\n    invoice_id: invoiceId,\n    link: invoiceId ? `https://startprev.bitrix24.com.br/crm/type/31/details/${invoiceId}/` : null,\n    title: item.json?.result?.item?.title || '',\n    // Extrair parcela do tÃ­tulo (ex: \"SM MARIA - Parcela 1/3 - 01/2026\")\n    parcela_extraida: (() => {\n      const match = (item.json?.result?.item?.title || '').match(/Parcela (\\d+)/i);\n      return match ? parseInt(match[1]) : null;\n    })()\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DOS NÃ“S (com fallback seguro)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst relatorio = buscarNo('12. Gerar RelatÃ³rio HTML');\nconst consolidar = buscarNo('11. Consolidar');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados9 = buscarNo('9. Preparar Fatura');\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\n\n// Resposta do Atualizar Deal (nÃ³ anterior direto)\nconst resp = $json || {};\nconst dealAtualizado = resp.result === true;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS COM FALLBACKS MÃšLTIPLOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Dados das faturas (dos nÃ³s anteriores - sem IDs ainda)\nconst faturasSemId = \n  relatorio.faturas_criadas || \n  consolidar.faturas_criadas || \n  dados9.faturas_criar ||\n  dados6D.faturas_criar ||\n  [];\n\nconst faturasErro = \n  relatorio.faturas_erro || \n  consolidar.faturas_erro || \n  [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ðŸ”¥ MESCLAR FATURAS COM IDS DO NÃ“ 10\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst faturasCriadas = faturasSemId.map((fatura, index) => {\n  // Tentar encontrar o ID correspondente pelo Ã­ndice ou pela parcela\n  let idInfo = idsFromNo10[index];\n  \n  // Se nÃ£o encontrou pelo Ã­ndice, tentar pela parcela\n  if (!idInfo?.invoice_id && fatura.parcela) {\n    idInfo = idsFromNo10.find(i => i.parcela_extraida === fatura.parcela);\n  }\n  \n  return {\n    ...fatura,\n    invoice_id: idInfo?.invoice_id || fatura.invoice_id || fatura.id || null,\n    link: idInfo?.link || fatura.link || null\n  };\n});\n\nconst totalCriadas = faturasCriadas.length;\nconst totalErro = faturasErro.length;\n\n// Resumo (mÃºltiplas fontes)\nconst resumo = \n  relatorio.resumo || \n  consolidar.resumo || \n  normalizador.resumo || \n  dados6D.resumo ||\n  dados9.resumo ||\n  {};\n\n// Deal ID (mÃºltiplas fontes)\nconst dealId = \n  relatorio.deal_id || \n  consolidar.deal_id || \n  normalizador.deal_id || \n  dados6D.deal_id ||\n  dados1B.deal_id ||\n  dados9.deal_id ||\n  0;\n\n// Status geral\nconst status = \n  relatorio.status || \n  consolidar.status || \n  dados6D.status ||\n  (dealAtualizado ? 'SUCESSO' : 'PENDENTE');\n\nconst sucesso = (status === 'SUCESSO' || status === 'OK') && dealAtualizado;\n\n// IDs das faturas criadas (agora com IDs reais!)\nconst idsInvoices = faturasCriadas\n  .map(f => f.invoice_id)\n  .filter(Boolean);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst asaasBoleto = dados9C.asaas_boleto_criado || false;\nconst asaasPaymentId = dados9C.asaas_payment_id || '';\nconst asaasBoletoUrl = dados9C.asaas_boleto_url || '';\nconst asaasInvoiceUrl = dados9C.asaas_invoice_url || '';\nconst asaasNossoNumero = dados9C.asaas_nosso_numero || '';\nconst asaasVencimento = dados9C.asaas_vencimento || '';\nconst asaasValor = dados9C.asaas_valor || 0;\nconst asaasStatus = dados9C.asaas_status || '';\nconst asaasCustomerId = dados9C.asaas_customer_id || '';\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '';\n  try {\n    const d = new Date(dataStr);\n    return d.toLocaleDateString('pt-BR');\n  } catch (e) {\n    return dataStr;\n  }\n};\n\nconst vencimentoFormatado = formatarData(asaasVencimento);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ENRIQUECER FATURAS COM DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst faturasCriadasComAsaas = faturasCriadas.map((fatura, index) => {\n  const isParcelaAtual = index === 0;\n  \n  return {\n    ...fatura,\n    // Dados do Asaas (sÃ³ na parcela atual)\n    asaas_payment_id: isParcelaAtual ? asaasPaymentId : '',\n    asaas_boleto_url: isParcelaAtual ? asaasBoletoUrl : '',\n    asaas_invoice_url: isParcelaAtual ? asaasInvoiceUrl : '',\n    asaas_nosso_numero: isParcelaAtual ? asaasNossoNumero : '',\n    asaas_vencimento: isParcelaAtual ? vencimentoFormatado : '',\n    asaas_status: isParcelaAtual ? asaasStatus : '',\n    tem_boleto: isParcelaAtual && asaasBoleto\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Status\n  sucesso: sucesso,\n  status: status,\n  deal_atualizado: dealAtualizado,\n  \n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  \n  // Faturas (AGORA COM IDS E LINKS!)\n  faturas_criadas: faturasCriadasComAsaas,\n  faturas_erro: faturasErro,\n  total_criadas: totalCriadas,\n  total_erro: totalErro,\n  ids_invoices: idsInvoices,\n  \n  // Resumo para mensagens\n  resumo: resumo,\n  nome_cliente: resumo.nome || dados1B.nome || '',\n  cpf: resumo.cpf || resumo.cpf_formatado || dados1B.cpf_formatado || dados1B.cpf || '',\n  nb: resumo.nb || resumo.nb_formatado || dados1B.nb_formatado || dados1B.nb || '',\n  mr: resumo.mr || 0,\n  mr_formatado: resumo.mr_formatado || '',\n  honorarios_start: resumo.honorarios_start || resumo.total_start || 0,\n  honorarios_start_formatado: resumo.honorarios_start_formatado || '',\n  saldo_final: resumo.saldo_start_final || resumo.saldo_final || 0,\n  saldo_final_formatado: resumo.saldo_start_final_formatado || '',\n  \n  // Auditoria\n  auditoria: relatorio.auditoria || consolidar.auditoria || dados6D.auditoria || {},\n  tags: relatorio.tags || consolidar.tags || dados6D.tags || [],\n  \n  // Extras para compatibilidade\n  config: dados1B.config || {},\n  links: dados1B.links || {},\n  \n  // DADOS DO ASAAS\n  asaas: {\n    boleto_criado: asaasBoleto,\n    payment_id: asaasPaymentId,\n    boleto_url: asaasBoletoUrl,\n    invoice_url: asaasInvoiceUrl,\n    nosso_numero: asaasNossoNumero,\n    vencimento: asaasVencimento,\n    vencimento_formatado: vencimentoFormatado,\n    valor: asaasValor,\n    status: asaasStatus,\n    customer_id: asaasCustomerId\n  },\n  tem_boleto: asaasBoleto,\n  \n  // Debug\n  _debug: {\n    versao: 'V23-COM-IDS',\n    ids_capturados_no10: idsFromNo10,\n    total_ids_no10: idsFromNo10.length,\n    ids_invoices_final: idsInvoices,\n    fontes_encontradas: {\n      relatorio: !!relatorio.deal_id,\n      consolidar: !!consolidar.deal_id,\n      normalizador: !!normalizador.deal_id,\n      dados6D: !!dados6D.deal_id,\n      dados1B: !!dados1B.deal_id,\n      dados9: !!dados9.deal_id,\n      dados9C: !!dados9C.asaas_boleto_criado,\n      no10: idsFromNo10.length > 0\n    }\n  }\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    8640,
    25936
  ],
  "id": "33115f0f-1420-47bf-a960-cc2a9de22477",
  "name": "14. Processar Resposta Fatura"
}