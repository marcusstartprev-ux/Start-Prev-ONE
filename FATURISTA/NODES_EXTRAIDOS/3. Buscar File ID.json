{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 3 - VALIDAR DUPLICIDADE (V3 - CORRIGIDO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Verificar se jÃ¡ existem faturas para este Deal\n// ENTRADA: Output do 2C (anÃ¡lise de faturas)\n// SAÃDA: erro: true/false + dados para prÃ³ximo nÃ³\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// CHANGELOG V3 (02/01/2026):\n// âœ… CORREÃ‡ÃƒO: Verifica FATURAS EXISTENTES (nÃ£o file_id!)\n// âœ… Pega file_id do 1B (webhook), nÃ£o do 2C\n// âœ… Bloqueia se jÃ¡ tem faturas para evitar duplicidade\n// âœ… Mensagem clara para o usuÃ¡rio\n//\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ctx = $('2C. Analisar Faturas').first().json;\n\n// File ID vem do webhook (via 1B)\nconst fileId = $('1B. Inicializar').first().json.file_id;\n\n// Dados do Deal\nconst dealId = ctx.deal_id;\n\n// Verificar se jÃ¡ tem faturas para este Deal\nconst temFaturas = ctx.tem_faturas || false;\nconst totalFaturas = ctx.stats_faturas?.total || 0;\nconst faturasPendentes = ctx.stats_faturas?.pendentes || 0;\nconst faturasPagas = ctx.stats_faturas?.pagas || 0;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// REGRA 1: Se jÃ¡ tem faturas â†’ BLOQUEAR (nÃ£o duplicar!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (temFaturas && totalFaturas > 0) {\n  return { \n    ...ctx, \n    erro: true, \n    tipo_erro: 'FATURAS_JA_EXISTEM',\n    file_id: fileId,\n    disk_file_id: fileId ? parseInt(fileId) : null,\n    alerta: { \n      tipo: 'AVISO', \n      emoji: 'âš ï¸', \n      titulo: 'FATURAS JÃ EXISTEM', \n      mensagem: `Deal ${dealId} jÃ¡ possui ${totalFaturas} fatura(s) (${faturasPendentes} pendente(s), ${faturasPagas} paga(s)). Processo bloqueado para evitar duplicidade.`, \n      severidade: 2, \n      bloqueia: true \n    }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// REGRA 2: Se nÃ£o tem file_id â†’ BLOQUEAR (nÃ£o tem PDF para processar)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (!fileId) {\n  return { \n    ...ctx, \n    erro: true, \n    tipo_erro: 'PDF_NAO_ENCONTRADO', \n    alerta: { \n      tipo: 'CRITICO', \n      emoji: 'ğŸš¨', \n      titulo: 'PDF NÃƒO ENCONTRADO', \n      mensagem: `Deal ${dealId}: Campo file_id nÃ£o enviado pelo webhook. Verifique se o extrato foi anexado ao Deal.`, \n      severidade: 3, \n      bloqueia: true \n    }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TUDO OK â†’ Continuar para processar PDF\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn { \n  ...ctx, \n  erro: false,\n  file_id: fileId,\n  disk_file_id: parseInt(fileId),\n  validacao: {\n    tem_faturas_existentes: false,\n    total_faturas: 0,\n    pode_criar: true,\n    mensagem: 'OK - Nenhuma fatura existente, pode criar novas'\n  }\n};"
  },
  "id": "e7653bfe-85a6-4aa3-8fa3-0cc91b7ffc05",
  "name": "3. Buscar File ID",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    4608,
    26000
  ]
}