{
  "parameters": {
    "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 15 - MONTAR ITENS_CRIADOS (V23 - DARF + ASAAS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Formatar dados para Chat e Sheets\n// ENTRADA: Output do 14. Processar Resposta Fatura\n// SAÃDA: Dados formatados para 16. Chat Sucesso e 19. Preparar Sheets\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// ATUALIZAÃ‡ÃƒO V23 (12/01/2026):\n// âœ… BASEADO NO V22-COMPATIVEL-ASAAS (mantÃ©m TUDO)\n// ðŸ”¥ ADICIONA dados de DARF do 6D (resumo.darf)\n// ðŸ”¥ PASSA darf para o nÃ³ 16. Chat Sucesso\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a (nÃ£o quebra se nÃ£o existir)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst proc = $json || {};\n\nconst relatorio = buscarNo('12. Gerar RelatÃ³rio HTML');\nconst consolidar = buscarNo('11. Consolidar');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados9 = buscarNo('9. Preparar Fatura');\n\n// NÃ“S DO ASAAS\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS COM FALLBACKS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dealId = proc.deal_id || \n               relatorio.deal_id || \n               consolidar.deal_id || \n               dados6D.deal_id ||\n               dados1B.deal_id ||\n               0;\n\nconst faturasCriadas = proc.faturas_criadas || [];\nconst faturasErro = proc.faturas_erro || [];\n\nconst totalCriadas = proc.total_criadas || faturasCriadas.length;\nconst totalErro = proc.total_erro || faturasErro.length;\n\nconst resumo = proc.resumo || \n               relatorio.resumo || \n               dados6D.resumo ||\n               {};\n\nconst camposAtualizarDeal = relatorio.campos_atualizar_deal || \n                            consolidar.campos_atualizar_deal || \n                            normalizador.campos_atualizar_deal || \n                            dados6D.campos_deal ||\n                            {};\n\n// Alertas para IF Warning\nconst alertasLista = [];\nif (totalErro > 0) {\n  alertasLista.push({ \n    tipo: 'WARNING', \n    codigo: 'ERROS_PARCIAIS', \n    mensagem: `${totalErro} fatura(s) com erro` \n  });\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ðŸ”¥ DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst asaas = proc.asaas || {};\nconst temBoleto = asaas.boleto_criado || proc.tem_boleto || false;\nconst boletoUrl = asaas.boleto_url || asaas.invoice_url || '';\nconst asaasPaymentId = asaas.payment_id || '';\nconst asaasVencimento = asaas.vencimento || '';\nconst asaasVencimentoFormatado = asaas.vencimento_formatado || asaasVencimento || '';\nconst asaasNossoNumero = asaas.nosso_numero || '';\nconst asaasValor = asaas.valor || 0;\nconst asaasStatus = asaas.status || '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ðŸ”¥ DADOS DA DARF (NOVO V23!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// A DARF vem do 6D.resumo.darf ou 6C.resumo\nconst darfResumo6D = dados6D.resumo?.darf || {};\nconst darfResumo6C = dados6C.resumo || {};\n\n// Truncar para 2 casas decimais\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\n// Verificar se Start paga DARF\nconst startPagaDarf = darfResumo6D.start_paga_darf || \n                      darfResumo6C.start_paga_darf || \n                      false;\n\n// Valor total da DARF\nconst valorDarfTotal = tr(\n  darfResumo6D.valor_darf_total || \n  darfResumo6C.valor_darf_original ||\n  0\n);\n\n// Quantidade de parcelas onde DARF foi rateada\nconst qtdParcelasDarf = darfResumo6D.qtd_parcelas_start_recebe || \n                        darfResumo6C.qtd_parcelas_com_darf ||\n                        0;\n\n// Valor aproximado por parcela\nconst valorDarfPorParcela = tr(\n  darfResumo6D.valor_darf_por_parcela_aprox || \n  darfResumo6C.valor_darf_por_parcela_aprox ||\n  0\n);\n\n// Total que Start recebe (honorÃ¡rios + DARF)\nconst totalStartComDarf = tr(\n  darfResumo6C.total_start_com_darf ||\n  resumo.total_start ||\n  0\n);\n\n// Tem DARF vÃ¡lida?\nconst temDarf = startPagaDarf && valorDarfTotal > 0;\n\n// Objeto consolidado de DARF\nconst darf = {\n  start_paga: startPagaDarf,\n  tem_darf: temDarf,\n  valor_total: valorDarfTotal,\n  valor_total_formatado: `R$ ${valorDarfTotal.toFixed(2).replace('.', ',')}`,\n  qtd_parcelas: qtdParcelasDarf,\n  valor_por_parcela: valorDarfPorParcela,\n  valor_por_parcela_formatado: `R$ ${valorDarfPorParcela.toFixed(2).replace('.', ',')}`,\n  total_start_com_darf: totalStartComDarf,\n  total_start_com_darf_formatado: `R$ ${totalStartComDarf.toFixed(2).replace('.', ',')}`\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MONTAR ITENS_CRIADOS (formato esperado + ASAAS + DARF)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst itensCriados = faturasCriadas.map((f, index) => {\n  const isParcelaAtual = index === 0;\n  \n  return {\n    // Dados originais V21\n    invoice_id: f.invoice_id || f.id,\n    link: (f.invoice_id || f.id) ? `https://startprev.bitrix24.com.br/crm/type/31/details/${f.invoice_id || f.id}/` : null,\n    parcela: f.parcela,\n    total_parcelas: f.total_parcelas || totalCriadas,\n    valor_start: f.valor_start,\n    valor_inss: f.valor_inss,\n    valor_cliente: f.valor_cliente,\n    competencia: f.competencia,\n    data_inss: f.data_inss || f.data_pagamento,\n    saldo_restante_start: f.saldo_depois || f.saldo_start_depois || 0,\n    \n    // DARF rateada nesta parcela (V23)\n    valor_darf_rateado: f.valor_darf_rateado || 0,\n    valor_start_total: f.valor_start_total || f.valor_start || 0,\n    \n    // DADOS DO ASAAS (sÃ³ na parcela atual)\n    tem_boleto: isParcelaAtual && temBoleto,\n    boleto_url: isParcelaAtual ? (f.asaas_boleto_url || boletoUrl) : '',\n    asaas_payment_id: isParcelaAtual ? (f.asaas_payment_id || asaasPaymentId) : '',\n    asaas_vencimento: isParcelaAtual ? (f.asaas_vencimento || asaasVencimentoFormatado) : '',\n    asaas_nosso_numero: isParcelaAtual ? (f.asaas_nosso_numero || asaasNossoNumero) : ''\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO (MESMA ESTRUTURA V22 + DARF)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Status\n  sucesso: proc.sucesso !== false && totalErro === 0,\n  status: proc.status || 'SUCESSO',\n  deal_atualizado: proc.deal_atualizado !== false,\n  \n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  \n  // Campos (compatibilidade)\n  campos_atualizar_deal: camposAtualizarDeal,\n  \n  // Contagens\n  total_processadas: totalCriadas + totalErro,\n  total_criadas: totalCriadas,\n  total_puladas: 0,\n  total_erros: totalErro,\n  \n  // Itens formatados (agora com Asaas + DARF)\n  itens_criados: itensCriados,\n  itens_pulados: [],\n  itens_com_erro: faturasErro,\n  \n  // Alertas\n  alertas_lista: alertasLista,\n  \n  // Resumo para mensagens\n  resumo: resumo,\n  nome_cliente: proc.nome_cliente || resumo.nome || dados1B.nome || '',\n  cpf: proc.cpf || resumo.cpf || dados1B.cpf_formatado || '',\n  nb: proc.nb || resumo.nb || dados1B.nb_formatado || '',\n  mr: proc.mr || resumo.mr || 0,\n  mr_formatado: proc.mr_formatado || resumo.mr_formatado || '',\n  honorarios_start: proc.honorarios_start || resumo.honorarios_start || resumo.total_start || 0,\n  honorarios_start_formatado: proc.honorarios_start_formatado || resumo.honorarios_start_formatado || '',\n  saldo_final: proc.saldo_final || resumo.saldo_start_final || 0,\n  saldo_final_formatado: proc.saldo_final_formatado || resumo.saldo_start_final_formatado || '',\n  \n  // Auditoria\n  auditoria: proc.auditoria || dados6D.auditoria || {},\n  tags: proc.tags || dados6D.tags || [],\n  \n  // IDs das faturas\n  ids_invoices: proc.ids_invoices || faturasCriadas.map(f => f.invoice_id || f.id).filter(Boolean),\n  \n  // Config e links\n  config: proc.config || dados1B.config || {},\n  links: proc.links || dados1B.links || {},\n  \n  // DADOS DO ASAAS\n  asaas: {\n    tem_boleto: temBoleto,\n    boleto_url: boletoUrl,\n    payment_id: asaasPaymentId,\n    vencimento: asaasVencimentoFormatado,\n    nosso_numero: asaasNossoNumero,\n    valor: asaasValor,\n    status: asaasStatus\n  },\n  tem_boleto: temBoleto,\n  \n  // ðŸ”¥ DADOS DA DARF (NOVO V23!)\n  darf: darf,\n  tem_darf: temDarf,\n  \n  // Debug\n  _debug: {\n    versao: 'V23-DARF',\n    fontes_encontradas: {\n      proc: !!proc.deal_id,\n      relatorio: !!relatorio.deal_id,\n      consolidar: !!consolidar.deal_id,\n      normalizador: !!normalizador.deal_id,\n      dados6D: !!dados6D.deal_id,\n      dados6C: !!dados6C.resumo,\n      dados1B: !!dados1B.deal_id,\n      dados9C: !!dados9C.asaas_boleto_criado\n    },\n    asaas_encontrado: temBoleto,\n    darf_encontrada: temDarf,\n    darf_fonte: darfResumo6D.start_paga_darf ? '6D.resumo.darf' : (darfResumo6C.start_paga_darf ? '6C.resumo' : 'nenhuma')\n  }\n};"
  },
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [
    8864,
    25936
  ],
  "id": "1a325b0d-cd03-414f-a27c-b1285b1c4099",
  "name": "15. Montar itens_criados"
}