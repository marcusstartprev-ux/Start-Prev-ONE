{
  "name": "Faturista Parte 1",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/crm.item.list",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"entityTypeId\": 31,\n  \"filter\": {\n    \"=parentId2\": \"{{ $('1B. Inicializar').first().json.deal_id }}\"\n  },\n  \"select\": [\n    \"id\",\n    \"title\",\n    \"stageId\",\n    \"assignedById\",\n    \"parentId2\",\n    \"ufCrm_652439CFE551C\",\n    \"ufCrm_6790DAD756E3C\",\n    \"ufCrm_691B6450B46E3\",\n    \"ufCrm_652439D9202B3\",\n    \"ufCrm_652439D8D6B8E\",\n    \"ufCrm_652439D915311\",\n    \"ufCrm_652439D8B3207\",\n    \"ufCrm_652439D8E9608\",\n    \"ufCrm_652439D8CDB53\",\n    \"ufCrm_69442F27CCFB3\",\n    \"ufCrm_69442F5F762AD\"\n  ]\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "63bd6571-66c1-470d-b97e-651dbfed138c",
      "name": "2B. Buscar Faturas CPF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        4160,
        26000
      ],
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 2C - ANALISAR FATURAS (V2.2 - BUSCA DEAL + IDs CORRIGIDOS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 31/01/2026\n// \n// CORREÃ‡Ã•ES V2.2:\n// âœ… Busca dados do Deal do nÃ³ \"BUSCAR DEAL\" (nÃ£o apenas do ctx)\n// âœ… IDs dos campos CORRIGIDOS (faltava underscore: ufCrm_XXXXX)\n// âœ… ValidaÃ§Ã£o de CPF com mensagem clara\n// âœ… Mensagem especÃ­fica sobre competÃªncias duplicadas\n// âœ… Links Ãºteis no retorno de erro\n//\n// MANTIDO DA V2.1:\n// âœ… Flag tem_faturas para IF posterior\n// âœ… Mapeamento por COMPETÃŠNCIA (mais confiÃ¡vel)\n// âœ… SeparaÃ§Ã£o por STATUS (pagas, pendentes, canceladas)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// IDs DOS CAMPOS - SMART INVOICE (CORRIGIDOS 31/01/2026)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CI = {\n  // IdentificaÃ§Ã£o\n  cpf:              'ufCrm_652439CFE551C',\n  nb:               'ufCrm_6790DAD756E3C',\n  \n  // Valores\n  valor_start:      'ufCrm_652439D9202B3',    // Valor Previsto (Start)\n  valor_inss:       'ufCrm_652439D8D6B8E',    // Valor INSS da parcela\n  valor_cliente:    'ufCrm_652439D915311',    // Valor que fica com cliente\n  \n  // Datas\n  data_inss:        'ufCrm_652439D8B3207',    // Data pagamento INSS\n  \n  // CompetÃªncia/Parcela\n  competencia:      'ufCrm_691B6450B46E3',    // \"12/2025\"\n  parcela_numero:   'ufCrm_652439D8E9608',    // 1, 2, 3...\n  parcela_formato:  'ufCrm_652439D8CDB53',    // \"1/3\", \"2/3\"\n  \n  // Controle\n  saldo_restante:   'ufCrm_69442F27CCFB3',    // Saldo Start apÃ³s esta fatura\n  regra_aplicada:   'ufCrm_69442F5F762AD',    // PROGRESSIVO_45, COBRA_TUDO, etc\n};\n\n// IDs alternativos (formato com underscore maiÃºsculo - API pode retornar assim)\nconst CI_ALT = {\n  cpf:              'UF_CRM_652439CFE551C',\n  nb:               'UF_CRM_6790DAD756E3C',\n  valor_start:      'UF_CRM_652439D9202B3',\n  valor_inss:       'UF_CRM_652439D8D6B8E',\n  valor_cliente:    'UF_CRM_652439D915311',\n  data_inss:        'UF_CRM_652439D8B3207',\n  competencia:      'UF_CRM_691B6450B46E3',\n  parcela_numero:   'UF_CRM_652439D8E9608',\n  parcela_formato:  'UF_CRM_652439D8CDB53',\n  saldo_restante:   'UF_CRM_69442F27CCFB3',\n  regra_aplicada:   'UF_CRM_69442F5F762AD',\n};\n\n// IDs dos campos do DEAL\nconst CD = {\n  cpf:              'UF_CRM_5F7DD07B0ADB5',\n  nb:               'UF_CRM_1737470444334',\n  mr_cliente:       'UF_CRM_1741726157749',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡Ã•ES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CONFIG = {\n  // Stages da Smart Invoice (ajustar conforme seu Bitrix)\n  STAGES_PAGAS: ['DT31_2:P', 'DT31_2:WON', 'PAID', 'P'],\n  STAGES_CANCELADAS: ['DT31_2:FAIL', 'DT31_2:LOSE', 'CANCELED', 'F'],\n  STAGES_PENDENTES: ['DT31_2:N', 'DT31_2:NEW', 'DT31_2:PREPARATION', 'NEW', 'N'],\n  \n  // Valor mÃ­nimo para considerar fatura vÃ¡lida\n  VALOR_MINIMO: 0.01,\n  \n  // VersÃ£o\n  VERSAO: 'V2.2',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES AUXILIARES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/**\n * Normaliza CPF/NIT para apenas nÃºmeros\n */\nconst normalizarDocumento = (valor) => {\n  if (!valor) return null;\n  const nums = String(valor).replace(/\\D/g, '');\n  return nums.length >= 11 ? nums : null;\n};\n\n/**\n * Parse de valor monetÃ¡rio (aceita vÃ¡rios formatos)\n */\nconst parseValor = (valor) => {\n  if (valor === null || valor === undefined) return 0;\n  if (typeof valor === 'number') return valor;\n  \n  let str = String(valor).trim();\n  \n  // Formato Bitrix money: \"1518|BRL\"\n  if (str.includes('|')) {\n    str = str.split('|')[0];\n  }\n  \n  str = str.replace(/[R$\\s]/gi, '');\n  \n  if (str.includes('.') && str.includes(',')) {\n    const lastDot = str.lastIndexOf('.');\n    const lastComma = str.lastIndexOf(',');\n    if (lastComma > lastDot) {\n      str = str.replace(/\\./g, '').replace(',', '.');\n    } else {\n      str = str.replace(/,/g, '');\n    }\n  } else if (str.includes(',')) {\n    str = str.replace(',', '.');\n  }\n  \n  const num = parseFloat(str);\n  return Number.isFinite(num) ? Math.floor(num * 100) / 100 : 0;\n};\n\n/**\n * Pega campo da fatura (tenta ambos formatos de ID)\n */\nconst getCampo = (fatura, campo) => {\n  return fatura[CI[campo]] || fatura[CI_ALT[campo]] || null;\n};\n\n/**\n * Cria chave Ãºnica para anti-duplicaÃ§Ã£o\n */\nconst criarChaveUnica = (cpf, nb, competencia) => {\n  const cpfNorm = normalizarDocumento(cpf);\n  if (!cpfNorm || !competencia) return null;\n  return `${cpfNorm}|${nb || 'SEM_NB'}|${competencia}`;\n};\n\n/**\n * Determina status da fatura\n */\nconst getStatusFatura = (stageId) => {\n  if (!stageId) return 'DESCONHECIDO';\n  const stage = String(stageId).toUpperCase();\n  \n  if (CONFIG.STAGES_PAGAS.some(s => stage.includes(s))) return 'PAGA';\n  if (CONFIG.STAGES_CANCELADAS.some(s => stage.includes(s))) return 'CANCELADA';\n  if (CONFIG.STAGES_PENDENTES.some(s => stage.includes(s))) return 'PENDENTE';\n  \n  return 'OUTRO';\n};\n\n/**\n * Cria objeto de alerta padronizado\n */\nconst criarAlerta = (tipo, emoji, titulo, mensagem, severidade = 1, bloqueia = false) => ({\n  tipo,\n  emoji,\n  titulo,\n  mensagem,\n  severidade,\n  bloqueia,\n});\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// INÃCIO DO PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n// Contexto do 1B. Inicializar (dados vÃªm do webhook)\nconst ctx = $('1B. Inicializar').first()?.json || {};\n\n// ğŸ”§ V2.2: Buscar dados do Deal do nÃ³ \"BUSCAR DEAL\"\nconst dealResult = $('BUSCAR DEAL').first()?.json?.result || {};\n\n// Faturas retornadas pelo nÃ³ 2B (crm.item.list)\n// Smart Invoice retorna em { result: { items: [...] } }\nlet faturas = [];\nif (Array.isArray($json?.result?.items)) {\n  faturas = $json.result.items;\n} else if (Array.isArray($json?.result)) {\n  faturas = $json.result;\n} else if (Array.isArray($json?.items)) {\n  faturas = $json.items;\n} else if (Array.isArray($json)) {\n  faturas = $json;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// DADOS DO DEAL (PRIORIZA NÃ“ \"BUSCAR DEAL\", FALLBACK PARA CTX)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst deal = {\n  id: Number(ctx.deal_id) || Number(dealResult.ID) || 0,\n  titulo: dealResult.TITLE || ctx.nome || ctx.nome_cliente || 'Cliente',\n  cpf: normalizarDocumento(dealResult[CD.cpf] || ctx.cpf),\n  nb: dealResult[CD.nb] || ctx.nb || null,\n  contact_id: dealResult.CONTACT_ID || ctx.contact_id || null,\n  mr_cliente: parseValor(dealResult[CD.mr_cliente] || ctx.mr),\n  file_id: ctx.file_id || null,\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// VALIDAÃ‡ÃƒO: CPF Ã‰ OBRIGATÃ“RIO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!deal.cpf) {\n  return {\n    erro: true,\n    tipo_erro: 'CPF_AUSENTE',\n    deal_id: deal.id,\n    file_id: deal.file_id,\n    alerta: criarAlerta(\n      'CRITICO',\n      'ğŸš¨',\n      'CPF NÃƒO INFORMADO',\n      `Deal ${deal.id}: Campo CPF nÃ£o enviado ou invÃ¡lido (vazio). O CPF Ã© necessÃ¡rio para verificar faturas existentes.`,\n      3,\n      true\n    ),\n    links: {\n      deal: `https://startprev.bitrix24.com.br/crm/deal/details/${deal.id}/`,\n    },\n    execucao: {\n      inicio: new Date(inicio).toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio,\n    },\n    \n    // Passar dados mesmo com erro (para nÃ£o quebrar fluxo)\n    cpf_cliente: null,\n    cpf: null,\n    nome_cliente: deal.titulo,\n    contact_id: deal.contact_id,\n    nb_cliente: deal.nb,\n    mr_cliente: deal.mr_cliente,\n    \n    // Flags mesmo com erro\n    tem_faturas: faturas.length > 0,\n    tem_faturas_ativas: false,\n    tem_faturas_pendentes: false,\n    \n    // Stats bÃ¡sicas das faturas encontradas\n    stats_faturas: {\n      total: faturas.length,\n      pagas: 0,\n      pendentes: 0,\n      canceladas: 0,\n      valor_start_cobrado: 0,\n      valor_start_pago: 0,\n      valor_start_pendente: 0,\n      ultima_parcela: 0,\n      ultima_competencia: null,\n      competencias_existentes: [],\n    },\n    \n    // Mapas vazios\n    faturas_existentes: {\n      todas: [],\n      pagas: [],\n      pendentes: [],\n      por_competencia: {},\n      por_data_inss: {},\n      por_chave_unica: {},\n    },\n    \n    saldo_start_ja_cobrado: 0,\n    \n    _debug_2c: {\n      deal_id: deal.id,\n      deal_cpf: null,\n      deal_nb: deal.nb,\n      deal_result_cpf: dealResult[CD.cpf],\n      ctx_cpf: ctx.cpf,\n      faturas_encontradas: faturas.length,\n      motivo_erro: 'CPF nÃ£o encontrado nem no Deal nem no contexto',\n    },\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESSAR FATURAS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst resultado = {\n  // Arrays\n  todas: [],\n  pagas: [],\n  pendentes: [],\n  canceladas: [],\n  \n  // Mapas para anti-duplicaÃ§Ã£o\n  por_competencia: {},\n  por_data_inss: {},\n  por_chave_unica: {},\n  \n  // Totais\n  totais: {\n    quantidade: 0,\n    quantidade_pagas: 0,\n    quantidade_pendentes: 0,\n    quantidade_canceladas: 0,\n    valor_start_total: 0,\n    valor_start_pago: 0,\n    valor_start_pendente: 0,\n    valor_inss_total: 0,\n  },\n  \n  // Controle\n  competencias_existentes: [],\n  ultima_parcela: 0,\n  ultima_competencia: null,\n};\n\nfor (const inv of faturas) {\n  // Extrair dados da fatura\n  const fatura = {\n    id: inv.id || inv.ID || inv.Id || null,\n    titulo: inv.title || inv.TITLE || null,\n    stage_id: inv.stageId || inv.STAGE_ID || inv.STATUS_ID || null,\n    \n    // Campos customizados\n    cpf: normalizarDocumento(getCampo(inv, 'cpf')),\n    nb: getCampo(inv, 'nb'),\n    valor_start: parseValor(getCampo(inv, 'valor_start')),\n    valor_inss: parseValor(getCampo(inv, 'valor_inss')),\n    valor_cliente: parseValor(getCampo(inv, 'valor_cliente')),\n    data_inss: getCampo(inv, 'data_inss'),\n    competencia: getCampo(inv, 'competencia'),\n    parcela_numero: parseInt(getCampo(inv, 'parcela_numero')) || 0,\n    parcela_formato: getCampo(inv, 'parcela_formato'),\n    saldo_restante: parseValor(getCampo(inv, 'saldo_restante')),\n    regra_aplicada: getCampo(inv, 'regra_aplicada'),\n  };\n  \n  // Determinar status\n  fatura.status = getStatusFatura(fatura.stage_id);\n  \n  // Adicionar Ã  lista geral\n  resultado.todas.push(fatura);\n  resultado.totais.quantidade++;\n  \n  // Separar por status\n  switch (fatura.status) {\n    case 'PAGA':\n      resultado.pagas.push(fatura);\n      resultado.totais.quantidade_pagas++;\n      resultado.totais.valor_start_pago += fatura.valor_start;\n      break;\n    case 'PENDENTE':\n      resultado.pendentes.push(fatura);\n      resultado.totais.quantidade_pendentes++;\n      resultado.totais.valor_start_pendente += fatura.valor_start;\n      break;\n    case 'CANCELADA':\n      resultado.canceladas.push(fatura);\n      resultado.totais.quantidade_canceladas++;\n      break;\n  }\n  \n  // Somar totais (exceto canceladas)\n  if (fatura.status !== 'CANCELADA') {\n    resultado.totais.valor_start_total += fatura.valor_start;\n    resultado.totais.valor_inss_total += fatura.valor_inss;\n  }\n  \n  // Mapear por COMPETÃŠNCIA (principal para anti-duplicaÃ§Ã£o)\n  if (fatura.competencia) {\n    if (!resultado.por_competencia[fatura.competencia]) {\n      resultado.por_competencia[fatura.competencia] = [];\n    }\n    resultado.por_competencia[fatura.competencia].push(fatura);\n    \n    // Lista de competÃªncias existentes\n    if (!resultado.competencias_existentes.includes(fatura.competencia)) {\n      resultado.competencias_existentes.push(fatura.competencia);\n    }\n  }\n  \n  // Mapear por DATA INSS (backup)\n  if (fatura.data_inss) {\n    if (!resultado.por_data_inss[fatura.data_inss]) {\n      resultado.por_data_inss[fatura.data_inss] = [];\n    }\n    resultado.por_data_inss[fatura.data_inss].push(fatura);\n  }\n  \n  // Mapear por CHAVE ÃšNICA (CPF+NB+COMPETÃŠNCIA)\n  const chave = criarChaveUnica(fatura.cpf || deal.cpf, fatura.nb || deal.nb, fatura.competencia);\n  if (chave) {\n    if (!resultado.por_chave_unica[chave]) {\n      resultado.por_chave_unica[chave] = [];\n    }\n    resultado.por_chave_unica[chave].push(fatura);\n  }\n  \n  // Rastrear Ãºltima parcela\n  if (fatura.parcela_numero > resultado.ultima_parcela) {\n    resultado.ultima_parcela = fatura.parcela_numero;\n    resultado.ultima_competencia = fatura.competencia;\n  }\n}\n\n// Truncar totais para 2 casas\nresultado.totais.valor_start_total = Math.floor(resultado.totais.valor_start_total * 100) / 100;\nresultado.totais.valor_start_pago = Math.floor(resultado.totais.valor_start_pago * 100) / 100;\nresultado.totais.valor_start_pendente = Math.floor(resultado.totais.valor_start_pendente * 100) / 100;\nresultado.totais.valor_inss_total = Math.floor(resultado.totais.valor_inss_total * 100) / 100;\n\n// Ordenar competÃªncias\nresultado.competencias_existentes.sort();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FLAGS DE CONTROLE (PARA IF POSTERIOR)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst flags = {\n  // Principal: TEM FATURAS?\n  tem_faturas: resultado.totais.quantidade > 0,\n  tem_faturas_ativas: (resultado.totais.quantidade_pagas + resultado.totais.quantidade_pendentes) > 0,\n  tem_faturas_pendentes: resultado.totais.quantidade_pendentes > 0,\n  tem_faturas_pagas: resultado.totais.quantidade_pagas > 0,\n  \n  // Saldo\n  saldo_start_ja_cobrado: resultado.totais.valor_start_total,\n  saldo_start_ja_pago: resultado.totais.valor_start_pago,\n  saldo_start_pendente: resultado.totais.valor_start_pendente,\n  \n  // Pode criar mais faturas?\n  pode_criar_novas: true, // SerÃ¡ validado nos prÃ³ximos nÃ³s\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// LOG PARA DEBUG\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst log = {\n  deal_id: deal.id,\n  deal_cpf: deal.cpf,\n  deal_nb: deal.nb,\n  deal_titulo: deal.titulo,\n  deal_mr: deal.mr_cliente,\n  faturas_encontradas: resultado.totais.quantidade,\n  faturas_pagas: resultado.totais.quantidade_pagas,\n  faturas_pendentes: resultado.totais.quantidade_pendentes,\n  faturas_canceladas: resultado.totais.quantidade_canceladas,\n  valor_start_ja_cobrado: resultado.totais.valor_start_total,\n  competencias: resultado.competencias_existentes,\n  ultima_parcela: resultado.ultima_parcela,\n  fonte_cpf: dealResult[CD.cpf] ? 'BUSCAR_DEAL' : (ctx.cpf ? 'CTX' : 'NENHUMA'),\n};\n\nconsole.log('[2C] AnÃ¡lise de Faturas V2.2:', JSON.stringify(log, null, 2));\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// RETORNO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nreturn {\n  // Manter contexto anterior\n  ...ctx,\n  \n  // Metadados da execuÃ§Ã£o\n  _no: '2C',\n  _versao: CONFIG.VERSAO,\n  _timestamp: new Date().toISOString(),\n  _tempo_ms: Date.now() - inicio,\n  \n  // Dados do Deal (OBRIGATÃ“RIO para nÃ³s seguintes)\n  deal_id: deal.id,\n  cpf_cliente: deal.cpf,\n  cpf: deal.cpf,\n  nome_cliente: deal.titulo,\n  contact_id: deal.contact_id,\n  nb_cliente: deal.nb,\n  mr_cliente: deal.mr_cliente,\n  file_id: deal.file_id,\n  \n  // FLAGS PARA IF (principais)\n  tem_faturas: flags.tem_faturas,\n  tem_faturas_ativas: flags.tem_faturas_ativas,\n  tem_faturas_pendentes: flags.tem_faturas_pendentes,\n  \n  // EstatÃ­sticas\n  stats_faturas: {\n    total: resultado.totais.quantidade,\n    pagas: resultado.totais.quantidade_pagas,\n    pendentes: resultado.totais.quantidade_pendentes,\n    canceladas: resultado.totais.quantidade_canceladas,\n    valor_start_cobrado: resultado.totais.valor_start_total,\n    valor_start_pago: resultado.totais.valor_start_pago,\n    valor_start_pendente: resultado.totais.valor_start_pendente,\n    ultima_parcela: resultado.ultima_parcela,\n    ultima_competencia: resultado.ultima_competencia,\n    competencias_existentes: resultado.competencias_existentes,\n  },\n  \n  // Mapas para anti-duplicaÃ§Ã£o (usados no NÃ³ 12)\n  faturas_existentes: {\n    todas: resultado.todas,\n    pagas: resultado.pagas,\n    pendentes: resultado.pendentes,\n    por_competencia: resultado.por_competencia,\n    por_data_inss: resultado.por_data_inss,\n    por_chave_unica: resultado.por_chave_unica,\n  },\n  \n  // Saldo Start (para cÃ¡lculos)\n  saldo_start_ja_cobrado: resultado.totais.valor_start_total,\n  \n  // Debug\n  _debug_2c: log,\n};"
      },
      "id": "3ce5f24c-a90d-4922-8dd7-3ee4cdae14eb",
      "name": "2C. Analisar Faturas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4384,
        26000
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 3 - VALIDAR DUPLICIDADE (V3 - CORRIGIDO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Verificar se jÃ¡ existem faturas para este Deal\n// ENTRADA: Output do 2C (anÃ¡lise de faturas)\n// SAÃDA: erro: true/false + dados para prÃ³ximo nÃ³\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// CHANGELOG V3 (02/01/2026):\n// âœ… CORREÃ‡ÃƒO: Verifica FATURAS EXISTENTES (nÃ£o file_id!)\n// âœ… Pega file_id do 1B (webhook), nÃ£o do 2C\n// âœ… Bloqueia se jÃ¡ tem faturas para evitar duplicidade\n// âœ… Mensagem clara para o usuÃ¡rio\n//\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ctx = $('2C. Analisar Faturas').first().json;\n\n// File ID vem do webhook (via 1B)\nconst fileId = $('1B. Inicializar').first().json.file_id;\n\n// Dados do Deal\nconst dealId = ctx.deal_id;\n\n// Verificar se jÃ¡ tem faturas para este Deal\nconst temFaturas = ctx.tem_faturas || false;\nconst totalFaturas = ctx.stats_faturas?.total || 0;\nconst faturasPendentes = ctx.stats_faturas?.pendentes || 0;\nconst faturasPagas = ctx.stats_faturas?.pagas || 0;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// REGRA 1: Se jÃ¡ tem faturas â†’ BLOQUEAR (nÃ£o duplicar!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (temFaturas && totalFaturas > 0) {\n  return { \n    ...ctx, \n    erro: true, \n    tipo_erro: 'FATURAS_JA_EXISTEM',\n    file_id: fileId,\n    disk_file_id: fileId ? parseInt(fileId) : null,\n    alerta: { \n      tipo: 'AVISO', \n      emoji: 'âš ï¸', \n      titulo: 'FATURAS JÃ EXISTEM', \n      mensagem: `Deal ${dealId} jÃ¡ possui ${totalFaturas} fatura(s) (${faturasPendentes} pendente(s), ${faturasPagas} paga(s)). Processo bloqueado para evitar duplicidade.`, \n      severidade: 2, \n      bloqueia: true \n    }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// REGRA 2: Se nÃ£o tem file_id â†’ BLOQUEAR (nÃ£o tem PDF para processar)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (!fileId) {\n  return { \n    ...ctx, \n    erro: true, \n    tipo_erro: 'PDF_NAO_ENCONTRADO', \n    alerta: { \n      tipo: 'CRITICO', \n      emoji: 'ğŸš¨', \n      titulo: 'PDF NÃƒO ENCONTRADO', \n      mensagem: `Deal ${dealId}: Campo file_id nÃ£o enviado pelo webhook. Verifique se o extrato foi anexado ao Deal.`, \n      severidade: 3, \n      bloqueia: true \n    }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TUDO OK â†’ Continuar para processar PDF\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn { \n  ...ctx, \n  erro: false,\n  file_id: fileId,\n  disk_file_id: parseInt(fileId),\n  validacao: {\n    tem_faturas_existentes: false,\n    total_faturas: 0,\n    pode_criar: true,\n    mensagem: 'OK - Nenhuma fatura existente, pode criar novas'\n  }\n};"
      },
      "id": "e7653bfe-85a6-4aa3-8fa3-0cc91b7ffc05",
      "name": "3. Buscar File ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4608,
        26000
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "err",
              "leftValue": "={{ $json.erro === true || $json.tem_faturas === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c26f8f39-083b-496e-8bf7-6df73dc48665",
      "name": "3. IF Erro",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        4832,
        26000
      ]
    },
    {
      "parameters": {
        "url": "=https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/disk.file.get?id={{ $json.disk_file_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5056,
        26480
      ],
      "id": "c7235eac-cc22-4ecd-9ffd-02b6d350f929",
      "name": "3B. Obter URL Disk"
    },
    {
      "parameters": {
        "url": "={{ $json.result.DOWNLOAD_URL }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          },
          "timeout": 60000
        }
      },
      "id": "98829dc2-f0d3-47e6-ae2f-17f3dc2b401d",
      "name": "4. Baixar PDF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        5280,
        26480
      ]
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "=VocÃª Ã© um extrator especializado em documentos do INSS. Analise o PDF \"EXTRATO DE PAGAMENTO DO INSS (HistÃ³rico de CrÃ©ditos)\".\n\nRETORNE APENAS UM JSON VÃLIDO (sem markdown, sem ```json```, sem texto antes/depois).\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRA DE OURO - VOCÃŠ Ã‰ UM EXTRATOR, NÃƒO UM GERADOR!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSua funÃ§Ã£o Ã© EXTRAIR o que EXISTE no PDF. \n\nPROIBIDO:\nâŒ Inventar crÃ©ditos que nÃ£o existem\nâŒ Inventar valores que nÃ£o aparecem\nâŒ Inventar datas que nÃ£o aparecem\nâŒ Inventar competÃªncias que nÃ£o aparecem\nâŒ Preencher campos com dados \"provÃ¡veis\" ou \"esperados\"\nâŒ Deduzir informaÃ§Ãµes que nÃ£o estÃ£o escritas\nâŒ Completar dados faltantes com suposiÃ§Ãµes\nâŒ Criar registros a partir de totalizadores ou rodapÃ©s\n\nSE NÃƒO ESTÃ ESCRITO NO PDF â†’ NÃƒO INCLUA\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nESTRUTURA DO PDF - MODELO VISUAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nO documento SEMPRE segue esta estrutura:\n\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CABEÃ‡ALHO (repete em toda pÃ¡gina)                                           â”‚\nâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚ â”‚ Logo INSS            \"HistÃ³rico de CrÃ©ditos\"      DATA/HORA (canto dir) â”‚ â”‚\nâ”‚ â”‚                                                   PÃ¡gina X de Y         â”‚ â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ IDENTIFICAÃ‡ÃƒO DO FILIADO (1x, pode repetir nas pÃ¡ginas seguintes)          â”‚\nâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚ â”‚ NIT: xxx    CPF: xxx    Data Nascimento: xxx                            â”‚ â”‚\nâ”‚ â”‚ Nome: xxx                                                                â”‚ â”‚\nâ”‚ â”‚ Nome da mÃ£e: xxx                                                         â”‚ â”‚\nâ”‚ â”‚ Compet. Inicial: MM/YYYY    Compet. Final: MM/YYYY                       â”‚ â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ DADOS DO BENEFÃCIO (1x no documento)                                        â”‚\nâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚ â”‚ NB: xxx    EspÃ©cie: xxx    APS: xxx                                      â”‚ â”‚\nâ”‚ â”‚ DIB: DD/MM/YYYY    DCB: DD/MM/YYYY    DIP: DD/MM/YYYY    MR: R$ x.xxx    â”‚ â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ CRÃ‰DITOS (estrutura que se repete para cada crÃ©dito)                        â”‚\nâ”‚                                                                             â”‚\nâ”‚ â”Œâ”€ CRÃ‰DITO COMPLETO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚\nâ”‚ â”‚ LINHA 1: CompetÃªncia â”‚ PerÃ­odo â”‚ Valor LÃ­quido â”‚ Meio Pgto â”‚ Status     â”‚â”‚\nâ”‚ â”‚ LINHA 2: Banco â”‚ OP â”‚ OcorrÃªncia                                        â”‚â”‚\nâ”‚ â”‚ LINHA 3: Data CÃ¡lculo â”‚ Origem â”‚ Validade InÃ­cio â”‚ Validade Fim         â”‚â”‚\nâ”‚ â”‚ TABELA RUBRICAS:                                                         â”‚â”‚\nâ”‚ â”‚   101 - VALOR TOTAL MR DO PERIODO         R$ x.xxx                      â”‚â”‚\nâ”‚ â”‚   104 - VALOR DO DECIMO-TERCEIRO          R$ xxx                        â”‚â”‚\nâ”‚ â”‚   110 - CORREÃ‡ÃƒO MONETÃRIA                R$ xxx                        â”‚â”‚\nâ”‚ â”‚   137 - ARREDONDAMENTO                    R$ x,xx                       â”‚â”‚\nâ”‚ â”‚   206 - DESCONTO DO INSS                  R$ xxx                        â”‚â”‚\nâ”‚ â”‚   215 - DESCONTO IR                       R$ xxx                        â”‚â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRA CRÃTICA: CRÃ‰DITO SÃ“ ESTÃ COMPLETO COM SUAS RUBRICAS!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nIMPORTANTE: VocÃª deve PROCURAR ATÃ‰ ENCONTRAR as rubricas de cada crÃ©dito!\n\nUm crÃ©dito NÃƒO estÃ¡ completo atÃ© vocÃª encontrar suas rubricas. \nAs rubricas podem estar:\n- Logo abaixo do crÃ©dito (mesmo bloco)\n- Na prÃ³xima pÃ¡gina (quebra de pÃ¡gina)\n- VÃ¡rias linhas depois\n\nPROCESSO OBRIGATÃ“RIO para cada crÃ©dito:\n1. Encontrou cabeÃ§alho do crÃ©dito (CompetÃªncia, PerÃ­odo, Valor, Status)\n2. Encontrou linha do Banco e OcorrÃªncia\n3. Encontrou linha de Data CÃ¡lculo, Origem, Validade\n4. AGORA PROCURE AS RUBRICAS - nÃ£o pare atÃ© encontrar!\n5. Se nÃ£o encontrou na mesma pÃ¡gina â†’ CONTINUE NA PRÃ“XIMA PÃGINA\n6. SÃ³ quando encontrar as rubricas â†’ crÃ©dito estÃ¡ COMPLETO\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRA CRÃTICA: QUEBRA DE PÃGINA - RUBRICAS CONTINUAM!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando um crÃ©dito Ã© \"cortado\" pela quebra de pÃ¡gina:\n\nPÃGINA 1:                              PÃGINA 2:\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ... CrÃ©dito 1 ...      â”‚            â”‚ CabeÃ§alho repetido     â”‚\nâ”‚ (rubricas do 1)        â”‚            â”‚ IdentificaÃ§Ã£o repetida â”‚\nâ”‚                        â”‚            â”‚                        â”‚\nâ”‚ â”Œâ”€ CrÃ©dito 2 â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚ â”Œâ”€ RUBRICAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚ â”‚ Comp: 01/2026      â”‚ â”‚            â”‚ â”‚ 101 = R$ 1.518     â”‚ â”‚ â† PERTENCEM\nâ”‚ â”‚ PerÃ­odo: 01/12...  â”‚ â”‚            â”‚ â”‚ 137 = R$ 0,85      â”‚ â”‚   AO CRÃ‰DITO 2!\nâ”‚ â”‚ Valor: R$ 1.405    â”‚ â”‚            â”‚ â”‚ 206 = R$ 113,85    â”‚ â”‚\nâ”‚ â”‚ Banco: 341 ITAU    â”‚ â”‚            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚                        â”‚\nâ”‚ (SEM rubricas aqui!)   â”‚            â”‚ â”Œâ”€ CrÃ©dito 3 â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nREGRAS:\n- Se uma pÃ¡gina COMEÃ‡A com rubricas (sem competÃªncia/perÃ­odo acima) â†’ pertencem ao ÃšLTIMO crÃ©dito da pÃ¡gina anterior\n- NUNCA crie um \"crÃ©dito\" sÃ³ com rubricas - isso Ã© continuaÃ§Ã£o do anterior\n- Se um crÃ©dito termina sem rubricas na pÃ¡gina â†’ as rubricas estÃ£o na prÃ³xima pÃ¡gina\n\nVALIDAÃ‡ÃƒO:\n- CrÃ©dito com valor_liquido > 0 mas rubricas todas zeradas = ERRO (procure melhor!)\n- \"CrÃ©dito\" sÃ³ com rubricas e sem competÃªncia = NÃƒO Ã‰ CRÃ‰DITO (Ã© continuaÃ§Ã£o)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nESTRUTURA JSON OBRIGATÃ“RIA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n{\n  \"tipo_documento\": \"EXTRATO_CREDITOS\",\n  \"identificacao\": {\n    \"nome\": \"\",\n    \"cpf\": \"000.000.000-00\",\n    \"nit\": \"000.00000.00-0\",\n    \"data_nascimento\": \"DD/MM/YYYY\",\n    \"nome_mae\": \"\"\n  },\n  \"compet_inicial\": \"MM/YYYY\",\n  \"compet_final\": \"MM/YYYY\",\n  \"beneficio\": {\n    \"nb\": \"000.000.000-0\",\n    \"especie\": \"\",\n    \"aps\": \"\",\n    \"mr\": 0.00,\n    \"dib\": \"DD/MM/YYYY\",\n    \"dip\": \"DD/MM/YYYY\",\n    \"dcb\": \"DD/MM/YYYY\",\n    \"banco\": \"\"\n  },\n  \"historico_creditos\": [\n    {\n      \"competencia\": \"MM/YYYY\",\n      \"periodo\": \"DD/MM/YYYY a DD/MM/YYYY\",\n      \"dias\": 0,\n      \"valor_liquido\": 0.00,\n      \"meio_pagamento\": \"\",\n      \"status\": \"PAGO|PENDENTE|CANCELADO\",\n      \"ocorrencia\": \"\",\n      \"previsao_pagamento\": \"DD/MM/YYYY\",\n      \"data_pagamento\": \"DD/MM/YYYY\",\n      \"credito_invalidado\": false,\n      \"isento_ir\": false,\n      \"banco\": \"\",\n      \"data_calculo\": \"DD/MM/YYYY\",\n      \"origem\": \"\",\n      \"validade_inicio\": \"DD/MM/YYYY\",\n      \"validade_fim\": \"DD/MM/YYYY\",\n      \"rubricas\": {\n        \"101\": 0.00,\n        \"104\": 0.00,\n        \"110\": 0.00,\n        \"137\": 0.00,\n        \"206\": 0.00,\n        \"215\": 0.00\n      }\n    }\n  ],\n  \"data_atualizacao\": \"DD/MM/YYYY HH:MM:SS\"\n}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCAMPOS OBRIGATÃ“RIOS - SEMPRE EXISTEM NO PDF\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nNÃVEL DOCUMENTO (sempre 1x):\nâœ“ identificacao.nome\nâœ“ identificacao.cpf (formato 000.000.000-00)\nâœ“ identificacao.nit (formato 000.00000.00-0)\nâœ“ identificacao.data_nascimento (formato DD/MM/YYYY)\nâœ“ identificacao.nome_mae\nâœ“ compet_inicial (formato MM/YYYY)\nâœ“ compet_final (formato MM/YYYY)\nâœ“ data_atualizacao (canto superior direito, formato DD/MM/YYYY HH:MM:SS)\nâœ“ beneficio.nb (formato 000.000.000-0)\nâœ“ beneficio.especie\nâœ“ beneficio.aps\nâœ“ beneficio.mr (valor numÃ©rico)\nâœ“ beneficio.dib\nâœ“ beneficio.dip\nâœ“ beneficio.dcb\nâœ“ beneficio.banco\n\nNÃVEL CRÃ‰DITO (por crÃ©dito, sempre):\nâœ“ competencia (formato MM/YYYY) - OBRIGATÃ“RIO, NUNCA VAZIO!\nâœ“ periodo (formato \"DD/MM/YYYY a DD/MM/YYYY\") - OBRIGATÃ“RIO, NUNCA VAZIO!\nâœ“ dias (calculado: data_fim - data_inicio + 1, sempre >= 1)\nâœ“ valor_liquido (valor numÃ©rico)\nâœ“ status (PAGO, PENDENTE ou CANCELADO)\nâœ“ meio_pagamento\nâœ“ banco\nâœ“ previsao_pagamento\nâœ“ data_calculo\nâœ“ origem\nâœ“ validade_inicio\nâœ“ validade_fim\nâœ“ rubricas (101, 104, 110, 137, 206, 215) - PROCURE ATÃ‰ ENCONTRAR!\n\nCONDICIONAL:\nâ—‹ data_pagamento - Apenas se status = \"PAGO\", senÃ£o null\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRAS DE EXTRAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1) EXTRAIA TODOS OS CRÃ‰DITOS de todas as pÃ¡ginas, na ordem do PDF.\n\n2) NORMALIZAÃ‡ÃƒO DE STATUS:\n   - \"Pagamento efetivado\", \"Pago\", \"Efetivado\" â†’ \"PAGO\"\n   - \"CrÃ©dito nÃ£o retornado\", \"Agendado\", \"Previsto\" â†’ \"PENDENTE\"\n   - \"Cancelado\", \"Bloqueado\", \"Invalidado\" â†’ \"CANCELADO\"\n   - Guarde o texto original em \"ocorrencia\"\n\n3) CÃLCULO DE DIAS:\n   - Sempre calcule: data_fim - data_inicio + 1 (inclusivo)\n   - Se perÃ­odo invertido, corrija a ordem\n   - Resultado DEVE ser >= 1 (nunca zero, nunca negativo)\n\n4) CONVERSÃƒO DE VALORES:\n   - Formato BR para decimal: \"R$ 5.992,91\" â†’ 5992.91\n   - Nunca valores negativos (use valor absoluto)\n\n5) RUBRICAS:\n   - PROCURE ATÃ‰ ENCONTRAR para cada crÃ©dito\n   - Se rubrica nÃ£o existir, coloque 0.00\n   - Sempre retorne as 6 rubricas: 101, 104, 110, 137, 206, 215\n\n6) DATAS:\n   - Formato DD/MM/YYYY para datas\n   - Formato DD/MM/YYYY HH:MM:SS para data_atualizacao\n   - Se data_pagamento nÃ£o existir (crÃ©dito nÃ£o pago), retorne null\n\n7) FORMATAÃ‡ÃƒO:\n   - CPF: 000.000.000-00\n   - NIT: 000.00000.00-0\n   - NB: 000.000.000-0\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVALIDAÃ‡ÃƒO DE CRÃ‰DITOS - O QUE NUNCA PODE ACONTECER\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nNUNCA RETORNE UM CRÃ‰DITO COM:\nâœ— competencia vazia \"\" ou null â†’ NÃƒO INCLUA\nâœ— periodo vazio \"\" ou null â†’ NÃƒO INCLUA\nâœ— dias = 0 ou negativo â†’ NÃƒO INCLUA\nâœ— valor_liquido > 0 mas TODAS as rubricas zeradas â†’ ERRO, procure as rubricas!\n\nANTES DE INCLUIR UM CRÃ‰DITO, VERIFIQUE:\n- Tem competencia preenchida? (MM/YYYY)\n- Tem periodo preenchido? (DD/MM/YYYY a DD/MM/YYYY)\n- Tem dias > 0?\n- Encontrou as rubricas? (pelo menos rubrica 101 deve ter valor se valor_liquido > 0)\n\nIGNORE COMPLETAMENTE (NÃƒO SÃƒO CRÃ‰DITOS):\n- Linhas de totalizadores (\"Total\", \"Soma\", \"Subtotal\")\n- CabeÃ§alhos e rodapÃ©s repetidos entre pÃ¡ginas\n- Rubricas SOLTAS sem crÃ©dito acima â†’ pertencem ao crÃ©dito anterior!\n- Linhas em branco ou com dados parciais\n\nCONTAGEM:\n- Conte os crÃ©ditos REAIS no PDF antes de extrair\n- Cada crÃ©dito tem: CompetÃªncia + PerÃ­odo + Valor + Status\n- O array deve ter EXATAMENTE esse nÃºmero de crÃ©ditos\n- Se o PDF tem 3 crÃ©ditos â†’ retorne 3 (nunca 4, nunca 2)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVALIDAÃ‡ÃƒO FINAL - ANTES DE RETORNAR O JSON\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nCHECKLIST OBRIGATÃ“RIO:\n\nâ–¡ Quantos crÃ©ditos REAIS existem no PDF? (conte os que tÃªm CompetÃªncia+PerÃ­odo)\nâ–¡ Meu array tem exatamente esse nÃºmero?\nâ–¡ Cada crÃ©dito tem competencia preenchida?\nâ–¡ Cada crÃ©dito tem periodo preenchido?\nâ–¡ Cada crÃ©dito tem suas rubricas? (nÃ£o zeradas se valor_liquido > 0)\nâ–¡ NÃ£o criei nenhum \"crÃ©dito\" sÃ³ com rubricas?\nâ–¡ Associei corretamente rubricas que estavam na pÃ¡gina seguinte?\n\nSE ALGUM CHECK FALHAR â†’ REVISE E CORRIJA ANTES DE RETORNAR!\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRESUMO DAS PROIBIÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâŒ NUNCA retorne crÃ©dito com competencia vazia\nâŒ NUNCA retorne crÃ©dito com periodo vazio\nâŒ NUNCA retorne crÃ©dito com dias = 0\nâŒ NUNCA retorne crÃ©dito com rubricas zeradas se valor_liquido > 0\nâŒ NUNCA crie crÃ©dito sÃ³ com rubricas (Ã© continuaÃ§Ã£o do anterior!)\nâŒ NUNCA invente crÃ©ditos que nÃ£o existem no PDF\nâŒ NUNCA inclua totalizadores como se fossem crÃ©ditos\nâŒ NUNCA retorne mais crÃ©ditos do que existem no PDF\nâŒ NUNCA retorne menos crÃ©ditos do que existem no PDF\nâŒ NUNCA use markdown (```json```) na resposta\nâŒ NUNCA adicione texto antes ou depois do JSON\nâŒ NUNCA \"feche\" um crÃ©dito sem encontrar suas rubricas - PROCURE ATÃ‰ ACHAR!",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        5504,
        26480
      ],
      "id": "ec6a32ed-ccca-40dd-80b5-9bd59a9fc522",
      "name": "5. Gemini Extrair2",
      "credentials": {
        "googlePalmApi": {
          "id": "r5uX4AsdaRMfjGim",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "faturista-start-v15",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "7e3a88f5-6b57-4de0-8b97-938875fe1c01",
      "name": "1. Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        3488,
        26720
      ],
      "webhookId": "faturista-v15"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6B - CÃLCULO DO INSS (v6.5 - CORREÃ‡Ã•ES CRÃTICAS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VersÃ£o: 6.5\n// Data: 29/01/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// CORREÃ‡Ã•ES v6.5:\n// âœ… MR usa valor ORIGINAL do cliente (nÃ£o forÃ§a salÃ¡rio mÃ­nimo)\n// âœ… SalÃ¡rio mÃ­nimo Ã© apenas PISO (Math.max(mr, minimo))\n// âœ… REMOVIDO fallback de estimativa de data (marca CRITICO se nÃ£o achar)\n// âœ… Sistema de TAGS com CRITICIDADE (OK, INFO, AVISO, CRITICO)\n// âœ… NENHUM erro para o fluxo - sempre passa pro 6D via merge\n// âœ… Campo pode_faturar explÃ­cito\n// âœ… Campo resumo_tags com contagem\n// âœ… ok = cÃ¡lculo confiÃ¡vel (nÃ£o tem CRITICO)\n//\n// MANTIDO das versÃµes anteriores:\n// - CalendÃ¡rios 2025 e 2026 COMPLETOS\n// - CÃ¡lculo INSS progressivo com truncamento\n// - 13Âº salÃ¡rio por avos\n// - ValidaÃ§Ã£o de continuidade de pagamentos\n// - Mapeamento de IDs Deal/Invoice corretos\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SISTEMA DE TAGS COM CRITICIDADE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst NIVEIS_CRITICIDADE = {\n  OK: { ordem: 0, emoji: 'âœ…', descricao: 'Tudo certo, pode faturar' },\n  INFO: { ordem: 1, emoji: 'â„¹ï¸', descricao: 'Informativo, nÃ£o afeta cÃ¡lculo' },\n  AVISO: { ordem: 2, emoji: 'âš ï¸', descricao: 'AtenÃ§Ã£o, revisar depois' },\n  CRITICO: { ordem: 3, emoji: 'ğŸ”´', descricao: 'Erro de cÃ¡lculo provÃ¡vel, NÃƒO faturar' }\n};\n\nconst TAGS = {\n  // === SUCESSO (OK) - Pode faturar com confianÃ§a ===\n  'OK_CALCULO_COMPLETO': { codigo: 'S01', nivel: 'OK', mensagem: 'CÃ¡lculo completo e confiÃ¡vel' },\n  'OK_PROJECAO_CONFIAVEL': { codigo: 'S02', nivel: 'OK', mensagem: 'ProjeÃ§Ã£o com calendÃ¡rio oficial' },\n  'OK_QUITACAO': { codigo: 'S03', nivel: 'OK', mensagem: '120 dias completos - quitaÃ§Ã£o' },\n  'OK_CALENDARIO_OFICIAL': { codigo: 'S04', nivel: 'OK', mensagem: 'Data obtida do calendÃ¡rio oficial' },\n\n  // === INFO - Informativo, nÃ£o afeta cÃ¡lculo ===\n  'INFO_PRIMEIRA_PARCELA': { codigo: 'I01', nivel: 'INFO', mensagem: 'Primeira parcela do benefÃ­cio' },\n  'INFO_TEM_13O': { codigo: 'I02', nivel: 'INFO', mensagem: '13Âº salÃ¡rio detectado (Start nÃ£o cobra)' },\n  'INFO_PARCELAS_JUNTAS': { codigo: 'I03', nivel: 'INFO', mensagem: 'MÃºltiplas parcelas no mesmo dia' },\n  'INFO_MR_AJUSTADO_MINIMO': { codigo: 'I04', nivel: 'INFO', mensagem: 'MR ajustado para novo salÃ¡rio mÃ­nimo' },\n  'INFO_PROJECAO_GERADA': { codigo: 'I05', nivel: 'INFO', mensagem: 'Parcelas futuras projetadas' },\n\n  // === AVISO - Revisar depois, mas cÃ¡lculo ok ===\n  'AVISO_QUASE_COMPLETO': { codigo: 'A01', nivel: 'AVISO', mensagem: 'Faltam â‰¤15 dias para completar' },\n  'AVISO_VALOR_BAIXO': { codigo: 'A02', nivel: 'AVISO', mensagem: 'Parcela com valor baixo (<R$100)' },\n  'AVISO_PERIODO_CURTO': { codigo: 'A03', nivel: 'AVISO', mensagem: 'PerÃ­odo muito curto (â‰¤5 dias)' },\n  'AVISO_EXTRATO_ANTIGO': { codigo: 'A04', nivel: 'AVISO', mensagem: 'Extrato pode estar desatualizado' },\n\n  // === CRÃTICO - VAI DAR ERRO DE CONTA, NÃƒO FATURAR ===\n  'CRITICO_MR_VAZIO': { codigo: 'C01', nivel: 'CRITICO', mensagem: 'MR vazio - impossÃ­vel calcular desconto INSS', campo: 'mr' },\n  'CRITICO_MR_INVALIDO': { codigo: 'C02', nivel: 'CRITICO', mensagem: 'MR invÃ¡lido (zero ou negativo)', campo: 'mr' },\n  'CRITICO_NB_VAZIO': { codigo: 'C03', nivel: 'CRITICO', mensagem: 'NB vazio - impossÃ­vel buscar calendÃ¡rio', campo: 'nb' },\n  'CRITICO_DIB_VAZIO': { codigo: 'C04', nivel: 'CRITICO', mensagem: 'DIB vazia - nÃ£o sabe quando comeÃ§ou benefÃ­cio', campo: 'dib' },\n  'CRITICO_DCB_VAZIO': { codigo: 'C05', nivel: 'CRITICO', mensagem: 'DCB vazia - projeÃ§Ã£o impossÃ­vel', campo: 'dcb' },\n  'CRITICO_DATA_NAO_ENCONTRADA': { codigo: 'C06', nivel: 'CRITICO', mensagem: 'Data de pagamento nÃ£o encontrada no calendÃ¡rio', campo: 'data_pagamento' },\n  'CRITICO_PULO_MES': { codigo: 'C07', nivel: 'CRITICO', mensagem: 'Pulo de mÃªs detectado na projeÃ§Ã£o', campo: 'projecao' },\n  'CRITICO_CPF_DIVERGENTE': { codigo: 'C08', nivel: 'CRITICO', mensagem: 'CPF do PDF diferente do Deal', campo: 'cpf' },\n  'CRITICO_DIAS_EXCEDIDOS': { codigo: 'C09', nivel: 'CRITICO', mensagem: 'Mais de 120 dias calculados - erro', campo: 'dias' },\n  'CRITICO_CREDITOS_VAZIO': { codigo: 'C10', nivel: 'CRITICO', mensagem: 'Sem crÃ©ditos no extrato', campo: 'creditos' },\n  'CRITICO_ERRO_6A': { codigo: 'C11', nivel: 'CRITICO', mensagem: 'Erro recebido do nÃ³ 6A', campo: '6A' },\n  'CRITICO_CALENDARIO_INEXISTENTE': { codigo: 'C12', nivel: 'CRITICO', mensagem: 'CalendÃ¡rio do ano nÃ£o disponÃ­vel', campo: 'calendario' }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡Ã•ES DE CRIAÃ‡ÃƒO DE TAGS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst criarTag = (tagId, detalhes = {}) => {\n  const tagDef = TAGS[tagId];\n  if (!tagDef) {\n    return {\n      tag: tagId,\n      codigo: 'X99',\n      nivel: 'AVISO',\n      emoji: 'â“',\n      mensagem: `Tag desconhecida: ${tagId}`,\n      detalhes\n    };\n  }\n  \n  const nivelInfo = NIVEIS_CRITICIDADE[tagDef.nivel];\n  return {\n    tag: tagId,\n    codigo: tagDef.codigo,\n    nivel: tagDef.nivel,\n    emoji: nivelInfo.emoji,\n    mensagem: tagDef.mensagem,\n    campo: tagDef.campo || null,\n    detalhes: Object.keys(detalhes).length > 0 ? detalhes : null\n  };\n};\n\nconst gerarResumoTags = (tags) => {\n  const contagem = { OK: 0, INFO: 0, AVISO: 0, CRITICO: 0 };\n  const criticos = [];\n  \n  for (const t of tags) {\n    if (contagem[t.nivel] !== undefined) {\n      contagem[t.nivel]++;\n    }\n    if (t.nivel === 'CRITICO') {\n      criticos.push(t);\n    }\n  }\n  \n  // Determinar maior criticidade\n  let maiorCriticidade = 'OK';\n  if (contagem.CRITICO > 0) maiorCriticidade = 'CRITICO';\n  else if (contagem.AVISO > 0) maiorCriticidade = 'AVISO';\n  else if (contagem.INFO > 0) maiorCriticidade = 'INFO';\n  \n  return {\n    total_ok: contagem.OK,\n    total_info: contagem.INFO,\n    total_aviso: contagem.AVISO,\n    total_critico: contagem.CRITICO,\n    maior_criticidade: maiorCriticidade,\n    lista_criticos: criticos,\n    pode_faturar: contagem.CRITICO === 0\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DO DEAL (IDs Bitrix)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CD = {\n  cpf: 'UF_CRM_5F7DD07B0ADB5',\n  rg: 'UF_CRM_5F7DD07B11C33',\n  nit: 'UF_CRM_1766282969',\n  nb: 'UF_CRM_1737470444334',\n  nome_filho: 'UF_CRM_1699462600794',\n  categoria: 'UF_CRM_5F7DD07B0295D',\n  dib: 'UF_CRM_1765928945',\n  dip: 'UF_CRM_1766439387',\n  dcb: 'UF_CRM_1748433331869',\n  dn_mamae: 'UF_CRM_1602615428011',\n  dn_filho: 'UF_CRM_5F7DD07B1997D',\n  dn_certidao: 'UF_CRM_1714741602233',\n  data_dnv: 'UF_CRM_1742827283535',\n  data_requerimento: 'UF_CRM_6094054C7C1C8',\n  data_concessao: 'UF_CRM_1602256897805',\n  mr_cliente: 'UF_CRM_1741726157749',\n  valor_total_beneficio: 'UF_CRM_1742841962002',\n  aliquota_mr: 'UF_CRM_1742841855608',\n  valor_inss: 'UF_CRM_1634158430224',\n  valor_cliente: 'UF_CRM_1634828809106',\n  valor_previsto: 'UF_CRM_1635261498013',\n  valor_recebido: 'UF_CRM_1633535814529',\n  parcela_numero: 'UF_CRM_1634158972573',\n  qtd_parcelas: 'UF_CRM_1625253358741',\n  banco: 'UF_CRM_1603216440272',\n  endereco_banco: 'UF_CRM_1603216499370',\n  agencia_banco: 'UF_CRM_1762558313',\n  justificativa_direito: 'UF_CRM_1765636941',\n  data_rodagem: 'UF_CRM_1764270308863',\n  rodagem_comentario: 'UF_CRM_1764270260617',\n  assessor: 'UF_CRM_5F7DD07AEC035',\n  ultimo_relacionador: 'UF_CRM_1688072257656',\n  ddd_cliente: 'UF_CRM_659C48C5F0594',\n  data_reclamacao: 'UF_CRM_1704738513559',\n  data_qualificacao: 'UF_CRM_65E74D984ED3C',\n  data_recuperacao: 'UF_CRM_1713804709729',\n  data_encerramento: 'UF_CRM_663007E42D75E',\n  data_reentrada: 'UF_CRM_1615653096667',\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DA INVOICE (IDs Bitrix)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CI = {\n  cpf: 'UF_CRM_652439CFE551C',\n  rg: 'UF_CRM_652439D00A9CF',\n  nit: 'UF_CRM_6947602572F0A',\n  nb: 'UF_CRM_6790DAD756E3C',\n  \n  categoria: 'UF_CRM_652439D03479D',\n  dib: 'UF_CRM_69442F085B2CD',\n  dip: 'UF_CRM_683860072DEB8',\n  dcb: 'UF_CRM_6838600845561',\n  dn_mamae: 'UF_CRM_652439D0138A5',\n  dn_filho: 'UF_CRM_652439D021438',\n  dn_certidao: 'UF_CRM_66351141F40C7',\n  data_dnv: 'UF_CRM_67E17F1C70EAF',\n  data_requerimento: 'UF_CRM_652439D3530AB',\n  data_concessao: 'UF_CRM_652439D157BA8',\n  mr_cliente: 'UF_CRM_67D19072D84A8',\n  valor_diario: 'UF_CRM_69442F466791E',\n  valor_liquido_mensal: 'UF_CRM_69442F4D0909D',\n  valor_total_beneficio: 'UF_CRM_69442F535C91B',\n  valor_restante_inss: 'UF_CRM_69442F3A581C2',\n  aliquota_mr: 'UF_CRM_67E1B184633ED',\n  especie_beneficio: 'UF_CRM_69442F6570BDB',\n  valor_total_start: 'UF_CRM_69442F217FB9D',\n  saldo_restante_start: 'UF_CRM_69442F27CCFB3',\n  aliquota_start: 'UF_CRM_69442F596A782',\n  regra_aplicada: 'UF_CRM_69442F5F762AD',\n  valor_inss: 'UF_CRM_652439D8D6B8E',\n  valor_cliente: 'UF_CRM_652439D915311',\n  valor_previsto: 'UF_CRM_652439D9202B3',\n  parcela_numero: 'UF_CRM_652439D8E9608',\n  parcela_formato: 'UF_CRM_652439D8CDB53',\n  qtd_parcelas: 'UF_CRM_67E1AD2860054',\n  competencia: 'UF_CRM_691B6450B46E3',\n  competencia_final: 'UF_CRM_69442F0E9A95A',\n  periodo: 'UF_CRM_691B64560A17F',\n  ultima_comp_valida: 'UF_CRM_693D7DE5148DB',\n  credito_invalidado: 'UF_CRM_691B6467F11F2',\n  dias_ja_recebidos: 'UF_CRM_69442F2E321C4',\n  dias_restantes: 'UF_CRM_69442F3449D22',\n  data_inss: 'UF_CRM_652439D8B3207',\n  data_pagamento_extrato: 'UF_CRM_691B64616C2C9',\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',\n  banco: 'UF_CRM_652439D194A06',\n  endereco_banco: 'UF_CRM_652439D1A53FA',\n  agencia_banco: 'UF_CRM_691225FDDDBE4',\n  justificativa_direito: 'UF_CRM_693D7BBC3E5D3',\n  resultado_analise: 'UF_CRM_693D7CB58EBD2',\n  data_rodagem: 'UF_CRM_6929FDA3C8A79',\n  rodagem_comentario: 'UF_CRM_6929FD9E9A95D',\n  direito_ate: 'UF_CRM_679781AAB3B1D',\n  ultimo_relacionador: 'UF_CRM_65BD5488EC8E9',\n  ddd_cliente: 'UF_CRM_65BD5489DF3A2',\n  data_reclamacao: 'UF_CRM_65BD5489C89AD',\n  data_qualificacao: 'UF_CRM_65E777E2A0CED',\n  data_recuperacao: 'UF_CRM_662699414BCF0',\n  data_encerramento: 'UF_CRM_6631460FD3BB4',\n  data_reentrada: 'UF_CRM_678EADB02E460',\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CAMPOS EXTRAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CAMPOS_EXTRAS = {\n  data_encerramento_sem_direito_deal: 'UF_CRM_663007E518A1E',\n  data_conversao_deal: 'UF_CRM_5F7DD07B204FD',\n  data_certidao_deal: 'UF_CRM_1674755625727',\n  data_consulta_deal: 'UF_CRM_1602256877083',\n  data_contato_deal: 'UF_CRM_1650915373840',\n  data_prox_contato_deal: 'UF_CRM_1650915411107',\n  data_sem_direito_deal: 'UF_CRM_1649701660322',\n  data_indeferimento_deal: 'UF_CRM_1620315580',\n  data_quebra_contrato_deal: 'UF_CRM_1737722079155',\n  relacionador_quebra_deal: 'UF_CRM_1737722166447',\n  relacionador_sem_direito_deal: 'UF_CRM_1737722233583',\n  recurso_deal: 'UF_CRM_1759219838803',\n  senha_deal: 'UF_CRM_1602257200479',\n  sugestao_senha_deal: 'UF_CRM_5FDA4FCE92DAA',\n  telefone_2_deal: 'UF_CRM_606C6C98B68A7',\n  telefone_3_deal: 'UF_CRM_606C6C9A00D10',\n  sine_deal: 'UF_CRM_1751375841241',\n  data_envio_recurso_deal: 'UF_CRM_1759220050331',\n  resultado_criacao_faturas_inv: 'UF_CRM_SMART_INVOICE_1767045330',\n  data_conversao_inv: 'UF_CRM_652439D0CF19F',\n  data_calculo_inv: 'UF_CRM_69442F14E544C',\n  data_certidao_inv: 'UF_CRM_652439DA75EFF',\n  data_consulta_inv: 'UF_CRM_652439D14CF3D',\n  data_acordo_inv: 'UF_CRM_652439DB85203',\n  data_contato_inv: 'UF_CRM_652439D9B26DF',\n  data_sem_direito_inv: 'UF_CRM_66ACE094C0195',\n  data_pagamento_inv: 'UF_CRM_652439D8BD582',\n  data_indeferimento_inv: 'UF_CRM_652439D3E866C',\n  data_recebimento_inv: 'UF_CRM_652439D1B26E2',\n  desconto_inv: 'UF_CRM_6838600A5C767',\n  data_quebra_contrato_inv: 'UF_CRM_6793A405B3FC1',\n  relacionador_quebra_inv: 'UF_CRM_6793A4065BECA',\n  relacionador_sem_direito_inv: 'UF_CRM_6793A40701BCB',\n  recurso_inv: 'UF_CRM_68DD552A351D0',\n  senha_inv: 'UF_CRM_652439D16254A',\n  sugestao_senha_inv: 'UF_CRM_652439D23E905',\n  telefone_2_inv: 'UF_CRM_652439D28D353',\n  telefone_3_inv: 'UF_CRM_652439D298A88',\n  sine_inv: 'UF_CRM_6883D4B47136F',\n  data_envio_recurso_inv: 'UF_CRM_68DD552F3DD02',\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONSTANTES OFICIAIS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst SALARIO_MINIMO = {\n  2024: 1412.00,\n  2025: 1518.00,\n  2026: 1621.00\n};\n\nconst FAIXAS_INSS = {\n  2024: [\n    { limite: 1412.00, aliquota: 7.5 },\n    { limite: 2666.68, aliquota: 9.0 },\n    { limite: 4000.03, aliquota: 12.0 },\n    { limite: 7786.02, aliquota: 14.0 }\n  ],\n  2025: [\n    { limite: 1518.00, aliquota: 7.5 },\n    { limite: 2793.88, aliquota: 9.0 },\n    { limite: 4190.83, aliquota: 12.0 },\n    { limite: 8157.41, aliquota: 14.0 }\n  ],\n  2026: [\n    { limite: 1621.00, aliquota: 7.5 },\n    { limite: 2923.61, aliquota: 9.0 },\n    { limite: 4386.05, aliquota: 12.0 },\n    { limite: 8537.55, aliquota: 14.0 }\n  ]\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALENDÃRIO INSS 2025 - ATÃ‰ 1 SALÃRIO MÃNIMO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CALENDARIO_ATE_1SM_2025 = {\n  '1': {\n    'dez/24': '2024-12-20', 'jan/25': '2025-01-27', 'fev/25': '2025-02-24', 'mar/25': '2025-03-25',\n    'abr/25': '2025-04-24', 'mai/25': '2025-05-26', 'jun/25': '2025-06-24', 'jul/25': '2025-07-25',\n    'ago/25': '2025-08-25', 'set/25': '2025-09-24', 'out/25': '2025-10-27', 'nov/25': '2025-11-24',\n    'dez/25': '2025-12-22'\n  },\n  '2': {\n    'dez/24': '2024-12-23', 'jan/25': '2025-01-28', 'fev/25': '2025-02-25', 'mar/25': '2025-03-26',\n    'abr/25': '2025-04-25', 'mai/25': '2025-05-27', 'jun/25': '2025-06-25', 'jul/25': '2025-07-28',\n    'ago/25': '2025-08-26', 'set/25': '2025-09-25', 'out/25': '2025-10-28', 'nov/25': '2025-11-25',\n    'dez/25': '2025-12-23'\n  },\n  '3': {\n    'dez/24': '2024-12-26', 'jan/25': '2025-01-29', 'fev/25': '2025-02-26', 'mar/25': '2025-03-27',\n    'abr/25': '2025-04-28', 'mai/25': '2025-05-28', 'jun/25': '2025-06-26', 'jul/25': '2025-07-29',\n    'ago/25': '2025-08-27', 'set/25': '2025-09-26', 'out/25': '2025-10-29', 'nov/25': '2025-11-26',\n    'dez/25': '2025-12-26'\n  },\n  '4': {\n    'dez/24': '2024-12-27', 'jan/25': '2025-01-30', 'fev/25': '2025-02-27', 'mar/25': '2025-03-28',\n    'abr/25': '2025-04-29', 'mai/25': '2025-05-29', 'jun/25': '2025-06-27', 'jul/25': '2025-07-30',\n    'ago/25': '2025-08-28', 'set/25': '2025-09-29', 'out/25': '2025-10-30', 'nov/25': '2025-11-27',\n    'dez/25': '2025-12-29'\n  },\n  '5': {\n    'dez/24': '2024-12-30', 'jan/25': '2025-01-31', 'fev/25': '2025-02-28', 'mar/25': '2025-03-31',\n    'abr/25': '2025-04-30', 'mai/25': '2025-05-30', 'jun/25': '2025-06-30', 'jul/25': '2025-07-31',\n    'ago/25': '2025-08-29', 'set/25': '2025-09-30', 'out/25': '2025-10-31', 'nov/25': '2025-11-28',\n    'dez/25': '2025-12-30'\n  },\n  '6': {\n    'dez/24': '2025-01-02', 'jan/25': '2025-02-03', 'fev/25': '2025-03-06', 'mar/25': '2025-04-01',\n    'abr/25': '2025-05-02', 'mai/25': '2025-06-02', 'jun/25': '2025-07-01', 'jul/25': '2025-08-01',\n    'ago/25': '2025-09-01', 'set/25': '2025-10-01', 'out/25': '2025-11-03', 'nov/25': '2025-12-01',\n    'dez/25': '2026-01-02'\n  },\n  '7': {\n    'dez/24': '2025-01-03', 'jan/25': '2025-02-04', 'fev/25': '2025-03-07', 'mar/25': '2025-04-02',\n    'abr/25': '2025-05-05', 'mai/25': '2025-06-03', 'jun/25': '2025-07-02', 'jul/25': '2025-08-04',\n    'ago/25': '2025-09-02', 'set/25': '2025-10-02', 'out/25': '2025-11-04', 'nov/25': '2025-12-02',\n    'dez/25': '2026-01-05'\n  },\n  '8': {\n    'dez/24': '2025-01-06', 'jan/25': '2025-02-05', 'fev/25': '2025-03-06', 'mar/25': '2025-04-03',\n    'abr/25': '2025-05-06', 'mai/25': '2025-06-04', 'jun/25': '2025-07-03', 'jul/25': '2025-08-05',\n    'ago/25': '2025-09-03', 'set/25': '2025-10-03', 'out/25': '2025-11-05', 'nov/25': '2025-12-03',\n    'dez/25': '2026-01-06'\n  },\n  '9': {\n    'dez/24': '2025-01-07', 'jan/25': '2025-02-06', 'fev/25': '2025-03-06', 'mar/25': '2025-04-04',\n    'abr/25': '2025-05-07', 'mai/25': '2025-06-05', 'jun/25': '2025-07-04', 'jul/25': '2025-08-06',\n    'ago/25': '2025-09-04', 'set/25': '2025-10-06', 'out/25': '2025-11-06', 'nov/25': '2025-12-04',\n    'dez/25': '2026-01-07'\n  },\n  '0': {\n    'dez/24': '2025-01-08', 'jan/25': '2025-02-07', 'fev/25': '2025-03-07', 'mar/25': '2025-04-07',\n    'abr/25': '2025-05-08', 'mai/25': '2025-06-06', 'jun/25': '2025-07-07', 'jul/25': '2025-08-07',\n    'ago/25': '2025-09-05', 'set/25': '2025-10-07', 'out/25': '2025-11-07', 'nov/25': '2025-12-05',\n    'dez/25': '2026-01-08'\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALENDÃRIO INSS 2025 - ACIMA DE 1 SALÃRIO MÃNIMO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CALENDARIO_ACIMA_1SM_2025 = {\n  '1': {\n    'dez/24': '2025-01-02', 'jan/25': '2025-02-03', 'fev/25': '2025-03-06', 'mar/25': '2025-04-01',\n    'abr/25': '2025-05-02', 'mai/25': '2025-06-02', 'jun/25': '2025-07-01', 'jul/25': '2025-08-01',\n    'ago/25': '2025-09-01', 'set/25': '2025-10-01', 'out/25': '2025-11-03', 'nov/25': '2025-12-01',\n    'dez/25': '2026-01-02'\n  },\n  '6': {\n    'dez/24': '2025-01-02', 'jan/25': '2025-02-03', 'fev/25': '2025-03-06', 'mar/25': '2025-04-01',\n    'abr/25': '2025-05-02', 'mai/25': '2025-06-02', 'jun/25': '2025-07-01', 'jul/25': '2025-08-01',\n    'ago/25': '2025-09-01', 'set/25': '2025-10-01', 'out/25': '2025-11-03', 'nov/25': '2025-12-01',\n    'dez/25': '2026-01-02'\n  },\n  '2': {\n    'dez/24': '2025-01-03', 'jan/25': '2025-02-04', 'fev/25': '2025-03-07', 'mar/25': '2025-04-02',\n    'abr/25': '2025-05-05', 'mai/25': '2025-06-03', 'jun/25': '2025-07-02', 'jul/25': '2025-08-04',\n    'ago/25': '2025-09-02', 'set/25': '2025-10-02', 'out/25': '2025-11-04', 'nov/25': '2025-12-02',\n    'dez/25': '2026-01-05'\n  },\n  '7': {\n    'dez/24': '2025-01-03', 'jan/25': '2025-02-04', 'fev/25': '2025-03-07', 'mar/25': '2025-04-02',\n    'abr/25': '2025-05-05', 'mai/25': '2025-06-03', 'jun/25': '2025-07-02', 'jul/25': '2025-08-04',\n    'ago/25': '2025-09-02', 'set/25': '2025-10-02', 'out/25': '2025-11-04', 'nov/25': '2025-12-02',\n    'dez/25': '2026-01-05'\n  },\n  '3': {\n    'dez/24': '2025-01-06', 'jan/25': '2025-02-05', 'fev/25': '2025-03-06', 'mar/25': '2025-04-03',\n    'abr/25': '2025-05-06', 'mai/25': '2025-06-04', 'jun/25': '2025-07-03', 'jul/25': '2025-08-05',\n    'ago/25': '2025-09-03', 'set/25': '2025-10-03', 'out/25': '2025-11-05', 'nov/25': '2025-12-03',\n    'dez/25': '2026-01-06'\n  },\n  '8': {\n    'dez/24': '2025-01-06', 'jan/25': '2025-02-05', 'fev/25': '2025-03-06', 'mar/25': '2025-04-03',\n    'abr/25': '2025-05-06', 'mai/25': '2025-06-04', 'jun/25': '2025-07-03', 'jul/25': '2025-08-05',\n    'ago/25': '2025-09-03', 'set/25': '2025-10-03', 'out/25': '2025-11-05', 'nov/25': '2025-12-03',\n    'dez/25': '2026-01-06'\n  },\n  '4': {\n    'dez/24': '2025-01-07', 'jan/25': '2025-02-06', 'fev/25': '2025-03-06', 'mar/25': '2025-04-04',\n    'abr/25': '2025-05-07', 'mai/25': '2025-06-05', 'jun/25': '2025-07-04', 'jul/25': '2025-08-06',\n    'ago/25': '2025-09-04', 'set/25': '2025-10-06', 'out/25': '2025-11-06', 'nov/25': '2025-12-04',\n    'dez/25': '2026-01-07'\n  },\n  '9': {\n    'dez/24': '2025-01-07', 'jan/25': '2025-02-06', 'fev/25': '2025-03-06', 'mar/25': '2025-04-04',\n    'abr/25': '2025-05-07', 'mai/25': '2025-06-05', 'jun/25': '2025-07-04', 'jul/25': '2025-08-06',\n    'ago/25': '2025-09-04', 'set/25': '2025-10-06', 'out/25': '2025-11-06', 'nov/25': '2025-12-04',\n    'dez/25': '2026-01-07'\n  },\n  '5': {\n    'dez/24': '2025-01-08', 'jan/25': '2025-02-07', 'fev/25': '2025-03-07', 'mar/25': '2025-04-07',\n    'abr/25': '2025-05-08', 'mai/25': '2025-06-06', 'jun/25': '2025-07-07', 'jul/25': '2025-08-07',\n    'ago/25': '2025-09-05', 'set/25': '2025-10-07', 'out/25': '2025-11-07', 'nov/25': '2025-12-05',\n    'dez/25': '2026-01-08'\n  },\n  '0': {\n    'dez/24': '2025-01-08', 'jan/25': '2025-02-07', 'fev/25': '2025-03-07', 'mar/25': '2025-04-07',\n    'abr/25': '2025-05-08', 'mai/25': '2025-06-06', 'jun/25': '2025-07-07', 'jul/25': '2025-08-07',\n    'ago/25': '2025-09-05', 'set/25': '2025-10-07', 'out/25': '2025-11-07', 'nov/25': '2025-12-05',\n    'dez/25': '2026-01-08'\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALENDÃRIO INSS 2026 - ATÃ‰ 1 SALÃRIO MÃNIMO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CALENDARIO_ATE_1SM_2026 = {\n  '1': {\n    'dez/25': '2025-12-22', 'jan/26': '2026-01-26', 'fev/26': '2026-02-23', 'mar/26': '2026-03-25',\n    'abr/26': '2026-04-24', 'mai/26': '2026-05-25', 'jun/26': '2026-06-24', 'jul/26': '2026-07-27',\n    'ago/26': '2026-08-25', 'set/26': '2026-09-24', 'out/26': '2026-10-26', 'nov/26': '2026-11-24',\n    'dez/26': '2026-12-22'\n  },\n  '2': {\n    'dez/25': '2025-12-23', 'jan/26': '2026-01-27', 'fev/26': '2026-02-24', 'mar/26': '2026-03-26',\n    'abr/26': '2026-04-27', 'mai/26': '2026-05-26', 'jun/26': '2026-06-25', 'jul/26': '2026-07-28',\n    'ago/26': '2026-08-26', 'set/26': '2026-09-25', 'out/26': '2026-10-27', 'nov/26': '2026-11-25',\n    'dez/26': '2026-12-23'\n  },\n  '3': {\n    'dez/25': '2025-12-26', 'jan/26': '2026-01-28', 'fev/26': '2026-02-25', 'mar/26': '2026-03-27',\n    'abr/26': '2026-04-28', 'mai/26': '2026-05-27', 'jun/26': '2026-06-26', 'jul/26': '2026-07-29',\n    'ago/26': '2026-08-27', 'set/26': '2026-09-28', 'out/26': '2026-10-28', 'nov/26': '2026-11-26',\n    'dez/26': '2026-12-28'\n  },\n  '4': {\n    'dez/25': '2025-12-29', 'jan/26': '2026-01-29', 'fev/26': '2026-02-26', 'mar/26': '2026-03-30',\n    'abr/26': '2026-04-29', 'mai/26': '2026-05-28', 'jun/26': '2026-06-29', 'jul/26': '2026-07-30',\n    'ago/26': '2026-08-28', 'set/26': '2026-09-29', 'out/26': '2026-10-29', 'nov/26': '2026-11-27',\n    'dez/26': '2026-12-29'\n  },\n  '5': {\n    'dez/25': '2025-12-30', 'jan/26': '2026-01-30', 'fev/26': '2026-02-27', 'mar/26': '2026-03-31',\n    'abr/26': '2026-04-30', 'mai/26': '2026-05-29', 'jun/26': '2026-06-30', 'jul/26': '2026-07-31',\n    'ago/26': '2026-08-31', 'set/26': '2026-09-30', 'out/26': '2026-10-30', 'nov/26': '2026-11-30',\n    'dez/26': '2026-12-30'\n  },\n  '6': {\n    'dez/25': '2026-01-02', 'jan/26': '2026-02-02', 'fev/26': '2026-03-02', 'mar/26': '2026-04-01',\n    'abr/26': '2026-05-04', 'mai/26': '2026-06-01', 'jun/26': '2026-07-01', 'jul/26': '2026-08-03',\n    'ago/26': '2026-09-01', 'set/26': '2026-10-01', 'out/26': '2026-11-03', 'nov/26': '2026-12-01',\n    'dez/26': '2027-01-04'\n  },\n  '7': {\n    'dez/25': '2026-01-05', 'jan/26': '2026-02-03', 'fev/26': '2026-03-03', 'mar/26': '2026-04-02',\n    'abr/26': '2026-05-05', 'mai/26': '2026-06-02', 'jun/26': '2026-07-02', 'jul/26': '2026-08-04',\n    'ago/26': '2026-09-02', 'set/26': '2026-10-02', 'out/26': '2026-11-04', 'nov/26': '2026-12-02',\n    'dez/26': '2027-01-05'\n  },\n  '8': {\n    'dez/25': '2026-01-06', 'jan/26': '2026-02-04', 'fev/26': '2026-03-04', 'mar/26': '2026-04-06',\n    'abr/26': '2026-05-06', 'mai/26': '2026-06-03', 'jun/26': '2026-07-03', 'jul/26': '2026-08-05',\n    'ago/26': '2026-09-03', 'set/26': '2026-10-05', 'out/26': '2026-11-05', 'nov/26': '2026-12-03',\n    'dez/26': '2027-01-06'\n  },\n  '9': {\n    'dez/25': '2026-01-07', 'jan/26': '2026-02-05', 'fev/26': '2026-03-05', 'mar/26': '2026-04-07',\n    'abr/26': '2026-05-07', 'mai/26': '2026-06-05', 'jun/26': '2026-07-06', 'jul/26': '2026-08-06',\n    'ago/26': '2026-09-04', 'set/26': '2026-10-06', 'out/26': '2026-11-06', 'nov/26': '2026-12-04',\n    'dez/26': '2027-01-07'\n  },\n  '0': {\n    'dez/25': '2026-01-08', 'jan/26': '2026-02-06', 'fev/26': '2026-03-06', 'mar/26': '2026-04-08',\n    'abr/26': '2026-05-08', 'mai/26': '2026-06-08', 'jun/26': '2026-07-07', 'jul/26': '2026-08-07',\n    'ago/26': '2026-09-08', 'set/26': '2026-10-07', 'out/26': '2026-11-09', 'nov/26': '2026-12-07',\n    'dez/26': '2027-01-08'\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALENDÃRIO INSS 2026 - ACIMA DE 1 SALÃRIO MÃNIMO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CALENDARIO_ACIMA_1SM_2026 = {\n  '1': {\n    'dez/25': '2026-01-02', 'jan/26': '2026-02-02', 'fev/26': '2026-03-02', 'mar/26': '2026-04-01',\n    'abr/26': '2026-05-04', 'mai/26': '2026-06-01', 'jun/26': '2026-07-01', 'jul/26': '2026-08-03',\n    'ago/26': '2026-09-01', 'set/26': '2026-10-01', 'out/26': '2026-11-03', 'nov/26': '2026-12-01',\n    'dez/26': '2027-01-04'\n  },\n  '6': {\n    'dez/25': '2026-01-02', 'jan/26': '2026-02-02', 'fev/26': '2026-03-02', 'mar/26': '2026-04-01',\n    'abr/26': '2026-05-04', 'mai/26': '2026-06-01', 'jun/26': '2026-07-01', 'jul/26': '2026-08-03',\n    'ago/26': '2026-09-01', 'set/26': '2026-10-01', 'out/26': '2026-11-03', 'nov/26': '2026-12-01',\n    'dez/26': '2027-01-04'\n  },\n  '2': {\n    'dez/25': '2026-01-05', 'jan/26': '2026-02-03', 'fev/26': '2026-03-03', 'mar/26': '2026-04-02',\n    'abr/26': '2026-05-05', 'mai/26': '2026-06-02', 'jun/26': '2026-07-02', 'jul/26': '2026-08-04',\n    'ago/26': '2026-09-02', 'set/26': '2026-10-02', 'out/26': '2026-11-04', 'nov/26': '2026-12-02',\n    'dez/26': '2027-01-05'\n  },\n  '7': {\n    'dez/25': '2026-01-05', 'jan/26': '2026-02-03', 'fev/26': '2026-03-03', 'mar/26': '2026-04-02',\n    'abr/26': '2026-05-05', 'mai/26': '2026-06-02', 'jun/26': '2026-07-02', 'jul/26': '2026-08-04',\n    'ago/26': '2026-09-02', 'set/26': '2026-10-02', 'out/26': '2026-11-04', 'nov/26': '2026-12-02',\n    'dez/26': '2027-01-05'\n  },\n  '3': {\n    'dez/25': '2026-01-06', 'jan/26': '2026-02-04', 'fev/26': '2026-03-04', 'mar/26': '2026-04-06',\n    'abr/26': '2026-05-06', 'mai/26': '2026-06-03', 'jun/26': '2026-07-03', 'jul/26': '2026-08-05',\n    'ago/26': '2026-09-03', 'set/26': '2026-10-05', 'out/26': '2026-11-05', 'nov/26': '2026-12-03',\n    'dez/26': '2027-01-06'\n  },\n  '8': {\n    'dez/25': '2026-01-06', 'jan/26': '2026-02-04', 'fev/26': '2026-03-04', 'mar/26': '2026-04-06',\n    'abr/26': '2026-05-06', 'mai/26': '2026-06-03', 'jun/26': '2026-07-03', 'jul/26': '2026-08-05',\n    'ago/26': '2026-09-03', 'set/26': '2026-10-05', 'out/26': '2026-11-05', 'nov/26': '2026-12-03',\n    'dez/26': '2027-01-06'\n  },\n  '4': {\n    'dez/25': '2026-01-07', 'jan/26': '2026-02-05', 'fev/26': '2026-03-05', 'mar/26': '2026-04-07',\n    'abr/26': '2026-05-07', 'mai/26': '2026-06-05', 'jun/26': '2026-07-06', 'jul/26': '2026-08-06',\n    'ago/26': '2026-09-04', 'set/26': '2026-10-06', 'out/26': '2026-11-06', 'nov/26': '2026-12-04',\n    'dez/26': '2027-01-07'\n  },\n  '9': {\n    'dez/25': '2026-01-07', 'jan/26': '2026-02-05', 'fev/26': '2026-03-05', 'mar/26': '2026-04-07',\n    'abr/26': '2026-05-07', 'mai/26': '2026-06-05', 'jun/26': '2026-07-06', 'jul/26': '2026-08-06',\n    'ago/26': '2026-09-04', 'set/26': '2026-10-06', 'out/26': '2026-11-06', 'nov/26': '2026-12-04',\n    'dez/26': '2027-01-07'\n  },\n  '5': {\n    'dez/25': '2026-01-08', 'jan/26': '2026-02-06', 'fev/26': '2026-03-06', 'mar/26': '2026-04-08',\n    'abr/26': '2026-05-08', 'mai/26': '2026-06-08', 'jun/26': '2026-07-07', 'jul/26': '2026-08-07',\n    'ago/26': '2026-09-08', 'set/26': '2026-10-07', 'out/26': '2026-11-09', 'nov/26': '2026-12-07',\n    'dez/26': '2027-01-08'\n  },\n  '0': {\n    'dez/25': '2026-01-08', 'jan/26': '2026-02-06', 'fev/26': '2026-03-06', 'mar/26': '2026-04-08',\n    'abr/26': '2026-05-08', 'mai/26': '2026-06-08', 'jun/26': '2026-07-07', 'jul/26': '2026-08-07',\n    'ago/26': '2026-09-08', 'set/26': '2026-10-07', 'out/26': '2026-11-09', 'nov/26': '2026-12-07',\n    'dez/26': '2027-01-08'\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡Ã•ES UTILITÃRIAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\nconst getFaixasINSS = (ano) => FAIXAS_INSS[ano] || FAIXAS_INSS[2025];\n\nconst getSalarioMinimo = (ano) => SALARIO_MINIMO[ano] || SALARIO_MINIMO[2025];\n\nconst extrairDigitoCalendario = (nb) => {\n  const numeros = String(nb).replace(/\\D/g, '');\n  return numeros.length >= 2 ? numeros[numeros.length - 2] : '1';\n};\n\nconst formatarChaveCalendario = (competencia) => {\n  const mesesAbrev = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];\n  const partes = competencia.split('/');\n  if (partes.length !== 2) return null;\n  const mes = parseInt(partes[0]);\n  const ano = String(partes[1]).slice(-2);\n  if (mes < 1 || mes > 12) return null;\n  return `${mesesAbrev[mes - 1]}/${ano}`;\n};\n\nconst calcularDias = (dataInicio, dataFim) => {\n  if (!dataInicio || !dataFim) return 0;\n  const d1 = new Date(dataInicio);\n  const d2 = new Date(dataFim);\n  return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;\n};\n\nconst adicionarDias = (dataISO, dias) => {\n  const d = new Date(dataISO);\n  d.setDate(d.getDate() + dias);\n  return d.toISOString().substring(0, 10);\n};\n\nconst ultimoDiaMes = (ano, mes) => new Date(ano, mes, 0).getDate();\n\nconst extrairMesAno = (dataISO) => {\n  if (!dataISO) return null;\n  return { mes: parseInt(dataISO.substring(5, 7)), ano: parseInt(dataISO.substring(0, 4)) };\n};\n\nconst dataParaCompetencia = (dataISO) => {\n  const info = extrairMesAno(dataISO);\n  if (!info) return null;\n  return `${String(info.mes).padStart(2, '0')}/${info.ano}`;\n};\n\nconst competenciaParaData = (competencia, dia = 1) => {\n  const partes = competencia.split('/');\n  if (partes.length !== 2) return null;\n  let mes = parseInt(partes[0]);\n  let ano = parseInt(partes[1]);\n  if (ano < 100) ano += 2000;\n  return `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;\n};\n\nconst formatarMoeda = (valor) => `R$ ${(valor || 0).toFixed(2).replace('.', ',')}`;\n\nconst formatarData = (dataISO) => {\n  if (!dataISO) return '-';\n  const [ano, mes, dia] = dataISO.split('-');\n  return `${dia}/${mes}/${ano}`;\n};\n\nconst formatMoneyBitrix = (valor) => {\n  if (!valor && valor !== 0) return null;\n  return `${tr(valor)}|BRL`;\n};\n\nconst formatDateBitrix = (dataISO) => {\n  if (!dataISO) return null;\n  return `${dataISO}T03:00:00+00:00`;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CÃLCULO INSS PROGRESSIVO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst calcularDescontoINSS = (mr, ano = 2025) => {\n  const faixas = getFaixasINSS(ano);\n  let descontoTotal = 0;\n  let baseAnterior = 0;\n  const detalhes = [];\n\n  for (const faixa of faixas) {\n    if (mr <= baseAnterior) break;\n    const baseCalculo = tr(Math.min(mr, faixa.limite) - baseAnterior);\n    if (baseCalculo > 0) {\n      const descontoFaixa = tr(baseCalculo * faixa.aliquota / 100);\n      descontoTotal += descontoFaixa;\n      detalhes.push({\n        faixa: detalhes.length + 1,\n        limite: faixa.limite,\n        aliquota: faixa.aliquota,\n        base_calculo: baseCalculo,\n        desconto: descontoFaixa\n      });\n    }\n    baseAnterior = faixa.limite;\n  }\n\n  descontoTotal = tr(descontoTotal);\n  const aliquotaEfetiva = mr > 0 ? tr((descontoTotal / mr) * 100) : 0;\n\n  return { desconto: descontoTotal, aliquota_efetiva: aliquotaEfetiva, detalhes };\n};\n\nconst calcularValoresDerivados = (mr, descontoINSS) => {\n  const liquidoMensal = tr(mr - descontoINSS);\n  const valorDiarioLiquido = tr(liquidoMensal / 30);\n  const total120Dias = tr(valorDiarioLiquido * 120);\n  return {\n    liquido_mensal: liquidoMensal,\n    valor_diario_liquido: valorDiarioLiquido,\n    total_120_dias: total120Dias\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SELETOR DE CALENDÃRIO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst getCalendario = (anoCompetencia, faixaMR) => {\n  if (faixaMR === 'ATE_1SM') {\n    if (anoCompetencia <= 2024) return CALENDARIO_ATE_1SM_2025;\n    if (anoCompetencia === 2025) return CALENDARIO_ATE_1SM_2025;\n    if (anoCompetencia >= 2026) return CALENDARIO_ATE_1SM_2026;\n  } else {\n    if (anoCompetencia <= 2024) return CALENDARIO_ACIMA_1SM_2025;\n    if (anoCompetencia === 2025) return CALENDARIO_ACIMA_1SM_2025;\n    if (anoCompetencia >= 2026) return CALENDARIO_ACIMA_1SM_2026;\n  }\n  return CALENDARIO_ATE_1SM_2025;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// v6.5 - OBTER DATA DE PAGAMENTO (SEM FALLBACK DE ESTIMATIVA!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// REGRA: Se nÃ£o encontrar no calendÃ¡rio oficial, retorna null e marca CRITICO\n// NÃƒO INVENTA DATA!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst obterDataPagamentoPorMes = (nb, mesPagamento, anoPagamento, mr) => {\n  const digitoCalendario = extrairDigitoCalendario(nb);\n  const salarioMinimo = getSalarioMinimo(anoPagamento);\n  const faixaMR = mr <= salarioMinimo ? 'ATE_1SM' : 'ACIMA_1SM';\n\n  // Verificar se temos calendÃ¡rio para esse ano\n  if (anoPagamento > 2026) {\n    return {\n      data_pagamento: null,\n      origem: 'CALENDARIO_INEXISTENTE',\n      erro: true,\n      tag: 'CRITICO_CALENDARIO_INEXISTENTE',\n      mensagem: `CalendÃ¡rio ${anoPagamento} nÃ£o disponÃ­vel`,\n      digito_nb: digitoCalendario,\n      faixa_mr: faixaMR,\n      ano_solicitado: anoPagamento\n    };\n  }\n\n  const calendario = getCalendario(anoPagamento, faixaMR);\n  const datas = calendario[digitoCalendario];\n\n  if (!datas) {\n    return {\n      data_pagamento: null,\n      origem: 'ERRO_DIGITO',\n      erro: true,\n      tag: 'CRITICO_DATA_NAO_ENCONTRADA',\n      mensagem: `DÃ­gito ${digitoCalendario} nÃ£o encontrado no calendÃ¡rio`,\n      digito_nb: digitoCalendario,\n      faixa_mr: faixaMR\n    };\n  }\n\n  // Formato do mÃªs de pagamento desejado: YYYY-MM\n  const mesPagamentoFormatado = `${anoPagamento}-${String(mesPagamento).padStart(2, '0')}`;\n\n  // Buscar no calendÃ¡rio a data que CAI nesse mÃªs\n  for (const [chaveComp, dataPagamento] of Object.entries(datas)) {\n    if (dataPagamento && dataPagamento.startsWith(mesPagamentoFormatado)) {\n      return {\n        data_pagamento: dataPagamento,\n        origem: 'CALENDARIO_OFICIAL',\n        erro: false,\n        tag: 'OK_CALENDARIO_OFICIAL',\n        digito_nb: digitoCalendario,\n        faixa_mr: faixaMR,\n        ano_calendario: anoPagamento <= 2025 ? 2025 : 2026,\n        competencia_calendario: chaveComp\n      };\n    }\n  }\n\n  // Tentar no calendÃ¡rio do ano anterior (para pagamentos no inÃ­cio do ano)\n  const calendarioAnterior = getCalendario(anoPagamento - 1, faixaMR);\n  const datasAnterior = calendarioAnterior[digitoCalendario];\n\n  if (datasAnterior) {\n    for (const [chaveComp, dataPagamento] of Object.entries(datasAnterior)) {\n      if (dataPagamento && dataPagamento.startsWith(mesPagamentoFormatado)) {\n        return {\n          data_pagamento: dataPagamento,\n          origem: 'CALENDARIO_OFICIAL_ANO_ANTERIOR',\n          erro: false,\n          tag: 'OK_CALENDARIO_OFICIAL',\n          digito_nb: digitoCalendario,\n          faixa_mr: faixaMR,\n          ano_calendario: anoPagamento - 1 <= 2025 ? 2025 : 2026,\n          competencia_calendario: chaveComp\n        };\n      }\n    }\n  }\n\n  // v6.5: NÃƒO FAZ FALLBACK DE ESTIMATIVA!\n  // Retorna null e marca como erro crÃ­tico\n  return {\n    data_pagamento: null,\n    origem: 'NAO_ENCONTRADA',\n    erro: true,\n    tag: 'CRITICO_DATA_NAO_ENCONTRADA',\n    mensagem: `Data de pagamento nÃ£o encontrada para ${mesPagamentoFormatado}`,\n    digito_nb: digitoCalendario,\n    faixa_mr: faixaMR,\n    mes_solicitado: mesPagamentoFormatado,\n    requer_revisao: true\n  };\n};\n\n// FunÃ§Ã£o para crÃ©ditos do extrato (mantida para compatibilidade)\nconst obterDataPagamentoINSS = (nb, competencia, mr, anoRef = 2025) => {\n  const digitoCalendario = extrairDigitoCalendario(nb);\n  const chaveComp = formatarChaveCalendario(competencia);\n  \n  if (!chaveComp) {\n    return { \n      data_pagamento: null, \n      origem: 'ERRO_COMPETENCIA',\n      erro: true,\n      tag: 'CRITICO_DATA_NAO_ENCONTRADA'\n    };\n  }\n\n  const partes = competencia.split('/');\n  let anoComp = parseInt(partes[1]);\n  if (anoComp < 100) anoComp += 2000;\n\n  const salarioMinimo = getSalarioMinimo(anoComp);\n  const faixaMR = mr <= salarioMinimo ? 'ATE_1SM' : 'ACIMA_1SM';\n  const calendario = getCalendario(anoComp, faixaMR);\n  const datas = calendario[digitoCalendario];\n\n  if (!datas) {\n    return { \n      data_pagamento: null, \n      origem: 'ERRO_DIGITO',\n      erro: true,\n      tag: 'CRITICO_DATA_NAO_ENCONTRADA'\n    };\n  }\n\n  const dataPagamento = datas[chaveComp];\n\n  if (dataPagamento) {\n    return {\n      data_pagamento: dataPagamento,\n      origem: 'CALENDARIO_OFICIAL',\n      erro: false,\n      tag: 'OK_CALENDARIO_OFICIAL',\n      digito_nb: digitoCalendario,\n      faixa_mr: faixaMR,\n      ano_calendario: anoComp <= 2025 ? 2025 : 2026\n    };\n  }\n\n  // v6.5: NÃƒO FAZ FALLBACK!\n  return {\n    data_pagamento: null,\n    origem: 'NAO_ENCONTRADA',\n    erro: true,\n    tag: 'CRITICO_DATA_NAO_ENCONTRADA',\n    mensagem: `CompetÃªncia ${competencia} nÃ£o encontrada no calendÃ¡rio`,\n    digito_nb: digitoCalendario,\n    faixa_mr: faixaMR\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SITUAÃ‡ÃƒO FINANCEIRA COMPLETA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst calcularSituacaoFinanceira = (creditos, valorDiarioLiquido) => {\n  const dias_pagos = creditos.filter(c => c.pagamento?.status === 'PAGO').reduce((sum, c) => sum + (c.dias || 0), 0);\n  const dias_pendentes = creditos.filter(c => c.pagamento?.status === 'PENDENTE').reduce((sum, c) => sum + (c.dias || 0), 0);\n  const dias_cobertos = dias_pagos + dias_pendentes;\n  const dias_restantes = Math.max(0, 120 - dias_cobertos);\n\n  const valor_pago = tr(creditos.filter(c => c.pagamento?.status === 'PAGO').reduce((sum, c) => sum + (c.valores?.liquido || 0), 0));\n  const valor_pendente = tr(creditos.filter(c => c.pagamento?.status === 'PENDENTE').reduce((sum, c) => sum + (c.valores?.liquido || 0), 0));\n  const valor_a_receber = tr(dias_restantes * valorDiarioLiquido);\n  const valor_total_beneficio = tr(120 * valorDiarioLiquido);\n\n  const pct_pago = tr((dias_pagos / 120) * 100);\n  const pct_pendente = tr((dias_pendentes / 120) * 100);\n  const pct_coberto = tr((dias_cobertos / 120) * 100);\n  const pct_restante = tr((dias_restantes / 120) * 100);\n\n  const parcelas_pagas = creditos.filter(c => c.pagamento?.status === 'PAGO').length;\n  const parcelas_pendentes = creditos.filter(c => c.pagamento?.status === 'PENDENTE').length;\n\n  return {\n    dias: { pagos: dias_pagos, pendentes: dias_pendentes, cobertos: dias_cobertos, restantes: dias_restantes, total: 120 },\n    valores: {\n      pago: valor_pago, pago_formatado: formatarMoeda(valor_pago),\n      pendente: valor_pendente, pendente_formatado: formatarMoeda(valor_pendente),\n      a_receber: valor_a_receber, a_receber_formatado: formatarMoeda(valor_a_receber),\n      total_beneficio: valor_total_beneficio, total_beneficio_formatado: formatarMoeda(valor_total_beneficio)\n    },\n    percentuais: { pago: pct_pago, pendente: pct_pendente, coberto: pct_coberto, restante: pct_restante },\n    parcelas: { pagas: parcelas_pagas, pendentes: parcelas_pendentes, total_extrato: creditos.length },\n    beneficio_completo: dias_cobertos >= 120,\n    tem_pendente: dias_pendentes > 0,\n    tem_a_receber: dias_restantes > 0\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// v6.5 - PROJEÃ‡ÃƒO DE PARCELAS FUTURAS (CORRIGIDA - MR ORIGINAL)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CORREÃ‡Ã•ES v6.5:\n// - Usa MR ORIGINAL do cliente (nÃ£o forÃ§a salÃ¡rio mÃ­nimo)\n// - SalÃ¡rio mÃ­nimo Ã© apenas PISO (Math.max)\n// - NÃ£o faz fallback de estimativa (marca CRITICO)\n// - MÃªs completo = valor mensal cheio\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst projetarParcelasFuturas = ({ dib, dcb, nb, mr, creditos, dias_restantes, valorDiarioLiquido, ultimo_dia_coberto }, tagsArray) => {\n  // ValidaÃ§Ãµes iniciais\n  if (!dcb || dias_restantes <= 0) return [];\n  if (!creditos || creditos.length === 0) return [];\n\n  const parcelas = [];\n\n  // 1. Identificar o ÃšLTIMO MÃŠS DE PAGAMENTO no extrato\n  let ultimaDataPagamento = null;\n  for (const credito of creditos) {\n    const dataPag = credito.pagamento?.data || credito.pagamento?.previsao;\n    if (dataPag && (!ultimaDataPagamento || dataPag > ultimaDataPagamento)) {\n      ultimaDataPagamento = dataPag;\n    }\n  }\n\n  if (!ultimaDataPagamento) return [];\n\n  \n  // 2. CORREÃ‡ÃƒO v6.6: Partir do Ãºltimo dia coberto + 1 dia\n  // A competÃªncia Ã© baseada no MÃŠS onde cai o primeiro dia do prÃ³ximo perÃ­odo\n  let primeiroDiaPeriodo;\n  if (ultimo_dia_coberto) {\n    primeiroDiaPeriodo = adicionarDias(ultimo_dia_coberto, 1);\n  } else {\n    // Fallback: usar Ãºltimo perÃ­odo do extrato\n    const ultimoCredito = creditos[creditos.length - 1];\n    if (ultimoCredito?.periodo?.fim) {\n      primeiroDiaPeriodo = adicionarDias(ultimoCredito.periodo.fim, 1);\n    } else {\n      // Ãšltimo recurso: usar data de pagamento\n      primeiroDiaPeriodo = adicionarDias(ultimaDataPagamento, 1);\n    }\n  }\n\n  // 3. Extrair mÃªs/ano do PERÃODO para competÃªncia\n  const { mes: mesPrimeiroDia, ano: anoPrimeiroDia } = extrairMesAno(primeiroDiaPeriodo);\n  \n  // 4. COMPETÃŠNCIA = mÃªs do perÃ­odo (usado para identificar a fatura)\n  let mesCompetencia = mesPrimeiroDia;\n  let anoCompetencia = anoPrimeiroDia;\n  let competenciaAtual = `${String(mesCompetencia).padStart(2, '0')}/${anoCompetencia}`;\n  \n  // 5. Extrair mÃªs/ano do ÃšLTIMO PAGAMENTO para calcular prÃ³ximo mÃªs de pagamento\n  const { mes: mesUltimoPgto, ano: anoUltimoPgto } = extrairMesAno(ultimaDataPagamento);\n  \n  // 6. MÃŠS DE PAGAMENTO = mÃªs seguinte ao Ãºltimo pagamento (usado para buscar no calendÃ¡rio)\n  let mesPagamentoAtual = mesUltimoPgto + 1;\n  let anoPagamentoAtual = anoUltimoPgto;\n  if (mesPagamentoAtual > 12) {\n    mesPagamentoAtual = 1;\n    anoPagamentoAtual++;\n  }\n  \n  // 7. TRAVA: Garantir que mÃªs de pagamento seja POSTERIOR ao Ãºltimo pagamento\n  const ultimoPgtoMesAno = `${anoUltimoPgto}-${String(mesUltimoPgto).padStart(2, '0')}`;\n  const proximoPgtoMesAno = `${anoPagamentoAtual}-${String(mesPagamentoAtual).padStart(2, '0')}`;\n  if (proximoPgtoMesAno <= ultimoPgtoMesAno) {\n    mesPagamentoAtual++;\n    if (mesPagamentoAtual > 12) {\n      mesPagamentoAtual = 1;\n      anoPagamentoAtual++;\n    }\n  }\n\n  let diasProjetados = 0;\n  let parcelaNum = 1;\n  let temErroCritico = false;\n\n  // 8. Loop por meses de COMPETÃŠNCIA (perÃ­odo)\n  while (diasProjetados < dias_restantes) {\n    // PERÃODO usa mesCompetencia/anoCompetencia\n    const inicioPeriodo = parcelaNum === 1 ? primeiroDiaPeriodo :\n      `${anoCompetencia}-${String(mesCompetencia).padStart(2, '0')}-01`;\n    const fimMes = `${anoCompetencia}-${String(mesCompetencia).padStart(2, '0')}-${ultimoDiaMes(anoCompetencia, mesCompetencia)}`;\n    \n    const fimPeriodo = fimMes <= dcb ? fimMes : dcb;\n\n    if (inicioPeriodo > dcb) break;\n\n    // CORREÃ‡ÃƒO v6.6: INSS usa sempre 30 dias por mÃªs (mÃªs comercial)\n    // MÃªs completo = 30 dias, independente de ter 28, 30 ou 31 dias reais\n    const primeiroDiaDoMes = `${anoCompetencia}-${String(mesCompetencia).padStart(2, '0')}-01`;\n    const ultimoDiaDoMesReal = ultimoDiaMes(anoCompetencia, mesCompetencia);\n    const ultimoDiaDoMes = `${anoCompetencia}-${String(mesCompetencia).padStart(2, '0')}-${ultimoDiaDoMesReal}`;\n    \n    // Verificar se Ã© mÃªs completo (comeÃ§a dia 1 e termina no Ãºltimo dia OU depois do DCB)\n    const ehMesCompleto = (inicioPeriodo === primeiroDiaDoMes) && (fimPeriodo === ultimoDiaDoMes);\n\n    \n\n\n   // CONTAGEM = dias corridos REAIS (para determinar quando completam 120 dias)\n    // VALOR = mÃªs completo paga MR cheio, parcial usa divisor 30\n    const diasPeriodo = calcularDias(inicioPeriodo, fimPeriodo);\n    const diasEfetivos = Math.min(diasPeriodo, dias_restantes - diasProjetados);\n\n   if (diasEfetivos <= 0) break;\n\n    // v6.6: MR ORIGINAL do cliente (com piso do salÃ¡rio mÃ­nimo)\n    const anoDoPeriodo = parseInt(inicioPeriodo.substring(0, 4));\n    const salarioMinimoPeriodo = getSalarioMinimo(anoDoPeriodo);\n    const mrDoPeriodo = Math.max(mr, salarioMinimoPeriodo);\n    \n    // Se MR foi ajustado para o mÃ­nimo, registrar como INFO\n    if (mr < salarioMinimoPeriodo) {\n      tagsArray.push(criarTag('INFO_MR_AJUSTADO_MINIMO', {\n        mr_original: mr,\n        mr_ajustado: salarioMinimoPeriodo,\n        ano: anoDoPeriodo\n      }));\n    }\n\n    // v6.6: Buscar data de pagamento pela COMPETÃŠNCIA (nÃ£o pelo mÃªs de pagamento!)\n    const resultadoData = obterDataPagamentoINSS(nb, competenciaAtual, mrDoPeriodo);\n\n    // Se nÃ£o encontrou data, marca crÃ­tico mas CONTINUA processando\n    if (resultadoData.erro) {\n      tagsArray.push(criarTag(resultadoData.tag, {\n        competencia: competenciaAtual,\n        mes_pagamento: `${mesPagamentoAtual}/${anoPagamentoAtual}`,\n        motivo: resultadoData.mensagem\n      }));\n      temErroCritico = true;\n    }\n\n    // Calcular valores do perÃ­odo\n    const descontoINSSPeriodo = calcularDescontoINSS(mrDoPeriodo, anoDoPeriodo);\n    const liquidoMensalPeriodo = tr(mrDoPeriodo - descontoINSSPeriodo.desconto);\n    const valorDiarioPeriodo = tr(liquidoMensalPeriodo / 30);\n\n    // Valor da parcela: mÃªs completo = valor mensal cheio\n    let valorLiquidoParcela;\n    if (ehMesCompleto) {\n      valorLiquidoParcela = liquidoMensalPeriodo;\n    } else {\n      valorLiquidoParcela = tr(valorDiarioPeriodo * diasEfetivos);\n    }\n    \n\n    parcelas.push({\n      numero: parcelaNum,\n      competencia: competenciaAtual,\n      periodo_inicio: inicioPeriodo,\n      periodo_fim: fimPeriodo,\n      dias: diasEfetivos,\n      valor_liquido: valorLiquidoParcela,\n      valor_liquido_formatado: formatarMoeda(valorLiquidoParcela),\n      data_pagamento_prevista: resultadoData.data_pagamento, // Pode ser null se nÃ£o encontrou\n      data_pagamento_prevista_formatada: formatarData(resultadoData.data_pagamento),\n      mes_pagamento: `${String(mesPagamentoAtual).padStart(2, '0')}/${anoPagamentoAtual}`,\n      origem_data: resultadoData.origem,\n      data_erro: resultadoData.erro || false,\n      digito_nb: resultadoData.digito_nb,\n      faixa_mr: resultadoData.faixa_mr,\n      ano_calendario: resultadoData.ano_calendario,\n      mr_utilizado: mrDoPeriodo,\n      eh_mes_completo: ehMesCompleto,\n      projetado: true,\n      status: 'PROJETADO'\n    });\n\n    diasProjetados += diasEfetivos;\n    parcelaNum++;\n\n    // AvanÃ§ar para prÃ³ximo mÃªs (AMBOS: competÃªncia e pagamento)\n    mesCompetencia++;\n    if (mesCompetencia > 12) {\n      mesCompetencia = 1;\n      anoCompetencia++;\n    }\n    mesPagamentoAtual++;\n    if (mesPagamentoAtual > 12) {\n      mesPagamentoAtual = 1;\n      anoPagamentoAtual++;\n    }\n    competenciaAtual = `${String(mesCompetencia).padStart(2, '0')}/${anoCompetencia}`;\n\n    if (parcelaNum > 12) break;\n  }\n\n  return parcelas;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VALIDAÃ‡ÃƒO DE CONTINUIDADE DE PAGAMENTOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst validarContinuidadePagamentos = (creditosProcessados, parcelasProjetadas) => {\n  const todosPagamentos = [\n    ...creditosProcessados.map(c => ({\n      competencia: c.competencia,\n      data_pagamento: c.pagamento?.data || c.pagamento?.previsao || c.calculo_inss?.data_pagamento_calendario,\n      tipo: 'EXTRATO'\n    })),\n    ...parcelasProjetadas.filter(p => p.data_pagamento_prevista).map(p => ({\n      competencia: p.competencia,\n      data_pagamento: p.data_pagamento_prevista,\n      tipo: 'PROJETADO'\n    }))\n  ];\n\n  const pagamentosValidos = todosPagamentos.filter(p => p.data_pagamento);\n\n  if (pagamentosValidos.length < 2) {\n    return { valido: true, mensagem: 'Poucos pagamentos para validar' };\n  }\n\n  pagamentosValidos.sort((a, b) => a.data_pagamento.localeCompare(b.data_pagamento));\n\n  const mesesPagamento = [...new Set(pagamentosValidos.map(p => p.data_pagamento.substring(0, 7)))].sort();\n\n  const erros = [];\n  for (let i = 1; i < mesesPagamento.length; i++) {\n    const [anoAnt, mesAnt] = mesesPagamento[i-1].split('-').map(Number);\n    const [anoAtual, mesAtual] = mesesPagamento[i].split('-').map(Number);\n    const diffMeses = (anoAtual - anoAnt) * 12 + (mesAtual - mesAnt);\n    if (diffMeses > 1) {\n      erros.push({\n        de: mesesPagamento[i-1],\n        para: mesesPagamento[i],\n        pulo: diffMeses - 1\n      });\n    }\n  }\n\n  if (erros.length > 0) {\n    return {\n      valido: false,\n      mensagem: `Pulo de mÃªs detectado: ${erros.map(e => `${e.de} â†’ ${e.para} (${e.pulo} mÃªs(es))`).join(', ')}`,\n      erros,\n      meses_pagamento: mesesPagamento\n    };\n  }\n\n  return {\n    valido: true,\n    mensagem: 'Continuidade de pagamentos validada - sem pulos',\n    meses_pagamento: mesesPagamento\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 13Âº SALÃRIO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst calcular13oSalario = (mr, dib, dcb) => {\n  if (!dib || !dcb) return null;\n\n  const dibDate = new Date(dib);\n  const dcbDate = new Date(dcb);\n  let avos = 0;\n  let mesesContados = [];\n\n  let dataAtual = new Date(dibDate);\n  while (dataAtual <= dcbDate) {\n    const ano = dataAtual.getFullYear();\n    const mes = dataAtual.getMonth() + 1;\n    const primeiroDiaMes = new Date(ano, mes - 1, 1);\n    const ultimoDiaMes = new Date(ano, mes, 0);\n    const inicioNoMes = dataAtual > primeiroDiaMes ? dataAtual : primeiroDiaMes;\n    const fimNoMes = dcbDate < ultimoDiaMes ? dcbDate : ultimoDiaMes;\n    const diasNoMes = Math.floor((fimNoMes - inicioNoMes) / (1000 * 60 * 60 * 24)) + 1;\n\n    mesesContados.push({ mes: `${String(mes).padStart(2, '0')}/${ano}`, dias: diasNoMes, conta_avo: diasNoMes >= 15 });\n    if (diasNoMes >= 15) avos++;\n\n    dataAtual = new Date(ano, mes, 1);\n  }\n\n  const valor13o = tr((mr / 12) * avos);\n\n  return {\n    valor_13o: valor13o,\n    valor_13o_formatado: formatarMoeda(valor13o),\n    avos,\n    avos_texto: `${avos}/12`,\n    meses_detalhes: mesesContados,\n    formula: `(${formatarMoeda(mr)} / 12) Ã— ${avos} = ${formatarMoeda(valor13o)}`\n  };\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO DE RETORNO (NUNCA PARA O FLUXO!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst criarRetorno = (resumo, dados, tags, campos_deal, campos_invoice_base, ctx6A) => {\n  const resumoTags = gerarResumoTags(tags);\n  \n  return [{\n    json: {\n      // Metadados\n      _no: '6B',\n      _versao: '6.5',\n      _timestamp: new Date().toISOString(),\n      _tempo_ms: Date.now() - inicio,\n      _processou: true, // SEMPRE true - o nÃ³ rodou\n      \n      // Status do cÃ¡lculo\n      ok: resumoTags.pode_faturar, // true se nÃ£o tem CRITICO\n      pode_faturar: resumoTags.pode_faturar,\n      \n      // Tags com criticidade\n      tags: tags,\n      resumo_tags: resumoTags,\n      \n      // Dados do cÃ¡lculo\n      resumo: resumo,\n      dados: dados,\n      \n      // Mapeamento de IDs\n      CAMPOS_DEAL_IDS: CD,\n      CAMPOS_INVOICE_IDS: CI,\n      CAMPOS_EXTRAS: CAMPOS_EXTRAS,\n      \n      // Campos para atualizar\n      campos_deal: campos_deal,\n      campos_invoice_base: campos_invoice_base,\n      \n      // Contexto do 6A\n      deal_id: ctx6A?.deal_id,\n      deal: ctx6A?.deal\n    }\n  }];\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXECUÃ‡ÃƒO PRINCIPAL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ctx6A = $json;\nconst campos_deal_6A = ctx6A.campos_deal || {};\nconst campos_invoice_6A = ctx6A.campos_invoice_base || {};\nconst tags = [];\n\n// Se 6A veio com erro, propaga mas NÃƒO PARA\nif (!ctx6A.ok) {\n  tags.push(criarTag('CRITICO_ERRO_6A', {\n    erro_original: ctx6A.erro?.tag || 'DESCONHECIDO',\n    mensagem: ctx6A.erro?.mensagem || 'Erro nÃ£o especificado do 6A'\n  }));\n  \n  // Propagar tags do 6A se existirem\n  if (Array.isArray(ctx6A.tags)) {\n    for (const t of ctx6A.tags) {\n      if (t && !tags.find(x => x.tag === t.tag)) tags.push(t);\n    }\n  }\n  \n  const resumoBase = {\n    nome: ctx6A.cliente?.nome || 'Desconhecido',\n    cpf: ctx6A.cliente?.cpf || '',\n    nb: ctx6A.beneficio?.nb || '',\n    deal_id: ctx6A.deal_id,\n    erro_6a: true\n  };\n  \n  return criarRetorno(resumoBase, ctx6A, tags, campos_deal_6A, campos_invoice_6A, ctx6A);\n}\n\n// Se nÃ£o Ã© extrato de crÃ©ditos, apenas repassa\nif (ctx6A.tipo_documento !== 'EXTRATO_CREDITOS') {\n  tags.push(criarTag('OK_CALCULO_COMPLETO', { tipo: ctx6A.tipo_documento }));\n  \n  return criarRetorno(\n    { tipo_documento: ctx6A.tipo_documento, mensagem: 'Documento nÃ£o requer cÃ¡lculos INSS' },\n    ctx6A,\n    tags,\n    campos_deal_6A,\n    campos_invoice_6A,\n    ctx6A\n  );\n}\n\n// Extrair dados do 6A\nconst { cliente, beneficio, creditos, cobertura } = ctx6A;\nconst mr = beneficio?.mr;\nconst nb = beneficio?.nb;\nconst dib = beneficio?.dib;\nconst dcb = beneficio?.dcb;\nconst ano = dib ? parseInt(dib.substring(0, 4)) : 2025;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VALIDAÃ‡Ã•ES CRÃTICAS (nÃ£o param o fluxo, sÃ³ marcam tags)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (!mr || mr === '' || mr === null || mr === undefined) {\n  tags.push(criarTag('CRITICO_MR_VAZIO', { valor_recebido: mr }));\n} else if (mr <= 0 || isNaN(mr)) {\n  tags.push(criarTag('CRITICO_MR_INVALIDO', { valor_recebido: mr }));\n}\n\nif (!nb || nb === '') {\n  tags.push(criarTag('CRITICO_NB_VAZIO'));\n}\n\nif (!dib || dib === '') {\n  tags.push(criarTag('CRITICO_DIB_VAZIO'));\n}\n\nif (!dcb || dcb === '') {\n  tags.push(criarTag('CRITICO_DCB_VAZIO'));\n}\n\nif (!creditos || creditos.length === 0) {\n  tags.push(criarTag('CRITICO_CREDITOS_VAZIO'));\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CÃLCULOS (mesmo com erros crÃ­ticos, tenta calcular o que dÃ¡)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst mrValido = mr && mr > 0 && !isNaN(mr) ? mr : 0;\nconst descontoINSS = mrValido > 0 ? calcularDescontoINSS(mrValido, ano) : { desconto: 0, aliquota_efetiva: 0, detalhes: [] };\nconst valoresDerivados = calcularValoresDerivados(mrValido, descontoINSS.desconto);\nconst situacaoFinanceira = calcularSituacaoFinanceira(creditos || [], valoresDerivados.valor_diario_liquido);\n\n// Processar crÃ©ditos do extrato\nconst creditosProcessados = (creditos || []).map(credito => {\n  const resultado = obterDataPagamentoINSS(nb || '', credito.competencia, mrValido);\n  \n  // Se nÃ£o encontrou data, registrar (mas nÃ£o criar tag duplicada aqui)\n  return {\n    ...credito,\n    calculo_inss: {\n      data_pagamento_calendario: resultado.data_pagamento,\n      data_pagamento_calendario_formatada: formatarData(resultado.data_pagamento),\n      origem_data: resultado.origem,\n      data_erro: resultado.erro || false,\n      digito_nb: resultado.digito_nb,\n      faixa_mr: resultado.faixa_mr,\n      ano_calendario: resultado.ano_calendario\n    }\n  };\n});\n\n// Projetar parcelas futuras\nlet parcelasProjetadas = [];\nif (situacaoFinanceira.tem_a_receber && situacaoFinanceira.dias.restantes > 0 && mrValido > 0 && nb && dcb) {\n  parcelasProjetadas = projetarParcelasFuturas({\n    dib,\n    dcb,\n    nb,\n    mr: mrValido,\n    creditos: creditosProcessados,\n    dias_restantes: situacaoFinanceira.dias.restantes,\n    valorDiarioLiquido: valoresDerivados.valor_diario_liquido,\n    ultimo_dia_coberto: cobertura?.ultimo_dia_coberto\n  }, tags);\n  \n  if (parcelasProjetadas.length > 0) {\n    tags.push(criarTag('INFO_PROJECAO_GERADA', { quantidade: parcelasProjetadas.length }));\n  }\n}\n\n// Validar continuidade de pagamentos\nif (parcelasProjetadas.length > 0) {\n  const validacao = validarContinuidadePagamentos(creditosProcessados, parcelasProjetadas);\n  if (!validacao.valido) {\n    tags.push(criarTag('CRITICO_PULO_MES', {\n      mensagem: validacao.mensagem,\n      erros: validacao.erros,\n      meses: validacao.meses_pagamento\n    }));\n  }\n}\n\n// Verificar se dias excederam 120\nconst diasTotais = situacaoFinanceira.dias.cobertos + parcelasProjetadas.reduce((sum, p) => sum + p.dias, 0);\nif (diasTotais > 120) {\n  tags.push(criarTag('CRITICO_DIAS_EXCEDIDOS', { dias_calculados: diasTotais }));\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ALERTAS E INFOS (nÃ£o crÃ­ticos)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 13Âº salÃ¡rio\nlet calculo13o = null;\nconst isAVista = situacaoFinanceira.beneficio_completo && !situacaoFinanceira.tem_a_receber;\nif (isAVista && creditos && creditos.length > 0 && mrValido > 0) {\n  calculo13o = calcular13oSalario(mrValido, dib, dcb);\n  if (calculo13o && calculo13o.valor_13o > 0) {\n    tags.push(criarTag('INFO_TEM_13O', { valor: calculo13o.valor_13o }));\n  }\n}\n\n// Primeira parcela\nif (creditos && creditos.length === 1 && situacaoFinanceira.dias.cobertos < 40) {\n  tags.push(criarTag('INFO_PRIMEIRA_PARCELA'));\n}\n\n// QuitaÃ§Ã£o\nif (situacaoFinanceira.beneficio_completo && !situacaoFinanceira.tem_a_receber) {\n  tags.push(criarTag('OK_QUITACAO'));\n}\n\n// Quase completo\nif (situacaoFinanceira.dias.restantes > 0 && situacaoFinanceira.dias.restantes <= 15) {\n  tags.push(criarTag('AVISO_QUASE_COMPLETO', { dias_restantes: situacaoFinanceira.dias.restantes }));\n}\n\n// Valores baixos e perÃ­odos curtos\nif (creditos) {\n  creditos.forEach(c => {\n    if (c.valores?.liquido < 100) {\n      tags.push(criarTag('AVISO_VALOR_BAIXO', { competencia: c.competencia, valor: c.valores.liquido }));\n    }\n    if (c.dias <= 5) {\n      tags.push(criarTag('AVISO_PERIODO_CURTO', { competencia: c.competencia, dias: c.dias }));\n    }\n  });\n}\n\n// Parcelas juntas\nconst datasPagamento = (creditos || []).map(c => c.pagamento?.data).filter(Boolean);\nconst datasUnicas = [...new Set(datasPagamento)];\nif (datasPagamento.length > datasUnicas.length) {\n  tags.push(criarTag('INFO_PARCELAS_JUNTAS', { quantidade: datasPagamento.length - datasUnicas.length }));\n}\n\n// Se nÃ£o tem nenhum crÃ­tico, marca como OK\nconst temCritico = tags.some(t => t.nivel === 'CRITICO');\nif (!temCritico) {\n  tags.push(criarTag('OK_CALCULO_COMPLETO'));\n  if (parcelasProjetadas.length > 0 && !parcelasProjetadas.some(p => p.data_erro)) {\n    tags.push(criarTag('OK_PROJECAO_CONFIAVEL'));\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MONTAR RESUMO E DADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst totalProjetado = parcelasProjetadas.reduce((sum, p) => sum + p.valor_liquido, 0);\nconst total13o = calculo13o?.valor_13o || 0;\n\nconst resumo = {\n  nome: cliente?.nome || 'Desconhecido',\n  cpf: cliente?.cpf || '',\n  nb: nb || '',\n  mr: mrValido,\n  mr_formatado: formatarMoeda(mrValido),\n  dib: formatarData(dib),\n  dcb: formatarData(dcb),\n  desconto_inss: descontoINSS.desconto,\n  desconto_inss_formatado: formatarMoeda(descontoINSS.desconto),\n  aliquota_efetiva: descontoINSS.aliquota_efetiva,\n  aliquota_efetiva_texto: `${descontoINSS.aliquota_efetiva}%`,\n  liquido_mensal: valoresDerivados.liquido_mensal,\n  liquido_mensal_formatado: formatarMoeda(valoresDerivados.liquido_mensal),\n  valor_diario_liquido: valoresDerivados.valor_diario_liquido,\n  valor_diario_liquido_formatado: formatarMoeda(valoresDerivados.valor_diario_liquido),\n  total_120_dias: valoresDerivados.total_120_dias,\n  total_120_dias_formatado: formatarMoeda(valoresDerivados.total_120_dias),\n  dias_pagos: situacaoFinanceira.dias.pagos,\n  dias_pendentes: situacaoFinanceira.dias.pendentes,\n  dias_cobertos: situacaoFinanceira.dias.cobertos,\n  dias_restantes: situacaoFinanceira.dias.restantes,\n  dias_total: 120,\n  valor_pago: situacaoFinanceira.valores.pago,\n  valor_pago_formatado: situacaoFinanceira.valores.pago_formatado,\n  valor_pendente: situacaoFinanceira.valores.pendente,\n  valor_pendente_formatado: situacaoFinanceira.valores.pendente_formatado,\n  valor_a_receber: situacaoFinanceira.valores.a_receber,\n  valor_a_receber_formatado: situacaoFinanceira.valores.a_receber_formatado,\n  valor_total_beneficio: situacaoFinanceira.valores.total_beneficio,\n  valor_total_beneficio_formatado: situacaoFinanceira.valores.total_beneficio_formatado,\n  percentual_pago: situacaoFinanceira.percentuais.pago,\n  percentual_pendente: situacaoFinanceira.percentuais.pendente,\n  percentual_coberto: situacaoFinanceira.percentuais.coberto,\n  percentual_restante: situacaoFinanceira.percentuais.restante,\n  parcelas_pagas: situacaoFinanceira.parcelas.pagas,\n  parcelas_pendentes: situacaoFinanceira.parcelas.pendentes,\n  parcelas_extrato: situacaoFinanceira.parcelas.total_extrato,\n  beneficio_completo: situacaoFinanceira.beneficio_completo,\n  tem_pendente: situacaoFinanceira.tem_pendente,\n  vai_ter_mais: situacaoFinanceira.tem_a_receber,\n  parcelas_projetadas: parcelasProjetadas.length,\n  total_projetado: tr(totalProjetado),\n  total_projetado_formatado: formatarMoeda(totalProjetado),\n  proxima_data: parcelasProjetadas[0]?.data_pagamento_prevista_formatada || '-',\n  ultima_data: parcelasProjetadas.length > 0 ? parcelasProjetadas[parcelasProjetadas.length - 1].data_pagamento_prevista_formatada : '-',\n  tem_13o: !!calculo13o,\n  valor_13o: total13o,\n  valor_13o_formatado: formatarMoeda(total13o),\n  avos_13o: calculo13o?.avos_texto || '-',\n  total_extrato: situacaoFinanceira.valores.pago + situacaoFinanceira.valores.pendente,\n  total_extrato_formatado: formatarMoeda(situacaoFinanceira.valores.pago + situacaoFinanceira.valores.pendente),\n  total_geral: tr(situacaoFinanceira.valores.pago + situacaoFinanceira.valores.pendente + totalProjetado + total13o),\n  total_geral_formatado: formatarMoeda(situacaoFinanceira.valores.pago + situacaoFinanceira.valores.pendente + totalProjetado + total13o),\n  deal_id: ctx6A.deal_id,\n  faturas_criadas: 0,\n  total_faturas: 0,\n  saldo_start: tr(valoresDerivados.total_120_dias * 0.30)\n};\n\nconst dados = {\n  tipo_documento: 'EXTRATO_CREDITOS',\n  cliente,\n  beneficio: {\n    ...beneficio,\n    desconto_inss: descontoINSS.desconto,\n    liquido_mensal: valoresDerivados.liquido_mensal,\n    valor_diario_liquido: valoresDerivados.valor_diario_liquido,\n    total_120_dias: valoresDerivados.total_120_dias\n  },\n  cobertura: {\n    ...cobertura,\n    dias_cobertos: situacaoFinanceira.dias.cobertos,\n    dias_restantes: situacaoFinanceira.dias.restantes,\n    percentual: situacaoFinanceira.percentuais.coberto,\n    vai_ter_mais_parcelas: situacaoFinanceira.tem_a_receber,\n    cobertura_completa: situacaoFinanceira.beneficio_completo\n  },\n  situacao_financeira: situacaoFinanceira,\n  calculo_inss: {\n    ano_referencia: ano,\n    faixas_utilizadas: descontoINSS.detalhes,\n    desconto_total: descontoINSS.desconto,\n    aliquota_efetiva: descontoINSS.aliquota_efetiva,\n    aliquota_efetiva_texto: `${descontoINSS.aliquota_efetiva}%`\n  },\n  creditos: creditosProcessados,\n  parcelas_projetadas: parcelasProjetadas,\n  decimo_terceiro: calculo13o,\n  calendario_info: {\n    nb: nb || '',\n    digito_calendario: extrairDigitoCalendario(nb || ''),\n    faixa_mr: mrValido <= getSalarioMinimo(ano) ? 'ATE_1SM' : 'ACIMA_1SM',\n    salario_minimo_ano: getSalarioMinimo(ano),\n    calendarios_disponiveis: ['2025', '2026']\n  },\n  deal_id: ctx6A.deal_id,\n  deal: ctx6A.deal\n};\n\n// Campos para atualizar no Deal\nconst campos_deal_enriquecido = {\n  ...campos_deal_6A,\n  [CD.aliquota_mr]: descontoINSS.aliquota_efetiva,\n  [CD.valor_total_beneficio]: valoresDerivados.total_120_dias,\n};\n\n// Campos para atualizar na Invoice\nconst campos_invoice_enriquecido = {\n  ...campos_invoice_6A,\n  [CI.aliquota_mr]: descontoINSS.aliquota_efetiva,\n  [CI.valor_liquido_mensal]: formatMoneyBitrix(valoresDerivados.liquido_mensal),\n  [CI.valor_diario]: valoresDerivados.valor_diario_liquido,\n  [CI.valor_total_beneficio]: valoresDerivados.total_120_dias,\n  [CI.dias_ja_recebidos]: situacaoFinanceira.dias.cobertos,\n  [CI.dias_restantes]: situacaoFinanceira.dias.restantes\n};\n\n// Log de debug\nconsole.log(JSON.stringify({\n  no: '6B',\n  versao: '6.5',\n  correcoes: ['MR_ORIGINAL', 'SEM_FALLBACK', 'TAGS_CRITICIDADE'],\n  ok: !temCritico,\n  pode_faturar: !temCritico,\n  mr_utilizado: mrValido,\n  tags_resumo: {\n    total: tags.length,\n    criticos: tags.filter(t => t.nivel === 'CRITICO').length,\n    avisos: tags.filter(t => t.nivel === 'AVISO').length\n  },\n  parcelas_projetadas: parcelasProjetadas.length,\n  tem_data_erro: parcelasProjetadas.some(p => p.data_erro)\n}));\n\nreturn criarRetorno(resumo, dados, tags, campos_deal_enriquecido, campos_invoice_enriquecido, ctx6A);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5952,
        25792
      ],
      "id": "5d393afb-c040-4eff-baae-4275e4daced6",
      "name": "6B.Calculo do INSS"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6D â€” REVISOR DE CÃLCULOS (V5.8)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Validar TUDO, consolidar tags, decidir ok/erro\n// ENTRADA: 5 inputs do Merge 1 (Gemini, 6A, 6B, 6C, BUSCAR DEAL)\n// SAÃDA: ok: true/false + auditoria completa + dados para prÃ³ximo nÃ³\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// CHANGELOG V5.7 (08/01/2026):\n// ğŸ”¥ CORREÃ‡ÃƒO CRÃTICA: ValidaÃ§Ã£o PDF vs Deal separada!\n//    - cpfPDF (do Gemini/6A) vs cpfDeal (do Deal/1B)\n//    - nbPDF (do Gemini/6A) vs nbDeal (do Deal/1B)\n// ğŸ”¥ NOVO: Erros especÃ­ficos E_CPF_PDF_DIFERENTE_DEAL e E_NB_PDF_DIFERENTE_DEAL\n// âœ… MANTÃ‰M: contact_id e assessor no output (v5.6)\n// âœ… MANTÃ‰M: Tudo do V5.5 (92 campos, mapeamento completo)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ BUSCAR CADA INPUT DO MERGE EXPLICITAMENTE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados6B = buscarNo('6B.Calculo do INSS');\nconst dados6A = buscarNo('6A. Calculo do Historico de credito (PDF)');\nconst dadosGemini = buscarNo('5. Gemini Extrair2');\nconst dados1B = buscarNo('1B. Inicializar');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.4: BUSCAR DEAL DO ARRAY DE INPUTS DO MERGE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// O Merge junta vÃ¡rios inputs em um array. O Deal vem no item que tem \"result\"\n// Precisamos iterar para encontrar o item correto!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Primeiro tenta buscar do nÃ³ BUSCAR DEAL diretamente\nlet dealData = {};\nconst dadosBuscarDealDireto = buscarNo('BUSCAR DEAL');\nif (dadosBuscarDealDireto && dadosBuscarDealDireto.result) {\n  dealData = dadosBuscarDealDireto.result;\n} else {\n  // Se nÃ£o encontrou, procura no array de inputs o item que tem \"result\"\n  const todosInputs = $input.all();\n  for (const item of todosInputs) {\n    if (item.json && item.json.result && item.json.result.ID) {\n      dealData = item.json.result;\n      break;\n    }\n  }\n}\n\n// Fallback: se ainda vazio, tenta pegar do primeiro input (compatibilidade)\nif (Object.keys(dealData).length === 0) {\n  const primeiroInput = $input.first()?.json || {};\n  if (primeiroInput.result) {\n    dealData = primeiroInput.result;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DEAL â†’ INVOICE (IDs corretos de cada entidade)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// IDs dos campos no DEAL\nconst CD = {\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // MAPEAMENTO COMPLETO DO DEAL - BASEADO NA PLANILHA OFICIAL\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  // 1. IDENTIFICAÃ‡ÃƒO\n  cpf: 'UF_CRM_5F7DD07B0ADB5',\n  rg: 'UF_CRM_5F7DD07B11C33',\n  nit: 'UF_CRM_1766282969',\n  nb: 'UF_CRM_1737470444334',\n  nome_filho: 'UF_CRM_1699462600794',\n  categoria: 'UF_CRM_5F7DD07B0295D',\n  \n  // 2. BENEFÃCIO (Datas)\n  dib: 'UF_CRM_1765928945',\n  dip: 'UF_CRM_1766439387',\n  dcb: 'UF_CRM_1748433331869',\n  dn_mamae: 'UF_CRM_1602615428011',\n  dn_filho: 'UF_CRM_5F7DD07B1997D',\n  dn_certidao: 'UF_CRM_1714741602233',\n  data_dnv: 'UF_CRM_1742827283535',\n  data_requerimento: 'UF_CRM_6094054C7C1C8',\n  data_concessao: 'UF_CRM_1602256897805',\n  \n  // 3. BENEFÃCIO (Valores)\n  mr_cliente: 'UF_CRM_1741726157749',\n  valor_total_beneficio: 'UF_CRM_1742841962002',\n  aliquota_mr: 'UF_CRM_1742841855608',\n  \n  // 5. FATURAMENTO (Parcela)\n  valor_inss: 'UF_CRM_1634158430224',\n  valor_cliente: 'UF_CRM_1634828809106',\n  valor_previsto: 'UF_CRM_1635261498013',\n  valor_recebido: 'UF_CRM_1633535814529',\n  parcela_numero: 'UF_CRM_1634158972573',\n  qtd_parcelas: 'UF_CRM_1625253358741',\n  \n  // 8. BANCO\n  banco: 'UF_CRM_1603216440272',\n  endereco_banco: 'UF_CRM_1603216499370',\n  agencia_banco: 'UF_CRM_1762558313',\n  \n  // 9. CONTROLE / ANÃLISE\n  justificativa_direito: 'UF_CRM_1765636941',\n  data_rodagem: 'UF_CRM_1764270308863',\n  rodagem_comentario: 'UF_CRM_1764270260617',\n  \n  // 10. GESTÃƒO\n  assessor: 'UF_CRM_5F7DD07AEC035',\n  ultimo_relacionador: 'UF_CRM_1688072257656',\n  ddd_cliente: 'UF_CRM_659C48C5F0594',\n  data_reclamacao: 'UF_CRM_1704738513559',\n  data_qualificacao: 'UF_CRM_65E74D984ED3C',\n  data_recuperacao: 'UF_CRM_1713804709729',\n  data_encerramento: 'UF_CRM_663007E42D75E',\n  data_reentrada: 'UF_CRM_1615653096667',\n\n\n\n  \n  // CAMPOS EXTRAS (da planilha - linhas 71-92)\n  data_conversao: 'UF_CRM_5F7DD07B204FD',\n  data_certidao: 'UF_CRM_1674755625727',\n  data_consulta: 'UF_CRM_1602256877083',\n  data_contato: 'UF_CRM_1650915373840',\n  data_prox_contato: 'UF_CRM_1650915411107',\n  data_sem_direito: 'UF_CRM_1649701660322',\n  data_indeferimento: 'UF_CRM_1620315580',\n  data_quebra_contrato: 'UF_CRM_1737722079155',\n  relacionador_quebra: 'UF_CRM_1737722166447',\n  relacionador_sem_direito: 'UF_CRM_1737722233583',\n  recurso: 'UF_CRM_1759219838803',\n  senha: 'UF_CRM_1602257200479',\n  sugestao_senha: 'UF_CRM_5FDA4FCE92DAA',\n  telefone_2: 'UF_CRM_606C6C98B68A7',\n  telefone_3: 'UF_CRM_606C6C9A00D10',\n  sine: 'UF_CRM_1751375841241',\n  data_envio_recurso: 'UF_CRM_1759220050331',\n\n  // 11. DARF (NOVO)\n  necessita_darf: 'UF_CRM_1650375670632', // NECESSITA DE DARF? (Sim! Start irÃ¡ pagar!)\n  valor_darf:     'UF_CRM_69416D0451D4A', // VALOR DA DARF\n\n\n\n};\n\n// IDs dos campos na INVOICE (Smart Process - entityTypeId 31)\nconst CI = {\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // MAPEAMENTO COMPLETO DA INVOICE - BASEADO NA PLANILHA OFICIAL\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  // 1. IDENTIFICAÃ‡ÃƒO\n  cpf: 'UF_CRM_652439CFE551C',\n  rg: 'UF_CRM_652439D00A9CF',\n  nit: 'UF_CRM_6947602572F0A',\n  nb: 'UF_CRM_6790DAD756E3C',\n  nome_filho: 'UF_CRM_65BD5488EC8E9',\n  categoria: 'UF_CRM_652439D03479D',\n  \n  // 2. BENEFÃCIO (Datas)\n  dib: 'UF_CRM_69442F085B2CD',\n  dip: 'UF_CRM_683860072DEB8',\n  dcb: 'UF_CRM_6838600845561',\n  dn_mamae: 'UF_CRM_652439D0138A5',\n  dn_filho: 'UF_CRM_652439D021438',\n  dn_certidao: 'UF_CRM_66351141F40C7',\n  data_dnv: 'UF_CRM_67E17F1C70EAF',\n  data_requerimento: 'UF_CRM_652439D3530AB',\n  data_concessao: 'UF_CRM_652439D157BA8',\n  \n  // 3. BENEFÃCIO (Valores)\n  mr_cliente: 'UF_CRM_67D19072D84A8',\n  valor_diario: 'UF_CRM_69442F466791E',\n  valor_liquido_mensal: 'UF_CRM_69442F4D0909D',\n  valor_total_beneficio: 'UF_CRM_69442F535C91B',\n  valor_restante_inss: 'UF_CRM_69442F3A581C2',\n  aliquota_mr: 'UF_CRM_67E1B184633ED',\n  especie_beneficio: 'UF_CRM_69442F6570BDB',\n  \n  // 4. HONORÃRIOS START\n  valor_total_start: 'UF_CRM_69442F217FB9D',\n  saldo_restante_start: 'UF_CRM_69442F27CCFB3',\n  aliquota_start: 'UF_CRM_69442F596A782',\n  regra_aplicada: 'UF_CRM_69442F5F762AD',\n  \n  // 5. FATURAMENTO (Parcela)\n  valor_inss: 'UF_CRM_652439D8D6B8E',\n  valor_cliente: 'UF_CRM_652439D915311',\n  valor_previsto: 'UF_CRM_652439D9202B3',\n  parcela_numero: 'UF_CRM_652439D8E9608',\n  parcela_formato: 'UF_CRM_652439D8CDB53',\n  qtd_parcelas: 'UF_CRM_67E1AD2860054',\n  \n  // 6. EXTRATO / COMPETÃŠNCIA\n  competencia: 'UF_CRM_691B6450B46E3',\n  competencia_final: 'UF_CRM_69442F0E9A95A',\n  periodo: 'UF_CRM_691B64560A17F',\n  ultima_comp_valida: 'UF_CRM_693D7DE5148DB',\n  credito_invalidado: 'UF_CRM_691B6467F11F2',\n  dias_ja_recebidos: 'UF_CRM_69442F2E321C4',\n  dias_restantes: 'UF_CRM_69442F3449D22',\n  \n  // 7. DATAS OPERACIONAIS\n  data_inss: 'UF_CRM_652439D8B3207',\n  data_pagamento_extrato: 'UF_CRM_691B64616C2C9',\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',\n  \n  // 8. BANCO\n  banco: 'UF_CRM_652439D194A06',\n  endereco_banco: 'UF_CRM_652439D1A53FA',\n  agencia_banco: 'UF_CRM_691225FDDDBE4',\n  \n  // 9. CONTROLE / ANÃLISE\n  justificativa_direito: 'UF_CRM_693D7BBC3E5D3',\n  resultado_analise: 'UF_CRM_693D7CB58EBD2',\n  data_rodagem: 'UF_CRM_6929FDA3C8A79',\n  rodagem_comentario: 'UF_CRM_6929FD9E9A95D',\n  direito_ate: 'UF_CRM_679781AAB3B1D',\n  \n  // 10. GESTÃƒO\n  assessor: 'UF_CRM_681E47094F79F',  // ğŸ”¥ V5.6: ID DO ASSESSOR NA INVOICE!\n  ultimo_relacionador: 'UF_CRM_65BD5488EC8E9',\n  ddd_cliente: 'UF_CRM_65BD5489DF3A2',\n  data_reclamacao: 'UF_CRM_65BD5489C89AD',\n  data_qualificacao: 'UF_CRM_65E777E2A0CED',\n  data_recuperacao: 'UF_CRM_662699414BCF0',\n  data_encerramento: 'UF_CRM_6631460FD3BB4',\n  data_reentrada: 'UF_CRM_678EADB02E460',\n  \n  // CAMPOS EXTRAS (da planilha - linhas 71-92)\n  data_conversao: 'UF_CRM_652439D0CF19F',\n  data_calculo: 'UF_CRM_69442F14E544C',\n  data_certidao: 'UF_CRM_652439DA75EFF',\n  data_consulta: 'UF_CRM_652439D14CF3D',\n  data_acordo: 'UF_CRM_652439DB85203',\n  data_contato: 'UF_CRM_652439D9B26DF',\n  data_sem_direito: 'UF_CRM_66ACE094C0195',\n  data_pagamento: 'UF_CRM_652439D8BD582',\n  data_indeferimento: 'UF_CRM_652439D3E866C',\n  data_recebimento: 'UF_CRM_652439D1B26E2',\n  desconto: 'UF_CRM_6838600A5C767',\n  data_quebra_contrato: 'UF_CRM_6793A405B3FC1',\n  relacionador_quebra: 'UF_CRM_6793A4065BECA',\n  relacionador_sem_direito: 'UF_CRM_6793A40701BCB',\n  recurso: 'UF_CRM_68DD552A351D0',\n  senha: 'UF_CRM_652439D16254A',\n  sugestao_senha: 'UF_CRM_652439D23E905',\n  telefone_2: 'UF_CRM_652439D28D353',\n  telefone_3: 'UF_CRM_652439D298A88',\n  sine: 'UF_CRM_6883D4B47136F',\n  data_envio_recurso: 'UF_CRM_68DD552F3DD02',\n  \n  // ğŸ”¥ V5.6: ASAAS\n  asaas_id: 'UF_CRM_SMART_INVOICE_1767292172702',\n  boleto_url: 'UF_CRM_SMART_INVOICE_1767292205661',\n\n  // 11. DARF (NOVO)\n  necessita_darf: 'UF_CRM_652439D99106D', // NECESSITA DE DARF? (na INVOICE)\n  valor_darf:     'UF_CRM_695C0F05B6DD0', // VALOR DA DARF (na INVOICE)\n\n\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.6: EXTRAIR CONTACT_ID E ASSESSOR DO DEAL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst contactId = dealData.CONTACT_ID || dealData.contact_id || null;\nconst assessorDeal = dealData[CD.assessor] || dealData.UF_CRM_5F7DD07AEC035 || null;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONSOLIDAR DADOS DOS DIFERENTES NÃ“S\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ctx = dados6C;\nconst resumo = ctx.resumo || dados6B.resumo || {};\nconst dados = ctx.dados || dados6B.dados || {};\nconst parcelas = dados.parcelas || [];\nconst deal = dados.deal || ctx.deal || dados6B.deal || dados6A.deal || {};\nconst config = dados.config || {};\n\nconst creditos_originais = dados.creditos_originais || dados6B.dados?.creditos || dados6A.creditos || [];\nconst parcelas_projetadas = dados.parcelas_projetadas_originais || [];\nconst primeiroCredito = creditos_originais[0] || {};\n\n// ğŸ”¥ V5.9: Buscar tags do 6A v7.1 (vem em .tags, nÃ£o em .info)\n// O 6A v7.1 envia tags como objetos {codigo, severidade, mensagem}\nconst tags_6a_raw = dados6A.tags || dados6A.info || [];\n// Converter severidade CRIT â†’ CRITICO (6A usa CRIT, 6D espera CRITICO)\nconst tags_6a = tags_6a_raw.map(t => {\n  if (typeof t === 'object' && t.severidade === 'CRIT') {\n    return { ...t, severidade: 'CRITICO' };\n  }\n  return typeof t === 'string' ? t : (t.codigo || t);\n});\n\n// ğŸ”¥ V5.9: Processar tags do 6B v6.5 (usa \"nivel\" em vez de \"severidade\")\nconst tags_6b_raw = dados6B.tags || dados6B.tags_sucesso || [];\nconst tags_6b = tags_6b_raw.map(t => {\n  if (typeof t === 'object' && t.nivel === 'CRITICO') {\n    return { ...t, severidade: 'CRITICO' };\n  }\n  return typeof t === 'string' ? t : (t.tag || t.codigo || t);\n});\n\n// ğŸ”¥ V5.9: Processar tags do 6C\nconst tags_6c_raw = ctx.tags || ctx.tags_sucesso || [];\nconst tags_6c = tags_6c_raw.map(t => {\n  if (typeof t === 'object') {\n    let sev = t.severidade || t.nivel || 'INFO';\n    if (sev === 'CRIT') sev = 'CRITICO';\n    return { ...t, severidade: sev };\n  }\n  return typeof t === 'string' ? t : (t.tag || t.codigo || t);\n});\nconst alertas_6a = dados6A.alertas || [];\nconst alertas_6b = dados6B.alertas || [];\nconst alertas_6c = ctx.alertas || [];\n\nconst campos_deal_6C = ctx.campos_deal || dados6B.campos_deal || dados6A.campos_deal || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.1: CAMPOS_INVOICE_BASE DO 6C (TEM DIB, NIT, DCB DO PDF!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst campos_invoice_6C = ctx.campos_invoice_base || dados6B.campos_invoice_base || dados6A.campos_invoice_base || {};\n\nconst CAMPOS_DEAL_IDS = ctx.CAMPOS_DEAL_IDS || dados6B.CAMPOS_DEAL_IDS || dados6A.CAMPOS_DEAL_IDS || {};\nconst CAMPOS_INVOICE_IDS = ctx.CAMPOS_INVOICE_IDS || dados6B.CAMPOS_INVOICE_IDS || dados6A.CAMPOS_INVOICE_IDS || {};\nconst CAMPOS_EXTRAS = ctx.CAMPOS_EXTRAS || dados6B.CAMPOS_EXTRAS || dados6A.CAMPOS_EXTRAS || {};\n\nconst faturas_existentes_obj = ctx.faturas_existentes || dados6A.faturas_existentes || { todas: [] };\nconst faturas_existentes = faturas_existentes_obj.todas || [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO 1B (FONTE ÃšNICA E CONFIÃVEL PARA CPF/NB DO NEGÃ“CIO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst cpfNegocio = dados1B.cpf || '';\nconst cpfNegocioFmt = dados1B.cpf_formatado || '';\nconst nbNegocio = dados1B.nb || '';\nconst nbNegocioFmt = dados1B.nb_formatado || '';\nconst nomeCliente = dados1B.nome || resumo.nome || '';\nconst dealId = dados1B.deal_id || resumo.deal_id || '';\n\n// â•â•â• HELPERS â•â•â•\nconst tr = (v) => Math.floor(v * 100) / 100;\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.8: NORMALIZADORES ROBUSTOS PARA CPF E NB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst soDigitos = (v) => {\n  if (v === null || v === undefined) return '';\n  return String(v).replace(/\\D/g, '').trim();\n};\n\nconst normalizarCPF = (cpf) => {\n  if (!cpf) return '';\n  // Remove TUDO que nÃ£o Ã© nÃºmero\n  const digits = String(cpf).replace(/\\D/g, '');\n  // CPF deve ter 11 dÃ­gitos - preenche zeros Ã  esquerda se necessÃ¡rio\n  if (digits.length === 0) return '';\n  if (digits.length <= 11) return digits.padStart(11, '0');\n  // Se tiver mais de 11, pega os Ãºltimos 11 (caso tenha prefixo estranho)\n  return digits.slice(-11);\n};\n\nconst normalizarNB = (nb) => {\n  if (!nb) return '';\n  // Remove TUDO que nÃ£o Ã© nÃºmero\n  const digits = String(nb).replace(/\\D/g, '');\n  if (digits.length === 0) return '';\n  // NB geralmente tem 10 dÃ­gitos, mas pode variar\n  return digits;\n};\nconst pv = (v) => {\n  if (v === null || v === undefined || v === '') return 0;\n  if (typeof v === 'number') return v;\n  const s = String(v).replace(/[^\\d,.\\-]/g, '').replace(',', '.');\n  return parseFloat(s) || 0;\n};\n\nconst formatarCPF = (cpf) => {\n  const d = soDigitos(cpf);\n  if (d.length !== 11) return cpf || '';\n  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;\n};\n\nconst formatarNB = (nb) => {\n  const d = soDigitos(nb);\n  if (d.length < 9) return nb || '';\n  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;\n};\n\nconst parseData = (data) => {\n  if (!data) return null;\n  const str = String(data).trim();\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    return new Date(str.split('T')[0]);\n  }\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(str)) {\n    const [d, m, y] = str.split('/');\n    return new Date(`${y}-${m}-${d}`);\n  }\n  return null;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DEFINIÃ‡ÃƒO DOS 7 CAMPOS CRÃTICOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CAMPOS_CRITICOS = {\n  nit: { id: CI.nit, nome: 'NIT', tag: 'A_CAMPO_NIT_VAZIO' },\n  dib: { id: CI.dib, nome: 'DIB', tag: 'A_CAMPO_DIB_VAZIO' },\n  dcb: { id: CI.dcb, nome: 'DCB', tag: 'A_CAMPO_DCB_VAZIO' },\n  dip: { id: CI.dip, nome: 'DIP', tag: 'A_CAMPO_DIP_VAZIO' },\n  competencia: { id: CI.competencia, nome: 'CompetÃªncia', tag: 'A_CAMPO_COMPETENCIA_VAZIO' },\n  data_atualizacao_extrato: { id: CI.data_atualizacao_extrato, nome: 'Data AtualizaÃ§Ã£o Extrato', tag: 'A_CAMPO_STATUS_VAZIO' },\n  endereco_banco: { id: CI.endereco_banco, nome: 'EndereÃ§o Banco', tag: 'A_CAMPO_BANCO_VAZIO' }\n};\n\n// â•â•â• ESTRUTURAS DE AUDITORIA â•â•â•\nconst problemas = [];\nconst alertas = [];\nconst tags = [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 0ï¸âƒ£ VALIDAÃ‡ÃƒO DE ERROS DOS NÃ“S ANTERIORES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (dados6A.ok === false || dados6A.erro) {\n  problemas.push({\n    codigo: 'ERRO_6A',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6A: ${dados6A.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar extraÃ§Ã£o do Extrato pelo Gemini'\n  });\n  tags.push('E_ERRO_6A');\n}\n\nif (dados6B.ok === false || dados6B.erro) {\n  problemas.push({\n    codigo: 'ERRO_6B',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6B: ${dados6B.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar cÃ¡lculo INSS no 6B'\n  });\n  tags.push('E_ERRO_6B');\n}\n\nif (dados6C.ok === false || dados6C.erro) {\n  problemas.push({\n    codigo: 'ERRO_6C',\n    gravidade: 'CRITICO',\n    mensagem: `Erro no processamento 6C: ${dados6C.erro || 'Erro nÃ£o especificado'}`,\n    pode_retry: true,\n    acao: 'Verificar distribuiÃ§Ã£o de parcelas no 6C'\n  });\n  tags.push('E_ERRO_6C');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1ï¸âƒ£ ğŸ”¥ V5.7: VALIDAÃ‡Ã•ES DE IDENTIFICAÃ‡ÃƒO - PDF vs DEAL SEPARADOS!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â• CPF DO PDF (extraÃ­do pelo Gemini) â•â•â•\nconst cpfPDF = normalizarCPF(\n  dadosGemini.identificacao?.cpf ||\n  dados6A.cliente?.cpf ||\n  resumo.cpf ||\n  campos_invoice_6C[CI.cpf] ||\n  ''\n);\nconst cpfPDFFmt = formatarCPF(cpfPDF);\n\n// â•â•â• CPF DO DEAL (cadastrado no Bitrix) â•â•â•\nconst cpfDeal = normalizarCPF(\n  dealData[CD.cpf] ||\n  dados1B.cpf ||\n  ''\n);\nconst cpfDealFmt = formatarCPF(cpfDeal);\n\n// â•â•â• VALIDAÃ‡ÃƒO 1: CPF existe no PDF? â•â•â•\nif (!cpfPDF) {\n  problemas.push({\n    codigo: 'CPF_PDF_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'CPF nÃ£o encontrado no Extrato PDF',\n    pode_retry: true,\n    acao: 'Verificar se o Gemini extraiu o CPF corretamente'\n  });\n  tags.push('E_CPF_PDF_AUSENTE');\n}\n\n// â•â•â• VALIDAÃ‡ÃƒO 2: CPF existe no Deal? â•â•â•\nif (!cpfDeal) {\n  problemas.push({\n    codigo: 'CPF_DEAL_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'CPF nÃ£o encontrado no Deal/NegÃ³cio',\n    pode_retry: false,\n    acao: 'Verificar se o Deal tem CPF cadastrado'\n  });\n  tags.push('E_CPF_DEAL_AUSENTE');\n}\n\n// â•â•â• ğŸ”¥ VALIDAÃ‡ÃƒO 3: PDF vs DEAL - O EXTRATO Ã‰ DO CLIENTE CERTO? â•â•â•\nif (cpfPDF && cpfDeal && cpfPDF !== cpfDeal) {\n  problemas.push({\n    codigo: 'CPF_PDF_DIFERENTE_DEAL',\n    gravidade: 'CRITICO',\n    mensagem: `âš ï¸ EXTRATO ERRADO! CPF do PDF (${cpfPDFFmt}) â‰  CPF do Deal (${cpfDealFmt})`,\n    pode_retry: false,\n    acao: 'O Extrato PDF NÃƒO pertence a este cliente! Verificar se enviou o arquivo correto.'\n  });\n  tags.push('E_CPF_PDF_DIFERENTE_DEAL');\n}\n\nif (cpfPDF && cpfDeal && cpfPDF === cpfDeal) {\n  tags.push('OK_CPF_PDF_IGUAL_DEAL');\n}\n\n// â•â•â• NB DO PDF (extraÃ­do pelo Gemini) â•â•â•\nconst nbPDF = normalizarNB(\n  dadosGemini.beneficio?.nb ||\n  dados6A.beneficio?.nb ||\n  dados6B.dados?.calendario_info?.nb ||\n  resumo.nb ||\n  campos_invoice_6C[CI.nb] ||\n  ''\n);\nconst nbPDFFmt = formatarNB(nbPDF);\n\n// â•â•â• NB DO DEAL (cadastrado no Bitrix) â•â•â•\nconst nbDeal = normalizarNB(\n  dealData[CD.nb] ||\n  dados1B.nb ||\n  ''\n);\nconst nbDealFmt = formatarNB(nbDeal);\n\n// â•â•â• VALIDAÃ‡ÃƒO 4: NB existe no PDF? â•â•â•\nif (!nbPDF) {\n  problemas.push({\n    codigo: 'NB_PDF_AUSENTE',\n    gravidade: 'CRITICO',\n    mensagem: 'NÃºmero do BenefÃ­cio (NB) nÃ£o encontrado no Extrato PDF',\n    pode_retry: true,\n    acao: 'Verificar se o Gemini extraiu o NB corretamente'\n  });\n  tags.push('E_NB_PDF_AUSENTE');\n}\n\n// â•â•â• VALIDAÃ‡ÃƒO 5: NB existe no Deal? â•â•â•\nif (!nbDeal) {\n  alertas.push({\n    codigo: 'NB_DEAL_AUSENTE',\n    gravidade: 'ALERTA',\n    mensagem: 'NB nÃ£o encontrado no Deal (pode ser primeiro processamento)',\n  });\n  tags.push('A_NB_DEAL_AUSENTE');\n}\n\n// â•â•â• ğŸ”¥ VALIDAÃ‡ÃƒO 6: PDF vs DEAL - O BENEFÃCIO Ã‰ O CORRETO? â•â•â•\nif (nbPDF && nbDeal && nbPDF !== nbDeal) {\n  problemas.push({\n    codigo: 'NB_PDF_DIFERENTE_DEAL',\n    gravidade: 'CRITICO',\n    mensagem: `âš ï¸ BENEFÃCIO ERRADO! NB do PDF (${nbPDFFmt}) â‰  NB do Deal (${nbDealFmt})`,\n    pode_retry: false,\n    acao: 'O Extrato PDF Ã© de outro benefÃ­cio! Verificar se enviou o arquivo correto.'\n  });\n  tags.push('E_NB_PDF_DIFERENTE_DEAL');\n}\n\nif (nbPDF && nbDeal && nbPDF === nbDeal) {\n  tags.push('OK_NB_PDF_IGUAL_DEAL');\n}\n\n// â•â•â• CPF FINAL PARA USO (prioriza PDF, depois Deal) â•â•â•\nconst cpfFinal = cpfPDF || cpfDeal;\nconst cpfFinalFmt = formatarCPF(cpfFinal);\n\n// â•â•â• NB FINAL PARA USO (prioriza PDF, depois Deal) â•â•â•\nconst nbFinal = nbPDF || nbDeal;\nconst nbFinalFmt = formatarNB(nbFinal);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.3ï¸âƒ£ VALIDAÃ‡ÃƒO DE MR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst mr = pv(\n  dadosGemini.beneficio?.mr ||         // ğŸ”¥ V5.7: PDF primeiro!\n  dados6A.beneficio?.mr ||\n  dados6B.dados?.beneficio?.mr ||\n  resumo.mr || \n  campos_invoice_6C[CI.mr_cliente] ||\n  dealData[CD.mr_cliente] ||\n  0\n);\n\nif (!mr || mr <= 0) {\n  problemas.push({\n    codigo: 'MR_INVALIDO',\n    gravidade: 'CRITICO',\n    mensagem: `MÃ©dia de RemuneraÃ§Ã£o invÃ¡lida: ${mr}`,\n    pode_retry: true,\n    acao: 'Verificar extraÃ§Ã£o do MR no Gemini'\n  });\n  tags.push('E_MR_INVALIDO');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.5ï¸âƒ£ VALIDAÃ‡ÃƒO DE DATAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dib = \n  campos_invoice_6C[CI.dib] ||         // ğŸ”¥ Prioridade: 6C (vem do PDF)\n  dadosGemini.beneficio?.dib ||\n  dados6A.beneficio?.dib ||\n  dealData[CD.dib] ||\n  resumo.dib || \n  '';\n\nconst dcb = \n  campos_invoice_6C[CI.dcb] ||         // ğŸ”¥ Prioridade: 6C (vem do PDF)\n  dadosGemini.beneficio?.dcb ||\n  dados6A.beneficio?.dcb ||\n  dealData[CD.dcb] ||\n  resumo.dcb || \n  '';\n\nconst dibDate = parseData(dib);\nconst dcbDate = parseData(dcb);\n\nif (dib && !dibDate) {\n  problemas.push({\n    codigo: 'DIB_INVALIDA',\n    gravidade: 'GRAVE',\n    mensagem: `DIB com formato invÃ¡lido: ${dib}`,\n    pode_retry: true,\n    acao: 'Verificar formato da DIB no extrato'\n  });\n  tags.push('E_DIB_INVALIDA');\n}\n\nif (dcb && !dcbDate) {\n  problemas.push({\n    codigo: 'DCB_INVALIDA',\n    gravidade: 'GRAVE',\n    mensagem: `DCB com formato invÃ¡lido: ${dcb}`,\n    pode_retry: true,\n    acao: 'Verificar formato da DCB no extrato'\n  });\n  tags.push('E_DCB_INVALIDA');\n}\n\nif (dibDate && dcbDate && dcbDate < dibDate) {\n  problemas.push({\n    codigo: 'DATAS_INCONSISTENTES',\n    gravidade: 'CRITICO',\n    mensagem: `DCB (${dcb}) Ã© anterior Ã  DIB (${dib})`,\n    pode_retry: false,\n    acao: 'Datas do benefÃ­cio estÃ£o invertidas!'\n  });\n  tags.push('E_DATAS_INCONSISTENTES');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.6ï¸âƒ£ VALIDAÃ‡ÃƒO DE PARCELAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (parcelas.length === 0) {\n  problemas.push({\n    codigo: 'ZERO_PARCELAS',\n    gravidade: 'CRITICO',\n    mensagem: 'Nenhuma parcela foi gerada pelo cÃ¡lculo',\n    pode_retry: true,\n    acao: 'Verificar se o 6B/6C geraram parcelas corretamente'\n  });\n  tags.push('E_ZERO_PARCELAS');\n}\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.7ï¸âƒ£ ğŸ”¥ NOVO: DARF (Start paga) â€” validaÃ§Ã£o + tags + rateio informativo\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst normalizarTexto = (v) => (v ?? '').toString().trim().toLowerCase();\n\nconst necessitaDarfRaw =\n  dealData?.[CD.necessita_darf] ??\n  campos_invoice_6C?.[CI.necessita_darf] ??\n  '';\n\nconst valorDarfTotal = pv(\n  dealData?.[CD.valor_darf] ??\n  campos_invoice_6C?.[CI.valor_darf] ??\n  0\n);\n\n// CritÃ©rio â€œStart pagaâ€ (robusto: aceita variaÃ§Ãµes)\nconst startPagaDarf = (() => {\n  const t = normalizarTexto(necessitaDarfRaw);\n  if (t.includes('start') && (t.includes('pagar') || t.includes('irÃ¡') || t.includes('vai'))) return true;\n  if (t === normalizarTexto('Sim! Start irÃ¡ pagar!')) return true;\n  return false;\n})();\n\n// Parcelas que a Start recebe = parcelas com valor_start > 0\nconst parcelasStartRecebe = (parcelas || []).filter(p => pv(p.valor_start) > 0);\nconst qtdParcelasStartRecebe = parcelasStartRecebe.length;\n\n// Gera tags/alertas\nif (startPagaDarf) {\n  tags.push('OK_DARF_START_PAGA');\n\n  if (!valorDarfTotal || valorDarfTotal <= 0) {\n    alertas.push({\n      codigo: 'DARF_SEM_VALOR',\n      gravidade: 'ALERTA',\n      mensagem: `Deal marcado como \"Start paga DARF\", mas Valor DARF estÃ¡ vazio/zero.`,\n    });\n    tags.push('A_DARF_SEM_VALOR');\n  } else {\n    tags.push('OK_DARF_EXISTE');\n    tags.push(`OK_DARF_TOTAL_${tr(valorDarfTotal).toFixed(2).replace('.', ',')}`);\n\n    if (qtdParcelasStartRecebe <= 0) {\n      problemas.push({\n        codigo: 'DARF_SEM_PARCELAS_START',\n        gravidade: 'GRAVE',\n        mensagem: `Start paga DARF (R$ ${tr(valorDarfTotal).toFixed(2).replace('.', ',')}), mas nÃ£o hÃ¡ parcelas em que a Start recebe (valor_start > 0).`,\n        pode_retry: false,\n        acao: 'Verificar cÃ¡lculo do 6C: valor_start nas parcelas ou regra aplicada.'\n      });\n      tags.push('E_DARF_SEM_PARCELAS_START');\n    } else {\n      tags.push(`OK_DARF_PARCELAS_START_${qtdParcelasStartRecebe}`);\n\n      const valorDarfPorParcela = tr(valorDarfTotal / qtdParcelasStartRecebe);\n      tags.push(`INFO_DARF_POR_PARCELA_${valorDarfPorParcela.toFixed(2).replace('.', ',')}`);\n\n      // Se o 6C jÃ¡ tiver colocado â€œvalor_darf_extraâ€ na parcela, valida soma\n      const somaDarfNasParcelas = tr(parcelasStartRecebe.reduce((acc, p) => acc + pv(p.valor_darf_rateado), 0));\n      const diffDarf = Math.abs(somaDarfNasParcelas - tr(valorDarfTotal));\n\n      if (somaDarfNasParcelas > 0) {\n        if (diffDarf > 0.02) {\n          alertas.push({\n            codigo: 'DARF_RATEIO_DIVERGENTE',\n            gravidade: 'ALERTA',\n            mensagem: `Soma do rateio DARF nas parcelas (${somaDarfNasParcelas}) â‰  Valor DARF total (${tr(valorDarfTotal)})`,\n            valor_total: tr(valorDarfTotal),\n            soma_rateio: somaDarfNasParcelas,\n            diff: tr(diffDarf),\n          });\n          tags.push('A_DARF_RATEIO_DIVERGENTE');\n        } else {\n          tags.push('OK_DARF_RATEIO_BATE');\n        }\n      } else {\n        tags.push('INFO_DARF_SEM_RATEIO_NAS_PARCELAS');\n      }\n    }\n  }\n} else {\n  tags.push('OK_DARF_NAO_APLICA');\n}\n\n// Guardar no resumo final (para debug/Bitrix)\nconst darfResumo = {\n  start_paga_darf: startPagaDarf,\n  necessita_darf_raw: necessitaDarfRaw || null,\n  valor_darf_total: tr(valorDarfTotal),\n  qtd_parcelas_start_recebe: qtdParcelasStartRecebe,\n  valor_darf_por_parcela_aprox: (startPagaDarf && valorDarfTotal > 0 && qtdParcelasStartRecebe > 0)\n    ? tr(valorDarfTotal / qtdParcelasStartRecebe)\n    : 0\n};\n\n\n\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2ï¸âƒ£ VALIDAÃ‡Ã•ES MATEMÃTICAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst total_120_dias = pv(resumo.total_120_dias);\nconst honorarios_start = pv(resumo.honorarios_start);\n// v5.9: HonorÃ¡rios podem ser truncados (sem centavos), tolerÃ¢ncia aumentada para R$ 1,00\nconst honorarios_esperado = Math.floor(total_120_dias * 0.30);\nif (total_120_dias > 0) {\n  const diff_honorarios = Math.abs(honorarios_start - honorarios_esperado);\n  \n  if (diff_honorarios > 1.00) {\n    alertas.push({\n      codigo: 'HONORARIOS_DIVERGENTE',\n      gravidade: 'ALERTA',\n      mensagem: `HonorÃ¡rios (${honorarios_start}) â‰  30% (${honorarios_esperado})`,\n      valor_calculado: honorarios_start,\n      valor_esperado: honorarios_esperado\n    });\n    tags.push('A_HONORARIOS_DIVERGENTE');\n  } else {\n    tags.push('OK_HONORARIOS_30_PERCENT');\n  }\n}\n\nconst total_start = pv(resumo.total_start);\nconst total_cliente = pv(resumo.total_cliente);\nconst soma_parcelas = parcelas.reduce((acc, p) => acc + pv(p.valor_parcela), 0);\nconst soma_calculada = tr(total_start + total_cliente);\nconst soma_parcelas_tr = tr(soma_parcelas);\n\nif (parcelas.length > 0) {\n  const diff_soma = Math.abs(soma_calculada - soma_parcelas_tr);\n  \n  if (diff_soma > 0.02) {\n    problemas.push({\n      codigo: 'SOMA_NAO_BATE',\n      gravidade: 'GRAVE',\n      mensagem: `Start(${total_start}) + Cliente(${total_cliente}) = ${soma_calculada} â‰  Î£parcelas(${soma_parcelas_tr})`,\n      pode_retry: false\n    });\n    tags.push('E_SOMA_NAO_BATE');\n  } else {\n    tags.push('OK_SOMA_BATE');\n  }\n}\n\n// 2.3 FAIXAS\nconst getFaixaEsperada = (valor) => {\n  if (valor >= 2000) return { aliquota: 0.45, nome: 'FAIXA_45' };\n  if (valor >= 1500) return { aliquota: 0.40, nome: 'FAIXA_40' };\n  if (valor >= 700)  return { aliquota: 0.35, nome: 'FAIXA_35' };\n  return { aliquota: 0.30, nome: 'FAIXA_30' };\n};\n\nlet faixas_ok = true;\nfor (const p of parcelas) {\n  const valor = pv(p.valor_parcela);\n  const aliquota_aplicada = pv(p.aliquota_aplicada);\n  const regra = p.regra_aplicada;\n  \n  if (regra === 'QUITACAO' || regra === 'QUITADO' || aliquota_aplicada === null) continue;\n  \n  const esperada = getFaixaEsperada(valor);\n  \n  if (Math.abs(aliquota_aplicada - esperada.aliquota) > 0.001) {\n    problemas.push({\n      codigo: 'FAIXA_INCORRETA',\n      gravidade: 'GRAVE',\n      mensagem: `Parcela ${p.numero}: valor ${valor} deveria ter ${esperada.nome}`,\n      pode_retry: false\n    });\n    tags.push(`E_FAIXA_P${p.numero}`);\n    faixas_ok = false;\n  }\n}\n\nif (faixas_ok && parcelas.length > 0) tags.push('OK_FAIXAS_CORRETAS');\n\n// 2.4 QUITAÃ‡ÃƒO\nlet quitacao_ok = true;\n\nfor (let i = 0; i < parcelas.length; i++) {\n  const p = parcelas[i];\n  const regra = p.regra_aplicada;\n  const saldo_antes = pv(p.saldo_start_antes);\n  const valor_parcela = pv(p.valor_parcela);\n  const limite_quitacao = tr(valor_parcela * 0.50);\n  \n  if (regra !== 'QUITACAO' && regra !== 'QUITADO' && saldo_antes > 0 && saldo_antes <= limite_quitacao) {\n    alertas.push({\n      codigo: 'QUITACAO_POSSIVEL',\n      gravidade: 'ALERTA',\n      mensagem: `Parcela ${p.numero}: Saldo (${saldo_antes}) <= 50% (${limite_quitacao})`\n    });\n    tags.push(`A_QUITACAO_POSSIVEL_P${p.numero}`);\n  }\n  \n  if (regra === 'QUITACAO') {\n    const saldo_depois = pv(p.saldo_start_depois);\n    if (saldo_depois !== 0) {\n      problemas.push({\n        codigo: 'QUITACAO_SALDO_NAO_ZEROU',\n        gravidade: 'GRAVE',\n        mensagem: `Parcela ${p.numero}: QuitaÃ§Ã£o mas saldo nÃ£o zerou`,\n        pode_retry: false\n      });\n      tags.push(`E_QUITACAO_P${p.numero}`);\n      quitacao_ok = false;\n    }\n  }\n}\n\nif (quitacao_ok && parcelas.length > 0) tags.push('OK_QUITACAO_VERIFICADA');\n\n// 2.5 REGRA 50%\nlet regra_50_ok = true;\n\nfor (const p of parcelas) {\n  const valor_parcela = pv(p.valor_parcela);\n  const valor_cliente = pv(p.valor_cliente);\n  const minimo_cliente = tr(valor_parcela * 0.50);\n  \n  if (valor_cliente < minimo_cliente - 0.01) {\n    problemas.push({\n      codigo: 'REGRA_50_VIOLADA',\n      gravidade: 'CRITICO',\n      mensagem: `Parcela ${p.numero}: Cliente (${valor_cliente}) < 50% (${minimo_cliente})`,\n      pode_retry: false\n    });\n    tags.push(`E_REGRA50_P${p.numero}`);\n    regra_50_ok = false;\n  }\n}\n\nif (regra_50_ok && parcelas.length > 0) tags.push('OK_REGRA_50_TODAS');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3ï¸âƒ£ DUPLICIDADE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst parcelas_novas = [];\nconst parcelas_duplicadas = [];\n\nfor (const p of parcelas) {\n  \n  \n  const duplicada = faturas_existentes.some(f => {\n    return f.parcela === p.numero || f.data_pagamento === p.data_pagamento;\n  });\n  \n  if (duplicada) {\n    parcelas_duplicadas.push(p);\n  } else {\n    parcelas_novas.push(p);\n  }\n}\n\nif (parcelas_duplicadas.length > 0) {\n  problemas.push({\n    codigo: 'FATURA_DUPLICADA',\n    gravidade: 'CRITICO',\n    mensagem: `${parcelas_duplicadas.length} fatura(s) jÃ¡ existe(m)!`,\n    pode_retry: false,\n    acao: 'Verificar se este Extrato jÃ¡ foi processado'\n  });\n  tags.push('E_FATURA_DUPLICADA');\n}\n\nif (parcelas_novas.length === 0 && parcelas.some(p => pv(p.valor_start) > 0)) {\n  tags.push('E_TODAS_DUPLICADAS');\n}\n\nif (parcelas_novas.length > 0 && parcelas_duplicadas.length === 0) {\n  tags.push(`OK_PARCELAS_NOVAS_${parcelas_novas.length}`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4ï¸âƒ£ CONSOLIDAÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tem_critico = problemas.some(p => p.gravidade === 'CRITICO');\nconst tem_grave = problemas.some(p => p.gravidade === 'GRAVE');\nconst tem_alerta = alertas.length > 0;\n\nconst tentativa_atual = dados6A.tentativa || dados1B.tentativa || 1;\nconst max_tentativas = 2;\nconst problemas_reprocessaveis = problemas.filter(p => p.pode_retry === true);\nconst pode_reprocessar = problemas_reprocessaveis.length > 0 && \n                         problemas_reprocessaveis.length === problemas.length &&\n                         tentativa_atual < max_tentativas;\n\nconst ok = !tem_critico && !tem_grave;\n\nconst gravidade_maxima = tem_critico ? 'CRITICO' \n                       : tem_grave ? 'GRAVE' \n                       : tem_alerta ? 'ALERTA'\n                       : 'OK';\n\nconst faturas_criar = ok ? parcelas_novas.map(p => ({\n  parcela: p.numero,\n  data_pagamento: p.data_pagamento,\n  data_pagamento_formatada: p.data_pagamento_formatada,\n  valor_inss: pv(p.valor_parcela),\n  valor_start: pv(p.valor_start),\n  valor_cliente: pv(p.valor_cliente),\n  aliquota: p.aliquota_efetiva,\n  regra: p.regra_aplicada,\n  competencia: p.competencia || `Parcela ${p.numero}`,\n  origem: p.origem,\n  saldo_start_depois: pv(p.saldo_start_depois)\n})) : [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5ï¸âƒ£ ğŸ”¥ V5.1/V5.3: CONSTRUIR campos_invoice\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst competencia_credito = primeiroCredito.competencia || '';\nconst banco_credito = primeiroCredito.pagamento?.banco || dados6A.beneficio?.banco || '';\n\n// â•â•â• CAMPOS DO DEAL (para atualizar o Deal) â•â•â•\nconst campos_deal = {\n  ...campos_deal_6C,\n  [CAMPOS_EXTRAS.data_calculo_inv || 'UF_CRM_69442F14E544C']: new Date().toISOString().split('T')[0]\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V5.1/V5.3: CAMPOS DA INVOICE - USAR 6C COMO BASE + DEAL DO MERGE!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1ï¸âƒ£ COMEÃ‡AR COM campos_invoice_6C (tem DIB, NIT, DCB, banco, etc. do PDF!)\nconst campos_invoice = { ...campos_invoice_6C };\n\n// 2ï¸âƒ£ Helper para adicionar campo se nÃ£o existir\nconst adicionarSeFaltando = (idInvoice, valorDeal, valorFallback = '') => {\n  if (campos_invoice[idInvoice] && campos_invoice[idInvoice] !== '') {\n    return;\n  }\n  if (valorDeal && valorDeal !== '') {\n    campos_invoice[idInvoice] = valorDeal;\n    return;\n  }\n  if (valorFallback && valorFallback !== '') {\n    campos_invoice[idInvoice] = valorFallback;\n  }\n};\n\n// â•â•â• CAMPOS EXCLUSIVOS DO DEAL (nÃ£o vÃªm do PDF) â•â•â•\nadicionarSeFaltando(CI.dn_mamae, dealData[CD.dn_mamae]);\nadicionarSeFaltando(CI.dn_filho, dealData[CD.dn_filho]);\nadicionarSeFaltando(CI.dn_certidao, dealData[CD.dn_certidao]);\nadicionarSeFaltando(CI.data_dnv, dealData[CD.data_dnv]);\nadicionarSeFaltando(CI.data_requerimento, dealData[CD.data_requerimento]);\nadicionarSeFaltando(CI.data_concessao, dealData[CD.data_concessao]);\nadicionarSeFaltando(CI.nome_filho, dealData[CD.nome_filho]);\nadicionarSeFaltando(CI.categoria, dealData[CD.categoria]);\nadicionarSeFaltando(CI.rg, dealData[CD.rg]);\nadicionarSeFaltando(CI.telefone_2, dealData[CD.telefone_2]);\nadicionarSeFaltando(CI.telefone_3, dealData[CD.telefone_3]);\nadicionarSeFaltando(CI.senha, dealData[CD.senha]);\nadicionarSeFaltando(CI.ddd_cliente, dealData[CD.ddd_cliente]);\nadicionarSeFaltando(CI.ultimo_relacionador, dealData[CD.ultimo_relacionador]);\n\n// â•â•â• CAMPOS EXTRAS DA PLANILHA (v5.5) â•â•â•\nadicionarSeFaltando(CI.sugestao_senha, dealData[CD.sugestao_senha]);\nadicionarSeFaltando(CI.data_reclamacao, dealData[CD.data_reclamacao]);\nadicionarSeFaltando(CI.data_qualificacao, dealData[CD.data_qualificacao]);\nadicionarSeFaltando(CI.data_recuperacao, dealData[CD.data_recuperacao]);\nadicionarSeFaltando(CI.data_encerramento, dealData[CD.data_encerramento]);\nadicionarSeFaltando(CI.data_reentrada, dealData[CD.data_reentrada]);\nadicionarSeFaltando(CI.data_conversao, dealData[CD.data_conversao]);\nadicionarSeFaltando(CI.data_certidao, dealData[CD.data_certidao]);\nadicionarSeFaltando(CI.data_consulta, dealData[CD.data_consulta]);\nadicionarSeFaltando(CI.data_contato, dealData[CD.data_contato]);\nadicionarSeFaltando(CI.data_sem_direito, dealData[CD.data_sem_direito]);\nadicionarSeFaltando(CI.data_indeferimento, dealData[CD.data_indeferimento]);\nadicionarSeFaltando(CI.data_quebra_contrato, dealData[CD.data_quebra_contrato]);\nadicionarSeFaltando(CI.relacionador_quebra, dealData[CD.relacionador_quebra]);\nadicionarSeFaltando(CI.relacionador_sem_direito, dealData[CD.relacionador_sem_direito]);\nadicionarSeFaltando(CI.recurso, dealData[CD.recurso]);\nadicionarSeFaltando(CI.sine, dealData[CD.sine]);\nadicionarSeFaltando(CI.data_envio_recurso, dealData[CD.data_envio_recurso]);\nadicionarSeFaltando(CI.justificativa_direito, dealData[CD.justificativa_direito]);\nadicionarSeFaltando(CI.data_rodagem, dealData[CD.data_rodagem]);\nadicionarSeFaltando(CI.rodagem_comentario, dealData[CD.rodagem_comentario]);\nadicionarSeFaltando(CI.banco, dealData[CD.banco]);\nadicionarSeFaltando(CI.agencia_banco, dealData[CD.agencia_banco]);\n\n// ğŸ”¥ V5.6: ASSESSOR (mapeamento Deal â†’ Invoice)\nadicionarSeFaltando(CI.assessor, assessorDeal);\n\n// â•â•â• CAMPOS QUE PODEM VIR DO PDF OU DO DEAL â•â•â•\nadicionarSeFaltando(CI.cpf, null, cpfFinalFmt || cpfFinal);\nadicionarSeFaltando(CI.nb, null, nbFinalFmt || nbFinal);\nadicionarSeFaltando(CI.dib, dealData[CD.dib], dib);\nadicionarSeFaltando(CI.dip, dealData[CD.dip]);\nadicionarSeFaltando(CI.dcb, dealData[CD.dcb], dcb);\nadicionarSeFaltando(CI.nit, dealData[CD.nit], resumo.nit);\nadicionarSeFaltando(CI.mr_cliente, null, mr);\nadicionarSeFaltando(CI.valor_total_beneficio, dealData[CD.valor_total_beneficio], resumo.total_120_dias);\nadicionarSeFaltando(CI.aliquota_mr, dealData[CD.aliquota_mr]);\nadicionarSeFaltando(CI.qtd_parcelas, dealData[CD.qtd_parcelas], parcelas.length);\nadicionarSeFaltando(CI.endereco_banco, dealData[CD.endereco_banco], banco_credito);\n\n// â•â•â• CAMPOS ESPECÃFICOS DO EXTRATO â•â•â•\nadicionarSeFaltando(CI.competencia, null, competencia_credito);\nadicionarSeFaltando(CI.data_atualizacao_extrato, null, resumo.data_extrato || new Date().toISOString().split('T')[0]);\n\n// â•â•â• DARF (NOVO) â•â•â•\nadicionarSeFaltando(CI.necessita_darf, dealData[CD.necessita_darf]);\nadicionarSeFaltando(CI.valor_darf, dealData[CD.valor_darf]);\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// LIMPAR CAMPOS VAZIOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst campos_deal_limpo = {};\nfor (const [k, v] of Object.entries(campos_deal)) {\n  if (v !== null && v !== undefined && v !== '' && v !== 0) {\n    campos_deal_limpo[k] = v;\n  }\n}\n\nconst campos_invoice_limpo = {};\nfor (const [k, v] of Object.entries(campos_invoice)) {\n  if (v !== null && v !== undefined && v !== '' && v !== 0 && v !== 'null') {\n    campos_invoice_limpo[k] = v;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VALIDAÃ‡ÃƒO DOS 7 CAMPOS CRÃTICOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst campos_criticos_status = {};\nconst campos_vazios = [];\nconst campos_preenchidos = [];\n\nfor (const [chave, configCampo] of Object.entries(CAMPOS_CRITICOS)) {\n  const valor = campos_invoice_limpo[configCampo.id];\n  const preenchido = valor !== null && valor !== undefined && valor !== '';\n  \n  campos_criticos_status[chave] = {\n    id: configCampo.id,\n    nome: configCampo.nome,\n    valor: valor || null,\n    preenchido\n  };\n  \n  if (preenchido) {\n    campos_preenchidos.push(chave);\n  } else {\n    campos_vazios.push(chave);\n    tags.push(configCampo.tag);\n    \n    alertas.push({\n      codigo: `CAMPO_CRITICO_VAZIO_${chave.toUpperCase()}`,\n      gravidade: 'ALERTA',\n      mensagem: `Campo ${configCampo.nome} estÃ¡ vazio`,\n      campo: chave,\n      id_bitrix: configCampo.id\n    });\n  }\n}\n\nif (campos_vazios.length === 0) {\n  tags.push('OK_7_CAMPOS_CRITICOS_PREENCHIDOS');\n} else if (campos_vazios.length <= 2) {\n  tags.push(`A_${campos_vazios.length}_CAMPOS_CRITICOS_VAZIOS`);\n} else {\n  tags.push(`E_${campos_vazios.length}_CAMPOS_CRITICOS_VAZIOS`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6ï¸âƒ£ MENSAGEM BITRIX\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet mensagem_bitrix = '';\n\nif (gravidade_maxima === 'OK') {\n  mensagem_bitrix = `âœ… Auditoria OK | ${faturas_criar.length} fatura(s) | ${campos_preenchidos.length}/7 campos`;\n} else if (gravidade_maxima === 'ALERTA') {\n  mensagem_bitrix = `âš ï¸ Auditoria com ${alertas.length} alerta(s) | ${faturas_criar.length} fatura(s)`;\n} else {\n  // ğŸ”¥ V5.7: Mensagens mais claras para PDF divergente\n  const errosPDFDivergente = problemas.filter(p => \n    p.codigo === 'CPF_PDF_DIFERENTE_DEAL' || p.codigo === 'NB_PDF_DIFERENTE_DEAL'\n  );\n  \n  if (errosPDFDivergente.length > 0) {\n    mensagem_bitrix = `âŒ EXTRATO ERRADO! PDF nÃ£o pertence a este cliente. Verificar arquivo enviado.`;\n  } else {\n    mensagem_bitrix = `âŒ ${gravidade_maxima} | ${problemas.length} problema(s): ${problemas.map(p => p.codigo).join(', ')}`;\n  }\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 7ï¸âƒ£ RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tags_final = [...new Set([...tags_6a, ...tags_6b, ...tags_6c, ...tags])];\n\nreturn {\n  _no: '6D',\n  _versao: '5.7',\n  _timestamp: new Date().toISOString(),\n  _tempo_ms: Date.now() - inicio,\n  \n  ok,\n  pode_reprocessar,\n  gravidade_maxima,\n  mensagem_bitrix,\n  tags: tags_final,\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ”¥ V5.6: CONTACT_ID E ASSESSOR NO OUTPUT!\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  contact_id: contactId,\n  assessor: assessorDeal,\n  \n  auditoria: {\n    total_problemas: problemas.length,\n    total_alertas: alertas.length,\n    problemas,\n    alertas,\n    \n    validacoes: {\n      cpf_ok: !problemas.some(p => p.codigo.includes('CPF')),\n      nb_ok: !problemas.some(p => p.codigo.includes('NB')),\n      mr_ok: !problemas.some(p => p.codigo === 'MR_INVALIDO'),\n      datas_ok: !problemas.some(p => p.codigo.includes('DATAS')),\n      parcelas_ok: !problemas.some(p => p.codigo === 'ZERO_PARCELAS'),\n      honorarios_ok: !alertas.some(a => a.codigo === 'HONORARIOS_DIVERGENTE'),\n      soma_ok: !problemas.some(p => p.codigo === 'SOMA_NAO_BATE'),\n      faixas_ok: !problemas.some(p => p.codigo === 'FAIXA_INCORRETA'),\n      quitacao_ok: !problemas.some(p => p.codigo.includes('QUITACAO')),\n      regra_50_ok: !problemas.some(p => p.codigo === 'REGRA_50_VIOLADA'),\n      duplicidade_ok: !problemas.some(p => p.codigo === 'FATURA_DUPLICADA'),\n      nos_anteriores_ok: !problemas.some(p => p.codigo.startsWith('ERRO_6')),\n      // ğŸ”¥ V5.7: Novas validaÃ§Ãµes\n      pdf_vs_deal_cpf_ok: !problemas.some(p => p.codigo === 'CPF_PDF_DIFERENTE_DEAL'),\n      pdf_vs_deal_nb_ok: !problemas.some(p => p.codigo === 'NB_PDF_DIFERENTE_DEAL'),\n            darf_ok: !problemas.some(p => p.codigo === 'DARF_SEM_PARCELAS_START'),\n\n    },\n    \n    campos_criticos: {\n      total: 7,\n      preenchidos: campos_preenchidos.length,\n      vazios: campos_vazios.length,\n      status: campos_criticos_status,\n      lista_vazios: campos_vazios,\n      lista_preenchidos: campos_preenchidos\n    },\n    \n    duplicidade: {\n      total_parcelas: parcelas.length,\n      parcelas_novas: parcelas_novas.length,\n      parcelas_duplicadas: parcelas_duplicadas.length,\n      parcelas_criar: faturas_criar.length\n    }\n  },\n  \n  resumo: {\n    nome: nomeCliente || resumo.nome || '',\n    // ğŸ”¥ V5.7: CPFs e NBs separados para debug\n    cpf: cpfFinal,\n    cpf_formatado: cpfFinalFmt,\n    cpf_pdf: cpfPDFFmt,\n    cpf_deal: cpfDealFmt,\n    cpf_match: cpfPDF === cpfDeal,\n    nb: nbFinal,\n    nb_formatado: nbFinalFmt,\n    nb_pdf: nbPDFFmt,\n    nb_deal: nbDealFmt,\n    nb_match: nbPDF === nbDeal,\n    mr: mr,\n    mr_formatado: resumo.mr_formatado || `R$ ${mr.toFixed(2).replace('.', ',')}`,\n    dib: dib,\n    dcb: dcb,\n    deal_id: dealId,\n    darf: darfResumo,\n    ...resumo\n  },\n  \n  dados: dados,\n  faturas_criar,\n  \n  faturas_duplicadas: parcelas_duplicadas.map(p => ({\n    parcela: p.numero,\n    data_pagamento: p.data_pagamento,\n    valor_start: pv(p.valor_start)\n  })),\n  \n  // â•â•â• CAMPOS PARA BITRIX â•â•â•\n  campos_deal: campos_deal_limpo,\n  campos_invoice: campos_invoice_limpo,\n  \n  // IDs de referÃªncia\n  CAMPOS_DEAL_IDS: CD,\n  CAMPOS_INVOICE_IDS: CI,\n  CAMPOS_EXTRAS,\n  \n  // ğŸ”¥ V5.7: Debug com informaÃ§Ãµes da validaÃ§Ã£o PDF vs Deal\n  _debug: {\n    versao: '5.7',\n    correcao_principal: 'ValidaÃ§Ã£o PDF vs Deal SEPARADA! CPF e NB do PDF comparados com Deal.',\n    problema_anterior: 'Estava comparando Deal vs 1B, nÃ£o PDF vs Deal',\n    \n    // ğŸ”¥ V5.7: ValidaÃ§Ã£o PDF vs Deal\n    validacao_pdf_vs_deal: {\n      cpf: {\n        pdf: cpfPDFFmt || 'NÃƒO ENCONTRADO',\n        deal: cpfDealFmt || 'NÃƒO ENCONTRADO',\n        match: cpfPDF && cpfDeal ? (cpfPDF === cpfDeal ? 'âœ… OK' : 'âŒ DIVERGENTE') : 'âš ï¸ INCOMPLETO',\n        fontes_pdf: [\n          dadosGemini.identificacao?.cpf ? 'Gemini.identificacao.cpf' : null,\n          dados6A.cliente?.cpf ? '6A.cliente.cpf' : null,\n          resumo.cpf ? 'resumo.cpf' : null,\n          campos_invoice_6C[CI.cpf] ? 'campos_invoice_6C' : null,\n        ].filter(Boolean),\n        fontes_deal: [\n          dealData[CD.cpf] ? 'dealData[CD.cpf]' : null,\n          dados1B.cpf ? '1B.cpf' : null,\n        ].filter(Boolean),\n      },\n      nb: {\n        pdf: nbPDFFmt || 'NÃƒO ENCONTRADO',\n        deal: nbDealFmt || 'NÃƒO ENCONTRADO',\n        match: nbPDF && nbDeal ? (nbPDF === nbDeal ? 'âœ… OK' : 'âŒ DIVERGENTE') : 'âš ï¸ INCOMPLETO',\n        fontes_pdf: [\n          dadosGemini.beneficio?.nb ? 'Gemini.beneficio.nb' : null,\n          dados6A.beneficio?.nb ? '6A.beneficio.nb' : null,\n          dados6B.dados?.calendario_info?.nb ? '6B.calendario_info.nb' : null,\n          resumo.nb ? 'resumo.nb' : null,\n          campos_invoice_6C[CI.nb] ? 'campos_invoice_6C' : null,\n        ].filter(Boolean),\n        fontes_deal: [\n          dealData[CD.nb] ? 'dealData[CD.nb]' : null,\n          dados1B.nb ? '1B.nb' : null,\n        ].filter(Boolean),\n      }\n    },\n    \n    // V5.6: Contact e Assessor\n    contact_id_fonte: contactId ? 'dealData.CONTACT_ID' : 'NÃƒO ENCONTRADO',\n    assessor_fonte: assessorDeal ? `dealData[${CD.assessor}]` : 'NÃƒO ENCONTRADO',\n    \n    fontes: {\n      mr: {\n        gemini: dadosGemini.beneficio?.mr || 'VAZIO',\n        dados6A: dados6A.beneficio?.mr || 'VAZIO',\n        dados6B: dados6B.dados?.beneficio?.mr || 'VAZIO',\n        resumo: resumo.mr || 'VAZIO',\n        dealData: dealData[CD.mr_cliente] || 'VAZIO',\n        usado: mr || 0\n      },\n      contact_id: {\n        dealData_CONTACT_ID: dealData.CONTACT_ID || 'VAZIO',\n        usado: contactId || 'NÃƒO ENCONTRADO'\n      },\n      assessor: {\n        dealData: dealData[CD.assessor] || 'VAZIO',\n        usado: assessorDeal || 'NÃƒO ENCONTRADO'\n      },\n      categoria: {\n        dealData: dealData[CD.categoria] || 'VAZIO',\n        usado: campos_invoice_limpo[CI.categoria] || 'NÃƒO PREENCHIDO'\n      }\n    },\n    \n    deal_data_encontrado: Object.keys(dealData).length > 0,\n    total_campos_deal_data: Object.keys(dealData).length,\n    deal_id_encontrado: dealData.ID || dealData.id || 'NÃƒO ENCONTRADO',\n    campos_6c_recebidos: Object.keys(campos_invoice_6C).length,\n    campos_invoice_final: Object.keys(campos_invoice_limpo).length,\n    \n    inputs_encontrados: {\n      '6C': !!dados6C.resumo,\n      '6B': !!dados6B.resumo,\n      '6A': !!dados6A.cliente,\n      'Gemini': !!dadosGemini.identificacao,\n      '1B': !!dados1B.deal_id,\n      'BUSCAR_DEAL (via array)': Object.keys(dealData).length > 0\n    }\n  },\n  \n  deal_id: dealId,\n  deal: deal,\n  tentativa: tentativa_atual,\n  max_tentativas\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6624,
        26224
      ],
      "id": "0d29cd56-39ba-47d8-9976-eefa4e2fdac3",
      "name": "6D. Revisor de Calculos"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6A - ORGANIZAR DADOS DO PDF (v7.1 - SISTEMA DE TAGS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VersÃ£o: 7.1 - Sistema completo de TAGs com severidade\n// Data: 29/01/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// NOVIDADES v7.1:\n// âœ… Sistema de TAGs com 5 nÃ­veis de severidade (CRIT, ALTO, MEDIO, BAIXO, INFO)\n// âœ… Filosofia \"nunca bloquear\" - sempre passa adiante com TAGs\n// âœ… Resumo de TAGs por severidade no output\n// âœ… Flags tem_problemas_criticos e tem_problemas_altos\n// âœ… Todas as validaÃ§Ãµes geram TAGs padronizadas\n//\n// MANTIDO da v7.0:\n// âœ… IDs do DEAL corrigidos conforme Mapeamento_CORRETO_DEAL_INVOICE.xlsx\n// âœ… IDs da INVOICE corrigidos conforme Mapeamento_CORRETO_DEAL_INVOICE.xlsx\n// âœ… 38 campos no Deal, 57 campos na Invoice\n// âœ… 25 campos extras mapeados para uso futuro\n// âœ… Todos os IDs validados contra Bitrix24 API\n//\n// DOCUMENTOS SUPORTADOS:\n// âœ… EXTRATO_CREDITOS - HistÃ³rico de CrÃ©ditos INSS (faturamento)\n// âœ… PGMEI_DAS - ContribuiÃ§Ãµes MEI (carÃªncia/elegibilidade)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡Ã•ES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst CONFIG = {\n  DIAS_SALARIO_MATERNIDADE: 120,\n  LIMITE_DIAS_NOVA_PARCELA: 15,\n  VALOR_BAIXO_ALERTA: 100,\n  PERIODO_CURTO_ALERTA: 5,\n  MESES_CARENCIA_MEI: 10,\n  SALARIO_MINIMO_2025: 1518.00,\n  TETO_INSS_2025: 8157.41\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TIPOS DE DOCUMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst TIPO_DOC = {\n  EXTRATO_CREDITOS: 'EXTRATO_CREDITOS',\n  PGMEI_DAS: 'PGMEI_DAS',\n  DESCONHECIDO: 'DESCONHECIDO'\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// v7.1: SISTEMA DE SEVERIDADE DE TAGS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst SEVERIDADE = {\n  CRIT: 'CRIT',    // ğŸ”´ CrÃ­tico - pode pausar para intervenÃ§Ã£o\n  ALTO: 'ALTO',   // ğŸŸ  Alto - alerta forte, revisar manualmente\n  MEDIO: 'MEDIO', // ğŸŸ¡ MÃ©dio - alerta moderado\n  BAIXO: 'BAIXO', // ğŸŸ¢ Baixo - apenas registra\n  INFO: 'INFO'    // ğŸ”µ Info - log para auditoria\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DO DEAL (IDs Bitrix) - v7.0 CORRIGIDO\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// Total: 38 campos\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CD = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_5F7DD07B0ADB5',      // CPF\n  rg:                       'UF_CRM_5F7DD07B11C33',      // RG\n  nit:                      'UF_CRM_1766282969',         // NIT (EXTRATO DE PAGAMENTO)\n  nb:                       'UF_CRM_1737470444334',      // NÂº DO BENEFICIO\n  nome_filho:               'UF_CRM_1699462600794',      // NOME DO FILHO(A)\n  categoria:                'UF_CRM_5F7DD07B0295D',      // CATEGORIA\n  \n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_1765928945',         // Data de InÃ­cio do BenefÃ­cio (DIB)\n  dip:                      'UF_CRM_1766439387',         // Data de InÃ­cio do Pagamento (DIP)\n  dcb:                      'UF_CRM_1748433331869',      // Data de CessaÃ§Ã£o do BenefÃ­cio (DCB)\n  dn_mamae:                 'UF_CRM_1602615428011',      // DN MAMÃƒE\n  dn_filho:                 'UF_CRM_5F7DD07B1997D',      // DN FILHO(A)\n  dn_certidao:              'UF_CRM_1714741602233',      // DN CERTIDÃƒO\n  data_dnv:                 'UF_CRM_1742827283535',      // DATA DNV\n  data_requerimento:        'UF_CRM_6094054C7C1C8',      // DATA REQUERIMENTO\n  data_concessao:           'UF_CRM_1602256897805',      // DATA CONCESSÃƒO\n  \n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_1741726157749',      // MR Cliente (BRUTO DO BENEFICIO)\n  valor_total_beneficio:    'UF_CRM_1742841962002',      // Valor Total BenefÃ­cio (120d)\n  aliquota_mr:              'UF_CRM_1742841855608',      // AlÃ­quota MR\n  \n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_1634158430224',      // VALOR DO INSS\n  valor_cliente:            'UF_CRM_1634828809106',      // VALOR DA CLIENTE\n  valor_previsto:           'UF_CRM_1635261498013',      // VALOR PREVISTO\n  valor_recebido:           'UF_CRM_1633535814529',      // VALOR RECEBIDO\n  parcela_numero:           'UF_CRM_1634158972573',      // PARCELA NÂº (Atual)\n  qtd_parcelas:             'UF_CRM_1625253358741',      // QUANTIDADE DE PARCELAS\n  \n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_1603216440272',      // BANCO\n  endereco_banco:           'UF_CRM_1603216499370',      // EndereÃ§o do Banco\n  agencia_banco:            'UF_CRM_1762558313',         // AGÃŠNCIA DO BANCO\n  \n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_1765636941',         // Justificativa Direito\n  data_rodagem:             'UF_CRM_1764270308863',      // Data Rodagem\n  rodagem_comentario:       'UF_CRM_1764270260617',      // ComentÃ¡rio Rodagem\n  \n  // â•â•â• 10. GESTÃƒO â•â•â•\n  assessor:                 'UF_CRM_5F7DD07AEC035',      // ASSESSOR(A)\n  ultimo_relacionador:      'UF_CRM_1688072257656',      // Ãšltimo Relacionador\n  ddd_cliente:              'UF_CRM_659C48C5F0594',      // DDD Cliente\n  data_reclamacao:          'UF_CRM_1704738513559',      // Data ReclamaÃ§Ã£o\n  data_qualificacao:        'UF_CRM_65E74D984ED3C',      // Data QualificaÃ§Ã£o\n  data_recuperacao:         'UF_CRM_1713804709729',      // Data RecuperaÃ§Ã£o\n  data_encerramento:        'UF_CRM_663007E42D75E',      // (PERDIDA) - DATA DE ENCERRAMENTO PERSONALIZADO\n  data_reentrada:           'UF_CRM_1615653096667',      // Data Reentrada\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DA INVOICE (IDs Bitrix) - v7.0 CORRIGIDO\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// Total: 57 campos\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CI = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_652439CFE551C',      // CPF\n  rg:                       'UF_CRM_652439D00A9CF',      // RG\n  nit:                      'UF_CRM_6947602572F0A',      // NIT (EXTRATO DE PAGAMENTO)\n  nb:                       'UF_CRM_6790DAD756E3C',      // NÂº DO BENEFICIO\n  nome_filho:               'UF_CRM_65BD5488EC8E9',      // NOME DO FILHO(A)\n  categoria:                'UF_CRM_652439D03479D',      // CATEGORIA\n  \n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_69442F085B2CD',      // Data de InÃ­cio do BenefÃ­cio (DIB)\n  dip:                      'UF_CRM_683860072DEB8',      // Data de InÃ­cio do Pagamento (DIP)\n  dcb:                      'UF_CRM_6838600845561',      // Data de CessaÃ§Ã£o do BenefÃ­cio (DCB)\n  dn_mamae:                 'UF_CRM_652439D0138A5',      // DN MAMÃƒE\n  dn_filho:                 'UF_CRM_652439D021438',      // DN FILHO(A)\n  dn_certidao:              'UF_CRM_66351141F40C7',      // DN CERTIDÃƒO\n  data_dnv:                 'UF_CRM_67E17F1C70EAF',      // DATA DNV\n  data_requerimento:        'UF_CRM_652439D3530AB',      // DATA REQUERIMENTO\n  data_concessao:           'UF_CRM_652439D157BA8',      // DATA CONCESSÃƒO\n  \n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_67D19072D84A8',      // MR Cliente\n  valor_diario:             'UF_CRM_69442F466791E',      // Valor DiÃ¡rio\n  valor_liquido_mensal:     'UF_CRM_69442F4D0909D',      // Valor LÃ­quido Mensal\n  valor_total_beneficio:    'UF_CRM_69442F535C91B',      // Valor Total BenefÃ­cio (120d)\n  valor_restante_inss:      'UF_CRM_69442F3A581C2',      // Valor Restante INSS\n  aliquota_mr:              'UF_CRM_67E1B184633ED',      // AlÃ­quota MR\n  especie_beneficio:        'UF_CRM_69442F6570BDB',      // EspÃ©cie do BenefÃ­cio\n  \n  // â•â•â• 4. HONORÃRIOS START â•â•â•\n  valor_total_start:        'UF_CRM_69442F217FB9D',      // Valor Total Start (30%)\n  saldo_restante_start:     'UF_CRM_69442F27CCFB3',      // Saldo Restante Start\n  aliquota_start:           'UF_CRM_69442F596A782',      // AlÃ­quota Start\n  regra_aplicada:           'UF_CRM_69442F5F762AD',      // Regra Aplicada\n  \n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_652439D8D6B8E',      // VALOR DO INSS\n  valor_cliente:            'UF_CRM_652439D915311',      // VALOR DA CLIENTE\n  valor_previsto:           'UF_CRM_652439D9202B3',      // VALOR PREVISTO\n  parcela_numero:           'UF_CRM_652439D8E9608',      // PARCELA NÂº\n  parcela_formato:          'UF_CRM_652439D8CDB53',      // Ã€ Vista ou Parcelado\n  qtd_parcelas:             'UF_CRM_67E1AD2860054',      // QUANTIDADE DE PARCELAS\n  \n  // â•â•â• 6. EXTRATO / COMPETÃŠNCIA â•â•â•\n  competencia:              'UF_CRM_691B6450B46E3',      // CompetÃªncia\n  competencia_final:        'UF_CRM_69442F0E9A95A',      // CompetÃªncia Final\n  periodo:                  'UF_CRM_691B64560A17F',      // PerÃ­odo\n  ultima_comp_valida:       'UF_CRM_693D7DE5148DB',      // Ãšltima CompetÃªncia VÃ¡lida\n  credito_invalidado:       'UF_CRM_691B6467F11F2',      // CrÃ©dito Invalidado\n  dias_ja_recebidos:        'UF_CRM_69442F2E321C4',      // Dias JÃ¡ Recebidos\n  dias_restantes:           'UF_CRM_69442F3449D22',      // Dias Restantes\n  \n  // â•â•â• 7. DATAS OPERACIONAIS â•â•â•\n  data_inss:                'UF_CRM_652439D8B3207',      // DATA INSS\n  data_pagamento_extrato:   'UF_CRM_691B64616C2C9',      // Data Pagamento Extrato\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',      // Data AtualizaÃ§Ã£o Extrato\n  \n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_652439D194A06',      // BANCO\n  endereco_banco:           'UF_CRM_652439D1A53FA',      // EndereÃ§o do Banco\n  agencia_banco:            'UF_CRM_691225FDDDBE4',      // AGÃŠNCIA DO BANCO\n  \n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_693D7BBC3E5D3',      // Justificativa Direito\n  resultado_analise:        'UF_CRM_693D7CB58EBD2',      // Resultado AnÃ¡lise\n  data_rodagem:             'UF_CRM_6929FDA3C8A79',      // Data Rodagem\n  rodagem_comentario:       'UF_CRM_6929FD9E9A95D',      // ComentÃ¡rio Rodagem\n  direito_ate:              'UF_CRM_679781AAB3B1D',      // Direito AtÃ©\n  \n  // â•â•â• 10. GESTÃƒO â•â•â•\n  ultimo_relacionador:      'UF_CRM_65BD5488EC8E9',      // Ãšltimo Relacionador\n  ddd_cliente:              'UF_CRM_65BD5489DF3A2',      // DDD Cliente\n  data_reclamacao:          'UF_CRM_65BD5489C89AD',      // Data ReclamaÃ§Ã£o\n  data_qualificacao:        'UF_CRM_65E777E2A0CED',      // Data QualificaÃ§Ã£o\n  data_recuperacao:         'UF_CRM_662699414BCF0',      // Data RecuperaÃ§Ã£o\n  data_encerramento:        'UF_CRM_6631460FD3BB4',      // (PERDIDA) - DATA DE ENCERRAMENTO PERSONALIZADO\n  data_reentrada:           'UF_CRM_678EADB02E460',      // Data Reentrada\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CAMPOS EXTRAS - Mapeados para uso futuro\n// Fonte: Mapeamento_CORRETO_DEAL_INVOICE.xlsx (02/01/2026)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CAMPOS_EXTRAS = {\n  // Deal\n  data_encerramento_sem_direito_deal: 'UF_CRM_663007E518A1E',  // (SEM DIREITO) - DATA DE ENCERRAMENTO\n  data_conversao_deal:                'UF_CRM_5F7DD07B204FD',  // DATA DE CONVERSÃƒO\n  data_certidao_deal:                 'UF_CRM_1674755625727',  // DATA CERTIDÃƒO\n  data_consulta_deal:                 'UF_CRM_1602256877083',  // Data da Consulta\n  data_contato_deal:                  'UF_CRM_1650915373840',  // DATA DO CONTATO\n  data_prox_contato_deal:             'UF_CRM_1650915411107',  // DATA DO PROXM CONTATO\n  data_sem_direito_deal:              'UF_CRM_1649701660322',  // DATA DE SEM DIREITO\n  data_indeferimento_deal:            'UF_CRM_1620315580',     // DATA DE INDEFERIMENTO\n  data_quebra_contrato_deal:          'UF_CRM_1737722079155',  // DATA QUEBRA DE CONTRATO\n  relacionador_quebra_deal:           'UF_CRM_1737722166447',  // RELACIONADOR ENVIO PARA QUEBRA\n  relacionador_sem_direito_deal:      'UF_CRM_1737722233583',  // RELACIONADOR ENVIO PARA SEM DIREITO\n  recurso_deal:                       'UF_CRM_1759219838803',  // Recurso\n  senha_deal:                         'UF_CRM_1602257200479',  // SENHA\n  sugestao_senha_deal:                'UF_CRM_5FDA4FCE92DAA',  // SugestÃ£o de senha\n  telefone_2_deal:                    'UF_CRM_606C6C98B68A7',  // TELEFONE - 2\n  telefone_3_deal:                    'UF_CRM_606C6C9A00D10',  // TELEFONE - 3\n  sine_deal:                          'UF_CRM_1751375841241',  // SINE\n  data_envio_recurso_deal:            'UF_CRM_1759220050331',  // Data Envio ao Recurso\n  \n  // Invoice\n  resultado_criacao_faturas_inv:      'UF_CRM_SMART_INVOICE_1767045330', // RESULTADO DA CRIAÃ‡ÃƒO AUT. DE FATURAS\n  data_conversao_inv:                 'UF_CRM_652439D0CF19F',  // DATA DE CONVERSÃƒO\n  data_calculo_inv:                   'UF_CRM_69442F14E544C',  // Data CÃ¡lculo\n  data_certidao_inv:                  'UF_CRM_652439DA75EFF',  // DATA CERTIDÃƒO\n  data_consulta_inv:                  'UF_CRM_652439D14CF3D',  // Data da Consulta\n  data_acordo_inv:                    'UF_CRM_652439DB85203',  // DATA DO ACORDO\n  data_contato_inv:                   'UF_CRM_652439D9B26DF',  // DATA DO CONTATO\n  data_sem_direito_inv:               'UF_CRM_66ACE094C0195',  // DATA DE SEM DIREITO\n  data_pagamento_inv:                 'UF_CRM_652439D8BD582',  // DATA DE PAGAMENTO\n  data_indeferimento_inv:             'UF_CRM_652439D3E866C',  // DATA DE INDEFERIMENTO\n  data_recebimento_inv:               'UF_CRM_652439D1B26E2',  // DATA DE RECEBIMENTO\n  desconto_inv:                       'UF_CRM_6838600A5C767',  // DESCONTO\n  data_quebra_contrato_inv:           'UF_CRM_6793A405B3FC1',  // DATA QUEBRA DE CONTRATO\n  relacionador_quebra_inv:            'UF_CRM_6793A4065BECA',  // RELACIONADOR ENVIO PARA QUEBRA\n  relacionador_sem_direito_inv:       'UF_CRM_6793A40701BCB',  // RELACIONADOR ENVIO PARA SEM DIREITO\n  recurso_inv:                        'UF_CRM_68DD552A351D0',  // Recurso\n  senha_inv:                          'UF_CRM_652439D16254A',  // SENHA\n  sugestao_senha_inv:                 'UF_CRM_652439D23E905',  // SugestÃ£o de senha\n  telefone_2_inv:                     'UF_CRM_652439D28D353',  // TELEFONE - 2\n  telefone_3_inv:                     'UF_CRM_652439D298A88',  // TELEFONE - 3\n  sine_inv:                           'UF_CRM_6883D4B47136F',  // SINE\n  data_envio_recurso_inv:             'UF_CRM_68DD552F3DD02',  // Data Envio ao Recurso\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TABELA DE CONVERSÃƒO BANCO TEXTO â†’ ENUM ID (para Invoice)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst BANCO_ENUM = {\n  'caixa': 4530,\n  'caixa economica': 4530,\n  'caixa econÃ´mica': 4530,\n  'cef': 4530,\n  '104': 4530,\n  'banco do brasil': 4532,\n  'bb': 4532,\n  '001': 4532,\n  'santander': 4534,\n  '033': 4534,\n  'banrisul': 4536,\n  'crefisa': 4538,\n  'bmg': 4540,\n  'agibank': 4542,\n  'sicredi': 4544,\n  'bancoob': 4546,\n  'banestes': 4548,\n  'acordo sem banco': 4550,\n  'banpara': 4552,\n  'banparÃ¡': 4552,\n  'banese': 4554,\n  'sicoob': 4556,\n  'brb': 6712,\n  'bradesco': 431,\n  '237': 431,\n  'itau': 433,\n  'itaÃº': 433,\n  '341': 433,\n  'mercantil': 435\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// TABELAS DE NORMALIZAÃ‡ÃƒO DE STATUS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst MAPA_STATUS_CREDITO = {\n  'pagamento efetivado': 'PAGO',\n  'pagamento efetuado': 'PAGO',\n  'pago': 'PAGO',\n  'credito liberado': 'PAGO',\n  'crÃ©dito liberado': 'PAGO',\n  'liberado': 'PAGO',\n  'efetivado': 'PAGO',\n  'efetuado': 'PAGO',\n  'crÃ©dito nÃ£o retornado': 'PENDENTE',\n  'credito nÃ£o retornado': 'PENDENTE',\n  'credito nao retornado': 'PENDENTE',\n  'nÃ£o retornado': 'PENDENTE',\n  'nao retornado': 'PENDENTE',\n  'previsto': 'PENDENTE',\n  'bloqueado': 'CANCELADO',\n  'cancelado': 'CANCELADO',\n  'invalidado': 'CANCELADO',\n  'suspenso': 'CANCELADO'\n};\n\nconst MAPA_STATUS_MEI = {\n  'liquidado': 'PAGO',\n  'pago': 'PAGO',\n  'devedor': 'DEVEDOR',\n  'em atraso': 'DEVEDOR',\n  'a vencer': 'A_VENCER',\n  'pendente': 'A_VENCER'\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES UTILITÃRIAS\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/** TRUNCAR - INSS usa truncamento, nÃ£o arredondamento! */\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\n/** Parse de valor brasileiro: \"R$ 1.518,00\" â†’ 1518.00 */\nfunction parseValorBR(valor) {\n  if (!valor) return 0;\n  if (typeof valor === 'number') return tr(valor);\n  const limpo = String(valor)\n    .replace(/R\\$\\s*/gi, '')\n    .replace(/\\./g, '')\n    .replace(',', '.')\n    .trim();\n  return tr(parseFloat(limpo) || 0);\n}\n\n/** Parse de data BR: \"01/10/2024\" â†’ \"2024-10-01\" */\nfunction parseDateBR(dataStr) {\n  if (!dataStr) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(dataStr)) {\n    return dataStr.substring(0, 10);\n  }\n  const match = dataStr.match(/(\\d{2})\\/(\\d{2})\\/(\\d{4})/);\n  if (match) {\n    return `${match[3]}-${match[2]}-${match[1]}`;\n  }\n  return null;\n}\n\n/** Formatar data para Bitrix */\nfunction formatDateBitrix(dataISO) {\n  if (!dataISO) return null;\n  return `${dataISO}T03:00:00+00:00`;\n}\n\n/** Formatar valor para campo money do Bitrix */\nfunction formatMoneyBitrix(valor) {\n  if (!valor && valor !== 0) return null;\n  return `${tr(valor)}|BRL`;\n}\n\n/** Parse de perÃ­odo: \"01/10/2024 a 31/10/2024\" â†’ { inicio, fim } */\nfunction parsePeriodo(periodoStr) {\n  if (!periodoStr) return { inicio: null, fim: null };\n  const partes = periodoStr.split(/\\s+a\\s+/i);\n  return {\n    inicio: parseDateBR(partes[0]?.trim()),\n    fim: parseDateBR(partes[1]?.trim() || partes[0]?.trim())\n  };\n}\n\n/** Limpa CPF/NIT: \"123.456.789-00\" â†’ \"12345678900\" */\nfunction limparDocumento(doc) {\n  if (!doc) return '';\n  return String(doc).replace(/\\D/g, '');\n}\n\n/** Normalizar competÃªncia: \"10/2024\" ou \"Outubro/2024\" â†’ \"10/2024\" */\nfunction normalizarCompetencia(comp) {\n  if (!comp) return null;\n  const match = comp.match(/(\\d{1,2})\\/(\\d{4})/);\n  if (match) {\n    return `${match[1].padStart(2, '0')}/${match[2]}`;\n  }\n  return comp;\n}\n\n/** Calcular diferenÃ§a em dias entre duas datas ISO (inclusivo) */\nfunction calcularDias(dataInicio, dataFim) {\n  if (!dataInicio || !dataFim) return 0;\n  const d1 = new Date(dataInicio);\n  const d2 = new Date(dataFim);\n  const diffTime = d2 - d1;\n  return Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;\n}\n\n/** Normalizar status do crÃ©dito */\nfunction normalizarStatusCredito(statusOriginal) {\n  if (!statusOriginal) return 'PENDENTE';\n  const key = statusOriginal.toLowerCase().trim();\n  for (const [pattern, status] of Object.entries(MAPA_STATUS_CREDITO)) {\n    if (key.includes(pattern)) return status;\n  }\n  return 'PENDENTE';\n}\n\n/** Normalizar status MEI */\nfunction normalizarStatusMEI(statusOriginal) {\n  if (!statusOriginal) return 'A_VENCER';\n  const key = statusOriginal.toLowerCase().trim();\n  for (const [pattern, status] of Object.entries(MAPA_STATUS_MEI)) {\n    if (key.includes(pattern)) return status;\n  }\n  return 'A_VENCER';\n}\n\n/** Extrair mÃªs/ano de uma data ISO */\nfunction extrairMesAno(dataISO) {\n  if (!dataISO) return null;\n  return `${dataISO.substring(5, 7)}/${dataISO.substring(0, 4)}`;\n}\n\n/** Comparar competÃªncias: retorna -1, 0 ou 1 */\nfunction compararCompetencias(comp1, comp2) {\n  if (!comp1 || !comp2) return 0;\n  const [m1, a1] = comp1.split('/').map(Number);\n  const [m2, a2] = comp2.split('/').map(Number);\n  if (a1 !== a2) return a1 - a2;\n  return m1 - m2;\n}\n\n/** Gerar hash Ãºnico */\nfunction gerarHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(16).padStart(8, '0');\n}\n\n/** Converter nome do banco para enum ID */\nfunction bancoParaEnum(bancoTexto) {\n  if (!bancoTexto) return null;\n  const key = String(bancoTexto).toLowerCase().trim();\n  \n  if (BANCO_ENUM[key]) return BANCO_ENUM[key];\n  \n  for (const [pattern, enumId] of Object.entries(BANCO_ENUM)) {\n    if (key.includes(pattern) || pattern.includes(key)) {\n      return enumId;\n    }\n  }\n  \n  return null;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// v7.1: FUNÃ‡ÃƒO PARA CRIAR TAG PADRONIZADA\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction criarTag(codigo, severidade, mensagem, extras = {}) {\n  return {\n    codigo,\n    severidade,\n    mensagem,\n    timestamp: new Date().toISOString(),\n    ...extras\n  };\n}\n\n/** Calcular resumo de tags por severidade */\nfunction calcularResumoTags(tags) {\n  const resumo = {\n    crit: 0,\n    alto: 0,\n    medio: 0,\n    baixo: 0,\n    info: 0,\n    total: tags.length\n  };\n  \n  tags.forEach(tag => {\n    switch (tag.severidade) {\n      case SEVERIDADE.CRIT: resumo.crit++; break;\n      case SEVERIDADE.ALTO: resumo.alto++; break;\n      case SEVERIDADE.MEDIO: resumo.medio++; break;\n      case SEVERIDADE.BAIXO: resumo.baixo++; break;\n      case SEVERIDADE.INFO: resumo.info++; break;\n    }\n  });\n  \n  return resumo;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 1. BUSCAR CONTEXTO DOS NÃ“S ANTERIORES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ctxAnterior = $('2C. Analisar Faturas').first()?.json || \n                    $('2. Buscar Deal').first()?.json || \n                    {};\n\nconst deal = ctxAnterior.deal || ctxAnterior.result || {};\nconst deal_id = ctxAnterior.deal_id || deal.ID || $json.deal_id;\nconst faturas_existentes = ctxAnterior.faturas_existentes || {};\nconst tentativa = ctxAnterior.tentativa || 1;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 2. PARSE DA RESPOSTA DO GEMINI\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nlet dadosGemini = null;\nlet erroGemini = null;\n\ntry {\n  const textoGemini = $json.content?.parts?.[0]?.text ||\n                      $json.candidates?.[0]?.content?.parts?.[0]?.text ||\n                      $json[0]?.content?.parts?.[0]?.text ||\n                      $json[0]?.candidates?.[0]?.content?.parts?.[0]?.text ||\n                      $json.text || \n                      (typeof $json === 'string' ? $json : null);\n  \n  if (!textoGemini) {\n    throw new Error('Resposta do Gemini vazia ou em formato inesperado');\n  }\n  \n  let jsonLimpo = textoGemini\n    .replace(/```json\\n?/gi, '')\n    .replace(/```\\n?/g, '')\n    .trim();\n  \n  const inicioJSON = jsonLimpo.indexOf('{');\n  const fimJSON = jsonLimpo.lastIndexOf('}');\n  \n  if (inicioJSON === -1 || fimJSON === -1) {\n    throw new Error('JSON nÃ£o encontrado na resposta do Gemini');\n  }\n  \n  jsonLimpo = jsonLimpo.substring(inicioJSON, fimJSON + 1);\n  dadosGemini = JSON.parse(jsonLimpo);\n  \n} catch (e) {\n  erroGemini = e.message;\n}\n\n// v7.1: Retorno de erro com sistema de TAGs\nif (erroGemini) {\n  const tags = [\n    criarTag('TAG_PARSE_GEMINI_ERRO', SEVERIDADE.CRIT, erroGemini, { pode_reprocessar: tentativa < 2 })\n  ];\n  const resumo_tags = calcularResumoTags(tags);\n  \n  return [{\n    json: {\n      _no: '6A',\n      _versao: '7.1',\n      _timestamp: new Date().toISOString(),\n      \n      ok: false,\n      tipo_documento: TIPO_DOC.DESCONHECIDO,\n      erro: {\n        tipo: 'PARSE_GEMINI',\n        mensagem: erroGemini,\n        pode_reprocessar: tentativa < 2\n      },\n      \n      // v7.1: Sistema de TAGs\n      tags,\n      resumo_tags,\n      tem_problemas_criticos: true,\n      tem_problemas_altos: false,\n      \n      deal_id,\n      deal,\n      faturas_existentes,\n      tentativa,\n      tempo_ms: Date.now() - inicio,\n      campos_deal: {},\n      campos_invoice_base: {}\n    }\n  }];\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3. DETECTAR TIPO DE DOCUMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction detectarTipoDocumento(dados) {\n  const temCNPJ = dados.cnpj || dados.CNPJ;\n  const temPGMEI = dados.tipo_documento?.toLowerCase().includes('pgmei') ||\n                   dados.tipo_documento?.toLowerCase().includes('das') ||\n                   dados.sistema?.toLowerCase().includes('pgmei');\n  const temContribuicoes = dados.contribuicoes || dados.Contribuicoes || \n                           dados.periodos_apuracao;\n  \n  const temNB = dados.beneficio?.nb || dados.NB || dados.numero_beneficio;\n  const temMR = dados.beneficio?.mr || dados.MR;\n  const temDIB = dados.beneficio?.dib || dados.DIB;\n  const temHistoricoCreditos = dados.historico_creditos || dados.Creditos || \n                               dados.Pagamentos;\n  \n  if (temCNPJ && (temPGMEI || temContribuicoes)) {\n    return TIPO_DOC.PGMEI_DAS;\n  }\n  \n  if (temNB || temMR || temDIB || temHistoricoCreditos) {\n    return TIPO_DOC.EXTRATO_CREDITOS;\n  }\n  \n  return TIPO_DOC.DESCONHECIDO;\n}\n\nconst tipoDocumento = detectarTipoDocumento(dadosGemini);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4A. PROCESSAR EXTRATO DE CRÃ‰DITOS INSS (v7.1 - COM SISTEMA DE TAGS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction processarExtratoCreditos(dados) {\n  // v7.1: Array unificado de TAGs\n  const tags = [];\n  \n  // Mantido da v7.0 para compatibilidade\n  const alertas = [];\n  const erros = [];\n  const info = [];\n  const tags_correcao = [];\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.1 IDENTIFICAÃ‡ÃƒO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const cliente = {\n    nome: dados.identificacao?.nome || dados.Nome || '',\n    cpf: limparDocumento(dados.identificacao?.cpf || dados.CPF),\n    nit: limparDocumento(dados.identificacao?.nit || dados.NIT)\n  };\n  \n  // v7.1: TAGs de identificaÃ§Ã£o\n  if (!cliente.cpf) {\n    tags.push(criarTag('TAG_CPF_AUSENTE', SEVERIDADE.CRIT, 'CPF nÃ£o extraÃ­do do PDF', { campo: 'cpf' }));\n    erros.push({ tipo: 'CPF_AUSENTE', mensagem: 'CPF nÃ£o encontrado no extrato', severidade: 'CRITICO' });\n  } else if (cliente.cpf.length !== 11) {\n    tags.push(criarTag('TAG_CPF_INVALIDO', SEVERIDADE.CRIT, `CPF com formato invÃ¡lido: ${cliente.cpf}`, { campo: 'cpf', valor: cliente.cpf }));\n    erros.push({ tipo: 'CPF_INVALIDO', mensagem: `CPF invÃ¡lido: ${cliente.cpf}`, severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_CPF_OK', SEVERIDADE.INFO, `CPF validado: ${cliente.cpf}`, { campo: 'cpf', valor: cliente.cpf }));\n  }\n  \n  if (!cliente.nit) {\n    tags.push(criarTag('TAG_NIT_AUSENTE', SEVERIDADE.ALTO, 'NIT nÃ£o extraÃ­do - necessÃ¡rio para calendÃ¡rio INSS', { campo: 'nit' }));\n  } else {\n    tags.push(criarTag('TAG_NIT_OK', SEVERIDADE.INFO, `NIT validado: ${cliente.nit}`, { campo: 'nit', valor: cliente.nit }));\n  }\n  \n  if (!cliente.nome) {\n    tags.push(criarTag('TAG_NOME_AUSENTE', SEVERIDADE.MEDIO, 'Nome nÃ£o extraÃ­do do PDF', { campo: 'nome' }));\n  } else {\n    tags.push(criarTag('TAG_NOME_OK', SEVERIDADE.INFO, `Nome: ${cliente.nome}`, { campo: 'nome', valor: cliente.nome }));\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.2 BENEFÃCIO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const beneficioRaw = dados.beneficio || dados.CreditosDoBeneficio || {};\n  \n  const mr = parseValorBR(beneficioRaw.mr || beneficioRaw.MR || dados.MR);\n  const dib = parseDateBR(beneficioRaw.dib || beneficioRaw.DIB || dados.DIB);\n  let dcb = parseDateBR(beneficioRaw.dcb || beneficioRaw.DCB || dados.DCB);\n  \n  let dip = parseDateBR(\n    beneficioRaw.dip || \n    beneficioRaw.DIP || \n    dados.DIP || \n    dados.dip ||\n    beneficioRaw.data_inicio_pagamento ||\n    dados.data_inicio_pagamento\n  );\n  \n  // v7.1: TAGs de NB\n  const nb = beneficioRaw.nb || beneficioRaw.NB || dados.NB || '';\n  if (!nb) {\n    tags.push(criarTag('TAG_NB_AUSENTE', SEVERIDADE.CRIT, 'NÃºmero do BenefÃ­cio nÃ£o extraÃ­do', { campo: 'nb' }));\n    erros.push({ tipo: 'NB_AUSENTE', mensagem: 'NÃºmero do BenefÃ­cio nÃ£o encontrado', severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_NB_OK', SEVERIDADE.INFO, `NB validado: ${nb}`, { campo: 'nb', valor: nb }));\n  }\n  \n  // v7.1: TAGs de MR\n  if (!mr || mr <= 0) {\n    tags.push(criarTag('TAG_MR_AUSENTE', SEVERIDADE.CRIT, 'MR nÃ£o extraÃ­da do PDF ou valor zero', { campo: 'mr', valor: mr }));\n    erros.push({ tipo: 'MR_INVALIDO', mensagem: `MR invÃ¡lido: ${mr}`, severidade: 'CRITICO' });\n  } else if (mr < CONFIG.SALARIO_MINIMO_2025) {\n    tags.push(criarTag('TAG_MR_ABAIXO_MINIMO', SEVERIDADE.ALTO, `MR (${mr}) abaixo do salÃ¡rio mÃ­nimo (${CONFIG.SALARIO_MINIMO_2025})`, { campo: 'mr', valor: mr, salario_minimo: CONFIG.SALARIO_MINIMO_2025 }));\n  } else if (mr > CONFIG.TETO_INSS_2025) {\n    tags.push(criarTag('TAG_MR_ACIMA_TETO', SEVERIDADE.MEDIO, `MR (${mr}) acima do teto INSS (${CONFIG.TETO_INSS_2025})`, { campo: 'mr', valor: mr, teto: CONFIG.TETO_INSS_2025 }));\n  } else {\n    tags.push(criarTag('TAG_MR_OK', SEVERIDADE.INFO, `MR validada: R$ ${mr}`, { campo: 'mr', valor: mr }));\n  }\n  \n  // v7.1: TAGs de DIB\n  if (!dib) {\n    tags.push(criarTag('TAG_DIB_AUSENTE', SEVERIDADE.CRIT, 'DIB nÃ£o extraÃ­da do PDF', { campo: 'dib' }));\n  } else {\n    const dibDate = new Date(dib);\n    const hoje = new Date();\n    if (dibDate > hoje) {\n      tags.push(criarTag('TAG_DIB_FUTURA', SEVERIDADE.ALTO, `DIB (${dib}) estÃ¡ no futuro`, { campo: 'dib', valor: dib }));\n    } else {\n      tags.push(criarTag('TAG_DIB_OK', SEVERIDADE.INFO, `DIB validada: ${dib}`, { campo: 'dib', valor: dib }));\n    }\n  }\n  \n  // Calcular DCB se nÃ£o veio (DIB + 120 dias)\n  if (!dcb && dib) {\n    const dibDate = new Date(dib);\n    dibDate.setDate(dibDate.getDate() + CONFIG.DIAS_SALARIO_MATERNIDADE - 1);\n    dcb = dibDate.toISOString().substring(0, 10);\n    tags.push(criarTag('TAG_DCB_CALCULADA', SEVERIDADE.INFO, `DCB calculada: ${dcb} (DIB + 119 dias)`, { campo: 'dcb', valor: dcb, calculado: true }));\n  } else if (dcb) {\n    tags.push(criarTag('TAG_DCB_OK', SEVERIDADE.INFO, `DCB validada: ${dcb}`, { campo: 'dcb', valor: dcb }));\n  } else {\n    tags.push(criarTag('TAG_DCB_AUSENTE', SEVERIDADE.MEDIO, 'DCB nÃ£o extraÃ­da e nÃ£o pode ser calculada (DIB ausente)', { campo: 'dcb' }));\n  }\n  \n  // Se DIP nÃ£o veio, usar DIB como fallback\n  if (!dip && dib) {\n    dip = dib;\n    tags.push(criarTag('TAG_DIP_FALLBACK_DIB', SEVERIDADE.INFO, `DIP usando DIB como fallback: ${dip}`, { campo: 'dip', valor: dip, fallback: true }));\n    info.push('INFO_DIP_FALLBACK_DIB');\n  } else if (dip) {\n    tags.push(criarTag('TAG_DIP_OK', SEVERIDADE.INFO, `DIP validada: ${dip}`, { campo: 'dip', valor: dip }));\n    info.push('INFO_DIP_EXTRAIDO_PDF');\n  } else {\n    tags.push(criarTag('TAG_DIP_AUSENTE', SEVERIDADE.MEDIO, 'DIP nÃ£o extraÃ­da e DIB tambÃ©m ausente', { campo: 'dip' }));\n    alertas.push({ tipo: 'DIP_NAO_EXTRAIDO', mensagem: 'DIP nÃ£o encontrado no PDF, usando DIB como fallback' });\n  }\n  \n  const dias_beneficio = dib && dcb ? calcularDias(dib, dcb) : CONFIG.DIAS_SALARIO_MATERNIDADE;\n  const valor_diario = tr(mr / 30);\n  \n  const bancoTexto = beneficioRaw.banco || \n                     dados.Banco || \n                     dados.banco ||\n                     beneficioRaw.meio_pagamento ||\n                     dados.meio_pagamento || '';\n  \n  const banco_enum = bancoParaEnum(bancoTexto);\n  \n  // v7.1: TAGs de Banco\n  if (!bancoTexto) {\n    tags.push(criarTag('TAG_BANCO_AUSENTE', SEVERIDADE.BAIXO, 'Banco nÃ£o extraÃ­do do PDF', { campo: 'banco' }));\n  } else if (!banco_enum) {\n    tags.push(criarTag('TAG_BANCO_NAO_MAPEADO', SEVERIDADE.BAIXO, `Banco '${bancoTexto}' nÃ£o mapeado para enum`, { campo: 'banco', valor: bancoTexto }));\n  } else {\n    tags.push(criarTag('TAG_BANCO_OK', SEVERIDADE.INFO, `Banco validado: ${bancoTexto} (enum: ${banco_enum})`, { campo: 'banco', valor: bancoTexto, enum_id: banco_enum }));\n  }\n  \n  const especie = beneficioRaw.especie || beneficioRaw.Especie || '80';\n  \n  // v7.1: TAG de EspÃ©cie\n  if (especie !== '80' && especie !== 80) {\n    tags.push(criarTag('TAG_ESPECIE_NAO_80', SEVERIDADE.ALTO, `EspÃ©cie (${especie}) nÃ£o Ã© SalÃ¡rio-Maternidade (80)`, { campo: 'especie', valor: especie }));\n  } else {\n    tags.push(criarTag('TAG_ESPECIE_OK', SEVERIDADE.INFO, 'EspÃ©cie validada: 80 - SalÃ¡rio-Maternidade', { campo: 'especie', valor: especie }));\n  }\n  \n  const beneficio = {\n    nb,\n    especie,\n    mr,\n    dib,\n    dip,\n    dcb,\n    dias_beneficio,\n    valor_diario,\n    banco: bancoTexto,\n    banco_enum\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.3 DADOS DO EXTRATO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const extrato = {\n    compet_inicial: normalizarCompetencia(dados.compet_inicial || dados.competencia_inicial),\n    compet_final: normalizarCompetencia(dados.compet_final || dados.competencia_final),\n    data_atualizacao: parseDateBR(dados.data_atualizacao)\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.4 PROCESSAR CRÃ‰DITOS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const creditosRaw = dados.historico_creditos || dados.Pagamentos || \n                      dados.Creditos || dados.creditos || [];\n  \n  // v7.1: TAG de crÃ©ditos\n  if (creditosRaw.length === 0) {\n    tags.push(criarTag('TAG_CREDITOS_VAZIO', SEVERIDADE.CRIT, 'Nenhum crÃ©dito extraÃ­do do PDF', { campo: 'creditos' }));\n  } else if (creditosRaw.length === 1) {\n    tags.push(criarTag('TAG_CREDITOS_UNICO', SEVERIDADE.INFO, 'Apenas 1 crÃ©dito no extrato', { campo: 'creditos', quantidade: 1 }));\n  } else if (creditosRaw.length > 6) {\n    tags.push(criarTag('TAG_CREDITOS_MUITOS', SEVERIDADE.MEDIO, `${creditosRaw.length} crÃ©ditos no extrato - verificar se correto`, { campo: 'creditos', quantidade: creditosRaw.length }));\n  } else {\n    tags.push(criarTag('TAG_CREDITOS_OK', SEVERIDADE.INFO, `${creditosRaw.length} crÃ©ditos extraÃ­dos`, { campo: 'creditos', quantidade: creditosRaw.length }));\n  }\n  \n  const creditos = creditosRaw.map((cred, index) => {\n    const periodo = parsePeriodo(cred.periodo || cred.Periodo);\n    const credId = index + 1;\n    \n    const diasCalculado = periodo.inicio && periodo.fim\n      ? calcularDias(periodo.inicio, periodo.fim)\n      : 0;\n\n    let diasInformado = (cred.dias !== undefined && cred.dias !== null) ? Number(cred.dias) : null;\n    if (Number.isNaN(diasInformado)) diasInformado = null;\n\n    let dias = diasCalculado;\n\n    // Se calculado deu <= 0 mas as datas existem, tentar corrigir invertendo\n    if (periodo.inicio && periodo.fim && diasCalculado <= 0) {\n      const tmp = periodo.inicio;\n      periodo.inicio = periodo.fim;\n      periodo.fim = tmp;\n\n      const diasRecalc = calcularDias(periodo.inicio, periodo.fim);\n      if (diasRecalc > 0) {\n        dias = diasRecalc;\n        if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n        tags.push(criarTag(`TAG_CRED${credId}_PERIODO_INVERTIDO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: perÃ­odo invertido, corrigido`, { credito_id: credId, dias_corrigido: dias }));\n        alertas.push({\n          tipo: 'DIAS_CORRIGIDOS_PERIODO_INVERTIDO',\n          mensagem: `CrÃ©dito #${credId}: perÃ­odo invertido no PDF/extraÃ§Ã£o. Dias recalculados para ${dias}.`,\n          credito_id: credId\n        });\n      }\n    }\n\n    // Se o Gemini informou dias e estÃ¡ diferente do calculado\n    if (diasInformado && diasInformado > 0 && diasCalculado > 0 && diasInformado !== diasCalculado) {\n      dias = diasCalculado;\n      if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_CORRIGIDO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: dias corrigido de ${diasInformado} para ${diasCalculado}`, { credito_id: credId, dias_informado: diasInformado, dias_calculado: diasCalculado }));\n      alertas.push({\n        tipo: 'DIAS_CORRIGIDOS_DIVERGENCIA',\n        mensagem: `CrÃ©dito #${credId}: dias informado (${diasInformado}) â‰  dias calculado (${diasCalculado}). Corrigido para ${diasCalculado}.`,\n        credito_id: credId,\n        dias_informado: diasInformado,\n        dias_calculado: diasCalculado\n      });\n    }\n\n    // Blindagem final: dias nunca negativo/zero se houver datas\n    if (periodo.inicio && periodo.fim && (!dias || dias <= 0)) {\n      dias = 1;\n      if (!tags_correcao.includes('TAG_DIAS_CORRIGIDOS')) tags_correcao.push('TAG_DIAS_CORRIGIDOS');\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_MINIMO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: dias ajustado para 1 (mÃ­nimo)`, { credito_id: credId }));\n      alertas.push({\n        tipo: 'DIAS_CORRIGIDOS_MINIMO',\n        mensagem: `CrÃ©dito #${credId}: dias ficou invÃ¡lido. Ajustado para 1 (mÃ­nimo).`,\n        credito_id: credId\n      });\n    }\n    \n    // v7.1: TAG de dias do crÃ©dito\n    if (dias === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_ZERO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: dias = 0`, { credito_id: credId }));\n    } else if (dias > 31) {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_EXCEDE_MES`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: ${dias} dias (excede 1 mÃªs)`, { credito_id: credId, dias }));\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_DIAS_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: ${dias} dias`, { credito_id: credId, dias }));\n    }\n\n    const valor_bruto = parseValorBR(cred.valor_bruto || cred.ValorBruto || cred.rubricas?.['101']);\n    const valor_liquido = parseValorBR(cred.valor_liquido || cred.ValorLiquido);\n    const desconto_inss = parseValorBR(cred.desconto_inss || cred.rubricas?.['206']);\n    const decimo_terceiro = parseValorBR(cred.decimo_terceiro || cred.rubricas?.['104']);\n    const arredondamento = parseValorBR(cred.arredondamento || cred.rubricas?.['137'] || cred.rubricas?.['215']);\n    \n    // v7.1: TAGs de valores do crÃ©dito\n    if (!valor_liquido || valor_liquido === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_AUSENTE`, SEVERIDADE.CRIT, `CrÃ©dito #${credId}: valor lÃ­quido nÃ£o extraÃ­do ou zero`, { credito_id: credId }));\n    } else if (valor_liquido < CONFIG.VALOR_BAIXO_ALERTA) {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_BAIXO`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: valor baixo R$ ${valor_liquido}`, { credito_id: credId, valor: valor_liquido }));\n      alertas.push({ tipo: 'VALOR_BAIXO', mensagem: `CrÃ©dito #${credId} com valor baixo: R$ ${valor_liquido}`, credito_id: credId });\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_LIQUIDO_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: lÃ­quido R$ ${valor_liquido}`, { credito_id: credId, valor: valor_liquido }));\n    }\n    \n    if (!valor_bruto || valor_bruto === 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_AUSENTE`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: valor bruto (rubrica 101) nÃ£o extraÃ­do`, { credito_id: credId }));\n    } else if (valor_bruto < valor_liquido) {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_MENOR_LIQUIDO`, SEVERIDADE.CRIT, `CrÃ©dito #${credId}: bruto (${valor_bruto}) < lÃ­quido (${valor_liquido})`, { credito_id: credId, bruto: valor_bruto, liquido: valor_liquido }));\n    } else {\n      tags.push(criarTag(`TAG_CRED${credId}_BRUTO_OK`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: bruto R$ ${valor_bruto}`, { credito_id: credId, valor: valor_bruto }));\n    }\n    \n    // v7.1: TAG de 13Âº salÃ¡rio\n    if (decimo_terceiro > 0) {\n      tags.push(criarTag(`TAG_CRED${credId}_TEM_13`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: inclui 13Âº salÃ¡rio R$ ${decimo_terceiro}`, { credito_id: credId, valor: decimo_terceiro }));\n      alertas.push({ tipo: 'TEM_13_SALARIO', mensagem: `CrÃ©dito #${credId} inclui 13Âº salÃ¡rio: R$ ${decimo_terceiro}`, credito_id: credId });\n    }\n    \n    const statusOriginal = cred.status || cred.Ocorrencia || cred.ocorrencia || '';\n    const status = normalizarStatusCredito(statusOriginal);\n    const creditoInvalidado = cred.credito_invalidado === true || \n                               cred.credito_invalidado === 'Sim' ||\n                               cred.CreditoInvalidado === 'Sim';\n    \n    // v7.1: TAGs de status do crÃ©dito\n    if (!statusOriginal) {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_AUSENTE`, SEVERIDADE.MEDIO, `CrÃ©dito #${credId}: status nÃ£o extraÃ­do - assumindo PENDENTE`, { credito_id: credId }));\n    } else if (status === 'PAGO') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_PAGO`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: jÃ¡ pago`, { credito_id: credId, status }));\n    } else if (status === 'PENDENTE') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_PENDENTE`, SEVERIDADE.INFO, `CrÃ©dito #${credId}: pendente`, { credito_id: credId, status }));\n    } else if (status === 'CANCELADO') {\n      tags.push(criarTag(`TAG_CRED${credId}_STATUS_CANCELADO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: cancelado/invalidado`, { credito_id: credId, status }));\n    }\n    \n    if (creditoInvalidado) {\n      tags.push(criarTag(`TAG_CRED${credId}_INVALIDADO`, SEVERIDADE.ALTO, `CrÃ©dito #${credId}: marcado como invalidado`, { credito_id: credId }));\n    }\n    \n    const bancoCred = cred.banco || cred.Banco || beneficio.banco;\n    \n    const ja_pago = status === 'PAGO';\n    const pode_faturar = status !== 'CANCELADO' && !creditoInvalidado;\n    const tem_13o = decimo_terceiro > 0;\n    \n    // v7.1: TAG de perÃ­odo curto\n    if (dias <= CONFIG.PERIODO_CURTO_ALERTA && dias > 0) {\n      alertas.push({ tipo: 'PERIODO_CURTO', mensagem: `CrÃ©dito #${credId} com apenas ${dias} dia(s)`, credito_id: credId });\n    }\n    \n    return {\n      id: credId,\n      competencia: normalizarCompetencia(cred.competencia || cred.Competencia),\n      periodo: cred.periodo || cred.Periodo || `${periodo.inicio} a ${periodo.fim}`,\n      periodo_inicio: periodo.inicio,\n      periodo_fim: periodo.fim,\n      dias,\n      \n      valores: {\n        bruto: valor_bruto || mr,\n        liquido: valor_liquido,\n        desconto_inss,\n        decimo_terceiro,\n        arredondamento\n      },\n      \n      pagamento: {\n        previsao: parseDateBR(cred.previsao_pagamento || cred.PrevisaoPagamento),\n        data: parseDateBR(cred.data_pagamento || cred.DataPagamento),\n        status,\n        status_original: statusOriginal,\n        banco: bancoCred,\n        banco_enum: bancoParaEnum(bancoCred)\n      },\n      \n      validade: {\n        inicio: parseDateBR(cred.validade_inicio || cred.ValidadeInicio),\n        fim: parseDateBR(cred.validade_fim || cred.ValidadeFim)\n      },\n      \n      origem: cred.origem || cred.Origem || '',\n      data_calculo: parseDateBR(cred.data_calculo || cred.DataCalculo),\n      \n      flags: {\n        ja_pago,\n        pode_faturar,\n        invalidado: creditoInvalidado,\n        tem_13o\n      }\n    };\n  });\n  \n  // Ordenar por perÃ­odo\n  creditos.sort((a, b) => {\n    const dataA = a.periodo_inicio || a.periodo_fim || '9999-12-31';\n    const dataB = b.periodo_inicio || b.periodo_fim || '9999-12-31';\n    return dataA.localeCompare(dataB);\n  });\n  \n  // Separar por status\n  const creditosValidos = creditos.filter(c => c.flags.pode_faturar);\n  const creditosPagos = creditos.filter(c => c.flags.ja_pago && c.flags.pode_faturar);\n  const creditosPendentes = creditos.filter(c => !c.flags.ja_pago && c.flags.pode_faturar);\n  const creditosInvalidos = creditos.filter(c => !c.flags.pode_faturar);\n\n  // Fallback/recalculo de competÃªncia inicial/final\n  const compPrimeira = creditosValidos[0]?.competencia || null;\n  const compUltima = creditosValidos[creditosValidos.length - 1]?.competencia || null;\n\n  if ((!extrato.compet_inicial && compPrimeira) || (!extrato.compet_final && compUltima)) {\n    const antesIni = extrato.compet_inicial;\n    const antesFim = extrato.compet_final;\n\n    if (!extrato.compet_inicial && compPrimeira) extrato.compet_inicial = compPrimeira;\n    if (!extrato.compet_final && compUltima) extrato.compet_final = compUltima;\n\n    if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n    tags.push(criarTag('TAG_COMP_AUTO_RECALCULADA', SEVERIDADE.MEDIO, `CompetÃªncia recalculada: ${extrato.compet_inicial} â†’ ${extrato.compet_final}`, { antes: { compet_inicial: antesIni, compet_final: antesFim }, depois: { compet_inicial: extrato.compet_inicial, compet_final: extrato.compet_final } }));\n    alertas.push({\n      tipo: 'COMP_RECALCULADA_FALLBACK',\n      mensagem: `CompetÃªncia inicial/final ausente. Recalculada a partir dos crÃ©ditos: ${extrato.compet_inicial} â†’ ${extrato.compet_final}.`,\n      antes: { compet_inicial: antesIni, compet_final: antesFim },\n      depois: { compet_inicial: extrato.compet_inicial, compet_final: extrato.compet_final }\n    });\n  } else {\n    if (compPrimeira && extrato.compet_inicial && compararCompetencias(extrato.compet_inicial, compPrimeira) !== 0) {\n      const antes = extrato.compet_inicial;\n      extrato.compet_inicial = compPrimeira;\n\n      if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n      tags.push(criarTag('TAG_COMP_INICIAL_CORRIGIDA', SEVERIDADE.MEDIO, `CompetÃªncia inicial corrigida de ${antes} para ${compPrimeira}`, { antes, depois: compPrimeira }));\n      alertas.push({\n        tipo: 'COMP_INICIAL_CORRIGIDA',\n        mensagem: `CompetÃªncia inicial divergente. Corrigida de ${antes} para ${compPrimeira} com base nos crÃ©ditos.`,\n        antes,\n        depois: compPrimeira\n      });\n    }\n\n    if (compUltima && extrato.compet_final && compararCompetencias(extrato.compet_final, compUltima) !== 0) {\n      const antes = extrato.compet_final;\n      extrato.compet_final = compUltima;\n\n      if (!tags_correcao.includes('TAG_COMP_RECALCULADA')) tags_correcao.push('TAG_COMP_RECALCULADA');\n      tags.push(criarTag('TAG_COMP_FINAL_CORRIGIDA', SEVERIDADE.MEDIO, `CompetÃªncia final corrigida de ${antes} para ${compUltima}`, { antes, depois: compUltima }));\n      alertas.push({\n        tipo: 'COMP_FINAL_CORRIGIDA',\n        mensagem: `CompetÃªncia final divergente. Corrigida de ${antes} para ${compUltima} com base nos crÃ©ditos.`,\n        antes,\n        depois: compUltima\n      });\n    }\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.5 VALIDAÃ‡Ã•ES DE CPF DEAL vs PDF\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const cpfBitrix = limparDocumento(deal[CD.cpf]);\n  if (cliente.cpf && cpfBitrix && cliente.cpf !== cpfBitrix) {\n    tags.push(criarTag('TAG_CPF_DIVERGENTE', SEVERIDADE.CRIT, `CPF PDF (${cliente.cpf}) â‰  Deal (${cpfBitrix})`, { campo: 'cpf', cpf_pdf: cliente.cpf, cpf_deal: cpfBitrix }));\n    erros.push({ \n      tipo: 'CPF_DIVERGENTE', \n      mensagem: `CPF PDF (${cliente.cpf}) â‰  Bitrix (${cpfBitrix})`,\n      severidade: 'CRITICO',\n      pode_reprocessar: false\n    });\n  }\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.6 ANÃLISE DE COBERTURA\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const dias_cobertos = creditosValidos.reduce((sum, c) => sum + c.dias, 0);\n  const dias_restantes = Math.max(0, beneficio.dias_beneficio - dias_cobertos);\n  const percentual_coberto = tr((dias_cobertos / beneficio.dias_beneficio) * 100);\n  \n  const primeiro_dia_coberto = creditosValidos.length > 0 ? creditosValidos[0].periodo_inicio : null;\n  const ultimo_dia_coberto = creditosValidos.length > 0 ? creditosValidos[creditosValidos.length - 1].periodo_fim : null;\n  \n  const cobertura_por_dias = dias_restantes <= CONFIG.LIMITE_DIAS_NOVA_PARCELA;\n  \n  const compFinalExtrato = extrato.compet_final || creditosValidos[creditosValidos.length - 1]?.competencia;\n  const mesDCB = extrairMesAno(beneficio.dcb);\n  const cobertura_por_competencia = compFinalExtrato && mesDCB ? compararCompetencias(compFinalExtrato, mesDCB) >= 0 : null;\n  \n  const cobertura_por_periodo = ultimo_dia_coberto && beneficio.dcb ? ultimo_dia_coberto >= beneficio.dcb : null;\n  \n  const metodos = [cobertura_por_dias, cobertura_por_competencia, cobertura_por_periodo].filter(m => m !== null);\n  const cobertura_completa = metodos.filter(m => m === true).length >= Math.ceil(metodos.length / 2);\n  const confianca = metodos.every(m => m === metodos[0]) ? 'ALTA' : 'MEDIA';\n  \n  // v7.1: TAGs de cobertura\n  if (cobertura_completa && confianca === 'ALTA') {\n    tags.push(criarTag('TAG_COBERTURA_COMPLETA_ALTA', SEVERIDADE.INFO, 'Cobertura completa - confianÃ§a ALTA', { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  } else if (cobertura_completa) {\n    tags.push(criarTag('TAG_COBERTURA_COMPLETA_MEDIA', SEVERIDADE.INFO, 'Cobertura completa - confianÃ§a MÃ‰DIA', { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  } else {\n    tags.push(criarTag('TAG_COBERTURA_INCOMPLETA', SEVERIDADE.INFO, `Cobertura ${percentual_coberto}% - ${dias_restantes} dias restantes`, { percentual: percentual_coberto, dias_cobertos, dias_restantes }));\n  }\n  \n  // v7.1: TAG de dias totais\n  if (dias_cobertos > CONFIG.DIAS_SALARIO_MATERNIDADE) {\n    tags.push(criarTag('TAG_DIAS_EXCEDEM_120', SEVERIDADE.MEDIO, `Total de dias (${dias_cobertos}) excede 120`, { dias_cobertos }));\n  }\n  \n  const cobertura = {\n    dib: beneficio.dib,\n    dcb: beneficio.dcb,\n    dias_beneficio: beneficio.dias_beneficio,\n    primeiro_dia_coberto,\n    ultimo_dia_coberto,\n    dias_cobertos,\n    dias_restantes,\n    percentual: percentual_coberto,\n    validacoes: {\n      por_dias: { dias_restantes, limite: CONFIG.LIMITE_DIAS_NOVA_PARCELA, completa: cobertura_por_dias },\n      por_competencia: { extrato: compFinalExtrato, dcb: mesDCB, completa: cobertura_por_competencia },\n      por_periodo: { ultimo: ultimo_dia_coberto, dcb: beneficio.dcb, completa: cobertura_por_periodo }\n    },\n    cobertura_completa,\n    confianca,\n    vai_ter_mais_parcelas: !cobertura_completa\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.7 ANÃLISE DE PAGAMENTO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const pagamento = {\n    parcelas_total: creditosValidos.length,\n    parcelas_pagas: creditosPagos.length,\n    parcelas_pendentes: creditosPendentes.length,\n    valor_total: tr(creditosValidos.reduce((s, c) => s + c.valores.liquido, 0)),\n    valor_pago: tr(creditosPagos.reduce((s, c) => s + c.valores.liquido, 0)),\n    valor_pendente: tr(creditosPendentes.reduce((s, c) => s + c.valores.liquido, 0)),\n    dias_pagos: creditosPagos.reduce((s, c) => s + c.dias, 0),\n    dias_pendentes: creditosPendentes.reduce((s, c) => s + c.dias, 0),\n    pagamento_completo: creditosPendentes.length === 0 && cobertura_completa,\n    primeira_data_pagamento: creditosPagos[0]?.pagamento?.data || null\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.8 COMPETÃŠNCIAS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const competencias = {\n    primeira: creditosValidos[0]?.competencia || null,\n    ultima: creditosValidos[creditosValidos.length - 1]?.competencia || null,\n    lista: [...new Set(creditosValidos.map(c => c.competencia))].sort((a, b) => compararCompetencias(a, b))\n  };\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.9 CAMPOS PARA ATUALIZAR NO DEAL - v7.1 SEMPRE MONTA (filosofia nunca bloquear)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  // v7.1: Calcula se tem erro crÃ­tico MAS ainda assim monta os campos\n  const temErroCritico = erros.some(e => e.severidade === 'CRITICO');\n  const campos_deal = {};\n  \n  // v7.1: SEMPRE monta campos_deal (mesmo com erro crÃ­tico, para auditoria)\n  // â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\n  if (cliente.cpf) campos_deal[CD.cpf] = cliente.cpf;\n  if (cliente.nit) campos_deal[CD.nit] = cliente.nit;\n  if (beneficio.nb) campos_deal[CD.nb] = beneficio.nb;\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  if (beneficio.dib) campos_deal[CD.dib] = formatDateBitrix(beneficio.dib);\n  if (beneficio.dcb) campos_deal[CD.dcb] = formatDateBitrix(beneficio.dcb);\n  if (beneficio.dip) campos_deal[CD.dip] = formatDateBitrix(beneficio.dip);\n  \n  // â•â•â• VALORES â•â•â•\n  if (beneficio.mr) campos_deal[CD.mr_cliente] = formatMoneyBitrix(beneficio.mr);\n  if (pagamento.valor_total) campos_deal[CD.valor_total_beneficio] = pagamento.valor_total;\n  \n  // â•â•â• PARCELAS â•â•â•\n  campos_deal[CD.qtd_parcelas] = String(creditosValidos.length);\n  \n  // â•â•â• BANCO â•â•â•\n  if (beneficio.banco_enum) {\n    campos_deal[CD.banco] = beneficio.banco_enum;\n  }\n  if (beneficio.banco) {\n    campos_deal[CD.endereco_banco] = beneficio.banco;\n  }\n  \n  info.push(`INFO_CAMPOS_DEAL_${Object.keys(campos_deal).length}`);\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.10 CAMPOS BASE PARA INVOICE - v7.1 SEMPRE MONTA\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const campos_invoice_base = {};\n  \n  // v7.1: SEMPRE monta campos_invoice_base\n  // â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\n  if (cliente.cpf) campos_invoice_base[CI.cpf] = cliente.cpf;\n  if (cliente.nit) campos_invoice_base[CI.nit] = cliente.nit;\n  if (beneficio.nb) campos_invoice_base[CI.nb] = beneficio.nb;\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  if (beneficio.dib) campos_invoice_base[CI.dib] = formatDateBitrix(beneficio.dib);\n  if (beneficio.dcb) campos_invoice_base[CI.dcb] = formatDateBitrix(beneficio.dcb);\n  if (beneficio.dip) campos_invoice_base[CI.dip] = formatDateBitrix(beneficio.dip);\n  \n  // â•â•â• VALORES â•â•â•\n  if (beneficio.mr) campos_invoice_base[CI.mr_cliente] = formatMoneyBitrix(beneficio.mr);\n  if (beneficio.valor_diario) campos_invoice_base[CI.valor_diario] = beneficio.valor_diario;\n  \n  // â•â•â• COMPETÃŠNCIA â•â•â•\n  if (competencias.ultima) campos_invoice_base[CI.competencia_final] = competencias.ultima;\n  if (competencias.ultima) campos_invoice_base[CI.ultima_comp_valida] = competencias.ultima;\n  \n  // â•â•â• DIAS â•â•â•\n  campos_invoice_base[CI.dias_ja_recebidos] = cobertura.dias_cobertos;\n  campos_invoice_base[CI.dias_restantes] = cobertura.dias_restantes;\n  \n  // â•â•â• PARCELAS â•â•â•\n  campos_invoice_base[CI.qtd_parcelas] = String(creditosValidos.length);\n  \n  // â•â•â• BANCO â•â•â•\n  if (beneficio.banco_enum) {\n    campos_invoice_base[CI.banco] = beneficio.banco_enum;\n  }\n  if (beneficio.banco) {\n    campos_invoice_base[CI.endereco_banco] = beneficio.banco;\n  }\n  \n  // â•â•â• ESPÃ‰CIE â•â•â•\n  if (beneficio.especie) {\n    campos_invoice_base[CI.especie_beneficio] = beneficio.especie;\n  }\n  \n  info.push(`INFO_CAMPOS_INVOICE_${Object.keys(campos_invoice_base).length}`);\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.11 v7.1: CALCULAR RESUMO DE TAGS\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  const resumo_tags = calcularResumoTags(tags);\n  const tem_problemas_criticos = resumo_tags.crit > 0;\n  const tem_problemas_altos = resumo_tags.alto > 0;\n  \n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4A.12 RETORNO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  \n  return {\n    tipo_documento: TIPO_DOC.EXTRATO_CREDITOS,\n    // v7.1: ok = false sÃ³ se tiver erro crÃ­tico, mas SEMPRE passa adiante\n    ok: !temErroCritico,\n    erro: temErroCritico ? erros[0] : null,\n    \n    cliente,\n    beneficio,\n    extrato,\n    \n    creditos: creditosValidos,\n    creditos_pagos: creditosPagos,\n    creditos_pendentes: creditosPendentes,\n    creditos_invalidos: creditosInvalidos,\n    \n    cobertura,\n    pagamento,\n    competencias,\n    \n    // v7.0: Dois mapeamentos separados (SEMPRE preenchidos na v7.1)\n    campos_deal,\n    campos_invoice_base,\n    \n    hash: gerarHash(`${cliente.cpf}-${beneficio.nb}-${extrato.data_atualizacao}-${creditos.length}`),\n\n    // v7.1: Sistema de TAGs\n    tags,\n    resumo_tags,\n    tem_problemas_criticos,\n    tem_problemas_altos,\n\n    // Mantido da v7.0 para compatibilidade\n    tags_correcao,\n    alertas,\n    erros,\n    info\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4B. PROCESSAR PGMEI / DAS (CONTRIBUIÃ‡Ã•ES MEI) - v7.1 COM TAGS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nfunction processarPGMEI(dados) {\n  const tags = [];\n  const alertas = [];\n  const erros = [];\n  \n  const cliente = {\n    nome: dados.nome || dados.Nome || '',\n    cpf: limparDocumento(dados.cpf || dados.CPF),\n    cnpj: limparDocumento(dados.cnpj || dados.CNPJ)\n  };\n  \n  // v7.1: TAGs de identificaÃ§Ã£o PGMEI\n  if (!cliente.cnpj) {\n    tags.push(criarTag('TAG_CNPJ_AUSENTE', SEVERIDADE.CRIT, 'CNPJ nÃ£o encontrado', { campo: 'cnpj' }));\n    erros.push({ tipo: 'CNPJ_AUSENTE', mensagem: 'CNPJ nÃ£o encontrado', severidade: 'CRITICO' });\n  } else {\n    tags.push(criarTag('TAG_CNPJ_OK', SEVERIDADE.INFO, `CNPJ validado: ${cliente.cnpj}`, { campo: 'cnpj', valor: cliente.cnpj }));\n  }\n  \n  const anoCalendario = dados.ano_calendario || dados.ano || new Date().getFullYear();\n  \n  const contribuicoesRaw = dados.contribuicoes || dados.Contribuicoes || dados.periodos_apuracao || [];\n  \n  const contribuicoes = contribuicoesRaw.map((contrib, index) => {\n    const statusOriginal = contrib.situacao || contrib.Situacao || '';\n    const status = normalizarStatusMEI(statusOriginal);\n    \n    return {\n      id: index + 1,\n      competencia: normalizarCompetencia(contrib.competencia || contrib.periodo),\n      apurado_beneficio: contrib.apurado_beneficio === true || contrib.apurado_beneficio === 'Sim' || contrib.ApuradoBeneficioINSS === 'Sim',\n      situacao: { status, status_original: statusOriginal },\n      valores: {\n        principal: parseValorBR(contrib.principal),\n        multa: parseValorBR(contrib.multa),\n        juros: parseValorBR(contrib.juros),\n        total: parseValorBR(contrib.total)\n      },\n      datas: {\n        vencimento: parseDateBR(contrib.vencimento),\n        acolhimento: parseDateBR(contrib.acolhimento)\n      },\n      flags: {\n        pago: status === 'PAGO',\n        em_atraso: status === 'DEVEDOR',\n        a_vencer: status === 'A_VENCER'\n      }\n    };\n  });\n  \n  contribuicoes.sort((a, b) => compararCompetencias(a.competencia, b.competencia));\n  \n  const pagas = contribuicoes.filter(c => c.flags.pago);\n  const devedoras = contribuicoes.filter(c => c.flags.em_atraso);\n  const aVencer = contribuicoes.filter(c => c.flags.a_vencer);\n  \n  const carenciaAtingida = pagas.length >= CONFIG.MESES_CARENCIA_MEI;\n  const mesesFaltantes = Math.max(0, CONFIG.MESES_CARENCIA_MEI - pagas.length);\n  \n  const debitoTotal = tr(devedoras.reduce((sum, c) => sum + c.valores.total, 0));\n  \n  // v7.1: TAGs de carÃªncia\n  if (!carenciaAtingida) {\n    tags.push(criarTag('TAG_CARENCIA_INSUFICIENTE', SEVERIDADE.ALTO, `CarÃªncia: ${pagas.length}/${CONFIG.MESES_CARENCIA_MEI} meses. Faltam ${mesesFaltantes}.`, { meses_pagos: pagas.length, meses_necessarios: CONFIG.MESES_CARENCIA_MEI, meses_faltantes: mesesFaltantes }));\n    alertas.push({ tipo: 'CARENCIA_INSUFICIENTE', mensagem: `CarÃªncia: ${pagas.length}/${CONFIG.MESES_CARENCIA_MEI} meses. Faltam ${mesesFaltantes}.` });\n  } else {\n    tags.push(criarTag('TAG_CARENCIA_OK', SEVERIDADE.INFO, `CarÃªncia atingida: ${pagas.length} meses`, { meses_pagos: pagas.length }));\n  }\n  \n  // v7.1: TAGs de dÃ©bitos\n  if (devedoras.length > 0) {\n    tags.push(criarTag('TAG_CONTRIBUICOES_ATRASADAS', SEVERIDADE.ALTO, `${devedoras.length} contribuiÃ§Ã£o(Ãµes) em atraso. DÃ©bito: R$ ${debitoTotal}`, { quantidade: devedoras.length, debito_total: debitoTotal }));\n    alertas.push({ tipo: 'CONTRIBUICOES_ATRASADAS', mensagem: `${devedoras.length} contribuiÃ§Ã£o(Ãµes) em atraso. DÃ©bito: R$ ${debitoTotal}` });\n  } else {\n    tags.push(criarTag('TAG_SEM_DEBITOS', SEVERIDADE.INFO, 'Sem contribuiÃ§Ãµes em atraso', {}));\n  }\n  \n  const analise = {\n    carencia: { meses_necessarios: CONFIG.MESES_CARENCIA_MEI, meses_pagos: pagas.length, meses_faltantes: mesesFaltantes, atingida: carenciaAtingida },\n    contribuicoes: { total: contribuicoes.length, pagas: pagas.length, devedoras: devedoras.length, a_vencer: aVencer.length },\n    debitos: { total: debitoTotal, quantidade: devedoras.length },\n    elegibilidade: { carencia_ok: carenciaAtingida, em_dia: devedoras.length === 0, pode_solicitar: carenciaAtingida }\n  };\n  \n  const temErroCritico = erros.some(e => e.severidade === 'CRITICO');\n  \n  // v7.1: Calcular resumo\n  const resumo_tags = calcularResumoTags(tags);\n  const tem_problemas_criticos = resumo_tags.crit > 0;\n  const tem_problemas_altos = resumo_tags.alto > 0;\n  \n  return {\n    tipo_documento: TIPO_DOC.PGMEI_DAS,\n    ok: !temErroCritico,\n    erro: temErroCritico ? erros[0] : null,\n    cliente,\n    ano_calendario: anoCalendario,\n    contribuicoes,\n    contribuicoes_pagas: pagas,\n    contribuicoes_devedoras: devedoras,\n    contribuicoes_a_vencer: aVencer,\n    analise,\n    hash: gerarHash(`${cliente.cnpj}-${anoCalendario}-${contribuicoes.length}`),\n    \n    // v7.1: Sistema de TAGs\n    tags,\n    resumo_tags,\n    tem_problemas_criticos,\n    tem_problemas_altos,\n    \n    alertas,\n    erros,\n    campos_deal: {},\n    campos_invoice_base: {}\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5. EXECUTAR PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nlet resultado;\n\nswitch (tipoDocumento) {\n  case TIPO_DOC.EXTRATO_CREDITOS:\n    resultado = processarExtratoCreditos(dadosGemini);\n    break;\n    \n  case TIPO_DOC.PGMEI_DAS:\n    resultado = processarPGMEI(dadosGemini);\n    break;\n    \n  default:\n    const tagsDesconhecido = [\n      criarTag('TAG_DOCUMENTO_NAO_RECONHECIDO', SEVERIDADE.CRIT, 'Tipo de documento nÃ£o reconhecido', {})\n    ];\n    resultado = {\n      tipo_documento: TIPO_DOC.DESCONHECIDO,\n      ok: false,\n      erro: {\n        tipo: 'DOCUMENTO_NAO_RECONHECIDO',\n        mensagem: 'Tipo de documento nÃ£o reconhecido. Esperado: Extrato de CrÃ©ditos INSS ou PGMEI/DAS.',\n        pode_reprocessar: false\n      },\n      tags: tagsDesconhecido,\n      resumo_tags: calcularResumoTags(tagsDesconhecido),\n      tem_problemas_criticos: true,\n      tem_problemas_altos: false,\n      alertas: [],\n      erros: [],\n      campos_deal: {},\n      campos_invoice_base: {}\n    };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 6. RETORNO FINAL\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst tempoExecucao = Date.now() - inicio;\n\nconsole.log(JSON.stringify({\n  no: '6A',\n  versao: '7.1',\n  tipo: tipoDocumento,\n  ok: resultado.ok,\n  tempo_ms: tempoExecucao,\n  campos_deal_count: Object.keys(resultado.campos_deal || {}).length,\n  campos_invoice_count: Object.keys(resultado.campos_invoice_base || {}).length,\n  tem_dip: !!resultado.beneficio?.dip,\n  // v7.1: Log de TAGs\n  tags_total: resultado.resumo_tags?.total || 0,\n  tags_criticas: resultado.resumo_tags?.crit || 0,\n  tags_altas: resultado.resumo_tags?.alto || 0\n}));\n\n// RETORNO NO FORMATO N8N\nreturn [{\n  json: {\n    // â•â•â• METADADOS â•â•â•\n    _no: '6A',\n    _versao: '7.1',\n    _timestamp: new Date().toISOString(),\n    _tempo_ms: tempoExecucao,\n    \n    // â•â•â• RESULTADO DO PROCESSAMENTO â•â•â•\n    ...resultado,\n    \n    // â•â•â• CONTEXTO PRESERVADO â•â•â•\n    deal_id,\n    deal,\n    faturas_existentes,\n    tentativa,\n    \n    // â•â•â• MAPEAMENTO DE CAMPOS (para debug e uso nos prÃ³ximos nÃ³s) â•â•â•\n    CAMPOS_DEAL_IDS: CD,\n    CAMPOS_INVOICE_IDS: CI,\n    CAMPOS_EXTRAS: CAMPOS_EXTRAS\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5728,
        25936
      ],
      "id": "15c7a47a-1001-458f-9589-fe6e5c51e3c6",
      "name": "6A. Calculo do Historico de credito (PDF)"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 6C - CÃLCULO START (v3.2 - VALOR REAL DO EXTRATO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VersÃ£o: 3.2 - HonorÃ¡rios calculados sobre valor REAL do extrato + projetadas\n// Data: 19/01/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// CORREÃ‡ÃƒO v3.2:\n// âœ… Parcelas do EXTRATO: base usa valor_liquido REAL do PDF (liquido do crÃ©dito)\n// âœ… Parcelas PROJETADAS: base usa valor projetado do 6B (valor_liquido)\n// âœ… honorariosStart = totalHonorariosBase Ã— 30%\n// âœ… MantÃ©m output/estrutura para nÃ£o quebrar nÃ³s posteriores\n//\n// REGRA DA DARF (mantida):\n// âœ… DARF Ã© um ADIANTAMENTO que a Start faz pelo cliente\n// âœ… Cliente precisa DEVOLVER esse valor para a Start\n// âœ… DARF Ã© SOMADA ao valor_start (aumenta o que Start recebe)\n// âœ… DARF Ã© SUBTRAÃDA do valor_cliente (diminui o que cliente fica)\n// âœ… DARF NÃƒO afeta a regra dos 50% (calculada ANTES)\n// âœ… DARF Ã© rateada apenas nas parcelas onde Start recebe (valor_start > 0)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡Ã•ES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst CONFIG = {\n  ALIQUOTA_HONORARIOS: 0.30,\n  FAIXAS: [\n    { min: 2000, aliquota: 0.45, nome: 'FAIXA_45' },\n    { min: 1500, aliquota: 0.40, nome: 'FAIXA_40' },\n    { min: 700,  aliquota: 0.35, nome: 'FAIXA_35' },\n    { min: 0,    aliquota: 0.30, nome: 'FAIXA_30' }\n  ],\n  MINIMO_CLIENTE: 0.50,\n  PARCELA_BAIXA_LIMITE: 100,\n  MUITAS_PARCELAS_LIMITE: 5,\n  MARGEM_APERTADA_LIMITE: 0.55\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DO DEAL (IDs Bitrix) - v3.2\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CD = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_5F7DD07B0ADB5',\n  rg:                       'UF_CRM_5F7DD07B11C33',\n  nit:                      'UF_CRM_1766282969',\n  nb:                       'UF_CRM_1737470444334',\n  nome_filho:               'UF_CRM_1699462600794',\n  categoria:                'UF_CRM_5F7DD07B0295D',\n\n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_1765928945',\n  dip:                      'UF_CRM_1766439387',\n  dcb:                      'UF_CRM_1748433331869',\n  dn_mamae:                 'UF_CRM_1602615428011',\n  dn_filho:                 'UF_CRM_5F7DD07B1997D',\n  dn_certidao:              'UF_CRM_1714741602233',\n  data_dnv:                 'UF_CRM_1742827283535',\n  data_requerimento:        'UF_CRM_6094054C7C1C8',\n  data_concessao:           'UF_CRM_1602256897805',\n\n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_1741726157749',\n  valor_total_beneficio:    'UF_CRM_1742841962002',\n  aliquota_mr:              'UF_CRM_1742841855608',\n\n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_1634158430224',\n  valor_cliente:            'UF_CRM_1634828809106',\n  valor_previsto:           'UF_CRM_1635261498013',\n  valor_recebido:           'UF_CRM_1633535814529',\n  parcela_numero:           'UF_CRM_1634158972573',\n  qtd_parcelas:             'UF_CRM_1625253358741',\n\n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_1603216440272',\n  endereco_banco:           'UF_CRM_1603216499370',\n  agencia_banco:            'UF_CRM_1762558313',\n\n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_1765636941',\n  data_rodagem:             'UF_CRM_1764270308863',\n  rodagem_comentario:       'UF_CRM_1764270260617',\n\n  // â•â•â• 10. GESTÃƒO â•â•â•\n  assessor:                 'UF_CRM_5F7DD07AEC035',\n  ultimo_relacionador:      'UF_CRM_1688072257656',\n  ddd_cliente:              'UF_CRM_659C48C5F0594',\n  data_reclamacao:          'UF_CRM_1704738513559',\n  data_qualificacao:        'UF_CRM_65E74D984ED3C',\n  data_recuperacao:         'UF_CRM_1713804709729',\n  data_encerramento:        'UF_CRM_663007E42D75E',\n  data_reentrada:           'UF_CRM_1615653096667',\n\n  // â•â•â• DARF / GUIA â•â•â•\n  necessita_darf:           'UF_CRM_1650375670632',\n  valor_darf:               'UF_CRM_69416D0451D4A'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE CAMPOS DA INVOICE (IDs Bitrix) - v3.2\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CI = {\n  // â•â•â• 1. IDENTIFICAÃ‡ÃƒO â•â•â•\n  cpf:                      'UF_CRM_652439CFE551C',\n  rg:                       'UF_CRM_652439D00A9CF',\n  nit:                      'UF_CRM_6947602572F0A',\n  nb:                       'UF_CRM_6790DAD756E3C',\n  nome_filho:               'UF_CRM_65BD5488EC8E9',\n  categoria:                'UF_CRM_652439D03479D',\n\n  // â•â•â• 2. BENEFÃCIO (Datas) â•â•â•\n  dib:                      'UF_CRM_69442F085B2CD',\n  dip:                      'UF_CRM_683860072DEB8',\n  dcb:                      'UF_CRM_6838600845561',\n  dn_mamae:                 'UF_CRM_652439D0138A5',\n  dn_filho:                 'UF_CRM_652439D021438',\n  dn_certidao:              'UF_CRM_66351141F40C7',\n  data_dnv:                 'UF_CRM_67E17F1C70EAF',\n  data_requerimento:        'UF_CRM_652439D3530AB',\n  data_concessao:           'UF_CRM_652439D157BA8',\n\n  // â•â•â• 3. BENEFÃCIO (Valores) â•â•â•\n  mr_cliente:               'UF_CRM_67D19072D84A8',\n  valor_diario:             'UF_CRM_69442F466791E',\n  valor_liquido_mensal:     'UF_CRM_69442F4D0909D',\n  valor_total_beneficio:    'UF_CRM_69442F535C91B',\n  valor_restante_inss:      'UF_CRM_69442F3A581C2',\n  aliquota_mr:              'UF_CRM_67E1B184633ED',\n  especie_beneficio:        'UF_CRM_69442F6570BDB',\n\n  // â•â•â• 4. HONORÃRIOS START â•â•â•\n  valor_total_start:        'UF_CRM_69442F217FB9D',\n  saldo_restante_start:     'UF_CRM_69442F27CCFB3',\n  aliquota_start:           'UF_CRM_69442F596A782',\n  regra_aplicada:           'UF_CRM_69442F5F762AD',\n\n  // â•â•â• 5. FATURAMENTO (Parcela) â•â•â•\n  valor_inss:               'UF_CRM_652439D8D6B8E',\n  valor_cliente:            'UF_CRM_652439D915311',\n  valor_previsto:           'UF_CRM_652439D9202B3',\n  parcela_numero:           'UF_CRM_652439D8E9608',\n  parcela_formato:          'UF_CRM_652439D8CDB53',\n  qtd_parcelas:             'UF_CRM_67E1AD2860054',\n\n  // â•â•â• 6. EXTRATO / COMPETÃŠNCIA â•â•â•\n  competencia:              'UF_CRM_691B6450B46E3',\n  competencia_final:        'UF_CRM_69442F0E9A95A',\n  periodo:                  'UF_CRM_691B64560A17F',\n  ultima_comp_valida:       'UF_CRM_693D7DE5148DB',\n  credito_invalidado:       'UF_CRM_691B6467F11F2',\n  dias_ja_recebidos:        'UF_CRM_69442F2E321C4',\n  dias_restantes:           'UF_CRM_69442F3449D22',\n\n  // â•â•â• 7. DATAS OPERACIONAIS â•â•â•\n  data_inss:                'UF_CRM_652439D8B3207',\n  data_pagamento_extrato:   'UF_CRM_691B64616C2C9',\n  data_atualizacao_extrato: 'UF_CRM_691B646EC01BF',\n\n  // â•â•â• 8. BANCO â•â•â•\n  banco:                    'UF_CRM_652439D194A06',\n  endereco_banco:           'UF_CRM_652439D1A53FA',\n  agencia_banco:            'UF_CRM_691225FDDDBE4',\n\n  // â•â•â• 9. CONTROLE / ANÃLISE â•â•â•\n  justificativa_direito:    'UF_CRM_693D7BBC3E5D3',\n  resultado_analise:        'UF_CRM_693D7CB58EBD2',\n  data_rodagem:             'UF_CRM_6929FDA3C8A79',\n  rodagem_comentario:       'UF_CRM_6929FD9E9A95D',\n  direito_ate:              'UF_CRM_679781AAB3B1D',\n\n  // â•â•â• 10. GESTÃƒO â•â•â•\n  ultimo_relacionador:      'UF_CRM_65BD5488EC8E9',\n  ddd_cliente:              'UF_CRM_65BD5489DF3A2',\n  data_reclamacao:          'UF_CRM_65BD5489C89AD',\n  data_qualificacao:        'UF_CRM_65E777E2A0CED',\n  data_recuperacao:         'UF_CRM_662699414BCF0',\n  data_encerramento:        'UF_CRM_6631460FD3BB4',\n  data_reentrada:           'UF_CRM_678EADB02E460',\n\n  // â•â•â• DARF / GUIA â•â•â•\n  necessita_darf:           'UF_CRM_652439D99106D',\n  valor_darf:               'UF_CRM_695C0F05B6DD0'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CAMPOS EXTRAS - Mapeados para uso futuro\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CAMPOS_EXTRAS = {\n  // Deal\n  data_encerramento_sem_direito_deal: 'UF_CRM_663007E518A1E',\n  data_conversao_deal:                'UF_CRM_5F7DD07B204FD',\n  data_certidao_deal:                 'UF_CRM_1674755625727',\n  data_consulta_deal:                 'UF_CRM_1602256877083',\n  data_contato_deal:                  'UF_CRM_1650915373840',\n  data_prox_contato_deal:             'UF_CRM_1650915411107',\n  data_sem_direito_deal:              'UF_CRM_1649701660322',\n  data_indeferimento_deal:            'UF_CRM_1620315580',\n  data_quebra_contrato_deal:          'UF_CRM_1737722079155',\n  relacionador_quebra_deal:           'UF_CRM_1737722166447',\n  relacionador_sem_direito_deal:      'UF_CRM_1737722233583',\n  recurso_deal:                       'UF_CRM_1759219838803',\n  senha_deal:                         'UF_CRM_1602257200479',\n  sugestao_senha_deal:                'UF_CRM_5FDA4FCE92DAA',\n  telefone_2_deal:                    'UF_CRM_606C6C98B68A7',\n  telefone_3_deal:                    'UF_CRM_606C6C9A00D10',\n  sine_deal:                          'UF_CRM_1751375841241',\n  data_envio_recurso_deal:            'UF_CRM_1759220050331',\n\n  // Invoice\n  resultado_criacao_faturas_inv:      'UF_CRM_SMART_INVOICE_1767045330',\n  data_conversao_inv:                 'UF_CRM_652439D0CF19F',\n  data_calculo_inv:                   'UF_CRM_69442F14E544C',\n  data_certidao_inv:                  'UF_CRM_652439DA75EFF',\n  data_consulta_inv:                  'UF_CRM_652439D14CF3D',\n  data_acordo_inv:                    'UF_CRM_652439DB85203',\n  data_contato_inv:                   'UF_CRM_652439D9B26DF',\n  data_sem_direito_inv:               'UF_CRM_66ACE094C0195',\n  data_pagamento_inv:                 'UF_CRM_652439D8BD582',\n  data_indeferimento_inv:             'UF_CRM_652439D3E866C',\n  data_recebimento_inv:               'UF_CRM_652439D1B26E2',\n  desconto_inv:                       'UF_CRM_6838600A5C767',\n  data_quebra_contrato_inv:           'UF_CRM_6793A405B3FC1',\n  relacionador_quebra_inv:            'UF_CRM_6793A4065BECA',\n  relacionador_sem_direito_inv:       'UF_CRM_6793A40701BCB',\n  recurso_inv:                        'UF_CRM_68DD552A351D0',\n  senha_inv:                          'UF_CRM_652439D16254A',\n  sugestao_senha_inv:                 'UF_CRM_652439D23E905',\n  telefone_2_inv:                     'UF_CRM_652439D28D353',\n  telefone_3_inv:                     'UF_CRM_652439D298A88',\n  sine_inv:                           'UF_CRM_6883D4B47136F',\n  data_envio_recurso_inv:             'UF_CRM_68DD552F3DD02'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SISTEMA DE ERROS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ERROS = {\n  E_INPUT_NULO: { codigo: 'E01', mensagem: 'Input do 6B veio nulo/undefined', severidade: 'CRITICO', acao: 'Verificar conexÃ£o entre nÃ³s 6B â†’ 6C' },\n  E_INPUT_OK_FALSE: { codigo: 'E02', mensagem: '6B retornou ok=false', severidade: 'CRITICO', acao: 'Verificar erro reportado pelo 6B' },\n  E_SEM_RESUMO: { codigo: 'E03', mensagem: 'Campo resumo ausente no input', severidade: 'CRITICO', acao: 'Verificar estrutura de retorno do 6B' },\n  E_SEM_DADOS: { codigo: 'E04', mensagem: 'Campo dados ausente no input', severidade: 'CRITICO', acao: 'Verificar estrutura de retorno do 6B' },\n  E_SEM_DEAL: { codigo: 'E05', mensagem: 'Deal nÃ£o veio do 6B', severidade: 'CRITICO', acao: 'Verificar se 6A/6B estÃ£o passando deal adiante' },\n\n  E_SEM_CREDITOS: { codigo: 'E06', mensagem: 'Nenhum crÃ©dito no extrato', severidade: 'ALERTA', acao: 'Verificar se extrato foi processado corretamente' },\n  E_SEM_PARCELAS: { codigo: 'E07', mensagem: 'Nenhuma parcela (extrato + projetadas)', severidade: 'CRITICO', acao: 'Verificar se hÃ¡ crÃ©ditos ou projeÃ§Ãµes disponÃ­veis' },\n\n  E_TOTAL_120_ZERO: { codigo: 'E08', mensagem: 'Total 120 dias = 0', severidade: 'CRITICO', acao: 'Verificar cÃ¡lculo de valor diÃ¡rio no 6B' },\n  E_TOTAL_120_NEGATIVO: { codigo: 'E09', mensagem: 'Total 120 dias < 0 (valor negativo)', severidade: 'CRITICO', acao: 'Verificar se MR e desconto INSS estÃ£o corretos' },\n  E_MR_ZERO: { codigo: 'E10', mensagem: 'MR (MÃ©dia RemuneraÃ§Ã£o) veio zerado', severidade: 'CRITICO', acao: 'Verificar extraÃ§Ã£o de MR do PDF pelo Gemini' },\n  E_ALIQUOTA_INSS_ZERO: { codigo: 'E11', mensagem: 'AlÃ­quota INSS nÃ£o veio do 6B', severidade: 'ALERTA', acao: 'Usando fallback 7.5% - verificar cÃ¡lculo no 6B' },\n  E_HONORARIOS_ZERO: { codigo: 'E12', mensagem: 'HonorÃ¡rios calculados = 0', severidade: 'CRITICO', acao: 'Verificar se base de honorÃ¡rios estÃ¡ correta (extrato + projeÃ§Ãµes)' },\n\n  E_PARCELA_SEM_DATA: { codigo: 'E13', mensagem: 'Parcela sem data de pagamento', severidade: 'CRITICO', acao: 'Verificar calendÃ¡rio INSS no 6B' },\n  E_PARCELA_SEM_VALOR: { codigo: 'E14', mensagem: 'Parcela com valor 0 ou nulo', severidade: 'CRITICO', acao: 'Verificar extraÃ§Ã£o de valores do extrato' },\n\n  E_CALCULO_EXCEPTION: { codigo: 'E15', mensagem: 'Exception durante cÃ¡lculo', severidade: 'CRITICO', acao: 'Verificar stack trace nos detalhes' },\n  E_REGRA_50_IMPOSSIVEL: { codigo: 'E16', mensagem: 'ImpossÃ­vel aplicar regra 50% em todas parcelas', severidade: 'ALERTA', acao: 'Verificar se hÃ¡ parcelas muito pequenas' }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// SISTEMA DE ALERTAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst ALERTAS = {\n  'ALERTA_ALIQUOTA_INSS_NAO_VEIO_6B': { emoji: 'âš ï¸', texto: 'AlÃ­quota INSS nÃ£o veio do 6B, usando 7.5%' },\n  'ALERTA_EXTRATO_SEM_CREDITOS': { emoji: 'ğŸ“‹', texto: 'Extrato sem crÃ©ditos, usando apenas projeÃ§Ãµes' },\n  'ALERTA_REPROCESSAMENTO': { emoji: 'ğŸ”„', texto: 'Reprocessamento detectado (saldo Start jÃ¡ existe)' },\n  'ALERTA_PARCELA_BAIXA': { emoji: 'ğŸ’°', texto: 'Parcela com valor baixo' },\n  'ALERTA_MARGEM_50_APERTADA': { emoji: 'âš–ï¸', texto: 'Margem 50% apertada' },\n  'ALERTA_DATA_RETROATIVA': { emoji: 'ğŸ“…', texto: 'Data de pagamento retroativa' },\n  'ALERTA_REGRA_50_VIOLADA': { emoji: 'âŒ', texto: 'Regra 50% violada em parcela' },\n  'ALERTA_REGRA_50_NAO_RESPEITADA_GERAL': { emoji: 'âš ï¸', texto: 'Regra 50% nÃ£o respeitada em alguma parcela' },\n  'ALERTA_MUITAS_PARCELAS': { emoji: 'ğŸ“Š', texto: 'Muitas parcelas no benefÃ­cio' },\n  'ALERTA_QUITACAO_TARDIA': { emoji: 'ğŸ', texto: 'QuitaÃ§Ã£o apenas na Ãºltima parcela' },\n  'ALERTA_SALDO_RESIDUAL': { emoji: 'ğŸ’¸', texto: 'Saldo residual pequeno (< R$ 1)' },\n  'ALERTA_DEAL_SEM_CAMPOS_START': { emoji: 'ğŸ“', texto: 'Deal sem campos Start preenchidos' },\n  'ALERTA_DIP_NAO_VEIO_6B': { emoji: 'ğŸ“†', texto: 'DIP nÃ£o veio do 6B' },\n\n  // DARF\n  'ALERTA_DARF_START_PAGA': { emoji: 'ğŸ§¾', texto: 'DARF adicionada aos honorÃ¡rios Start (cliente reembolsa)' },\n  'ALERTA_DARF_START_PAGA_SEM_VALOR': { emoji: 'âš ï¸', texto: 'Start irÃ¡ pagar a DARF marcado, mas Valor da DARF estÃ¡ vazio/zerado' },\n  'ALERTA_DARF_SEM_PARCELAS_START': { emoji: 'âš ï¸', texto: 'DARF marcada para Start pagar, mas nÃ£o hÃ¡ parcelas com recebimento Start' }\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES AUXILIARES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\nconst formatarMoeda = (v) => `R$ ${tr(v).toFixed(2).replace('.', ',')}`;\nconst formatarPercentual = (v) => `${(v * 100).toFixed(2)}%`;\n\nconst parseValor = (v) => {\n  if (v === null || v === undefined || v === '') return 0;\n  if (typeof v === 'number') return v;\n  if (typeof v === 'string') {\n    let limpo = v.replace('|BRL', '').replace(/[R$\\s]/g, '').trim();\n    const temVirgula = limpo.includes(',');\n    const temPonto = limpo.includes('.');\n    if (temVirgula && temPonto) {\n      limpo = limpo.replace(/\\./g, '').replace(',', '.');\n    } else if (temVirgula) {\n      limpo = limpo.replace(',', '.');\n    }\n    const n = parseFloat(limpo);\n    return isNaN(n) ? 0 : n;\n  }\n  return 0;\n};\n\nconst formatarDataBR = (data) => {\n  if (!data) return '-';\n  if (typeof data === 'string' && data.includes('/')) return data;\n  const d = new Date(data);\n  if (isNaN(d.getTime())) return '-';\n  return d.toLocaleDateString('pt-BR');\n};\n\nconst extrairData = (data) => {\n  if (!data) return null;\n  if (typeof data === 'string') {\n    if (/^\\d{4}-\\d{2}-\\d{2}/.test(data)) return data.substring(0, 10);\n    if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(data)) {\n      const [d, m, y] = data.split('/');\n      return `${y}-${m}-${d}`;\n    }\n  }\n  const d = new Date(data);\n  if (isNaN(d.getTime())) return null;\n  return d.toISOString().substring(0, 10);\n};\n\nconst formatMoneyBitrix = (valor) => {\n  if (!valor && valor !== 0) return null;\n  return `${tr(valor)}|BRL`;\n};\n\nconst formatDateBitrix = (dataISO) => {\n  if (!dataISO) return null;\n  const data = extrairData(dataISO);\n  if (!data) return null;\n  return `${data}T03:00:00+00:00`;\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES DE RETORNO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst criarErro = (tag, detalhes = {}, contexto = {}, campos_deal = {}, campos_invoice_base = {}) => {\n  const erro = ERROS[tag] || { codigo: 'E99', mensagem: 'Erro desconhecido', severidade: 'CRITICO', acao: 'Contatar suporte' };\n  return [{\n    json: {\n      _no: '6C',\n      _versao: '3.2',\n      _timestamp: new Date().toISOString(),\n      _tempo_ms: Date.now() - inicio,\n\n      ok: false,\n      erro: {\n        tag,\n        codigo: erro.codigo,\n        mensagem: erro.mensagem,\n        severidade: erro.severidade,\n        acao_sugerida: erro.acao,\n        detalhes\n      },\n\n      alertas: [],\n      tags_sucesso: [],\n      info: [],\n\n      resumo: {\n        nome: contexto.nome || 'Desconhecido',\n        cpf: contexto.cpf || '',\n        nb: contexto.nb || '',\n        deal_id: contexto.deal_id || null\n      },\n\n      dados: {\n        deal_id: contexto.deal_id,\n        deal: contexto.deal\n      },\n\n      CAMPOS_DEAL_IDS: CD,\n      CAMPOS_INVOICE_IDS: CI,\n      CAMPOS_EXTRAS: CAMPOS_EXTRAS,\n\n      campos_deal,\n      campos_invoice_base\n    }\n  }];\n};\n\nconst criarSucesso = (resumo, dados, tags_sucesso, alertas, info, campos_deal = {}, campos_invoice_base = {}) => {\n  return [{\n    json: {\n      _no: '6C',\n      _versao: '3.2',\n      _timestamp: new Date().toISOString(),\n      _tempo_ms: Date.now() - inicio,\n\n      ok: true,\n      erro: null,\n\n      tags_sucesso,\n      alertas,\n      info,\n\n      resumo,\n      dados,\n\n      CAMPOS_DEAL_IDS: CD,\n      CAMPOS_INVOICE_IDS: CI,\n      CAMPOS_EXTRAS: CAMPOS_EXTRAS,\n\n      campos_deal,\n      campos_invoice_base\n    }\n  }];\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES DE CÃLCULO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst obterFaixa = (valorParcela) => {\n  for (const faixa of CONFIG.FAIXAS) {\n    if (valorParcela >= faixa.min) return faixa;\n  }\n  return CONFIG.FAIXAS[CONFIG.FAIXAS.length - 1];\n};\n\nconst podeQuitar = (valorParcela, saldoStart) => {\n  const clienteFicaCom = valorParcela - saldoStart;\n  const minimoCliente = valorParcela * CONFIG.MINIMO_CLIENTE;\n  return clienteFicaCom >= minimoCliente;\n};\n\nconst calcularPorFaixa = (valorParcela, saldoStart) => {\n  const faixa = obterFaixa(valorParcela);\n  // v3.3: Arredondar para baixo (sem centavos)\n  let valorStart = Math.floor(valorParcela * faixa.aliquota);\n\n  if (valorStart > saldoStart) valorStart = saldoStart;\n\n  const clienteFicaCom = valorParcela - valorStart;\n  const minimoCliente = tr(valorParcela * CONFIG.MINIMO_CLIENTE);\n\n  if (clienteFicaCom < minimoCliente) {\n    // v3.3: Arredondar para baixo\n    valorStart = Math.floor(valorParcela - minimoCliente);\n  }\n\n  // v3.3: Garantir inteiro no retorno\n  return { valorStart: Math.floor(valorStart), faixa: faixa.nome, aliquota: faixa.aliquota };\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESSAMENTO PRINCIPAL\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst tags_sucesso = [];\nconst alertas = [];\nconst info = [];\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 1. VALIDAR INPUT\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst input = $json;\n\nconst campos_deal_6B = input?.campos_deal || {};\nconst campos_invoice_6B = input?.campos_invoice_base || {};\n\nconst contexto = {\n  nome: input?.resumo?.nome || input?.dados?.cliente?.nome,\n  cpf: input?.resumo?.cpf || input?.dados?.cliente?.cpf,\n  nb: input?.resumo?.nb || input?.dados?.beneficio?.nb,\n  deal_id: input?.resumo?.deal_id || input?.dados?.deal_id,\n  deal: input?.dados?.deal\n};\n\nif (!input) {\n  return criarErro('E_INPUT_NULO', { input_type: typeof input }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (input.ok === false) {\n  return criarErro('E_INPUT_OK_FALSE', {\n    erro_anterior: input.erro,\n    tag_anterior: input.erro?.tag,\n    codigo_anterior: input.erro?.codigo\n  }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (!input.resumo) {\n  return criarErro('E_SEM_RESUMO', { campos_presentes: Object.keys(input) }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (!input.dados) {\n  return criarErro('E_SEM_DADOS', { campos_presentes: Object.keys(input) }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (!input.dados.deal) {\n  return criarErro('E_SEM_DEAL', { dados_campos: Object.keys(input.dados) }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\ntags_sucesso.push('OK_INPUT_VALIDADO');\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 2. EXTRAIR DADOS DO 6B\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst resumo6B = input.resumo;\nconst dados6B = input.dados;\n\nconst { nome, cpf, nb, deal_id, mr, aliquota_efetiva, total_120_dias, tem_13o, valor_13o } = resumo6B;\n\nif (!total_120_dias || total_120_dias === 0) {\n  return criarErro('E_TOTAL_120_ZERO', { total_120_dias, mr, aliquota_efetiva }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (total_120_dias < 0) {\n  return criarErro('E_TOTAL_120_NEGATIVO', { total_120_dias, mr }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (!mr || mr === 0) {\n  return criarErro('E_MR_ZERO', { mr, resumo_keys: Object.keys(resumo6B) }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\nif (aliquota_efetiva === undefined || aliquota_efetiva === null) {\n  alertas.push('ALERTA_ALIQUOTA_INSS_NAO_VEIO_6B');\n  info.push('INFO_USANDO_ALIQUOTA_DEFAULT_7.5');\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3. COLETAR E AGRUPAR PARCELAS POR DATA\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst creditos = dados6B.creditos || [];\nconst parcelasProjetadas = dados6B.parcelas_projetadas || [];\n\nconst qtdExtrato = creditos.length;\nconst qtdProjetadas = parcelasProjetadas.length;\n\ninfo.push(`INFO_PARCELAS_EXTRATO_${qtdExtrato}`);\ninfo.push(`INFO_PARCELAS_PROJETADAS_${qtdProjetadas}`);\n\nif (qtdExtrato === 0) {\n  alertas.push('ALERTA_EXTRATO_SEM_CREDITOS');\n  info.push('INFO_USANDO_APENAS_PROJECOES');\n}\n\nif (qtdExtrato === 0 && qtdProjetadas === 0) {\n  return criarErro('E_SEM_PARCELAS', {\n    creditos_length: qtdExtrato,\n    projetadas_length: qtdProjetadas\n  }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TRY/CATCH PARA E_CALCULO_EXCEPTION\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\ntry {\n\n  // Agrupar por data de pagamento\n  const parcelasPorData = {};\n\n  creditos.forEach(cred => {\n    const dataPag = extrairData(cred.pagamento?.previsao) || extrairData(cred.pagamento?.data);\n    if (!dataPag) return;\n\n    if (!parcelasPorData[dataPag]) {\n      parcelasPorData[dataPag] = { data: dataPag, valor: 0, dias: 0, origem: [], tem_13o: false, valor_13o: 0, competencia: null };\n    }\n\n    // Base EXTRATO: valor lÃ­quido real do PDF\n    parcelasPorData[dataPag].valor += cred.valores?.liquido || 0;\n    parcelasPorData[dataPag].dias += cred.dias || 0;\n    parcelasPorData[dataPag].origem.push('EXTRATO');\n    if (cred.competencia) parcelasPorData[dataPag].competencia = cred.competencia;\n\n    if (cred.flags?.tem_13o && cred.valores?.decimo_terceiro > 0) {\n      parcelasPorData[dataPag].tem_13o = true;\n      parcelasPorData[dataPag].valor_13o += cred.valores.decimo_terceiro;\n    }\n  });\n\n  parcelasProjetadas.forEach(proj => {\n    const dataPag = extrairData(proj.data_pagamento_prevista);\n    if (!dataPag) return;\n\n    if (!parcelasPorData[dataPag]) {\n      parcelasPorData[dataPag] = { data: dataPag, valor: 0, dias: 0, origem: [], tem_13o: false, valor_13o: 0, competencia: null };\n    }\n\n    // Base PROJETADA: valor lÃ­quido projetado do 6B\n    parcelasPorData[dataPag].valor += proj.valor_liquido || 0;\n    parcelasPorData[dataPag].dias += proj.dias || 0;\n    parcelasPorData[dataPag].origem.push('PROJETADA');\n    if (proj.competencia) parcelasPorData[dataPag].competencia = proj.competencia;\n  });\n\n  const parcelasAgrupadas = Object.values(parcelasPorData)\n    .map(p => ({ ...p, valor: tr(p.valor) }))\n    .sort((a, b) => a.data.localeCompare(b.data));\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // V3.2: CALCULAR BASE DE HONORÃRIOS (REAL + PROJETADA)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ObservaÃ§Ã£o: p.valor jÃ¡ representa:\n  //   - EXTRATO: soma dos liquidos reais\n  //   - PROJETADA: soma dos valores projetados\n  // Aqui mantemos logs por origem para auditoria.\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  let totalHonorariosBase = 0;\n\n  for (const p of parcelasAgrupadas) {\n    totalHonorariosBase += (p.valor || 0);\n\n    if (p.origem.includes('EXTRATO')) {\n      info.push(`INFO_PARCELA_EXTRATO_VALOR_REAL_${tr(p.valor)}`);\n    }\n    if (p.origem.includes('PROJETADA')) {\n      info.push(`INFO_PARCELA_PROJETADA_VALOR_TEORICO_${tr(p.valor)}`);\n    }\n  }\n\n  totalHonorariosBase = tr(totalHonorariosBase);\n  info.push(`INFO_TOTAL_BASE_HONORARIOS_${tr(totalHonorariosBase)}`);\n\n  // âœ… CorreÃ§Ã£o chave: definir honorariosStart\n  // v3.3: Arredondar honorÃ¡rios Start para baixo (sem centavos)\n  const honorariosStart = Math.floor(totalHonorariosBase * CONFIG.ALIQUOTA_HONORARIOS);\n  info.push(`INFO_HONORARIOS_START_${tr(honorariosStart)}`);\n\n  // (Opcional) auditoria real vs teÃ³rico (120 dias)\n  if (total_120_dias && total_120_dias > 0 && totalHonorariosBase !== total_120_dias) {\n    info.push(`INFO_DIFERENCA_REAL_VS_TEORICO_${tr(totalHonorariosBase - total_120_dias)}`);\n    if (totalHonorariosBase > total_120_dias) {\n      tags_sucesso.push('OK_USANDO_VALOR_REAL_EXTRATO');\n    }\n  }\n\n  if (parcelasAgrupadas.length === 0) {\n    return criarErro('E_SEM_PARCELAS', { motivo: 'Nenhuma parcela com data vÃ¡lida' }, contexto, campos_deal_6B, campos_invoice_6B);\n  }\n\n  tags_sucesso.push('OK_PARCELAS_AGRUPADAS');\n  info.push(`INFO_TOTAL_PARCELAS_${parcelasAgrupadas.length}`);\n\n  const diasTotais = parcelasAgrupadas.reduce((sum, p) => sum + p.dias, 0);\n  info.push(`INFO_DIAS_TOTAIS_${diasTotais}`);\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4. VALIDAR HONORÃRIOS START (jÃ¡ calculado acima na v3.2)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  if (honorariosStart <= 0) {\n    return criarErro('E_HONORARIOS_ZERO', {\n      totalHonorariosBase,\n      aliquota: CONFIG.ALIQUOTA_HONORARIOS,\n      calculo: `${tr(totalHonorariosBase)} Ã— ${CONFIG.ALIQUOTA_HONORARIOS} = ${honorariosStart}`\n    }, contexto, campos_deal_6B, campos_invoice_6B);\n  }\n\n  tags_sucesso.push('OK_HONORARIOS_CALCULADOS');\n\n  const deal = dados6B.deal;\n\n  const saldoStartExistente = parseFloat(deal?.['UF_CRM_69442F27CCFB3']) || 0;\n\n  if (saldoStartExistente === 0) {\n    info.push('INFO_PRIMEIRO_PROCESSAMENTO');\n  } else {\n    alertas.push('ALERTA_REPROCESSAMENTO');\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 4.1 LER DARF DO DEAL (para usar depois do cÃ¡lculo)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  const necessitaDarfRaw = (deal?.[CD.necessita_darf] ?? '').toString().trim();\n  const startPagaDarf = necessitaDarfRaw === 'Sim! Start irÃ¡ pagar!';\n  const valorDarf = tr(parseValor(deal?.[CD.valor_darf]));\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 5. SIMULAR PARCELAS (CÃLCULO NORMAL - SEM DARF)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  let saldoStart = honorariosStart;\n  let parcelaQuitacao = null;\n  let diasAcumulados = 0;\n  let valorAcumulado = 0;\n\n  const parcelasCalculadas = [];\n  const faixasAplicadas = new Set();\n\n  for (let i = 0; i < parcelasAgrupadas.length; i++) {\n    const parcela = parcelasAgrupadas[i];\n    const numero = i + 1;\n    const valorParcela = parcela.valor;\n\n    if (!parcela.data) {\n      return criarErro('E_PARCELA_SEM_DATA', { parcela: numero, dados_parcela: parcela }, contexto, campos_deal_6B, campos_invoice_6B);\n    }\n\n    if (!valorParcela || valorParcela <= 0) {\n      return criarErro('E_PARCELA_SEM_VALOR', { parcela: numero, valor: valorParcela }, contexto, campos_deal_6B, campos_invoice_6B);\n    }\n\n    const diasRestantes = diasTotais - diasAcumulados - parcela.dias;\n    const valorRestante = tr(parcelasAgrupadas.slice(i + 1).reduce((sum, p) => sum + p.valor, 0));\n    const parcelasRestantes = parcelasAgrupadas.length - numero;\n\n    let valorStart = 0;\n    let aliquotaAplicada = null;\n    let aliquotaEfetivaParcela = 0;\n    let regraAplicada = '';\n\n    if (saldoStart <= 0) {\n      regraAplicada = 'QUITADO';\n      aliquotaEfetivaParcela = 0;\n    } else {\n      if (podeQuitar(valorParcela, saldoStart)) {\n        // v3.3: QuitaÃ§Ã£o tambÃ©m truncada\n        valorStart = Math.floor(saldoStart);\n        regraAplicada = 'QUITACAO';\n        aliquotaEfetivaParcela = tr(valorStart / valorParcela);\n        parcelaQuitacao = numero;\n        tags_sucesso.push(`OK_QUITACAO_P${numero <= 4 ? numero : '5_PLUS'}`);\n      } else {\n        const resultado = calcularPorFaixa(valorParcela, saldoStart);\n        valorStart = resultado.valorStart;\n        aliquotaAplicada = resultado.aliquota;\n        aliquotaEfetivaParcela = tr(valorStart / valorParcela);\n        regraAplicada = resultado.faixa;\n        faixasAplicadas.add(resultado.faixa);\n      }\n    }\n\n    const saldoAntes = saldoStart;\n    saldoStart = tr(saldoStart - valorStart);\n\n    // Valor cliente = parcela - honorÃ¡rios (SEM DARF ainda)\n    const valorCliente = tr(valorParcela - valorStart);\n    const percentualCliente = tr(valorCliente / valorParcela);\n\n    // Verificar regra 50% (sobre honorÃ¡rios apenas)\n    if (regraAplicada !== 'QUITADO' && percentualCliente < CONFIG.MINIMO_CLIENTE) {\n      alertas.push(`ALERTA_REGRA_50_VIOLADA_P${numero}`);\n    }\n\n    // Alertas por parcela\n    if (valorParcela < CONFIG.PARCELA_BAIXA_LIMITE) {\n      alertas.push(`ALERTA_PARCELA_BAIXA_P${numero}`);\n    }\n\n    if (percentualCliente > 0 && percentualCliente < CONFIG.MARGEM_APERTADA_LIMITE) {\n      alertas.push(`ALERTA_MARGEM_50_APERTADA_P${numero}`);\n    }\n\n    const hoje = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Sao_Paulo' });\n    if (parcela.data < hoje) {\n      alertas.push(`ALERTA_DATA_RETROATIVA_P${numero}`);\n    }\n\n    diasAcumulados += parcela.dias;\n    valorAcumulado += valorParcela;\n\n    parcelasCalculadas.push({\n      numero,\n      data_pagamento: parcela.data,\n      data_pagamento_formatada: formatarDataBR(parcela.data),\n      competencia: parcela.competencia,\n\n      valor_parcela: valorParcela,\n      valor_parcela_formatado: formatarMoeda(valorParcela),\n\n      // HonorÃ¡rios (sem DARF)\n      valor_start: valorStart,\n      valor_start_formatado: formatarMoeda(valorStart),\n\n      // DARF (serÃ¡ preenchido depois)\n      valor_darf_rateado: 0,\n      valor_darf_rateado_formatado: formatarMoeda(0),\n\n      // Total Start (honorÃ¡rios + DARF) - serÃ¡ atualizado depois\n      valor_start_total: valorStart,\n      valor_start_total_formatado: formatarMoeda(valorStart),\n\n      // Cliente (parcela - start_total) - serÃ¡ atualizado depois\n      valor_cliente: valorCliente,\n      valor_cliente_formatado: formatarMoeda(valorCliente),\n\n      aliquota_aplicada: aliquotaAplicada,\n      aliquota_efetiva: aliquotaEfetivaParcela,\n      aliquota_efetiva_formatada: formatarPercentual(aliquotaEfetivaParcela),\n\n      // Percentual cliente calculado sobre honorÃ¡rios (para regra 50%)\n      percentual_cliente: percentualCliente,\n      percentual_cliente_formatado: formatarPercentual(percentualCliente),\n\n      regra_aplicada: regraAplicada,\n\n      saldo_start_antes: saldoAntes,\n      saldo_start_antes_formatado: formatarMoeda(saldoAntes),\n      saldo_start_depois: saldoStart,\n      saldo_start_depois_formatado: formatarMoeda(saldoStart),\n\n      dias: parcela.dias,\n      dias_acumulados: diasAcumulados,\n      dias_restantes: diasRestantes,\n\n      valor_restante: valorRestante,\n      valor_restante_formatado: formatarMoeda(valorRestante),\n      parcelas_restantes: parcelasRestantes,\n\n      origem: parcela.origem.join('+'),\n      tem_13o: parcela.tem_13o,\n      valor_13o: parcela.valor_13o\n    });\n  }\n\n  // Tags das faixas\n  faixasAplicadas.forEach(faixa => tags_sucesso.push(`OK_${faixa}_APLICADA`));\n\n  // Verificar regra 50% geral (sobre honorÃ¡rios)\n  const regra50Respeitada = parcelasCalculadas.every(p =>\n    p.percentual_cliente >= CONFIG.MINIMO_CLIENTE || p.regra_aplicada === 'QUITADO'\n  );\n\n  if (regra50Respeitada) {\n    tags_sucesso.push('OK_REGRA_50_RESPEITADA');\n  } else {\n    alertas.push('ALERTA_REGRA_50_NAO_RESPEITADA_GERAL');\n  }\n\n  // 13Âº (mantido como era)\n  if (tem_13o && valor_13o > 0) {\n    tags_sucesso.push('OK_13O_INCLUIDO');\n  } else {\n    tags_sucesso.push('OK_13O_EXCLUIDO');\n  }\n\n  // Alertas finais\n  if (parcelasAgrupadas.length > CONFIG.MUITAS_PARCELAS_LIMITE) alertas.push('ALERTA_MUITAS_PARCELAS');\n  if (parcelaQuitacao === parcelasAgrupadas.length) alertas.push('ALERTA_QUITACAO_TARDIA');\n  if (saldoStart > 0 && saldoStart < 1) alertas.push('ALERTA_SALDO_RESIDUAL');\n\n  if (!deal?.['UF_CRM_69442F27CCFB3']) {\n    alertas.push('ALERTA_DEAL_SEM_CAMPOS_START');\n  }\n\n  tags_sucesso.push('OK_SIMULACAO_COMPLETA');\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 5.1 ADICIONAR DARF NAS PARCELAS ONDE START RECEBE\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // REGRA: DARF Ã© adicionada ao valor_start (Start recebe mais)\n  //        e subtraÃ­da do valor_cliente (cliente paga o reembolso)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  // Identificar parcelas onde Start recebe (valor_start > 0)\n  const parcelasComStart = parcelasCalculadas.filter(p => (p.valor_start || 0) > 0);\n  const qtdParcelasStart = parcelasComStart.length;\n\n  let darfTotal = 0;\n  let darfPorParcelaAprox = 0;\n\n  if (startPagaDarf) {\n    if (valorDarf > 0) {\n      darfTotal = valorDarf;\n      tags_sucesso.push('OK_DARF_EXISTE');\n      info.push(`INFO_DARF_TOTAL_${formatarMoeda(darfTotal)}`);\n      info.push(`INFO_DARF_PARCELAS_START_${qtdParcelasStart}`);\n\n      if (qtdParcelasStart > 0) {\n        tags_sucesso.push(`OK_DARF_PARCELAS_START_${qtdParcelasStart}`);\n\n        // Rateio por centavos para fechar exatamente\n        const totalCent = Math.round(darfTotal * 100);\n        const baseCent = Math.floor(totalCent / qtdParcelasStart);\n        let resto = totalCent - (baseCent * qtdParcelasStart);\n\n        for (const p of parcelasCalculadas) {\n          if ((p.valor_start || 0) <= 0) continue;\n\n          // Distribui centavos extras nas primeiras parcelas\n          const extraCent = baseCent + (resto > 0 ? 1 : 0);\n          if (resto > 0) resto--;\n\n          const darfRateado = tr(extraCent / 100);\n\n          // Atualiza a parcela\n          p.valor_darf_rateado = darfRateado;\n          p.valor_darf_rateado_formatado = formatarMoeda(darfRateado);\n\n          // Start recebe: honorÃ¡rios + DARF\n          p.valor_start_total = tr(p.valor_start + darfRateado);\n          p.valor_start_total_formatado = formatarMoeda(p.valor_start_total);\n\n          // Cliente fica: parcela - total Start\n          p.valor_cliente = tr(p.valor_parcela - p.valor_start_total);\n          p.valor_cliente_formatado = formatarMoeda(p.valor_cliente);\n        }\n\n        darfPorParcelaAprox = tr(darfTotal / qtdParcelasStart);\n        info.push(`INFO_DARF_POR_PARCELA_APROX_${formatarMoeda(darfPorParcelaAprox)}`);\n        alertas.push('ALERTA_DARF_START_PAGA');\n\n      } else {\n        // NÃ£o hÃ¡ parcelas com recebimento Start\n        alertas.push('ALERTA_DARF_SEM_PARCELAS_START');\n      }\n    } else {\n      // Marcado para Start pagar mas sem valor\n      alertas.push('ALERTA_DARF_START_PAGA_SEM_VALOR');\n    }\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // 6. MONTAR RETORNO\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  // Totais (honorÃ¡rios apenas, sem DARF)\n  const totalStartHonorarios = tr(parcelasCalculadas.reduce((sum, p) => sum + (p.valor_start || 0), 0));\n\n  // Totais com DARF\n  const totalStartComDarf = tr(parcelasCalculadas.reduce((sum, p) => sum + (p.valor_start_total || 0), 0));\n  const totalCliente = tr(parcelasCalculadas.reduce((sum, p) => sum + (p.valor_cliente || 0), 0));\n  const totalDarfRateado = tr(parcelasCalculadas.reduce((sum, p) => sum + (p.valor_darf_rateado || 0), 0));\n\n  const aliquotaINSSUsada = aliquota_efetiva || 7.5;\n  const valorLiquidoMensal = tr(mr - (mr * aliquotaINSSUsada / 100));\n  const valorDiario = tr(valorLiquidoMensal / 30);\n\n  const primeiraParcela = parcelasCalculadas[0];\n  const ultimaParcela = parcelasCalculadas[parcelasCalculadas.length - 1];\n\n  const resumoFinal = {\n    nome, cpf, nb, deal_id,\n    mr, mr_formatado: formatarMoeda(mr),\n    aliquota_inss: aliquotaINSSUsada,\n    aliquota_inss_formatada: `${aliquotaINSSUsada}%`,\n    total_120_dias, total_120_dias_formatado: formatarMoeda(total_120_dias),\n\n    aliquota_honorarios: CONFIG.ALIQUOTA_HONORARIOS,\n    aliquota_honorarios_formatada: formatarPercentual(CONFIG.ALIQUOTA_HONORARIOS),\n\n    honorarios_start: honorariosStart,\n    honorarios_start_formatado: formatarMoeda(honorariosStart),\n\n    total_parcelas: parcelasAgrupadas.length,\n    parcela_quitacao: parcelaQuitacao,\n\n    // HonorÃ¡rios (sem DARF)\n    total_start_honorarios: totalStartHonorarios,\n    total_start_honorarios_formatado: formatarMoeda(totalStartHonorarios),\n\n    // DARF\n    start_paga_darf: startPagaDarf,\n    valor_darf_original: darfTotal,\n    valor_darf_original_formatado: formatarMoeda(darfTotal),\n    total_darf_rateado: totalDarfRateado,\n    total_darf_rateado_formatado: formatarMoeda(totalDarfRateado),\n    qtd_parcelas_start_recebe: qtdParcelasStart,\n    valor_darf_por_parcela_aprox: darfPorParcelaAprox,\n    valor_darf_por_parcela_aprox_formatado: formatarMoeda(darfPorParcelaAprox),\n\n    // Total Start (honorÃ¡rios + DARF)\n    total_start: totalStartComDarf,\n    total_start_formatado: formatarMoeda(totalStartComDarf),\n\n    // Cliente (parcela - total Start)\n    total_cliente: totalCliente,\n    total_cliente_formatado: formatarMoeda(totalCliente),\n\n    saldo_start_final: saldoStart,\n    saldo_start_final_formatado: formatarMoeda(saldoStart),\n\n    dias_totais: diasTotais,\n\n    tem_13o, valor_13o, valor_13o_formatado: formatarMoeda(valor_13o || 0)\n  };\n\n  const dadosFinal = {\n    config: { aliquota_honorarios: CONFIG.ALIQUOTA_HONORARIOS, faixas: CONFIG.FAIXAS, minimo_cliente: CONFIG.MINIMO_CLIENTE },\n    parcelas: parcelasCalculadas,\n    deal_id, deal,\n    creditos_originais: creditos,\n    parcelas_projetadas_originais: parcelasProjetadas\n  };\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ENRIQUECER campos_deal E campos_invoice COM DADOS CALCULADOS\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  const campos_deal_enriquecido = {\n    ...campos_deal_6B,\n\n    [CD.mr_cliente]: formatMoneyBitrix(mr),\n    [CD.valor_total_beneficio]: total_120_dias,\n\n    [CD.aliquota_mr]: aliquotaINSSUsada,\n    [CD.qtd_parcelas]: String(parcelasAgrupadas.length)\n  };\n\n  const campos_invoice_enriquecido = {\n    ...campos_invoice_6B,\n\n    [CI.mr_cliente]: formatMoneyBitrix(mr),\n    [CI.valor_diario]: valorDiario,\n    [CI.valor_liquido_mensal]: formatMoneyBitrix(valorLiquidoMensal),\n    [CI.valor_total_beneficio]: total_120_dias,\n\n    [CI.aliquota_mr]: aliquotaINSSUsada,\n    [CI.aliquota_start]: tr(CONFIG.ALIQUOTA_HONORARIOS * 100),\n\n    // HonorÃ¡rios + DARF = total que Start recebe\n    [CI.valor_total_start]: formatMoneyBitrix(totalStartComDarf),\n    [CI.saldo_restante_start]: formatMoneyBitrix(saldoStart),\n\n    // Cliente = benefÃ­cio - total Start (SEM DARF separado)\n    [CI.valor_restante_inss]: formatMoneyBitrix(totalCliente),\n\n    [CI.regra_aplicada]: primeiraParcela.regra_aplicada,\n    [CI.qtd_parcelas]: String(parcelasAgrupadas.length),\n\n    // DARF na invoice (informativo)\n    [CI.necessita_darf]: startPagaDarf ? 'Sim! Start irÃ¡ pagar!' : (necessitaDarfRaw || null),\n    [CI.valor_darf]: (darfTotal > 0 ? formatMoneyBitrix(darfTotal) : null)\n  };\n\n  if (!campos_invoice_6B[CI.competencia_final] && ultimaParcela.competencia) {\n    campos_invoice_enriquecido[CI.competencia_final] = ultimaParcela.competencia;\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // DEBUG\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n  info.push('INFO_CAMPOS_DEAL_ENRIQUECIDOS');\n  info.push(`INFO_CAMPOS_DEAL_6B_RECEBIDOS_${Object.keys(campos_deal_6B).length}`);\n  info.push(`INFO_CAMPOS_DEAL_TOTAL_${Object.keys(campos_deal_enriquecido).length}`);\n  info.push(`INFO_CAMPOS_INVOICE_6B_RECEBIDOS_${Object.keys(campos_invoice_6B).length}`);\n  info.push(`INFO_CAMPOS_INVOICE_TOTAL_${Object.keys(campos_invoice_enriquecido).length}`);\n\n  if (campos_deal_6B[CD.dip]) {\n    info.push('INFO_DIP_PRESERVADO_6B');\n  } else {\n    alertas.push('ALERTA_DIP_NAO_VEIO_6B');\n  }\n\n  if (campos_deal_6B[CD.competencia_final]) {\n    info.push('INFO_COMPETENCIA_FINAL_PRESERVADA_6B');\n  }\n\n  console.log(JSON.stringify({\n    no: '6C',\n    versao: '3.2',\n    campos_deal_in: Object.keys(campos_deal_6B).length,\n    campos_deal_out: Object.keys(campos_deal_enriquecido).length,\n    campos_invoice_in: Object.keys(campos_invoice_6B).length,\n    campos_invoice_out: Object.keys(campos_invoice_enriquecido).length,\n    honorarios: honorariosStart,\n    darf_total: darfTotal,\n    darf_parcelas: qtdParcelasStart,\n    total_start_com_darf: totalStartComDarf,\n    total_cliente: totalCliente,\n    saldo_final: saldoStart\n  }));\n\n  return criarSucesso(resumoFinal, dadosFinal, tags_sucesso, alertas, info, campos_deal_enriquecido, campos_invoice_enriquecido);\n\n} catch (excecao) {\n  return criarErro('E_CALCULO_EXCEPTION', {\n    mensagem: excecao.message,\n    stack: excecao.stack?.substring(0, 500),\n    linha: excecao.lineNumber || 'N/A'\n  }, contexto, campos_deal_6B, campos_invoice_6B);\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6176,
        25712
      ],
      "id": "2a21d8b1-29ed-4094-9035-80ee88a42a15",
      "name": "6C. Calculo Start"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 9 - PREPARAR FATURA (V25 - COMPLETO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Prepara faturas prontas para crm.item.add (Invoice entityTypeId=31)\n// ENTRADA: Output do 6D via $input.first().json\n// SAÃDA: Array de items com body completo para HTTP Request\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// CHANGELOG V25 (08/01/2026):\n// ğŸ”¥ NOVO: Copia TODOS os campos do campos_invoice do 6D automaticamente\n// ğŸ”¥ NOVO: Converte IDs de UF_CRM_ para ufCrm_ (formato crm.item.add)\n// âœ… MANTÃ‰M: Fallbacks para campos crÃ­ticos (resumo, dados, deal)\n// âœ… MANTÃ‰M: Debug detalhado de campos crÃ­ticos\n// âœ… MANTÃ‰M: Mapeamento CI completo (70+ campos)\n// âœ… MANTÃ‰M: Toda lÃ³gica de preparaÃ§Ã£o de faturas\n// âœ… MANTÃ‰M: Mapeamento banco Deal â†’ Invoice\n// \n// VANTAGEM V25:\n// - Qualquer campo novo no 6D vai automaticamente para a Invoice\n// - MAS mantÃ©m seguranÃ§a com fallbacks se campos_invoice estiver incompleto\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO BANCO DEAL â†’ INVOICE (enum IDs diferentes!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst BANCO_DEAL_TO_INVOICE = {\n  '7137': '25',   // 001 - BB\n  '7139': '27',   // 033 - Santander\n  '7141': '29',   // 104 - Caixa\n  '7143': '31',   // 237 - Bradesco\n  '7145': '33',   // 341 - ItaÃº\n  '7147': '35',   // 756 - Sicoob\n  '433': '33',    // ItaÃº (cÃ³digo antigo)\n  '4530': '29',   // Caixa\n  '4532': '25',   // BB\n  '4534': '27',   // Santander\n  '4544': '35',   // Sicredi/Sicoob\n  '4556': '35',   // Sicoob\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO OFICIAL COMPLETO - IDs DA INVOICE (entityTypeId = 31)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CI = {\n  // â”€â”€â”€ 1. IDENTIFICAÃ‡ÃƒO â”€â”€â”€\n  cpf: 'ufCrm_652439CFE551C',\n  rg: 'ufCrm_652439D00A9CF',\n  nit: 'ufCrm_6947602572F0A',\n  nb: 'ufCrm_6790DAD756E3C',\n  nome_filho: 'ufCrm_65BD5488EC8E9',\n  categoria: 'ufCrm_652439D03479D',\n  \n  // â”€â”€â”€ 2. BENEFÃCIO (Datas) â”€â”€â”€\n  dib: 'ufCrm_69442F085B2CD',\n  dip: 'ufCrm_683860072DEB8',\n  dcb: 'ufCrm_6838600845561',\n  dn_mamae: 'ufCrm_652439D0138A5',\n  dn_filho: 'ufCrm_652439D021438',\n  dn_certidao: 'ufCrm_66351141F40C7',\n  data_dnv: 'ufCrm_67E17F1C70EAF',\n  data_requerimento: 'ufCrm_652439D3530AB',\n  data_concessao: 'ufCrm_652439D157BA8',\n  \n  // â”€â”€â”€ 3. BENEFÃCIO (Valores) â”€â”€â”€\n  mr_cliente: 'ufCrm_652439D00A9CF',\n  mr_cliente_money: 'ufCrm_67D19072D84A8',\n  valor_diario: 'ufCrm_69442F466791E',\n  valor_liquido_mensal: 'ufCrm_69442F4D0909D',\n  valor_total_beneficio: 'ufCrm_69442F535C91B',\n  valor_total_beneficio_120d: 'ufCrm_69442F535C91B',\n  valor_total_beneficio_alt: 'ufCrm_67E1AD2AC8BEB',\n  valor_restante_inss: 'ufCrm_69442F3A581C2',\n  aliquota_mr: 'ufCrm_67E1B184633ED',\n  especie_beneficio: 'ufCrm_69442F6570BDB',\n  \n  // â”€â”€â”€ 4. HONORÃRIOS START â”€â”€â”€\n  valor_total_start: 'ufCrm_69442F217FB9D',\n  valor_total_start_30: 'ufCrm_69442F217FB9D',\n  saldo_restante_start: 'ufCrm_69442F27CCFB3',\n  aliquota_start: 'ufCrm_69442F596A782',\n  aliquota_start_aplicada: 'ufCrm_69442F596A782',\n  regra_aplicada: 'ufCrm_69442F5F762AD',\n  \n  // â”€â”€â”€ 5. FATURAMENTO (Parcela) â”€â”€â”€\n  valor_inss: 'ufCrm_652439D8D6B8E',\n  valor_cliente: 'ufCrm_652439D915311',\n  valor_previsto: 'ufCrm_652439D9202B3',\n  parcela_numero: 'ufCrm_652439D8CDB53',\n  parcela_atual: 'ufCrm_652439D8E9608',\n  parcela_formato: 'ufCrm_652439D8CDB53',\n  qtd_parcelas: 'ufCrm_67E1AD2860054',\n  quantidade_parcelas: 'ufCrm_67E1AD2860054',\n  valor_darf: 'ufCrm_6941BDC604550',\n  \n  // â”€â”€â”€ 6. EXTRATO / COMPETÃŠNCIA â”€â”€â”€\n  competencia: 'ufCrm_691B6450B46E3',\n  competencia_final: 'ufCrm_69442F0E9A95A',\n  compet_final: 'ufCrm_69442F0E9A95A',\n  compet_final_extrato: 'ufCrm_691B6474BE0F7',\n  periodo: 'ufCrm_691B64560A17F',\n  ultima_comp_valida: 'ufCrm_693D7DE5148DB',\n  ultima_competencia_valida: 'ufCrm_693D7DE5148DB',\n  credito_invalidado: 'ufCrm_691B6467F11F2',\n  dias_ja_recebidos: 'ufCrm_69442F2E321C4',\n  dias_restantes: 'ufCrm_69442F3449D22',\n  dias_restantes_cliente: 'ufCrm_69442F3449D22',\n  \n  // â”€â”€â”€ 7. DATAS OPERACIONAIS â”€â”€â”€\n  data_inss: 'ufCrm_652439D8B3207',\n  data_pagamento_extrato: 'ufCrm_691B64616C2C9',\n  data_atualizacao_extrato: 'ufCrm_691B646EC01BF',\n  status_extrato: 'ufCrm_691B646EC01BF',\n  \n  // â”€â”€â”€ 8. BANCO â”€â”€â”€\n  banco: 'ufCrm_652439D194A06',\n  endereco_banco: 'ufCrm_652439D1A53FA',\n  agencia_banco: 'ufCrm_691225FDDDBE4',\n  \n  // â”€â”€â”€ 9. CONTROLE / ANÃLISE â”€â”€â”€\n  justificativa_direito: 'ufCrm_693D7BBC3E5D3',\n  resultado_analise: 'ufCrm_693D7CB58EBD2',\n  data_rodagem: 'ufCrm_6929FDA3C8A79',\n  rodagem_comentario: 'ufCrm_6929FD9E9A95D',\n  direito_ate: 'ufCrm_679781AAB3B1D',\n  \n  // â”€â”€â”€ 10. GESTÃƒO â”€â”€â”€\n  ultimo_relacionador: 'ufCrm_65BD5488EC8E9',\n  ddd_cliente: 'ufCrm_65BD5489DF3A2',\n  data_reclamacao: 'ufCrm_65BD5489C89AD',\n  data_qualificacao: 'ufCrm_65E777E2A0CED',\n  data_recuperacao: 'ufCrm_662699414BCF0',\n  data_encerramento: 'ufCrm_6631460FD3BB4',\n  data_reentrada: 'ufCrm_678EADB02E460',\n  \n  // â”€â”€â”€ 11. CAMPOS EXTRAS â”€â”€â”€\n  data_conversao: 'ufCrm_652439D0CF19F',\n  data_calculo: 'ufCrm_69442F14E544C',\n  data_certidao: 'ufCrm_652439DA75EFF',\n  data_consulta: 'ufCrm_652439D14CF3D',\n  data_acordo: 'ufCrm_652439DB85203',\n  data_contato: 'ufCrm_652439D9B26DF',\n  data_sem_direito: 'ufCrm_66ACE094C0195',\n  data_pagamento: 'ufCrm_652439D8BD582',\n  data_indeferimento: 'ufCrm_652439D3E866C',\n  data_recebimento: 'ufCrm_652439D1B26E2',\n  desconto: 'ufCrm_6838600A5C767',\n  data_quebra_contrato: 'ufCrm_6793A405B3FC1',\n  relacionador_quebra: 'ufCrm_6793A4065BECA',\n  relacionador_sem_direito: 'ufCrm_6793A40701BCB',\n  recurso: 'ufCrm_68DD552A351D0',\n  senha: 'ufCrm_652439D16254A',\n  sugestao_senha: 'ufCrm_652439D23E905',\n  telefone_2: 'ufCrm_652439D28D353',\n  telefone_3: 'ufCrm_652439D298A88',\n  sine: 'ufCrm_6883D4B47136F',\n  data_envio_recurso: 'ufCrm_68DD552F3DD02',\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HELPERS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst tr = (v) => Math.floor(v * 100) / 100;\n\nconst pv = (v) => {\n  if (v === null || v === undefined || v === '') return 0;\n  if (typeof v === 'number') return v;\n  const s = String(v).replace(/[^\\d,.\\\\-]/g, '').replace(',', '.');\n  return parseFloat(s) || 0;\n};\n\nconst formatarData = (data) => {\n  if (!data) return null;\n  const str = String(data);\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    return str.includes('T') ? str : `${str}T03:00:00+03:00`;\n  }\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(str)) {\n    const [d, m, y] = str.split('/');\n    return `${y}-${m}-${d}T03:00:00+03:00`;\n  }\n  return str;\n};\n\nconst formatarMoney = (valor) => {\n  const num = typeof valor === 'number' ? valor : parseFloat(valor) || 0;\n  return `${num}|BRL`;\n};\n\nconst limparCamposVazios = (obj) => {\n  const limpo = {};\n  for (const [key, value] of Object.entries(obj)) {\n    if (value !== null && value !== undefined && value !== '' && value !== 'null') {\n      limpo[key] = value;\n    }\n  }\n  return limpo;\n};\n\nconst soDigitos = (v) => v ? String(v).replace(/\\D/g, '') : '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: CONVERTER IDs DE UF_CRM_ PARA ufCrm_ (formato crm.item.add)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst converterIdParaUfCrm = (id) => {\n  if (!id) return id;\n  const str = String(id);\n  if (str.startsWith('UF_CRM_')) {\n    return 'ufCrm_' + str.substring(7);\n  }\n  return str;\n};\n\nconst converterCamposInvoice = (campos) => {\n  const convertidos = {};\n  for (const [key, value] of Object.entries(campos)) {\n    const novaChave = converterIdParaUfCrm(key);\n    \n    // Formatar datas automaticamente (campos que contÃªm \"data\", \"dn_\", \"dib\", \"dcb\", \"dip\")\n    const keyLower = novaChave.toLowerCase();\n    if (keyLower.includes('data') || \n        keyLower.includes('dn_') ||\n        keyLower.includes('dib') ||\n        keyLower.includes('dcb') ||\n        keyLower.includes('dip')) {\n      convertidos[novaChave] = formatarData(value);\n    } else {\n      convertidos[novaChave] = value;\n    }\n  }\n  return convertidos;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: DADOS VÃŠM DO $input (OUTPUT DO 6D!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst ctx = $input.first().json || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ V25: BUSCAR campos_invoice DO 6D E CONVERTER IDs\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst camposInvoiceOriginal = ctx.campos_invoice || {};\nconst camposInvoiceConvertidos = converterCamposInvoice(camposInvoiceOriginal);\n\n// Helper para buscar campo da Invoice (com fallback para diferentes formatos de ID)\nconst getCampoInvoice = (invoiceId) => {\n  // Tenta direto\n  let valor = camposInvoiceConvertidos[invoiceId];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  // Tenta com UF_CRM_ maiÃºsculo no original\n  const idMaiusculo = invoiceId.replace('ufCrm_', 'UF_CRM_');\n  valor = camposInvoiceOriginal[idMaiusculo];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  // Tenta com ufCrm_ no original\n  valor = camposInvoiceOriginal[invoiceId];\n  if (valor !== null && valor !== undefined && valor !== '') {\n    return valor;\n  }\n  \n  return null;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DO CONTEXTO (OUTPUT DO 6D)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dealId = ctx.deal_id || 0;\nconst faturasCriar = ctx.faturas_criar || [];\nconst faturasDuplicadas = ctx.faturas_duplicadas || [];\nconst resumo = ctx.resumo || {};\nconst dados = ctx.dados || {};\nconst deal = ctx.deal || {};\nconst auditoria = ctx.auditoria || {};\nconst tags = ctx.tags || [];\nconst ok = ctx.ok;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 1 â€” ERRO CRÃTICO (6D retornou ok: false)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (ok === false) {\n  return [{\n    json: {\n      pular: true,\n      permitido_criar: false,\n      status: 'BLOQUEADO',\n      motivo: ctx.gravidade_maxima || 'ERRO_CALCULO',\n      deal_id: dealId,\n      mensagem: ctx.mensagem_bitrix || 'Erro no processamento do 6D',\n      problemas: auditoria.problemas || [],\n      _fonte_dados: '$input.first().json (6D)',\n      _versao: 'V25'\n    }\n  }];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 2 â€” SEM FATURAS PARA CRIAR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nif (faturasCriar.length === 0) {\n  return [{\n    json: {\n      pular: true,\n      permitido_criar: false,\n      status: 'SEM_FATURAS',\n      motivo: faturasDuplicadas.length > 0 ? 'TODAS_DUPLICADAS' : 'SALDO_ZERO_OU_QUITADO',\n      deal_id: dealId,\n      faturas_duplicadas: faturasDuplicadas.length,\n      saldo_final: resumo.saldo_start_final || 0,\n      _fonte_dados: '$input.first().json (6D)',\n      _versao: 'V25'\n    }\n  }];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS COMUNS - COM FALLBACKS PARA SEGURANÃ‡A\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Cliente\nconst nomeCliente = resumo.nome || dados.nome || deal.nome || 'Cliente';\nconst cpf = soDigitos(\n  getCampoInvoice(CI.cpf) || \n  resumo.cpf || \n  dados.cpf || \n  ''\n);\n\n// BenefÃ­cio - BUSCA COM FALLBACKS!\nconst nb = getCampoInvoice(CI.nb) || resumo.nb || dados.nb || '';\nconst nit = getCampoInvoice(CI.nit) || dados.nit || '';\nconst mr = pv(getCampoInvoice(CI.mr_cliente) || getCampoInvoice(CI.mr_cliente_money) || resumo.mr || dados.mr || 0);\n\n// Valores 120 dias - COM FALLBACKS!\nconst valorDiario = pv(getCampoInvoice(CI.valor_diario) || dados.valor_diario || 0);\nconst valorLiquidoMensal = pv(getCampoInvoice(CI.valor_liquido_mensal) || dados.valor_liquido_mensal || 0);\nconst valorTotalBeneficio = pv(getCampoInvoice(CI.valor_total_beneficio_120d) || resumo.total_120_dias || 0);\nconst valorTotalStart = pv(getCampoInvoice(CI.valor_total_start_30) || resumo.honorarios_start || 0);\nconst aliquotaMr = pv(getCampoInvoice(CI.aliquota_mr) || dados.aliquota_inss_efetiva || 0);\n\n// Datas do benefÃ­cio - COM FALLBACKS!\nconst dib = getCampoInvoice(CI.dib) || resumo.dib || dados.dib || '';\nconst dip = getCampoInvoice(CI.dip) || dados.dip || '';\nconst dcb = getCampoInvoice(CI.dcb) || resumo.dcb || dados.dcb || '';\nconst dataAtualizacaoExtrato = getCampoInvoice(CI.data_atualizacao_extrato) || getCampoInvoice(CI.status_extrato) || '';\n\n// Banco - COM FALLBACKS!\nconst bancoIdOriginal = getCampoInvoice(CI.banco) || null;\nconst bancoIdConvertido = BANCO_DEAL_TO_INVOICE[bancoIdOriginal] || bancoIdOriginal;\nconst enderecoBanco = getCampoInvoice(CI.endereco_banco) || dados.endereco_banco || '';\n\n// CompetÃªncias - COM FALLBACKS!\nconst competenciaInicial = getCampoInvoice(CI.competencia) || '';\nconst competFinalExtrato = getCampoInvoice(CI.compet_final) || getCampoInvoice(CI.compet_final_extrato) || '';\nconst periodo = getCampoInvoice(CI.periodo) || '';\nconst ultimaCompetenciaValida = getCampoInvoice(CI.ultima_competencia_valida) || '';\nconst diasRestantes = pv(getCampoInvoice(CI.dias_restantes_cliente) || 0);\n\n// EspÃ©cie\nconst especie = getCampoInvoice(CI.especie_beneficio) || '80';\n\n// AlÃ­quota e Regra\nconst aliquotaStartBase = getCampoInvoice(CI.aliquota_start_aplicada) || '';\nconst regraAplicadaBase = getCampoInvoice(CI.regra_aplicada) || '';\n\n// Dados pessoais do Deal (via campos_invoice do 6D) - COM FALLBACKS!\nconst dnMamae = getCampoInvoice(CI.dn_mamae) || '';\nconst dnFilho = getCampoInvoice(CI.dn_filho) || '';\nconst nomeFilho = getCampoInvoice(CI.nome_filho) || '';\nconst categoria = getCampoInvoice(CI.categoria) || '';\nconst rg = getCampoInvoice(CI.rg) || '';\nconst telefone2 = getCampoInvoice(CI.telefone_2) || '';\nconst telefone3 = getCampoInvoice(CI.telefone_3) || '';\nconst senha = getCampoInvoice(CI.senha) || '';\nconst dddCliente = getCampoInvoice(CI.ddd_cliente) || '';\nconst ultimoRelacionador = getCampoInvoice(CI.ultimo_relacionador) || '';\nconst dataConcessao = getCampoInvoice(CI.data_concessao) || '';\nconst dataRequerimento = getCampoInvoice(CI.data_requerimento) || '';\n\n// Total de parcelas\nconst totalParcelas = faturasCriar.length;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CASO 3 â€” FATURAS VÃLIDAS: MONTAR BODY PARA CADA UMA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn faturasCriar.map((f, index) => {\n  \n  // â”€â”€â”€ DADOS DA PARCELA â”€â”€â”€\n  const parcela = f.parcela || index + 1;\n  const competencia = f.competencia_final || f.competencia || competenciaInicial || '';\n  const competenciaFinal = f.competencia_final || competencia;\n  const periodoFatura = f.periodo || periodo || '';\n  const dataInss = f.data_pagamento || f.data_inss || '';\n  \n  // â”€â”€â”€ VALORES DA PARCELA â”€â”€â”€\n  const valorInss = pv(f.valor_inss || f.valor_total_inss || 0);\n  const valorStart = pv(f.valor_start || 0);\n  const valorCliente = pv(f.valor_cliente || 0);\n  const saldoDepois = pv(f.saldo_start_depois || f.saldo_depois || 0);\n  \n  // â”€â”€â”€ ALÃQUOTA E REGRA â”€â”€â”€\n  const aliquotaStart = f.aliquota || f.aliquota_texto || aliquotaStartBase || '';\n  const regra = f.regra || regraAplicadaBase || '';\n  \n  // â”€â”€â”€ RESPONSÃVEL â”€â”€â”€\n  const responsavelId = f.responsavel_id || 178122;\n  \n  // â”€â”€â”€ TÃTULO â”€â”€â”€\n  const titulo = `SM ${nomeCliente} - Parcela ${parcela}/${totalParcelas} - ${competencia}`;\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ”¥ V25: MONTAR FIELDS - SPREAD AUTOMÃTICO + SOBRESCRITAS\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // 1. COPIA TUDO do campos_invoice convertido (79 campos do 6D!)\n  // 2. SOBRESCREVE campos especÃ­ficos da parcela\n  // 3. ADICIONA campos calculados com fallbacks\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  \n  const fields = {\n    // â•â•â• 1. COPIAR TUDO DO 6D (79 campos automaticamente!) â•â•â•\n    ...camposInvoiceConvertidos,\n    \n    // â•â•â• 2. CAMPOS DO SISTEMA (obrigatÃ³rios) â•â•â•\n    title: titulo,\n    stageId: 'DT31_40:NEW',\n    categoryId: 2,\n    assignedById: responsavelId,\n    parentId2: dealId,\n    \n    // â•â•â• 3. IDENTIFICAÃ‡ÃƒO (com fallbacks) â•â•â•\n    [CI.cpf]: cpf,\n    [CI.nb]: nb,\n    [CI.nit]: nit,\n    [CI.mr_cliente]: String(mr),\n    [CI.mr_cliente_money]: formatarMoney(mr),\n    [CI.rg]: rg,\n    [CI.categoria]: categoria,\n    [CI.nome_filho]: nomeFilho,\n    \n    // â•â•â• 4. DADOS PESSOAIS (com fallbacks) â•â•â•\n    [CI.dn_mamae]: formatarData(dnMamae),\n    [CI.dn_filho]: formatarData(dnFilho),\n    [CI.telefone_2]: telefone2,\n    [CI.telefone_3]: telefone3,\n    [CI.senha]: senha,\n    [CI.ddd_cliente]: dddCliente,\n    [CI.ultimo_relacionador]: ultimoRelacionador,\n    \n    // â•â•â• 5. VALORES 120 DIAS (com fallbacks) â•â•â•\n    [CI.valor_total_beneficio_120d]: tr(valorTotalBeneficio),\n    [CI.valor_diario]: tr(valorDiario),\n    [CI.valor_total_start_30]: tr(valorTotalStart),\n    [CI.valor_liquido_mensal]: tr(valorLiquidoMensal),\n    [CI.valor_total_beneficio]: tr(valorTotalBeneficio),\n    [CI.valor_total_beneficio_alt]: tr(valorTotalBeneficio),\n    \n    // â•â•â• 6. PARCELA (especÃ­fico por fatura - SOBRESCREVE) â•â•â•\n    [CI.parcela_numero]: `${parcela}/${totalParcelas}`,\n    [CI.parcela_atual]: String(parcela),\n    [CI.quantidade_parcelas]: String(totalParcelas),\n    [CI.valor_inss]: String(tr(valorInss)),\n    [CI.valor_cliente]: String(tr(valorCliente)),\n    [CI.valor_previsto]: String(tr(valorStart)),\n    [CI.valor_restante_inss]: tr(saldoDepois),\n    \n    // â•â•â• 7. ALÃQUOTAS E REGRAS (podem variar por parcela) â•â•â•\n    [CI.aliquota_mr]: tr(aliquotaMr * 100),\n    [CI.aliquota_start_aplicada]: aliquotaStart,\n    [CI.regra_aplicada]: regra,\n    [CI.saldo_restante_start]: tr(saldoDepois),\n    \n    // â•â•â• 8. COMPETÃŠNCIAS (variam por parcela - SOBRESCREVE) â•â•â•\n    [CI.competencia]: competencia,\n    [CI.periodo]: periodoFatura,\n    [CI.compet_final]: competenciaFinal,\n    [CI.compet_final_extrato]: competFinalExtrato,\n    [CI.ultima_competencia_valida]: ultimaCompetenciaValida,\n    [CI.dias_restantes_cliente]: String(diasRestantes),\n    \n    // â•â•â• 9. DATAS (com formataÃ§Ã£o) â•â•â•\n    [CI.data_inss]: formatarData(dataInss),\n    [CI.dib]: formatarData(dib),\n    [CI.dcb]: formatarData(dcb),\n    [CI.dip]: formatarData(dip),\n    [CI.data_concessao]: formatarData(dataConcessao),\n    [CI.data_requerimento]: formatarData(dataRequerimento),\n    [CI.data_atualizacao_extrato]: formatarData(dataAtualizacaoExtrato),\n    \n    // â•â•â• 10. BANCO (ID convertido) â•â•â•\n    [CI.banco]: bancoIdConvertido,\n    [CI.endereco_banco]: enderecoBanco,\n    \n    // â•â•â• 11. ESPÃ‰CIE â•â•â•\n    [CI.especie_beneficio]: especie,\n    \n    // â•â•â• 12. DARF â•â•â•\n    [CI.valor_darf]: 0,\n  };\n  \n  // â”€â”€â”€ LIMPAR CAMPOS VAZIOS â”€â”€â”€\n  const fieldsLimpos = limparCamposVazios(fields);\n  \n  // â”€â”€â”€ DEBUG DETALHADO DOS CAMPOS CRÃTICOS â”€â”€â”€\n  const debugCamposCriticos = {\n    cpf: { valor: cpf, fonte: cpf ? 'campos_invoice/fallback' : 'VAZIO' },\n    nit: { valor: nit, fonte: nit ? 'campos_invoice/fallback' : 'VAZIO' },\n    nb: { valor: nb, fonte: nb ? 'campos_invoice/fallback' : 'VAZIO' },\n    dib: { valor: dib, fonte: dib ? 'campos_invoice/fallback' : 'VAZIO' },\n    dcb: { valor: dcb, fonte: dcb ? 'campos_invoice/fallback' : 'VAZIO' },\n    dip: { valor: dip, fonte: dip ? 'campos_invoice/fallback' : 'VAZIO' },\n    mr: { valor: mr, fonte: mr ? 'campos_invoice/fallback' : 'VAZIO' },\n    endereco_banco: { valor: enderecoBanco, fonte: enderecoBanco ? 'campos_invoice/fallback' : 'VAZIO' },\n    banco_id: { original: bancoIdOriginal, convertido: bancoIdConvertido },\n    dn_mamae: { valor: dnMamae, fonte: dnMamae ? 'campos_invoice' : 'VAZIO' },\n    dn_filho: { valor: dnFilho, fonte: dnFilho ? 'campos_invoice' : 'VAZIO' },\n    categoria: { valor: categoria, fonte: categoria ? 'campos_invoice' : 'VAZIO' },\n    senha: { valor: senha ? '***' : 'VAZIO', fonte: senha ? 'campos_invoice' : 'VAZIO' },\n    rg: { valor: rg, fonte: rg ? 'campos_invoice' : 'VAZIO' },\n    telefone_2: { valor: telefone2, fonte: telefone2 ? 'campos_invoice' : 'VAZIO' },\n    telefone_3: { valor: telefone3, fonte: telefone3 ? 'campos_invoice' : 'VAZIO' },\n    ddd_cliente: { valor: dddCliente, fonte: dddCliente ? 'campos_invoice' : 'VAZIO' },\n    ultimo_relacionador: { valor: ultimoRelacionador, fonte: ultimoRelacionador ? 'campos_invoice' : 'VAZIO' },\n  };\n  \n  // â”€â”€â”€ DEBUG GERAL â”€â”€â”€\n  const debugGeral = {\n    parcela: parcela,\n    total_parcelas: totalParcelas,\n    competencia: competencia,\n    valor_inss: valorInss,\n    valor_start: valorStart,\n    valor_cliente: valorCliente,\n    aliquota_start: aliquotaStart,\n    regra: regra,\n    saldo_depois: saldoDepois,\n    \n    // EstatÃ­sticas de campos\n    campos_6d_original: Object.keys(camposInvoiceOriginal).length,\n    campos_6d_convertidos: Object.keys(camposInvoiceConvertidos).length,\n    campos_finais: Object.keys(fieldsLimpos).length,\n    \n    // Exemplo de conversÃ£o\n    conversao_exemplo: {\n      original: 'UF_CRM_652439CFE551C',\n      convertido: 'ufCrm_652439CFE551C'\n    },\n    \n    fonte_dados: '$input.first().json (6D) + spread automÃ¡tico + fallbacks',\n    campos_criticos: debugCamposCriticos\n  };\n  \n  // â”€â”€â”€ RETORNAR ITEM â”€â”€â”€\n  return {\n    json: {\n      body: {\n        entityTypeId: 31,\n        fields: fieldsLimpos\n      },\n      \n      anti_dup: {\n        deal_id: dealId,\n        parcela: parcela,\n        competencia: competencia,\n        data_inss: dataInss,\n        titulo: titulo\n      },\n      \n      pular: false,\n      permitido_criar: true,\n      status: 'CRIAR_FATURA',\n      \n      debug: debugGeral,\n      resumo: resumo,\n      auditoria: auditoria,\n      tags: tags,\n      \n      _versao: 'V25'\n    }\n  };\n});"
      },
      "id": "c775b9a1-d646-4f58-9460-caf398f3aed1",
      "name": "9. Preparar Fatura",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7744,
        26128
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/crm.item.add",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8192,
        26128
      ],
      "id": "3382e256-77a7-4937-be74-633f4af61b1e",
      "name": "10. Criar Fatura"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 14 - PROCESSAR RESPOSTA FATURA (V23 - COM CAPTURA DE IDS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Processar resposta apÃ³s criaÃ§Ã£o das faturas\n// ENTRADA: Output do 13. Atualizar Deal (via 13A. IF Pular)\n// SAÃDA: Dados formatados para prÃ³ximos nÃ³s COM IDS DAS FATURAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// ATUALIZAÃ‡ÃƒO V23 (08/01/2026):\n// âœ… MANTÃ‰M TUDO DO V22-COMPATIVEL-ASAAS\n// âœ… ğŸ”¥ CAPTURA IDS DAS FATURAS DO NÃ“ 10 (Criar Fatura)\n// âœ… GERA LINKS CORRETOS PARA AS FATURAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a (nÃ£o quebra se nÃ£o existir)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\nconst buscarTodosNo = (nomeNo) => {\n  try {\n    return $(nomeNo).all() || [];\n  } catch (e) {\n    return [];\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ CAPTURAR IDS DAS FATURAS CRIADAS NO NÃ“ 10\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst resultadosNo10 = buscarTodosNo('10. Criar Fatura');\nconst idsFromNo10 = resultadosNo10.map(item => {\n  const invoiceId = item.json?.result?.item?.id;\n  return {\n    invoice_id: invoiceId,\n    link: invoiceId ? `https://startprev.bitrix24.com.br/crm/type/31/details/${invoiceId}/` : null,\n    title: item.json?.result?.item?.title || '',\n    // Extrair parcela do tÃ­tulo (ex: \"SM MARIA - Parcela 1/3 - 01/2026\")\n    parcela_extraida: (() => {\n      const match = (item.json?.result?.item?.title || '').match(/Parcela (\\d+)/i);\n      return match ? parseInt(match[1]) : null;\n    })()\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DOS NÃ“S (com fallback seguro)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst relatorio = buscarNo('12. Gerar RelatÃ³rio HTML');\nconst consolidar = buscarNo('11. Consolidar');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados9 = buscarNo('9. Preparar Fatura');\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\n\n// Resposta do Atualizar Deal (nÃ³ anterior direto)\nconst resp = $json || {};\nconst dealAtualizado = resp.result === true;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS COM FALLBACKS MÃšLTIPLOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Dados das faturas (dos nÃ³s anteriores - sem IDs ainda)\nconst faturasSemId = \n  relatorio.faturas_criadas || \n  consolidar.faturas_criadas || \n  dados9.faturas_criar ||\n  dados6D.faturas_criar ||\n  [];\n\nconst faturasErro = \n  relatorio.faturas_erro || \n  consolidar.faturas_erro || \n  [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ MESCLAR FATURAS COM IDS DO NÃ“ 10\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst faturasCriadas = faturasSemId.map((fatura, index) => {\n  // Tentar encontrar o ID correspondente pelo Ã­ndice ou pela parcela\n  let idInfo = idsFromNo10[index];\n  \n  // Se nÃ£o encontrou pelo Ã­ndice, tentar pela parcela\n  if (!idInfo?.invoice_id && fatura.parcela) {\n    idInfo = idsFromNo10.find(i => i.parcela_extraida === fatura.parcela);\n  }\n  \n  return {\n    ...fatura,\n    invoice_id: idInfo?.invoice_id || fatura.invoice_id || fatura.id || null,\n    link: idInfo?.link || fatura.link || null\n  };\n});\n\nconst totalCriadas = faturasCriadas.length;\nconst totalErro = faturasErro.length;\n\n// Resumo (mÃºltiplas fontes)\nconst resumo = \n  relatorio.resumo || \n  consolidar.resumo || \n  normalizador.resumo || \n  dados6D.resumo ||\n  dados9.resumo ||\n  {};\n\n// Deal ID (mÃºltiplas fontes)\nconst dealId = \n  relatorio.deal_id || \n  consolidar.deal_id || \n  normalizador.deal_id || \n  dados6D.deal_id ||\n  dados1B.deal_id ||\n  dados9.deal_id ||\n  0;\n\n// Status geral\nconst status = \n  relatorio.status || \n  consolidar.status || \n  dados6D.status ||\n  (dealAtualizado ? 'SUCESSO' : 'PENDENTE');\n\nconst sucesso = (status === 'SUCESSO' || status === 'OK') && dealAtualizado;\n\n// IDs das faturas criadas (agora com IDs reais!)\nconst idsInvoices = faturasCriadas\n  .map(f => f.invoice_id)\n  .filter(Boolean);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst asaasBoleto = dados9C.asaas_boleto_criado || false;\nconst asaasPaymentId = dados9C.asaas_payment_id || '';\nconst asaasBoletoUrl = dados9C.asaas_boleto_url || '';\nconst asaasInvoiceUrl = dados9C.asaas_invoice_url || '';\nconst asaasNossoNumero = dados9C.asaas_nosso_numero || '';\nconst asaasVencimento = dados9C.asaas_vencimento || '';\nconst asaasValor = dados9C.asaas_valor || 0;\nconst asaasStatus = dados9C.asaas_status || '';\nconst asaasCustomerId = dados9C.asaas_customer_id || '';\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '';\n  try {\n    const d = new Date(dataStr);\n    return d.toLocaleDateString('pt-BR');\n  } catch (e) {\n    return dataStr;\n  }\n};\n\nconst vencimentoFormatado = formatarData(asaasVencimento);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ENRIQUECER FATURAS COM DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst faturasCriadasComAsaas = faturasCriadas.map((fatura, index) => {\n  const isParcelaAtual = index === 0;\n  \n  return {\n    ...fatura,\n    // Dados do Asaas (sÃ³ na parcela atual)\n    asaas_payment_id: isParcelaAtual ? asaasPaymentId : '',\n    asaas_boleto_url: isParcelaAtual ? asaasBoletoUrl : '',\n    asaas_invoice_url: isParcelaAtual ? asaasInvoiceUrl : '',\n    asaas_nosso_numero: isParcelaAtual ? asaasNossoNumero : '',\n    asaas_vencimento: isParcelaAtual ? vencimentoFormatado : '',\n    asaas_status: isParcelaAtual ? asaasStatus : '',\n    tem_boleto: isParcelaAtual && asaasBoleto\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Status\n  sucesso: sucesso,\n  status: status,\n  deal_atualizado: dealAtualizado,\n  \n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  \n  // Faturas (AGORA COM IDS E LINKS!)\n  faturas_criadas: faturasCriadasComAsaas,\n  faturas_erro: faturasErro,\n  total_criadas: totalCriadas,\n  total_erro: totalErro,\n  ids_invoices: idsInvoices,\n  \n  // Resumo para mensagens\n  resumo: resumo,\n  nome_cliente: resumo.nome || dados1B.nome || '',\n  cpf: resumo.cpf || resumo.cpf_formatado || dados1B.cpf_formatado || dados1B.cpf || '',\n  nb: resumo.nb || resumo.nb_formatado || dados1B.nb_formatado || dados1B.nb || '',\n  mr: resumo.mr || 0,\n  mr_formatado: resumo.mr_formatado || '',\n  honorarios_start: resumo.honorarios_start || resumo.total_start || 0,\n  honorarios_start_formatado: resumo.honorarios_start_formatado || '',\n  saldo_final: resumo.saldo_start_final || resumo.saldo_final || 0,\n  saldo_final_formatado: resumo.saldo_start_final_formatado || '',\n  \n  // Auditoria\n  auditoria: relatorio.auditoria || consolidar.auditoria || dados6D.auditoria || {},\n  tags: relatorio.tags || consolidar.tags || dados6D.tags || [],\n  \n  // Extras para compatibilidade\n  config: dados1B.config || {},\n  links: dados1B.links || {},\n  \n  // DADOS DO ASAAS\n  asaas: {\n    boleto_criado: asaasBoleto,\n    payment_id: asaasPaymentId,\n    boleto_url: asaasBoletoUrl,\n    invoice_url: asaasInvoiceUrl,\n    nosso_numero: asaasNossoNumero,\n    vencimento: asaasVencimento,\n    vencimento_formatado: vencimentoFormatado,\n    valor: asaasValor,\n    status: asaasStatus,\n    customer_id: asaasCustomerId\n  },\n  tem_boleto: asaasBoleto,\n  \n  // Debug\n  _debug: {\n    versao: 'V23-COM-IDS',\n    ids_capturados_no10: idsFromNo10,\n    total_ids_no10: idsFromNo10.length,\n    ids_invoices_final: idsInvoices,\n    fontes_encontradas: {\n      relatorio: !!relatorio.deal_id,\n      consolidar: !!consolidar.deal_id,\n      normalizador: !!normalizador.deal_id,\n      dados6D: !!dados6D.deal_id,\n      dados1B: !!dados1B.deal_id,\n      dados9: !!dados9.deal_id,\n      dados9C: !!dados9C.asaas_boleto_criado,\n      no10: idsFromNo10.length > 0\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8640,
        25936
      ],
      "id": "33115f0f-1420-47bf-a960-cc2a9de22477",
      "name": "14. Processar Resposta Fatura"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/im.message.add",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "DIALOG_ID",
              "value": "chat282584"
            },
            {
              "name": "MESSAGE",
              "value": "==âœ… [B]FATURAMENTO CONCLUÃDO COM SUCESSO[/B]\n\nğŸ“‹ [B]NegÃ³cio:[/B] #{{ $json.deal_id }}\nğŸ”— https://startprev.bitrix24.com.br/crm/deal/details/{{ $json.deal_id }}/\n\nğŸ‘¤ [B]Cliente:[/B] {{ ($json.nome_cliente || 'N/A').replace(/[\"\\\\n]/g, ' ') }}\nğŸ“„ [B]CPF:[/B] {{ $json.cpf || 'N/A' }}\nğŸ« [B]NB:[/B] {{ $json.nb || 'N/A' }}\nğŸ’° [B]MR:[/B] {{ $json.mr_formatado || 'N/A' }}\n\nğŸ“Š [B]FATURAS CRIADAS: {{ $json.total_criadas || 0 }}[/B]\n\n{{ ($json.itens_criados || []).map(f => 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\nğŸ“Œ [B]Parcela ' + f.parcela + '/' + (f.total_parcelas || $json.total_criadas) + ' - ' + (f.competencia || '') + '[/B]\\\\nğŸ’µ Valor INSS: R$ ' + Number(f.valor_inss || 0).toFixed(2).replace('.', ',') + '\\\\nğŸ’¼ Valor Start: R$ ' + Number(f.valor_start || 0).toFixed(2).replace('.', ',') + (f.valor_darf_rateado > 0 ? ' + R$ ' + Number(f.valor_darf_rateado).toFixed(2).replace('.', ',') + ' DARF' : '') + '\\\\nğŸ‘© Valor Cliente: R$ ' + Number(f.valor_cliente || 0).toFixed(2).replace('.', ',') + '\\\\nğŸ”— Fatura: https://startprev.bitrix24.com.br/crm/type/31/details/' + (f.invoice_id || '') + '/\\\\nğŸ« Boleto: ' + (f.boleto_url || f.asaas_boleto_url || 'NÃ£o gerado')).join('\\\\n\\\\n') }}\n\n{{ $json.tem_darf ? 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\\\nğŸ’³ [B]DARF (START IRÃ PAGAR)[/B]\\\\nğŸ’µ Valor Total: ' + ($json.darf?.valor_total_formatado || 'R$ 0,00') + '\\\\nğŸ“Š Rateado em: ' + ($json.darf?.qtd_parcelas || 0) + ' parcela(s)\\\\nğŸ’° Valor/Parcela: ' + ($json.darf?.valor_por_parcela_formatado || 'R$ 0,00') + '\\\\nâœ… Cliente reembolsa Start via faturas' : '' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸŸ¢ Processo concluÃ­do!"
            }
          ]
        },
        "options": {}
      },
      "id": "8455b99c-9a31-4d69-b65b-058cbc4f5a95",
      "name": "16. Chat Sucesso",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        9088,
        25936
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "warn",
              "leftValue": "={{ ($json.alertas_lista || []).filter(a => a.tipo === 'WARNING').length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ab2ae438-529d-4fd3-a304-e03e4c3407f8",
      "name": "17 IF Warning",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        9312,
        25936
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/im.message.add",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"DIALOG_ID\": \"chat282150\",\n  \"MESSAGE\": \"âš ï¸ [B]ALERTA DO PROCESSAMENTO[/B]\\n\\nğŸ“‹ Deal: {{ $json.deal_id }}\\nğŸ”— https://startprev.bitrix24.com.br/crm/deal/details/{{ $json.deal_id }}/\\n\\nğŸ‘¤ Cliente: {{ $json.nome_cliente || 'N/A' }}\\n\\nğŸ’° [B]Faturas Criadas:[/B]\\n{{ ($json.itens_criados || []).map(f => 'â€¢ Parcela ' + f.parcela + ' | ' + f.competencia + '\\\\n  ğŸ”— ' + f.link).join('\\\\n') || 'â€” Nenhuma â€”' }}\\n\\nğŸš¨ [B]Alertas:[/B]\\n{{ ($json.alertas_lista || []).map(a => 'â€¢ ' + a.mensagem).join('\\\\n') || 'Sem alertas especÃ­ficos.' }}\\n\\nğŸ‘¤ ResponsÃ¡vel: [USER={{ $('8C. Definir ResponsÃ¡vel').first().json.responsavel.id }}]{{ $('8C. Definir ResponsÃ¡vel').first().json.responsavel.nome }}[/USER]\",\n  \"SYSTEM\": \"Y\"\n}",
        "options": {}
      },
      "id": "39560580-63d6-4d05-9a80-f05162cc405c",
      "name": "18. Chat Warning",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        9536,
        25856
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/im.message.add",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "DIALOG_ID",
              "value": "={{ $json.DIALOG_ID }}"
            },
            {
              "name": "MESSAGE",
              "value": "={{ $json.MESSAGE }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c16c880a-be30-4448-83c1-81e748a1c575",
      "name": "22. Chat Erro",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        7744,
        25600
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7f3c2e72-a0c1-4502-b98f-6ce4599a9a2f",
      "name": "23. Responder ERRO",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [
        7968,
        25568
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 12 - GERAR RELATÃ“RIO HTML (V8 - ASAAS CAMELCASE FIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Mescla campos_invoice do 6D com fields do nÃ³ 9, adiciona HTML + ASAAS\n// ENTRADA: Output do 9C. Processar Resposta Asaas\n// SAÃDA: body completo com TODOS os campos + HTML + campos Asaas\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//\n// CHANGELOG V8 (12/01/2026):\n// ğŸ”¥ FIX CRÃTICO: Campos Asaas agora usam ufCrm_ (camelCase) em vez de UF_CRM_\n//    - ANTES (V7): UF_CRM_SMART_INVOICE_1767292172702 âŒ (ignorado pelo Bitrix)\n//    - AGORA (V8): ufCrm_SMART_INVOICE_1767292172702 âœ… (aceito pelo Bitrix)\n// âœ… MANTÃ‰M: Tudo do V7 (mescla 6D + nÃ³ 9 + HTML + Asaas)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO DE BUSCA SEGURA\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nome) => {\n  try {\n    return $(nome).first()?.json || null;\n  } catch (e) {\n    return null;\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PEGAR DADOS DE TODOS OS NÃ“S RELEVANTES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// NÃ³ 9C (anterior direto - tem body + dados do Asaas!)\nconst dadosNo9 = $json || {};\nconst bodyNo9 = dadosNo9.body || {};\nconst fieldsNo9 = bodyNo9.fields || {};\n\n// ğŸ”¥ V7: DADOS DO ASAAS (vindos do 9C)\nconst asaasPaymentId = dadosNo9.asaas_payment_id || '';\nconst asaasBoletoUrl = dadosNo9.asaas_boleto_url || '';\nconst asaasInvoiceUrl = dadosNo9.asaas_invoice_url || '';\nconst asaasNossoNumero = dadosNo9.asaas_nosso_numero || '';\nconst asaasStatus = dadosNo9.asaas_status || '';\nconst asaasCustomerId = dadosNo9.asaas_customer_id || '';\n\n// NÃ³ 6D (tem campos_invoice com valores corretos do Deal!)\nconst dados6D = buscarNo('6D. Revisor de Calculos') || {};\nconst camposInvoice6D = dados6D.campos_invoice || {};\n\n// NÃ³ 1B (deal_id, cpf, nb)\nconst dados1B = buscarNo('1B. Inicializar') || {};\n\n// BUSCAR DEAL (tem os valores reais dos campos)\nconst dadosBuscarDeal = buscarNo('BUSCAR DEAL') || {};\nconst dealData = dadosBuscarDeal.result || dadosBuscarDeal || {};\n\n// Se nÃ£o tem body do nÃ³ 9, algo estÃ¡ errado\nif (!bodyNo9.entityTypeId) {\n  return {\n    ...dadosNo9,\n    _erro_no12: 'Body nÃ£o encontrado do nÃ³ 9',\n    _debug: { bodyNo9, fieldsNo9 }\n  };\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS PARA O HTML\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dealId = dados1B.deal_id || dadosNo9.anti_dup?.deal_id || 0;\nconst resumo = dados6D.resumo || dadosNo9.resumo || {};\nconst faturas_criar = dados6D.faturas_criar || [];\nconst status = dados6D.ok ? 'SUCESSO' : (dados6D.gravidade_maxima || 'OK');\nconst auditoria = dados6D.auditoria || dadosNo9.auditoria || {};\nconst tags = dados6D.tags || dadosNo9.tags || [];\nconst debug = dadosNo9.debug || {};\n\n// Dados do benefÃ­cio\nconst nomeCliente = resumo.nome || dados1B.nome || 'Cliente';\nconst cpf = resumo.cpf_formatado || resumo.cpf || '';\nconst nb = resumo.nb_formatado || resumo.nb || '';\nconst nit = resumo.nit || '';\nconst dib = resumo.dib || '';\nconst dcb = resumo.dcb || '';\nconst dip = resumo.dip || '';\nconst competencia = debug.competencia || resumo.competencia || '';\n\nconst mr = resumo.mr || 0;\nconst mrFormatado = resumo.mr_formatado || `R$ ${Number(mr).toFixed(2).replace('.', ',')}`;\nconst totalBeneficio = resumo.total_120_dias || 0;\nconst totalBeneficioFormatado = `R$ ${Number(totalBeneficio).toFixed(2).replace('.', ',')}`;\n\nconst honorariosStart = resumo.honorarios_start || resumo.total_start || 0;\nconst honorariosStartFormatado = `R$ ${Number(honorariosStart).toFixed(2).replace('.', ',')}`;\nconst saldoFinal = resumo.saldo_start_final || 0;\nconst saldoFinalFormatado = `R$ ${Number(saldoFinal).toFixed(2).replace('.', ',')}`;\n\n// Dados da parcela atual (do debug do nÃ³ 9)\nconst parcelaAtual = debug.parcela || 1;\nconst totalParcelas = debug.total_parcelas || faturas_criar.length || 1;\nconst valorInss = debug.valor_inss || 0;\nconst valorStart = debug.valor_start || 0;\nconst valorCliente = debug.valor_cliente || 0;\nconst aliquotaStart = debug.aliquota_start || '';\nconst regra = debug.regra || '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HELPERS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst formatarMoeda = (valor) => {\n  const num = typeof valor === 'number' ? valor : parseFloat(valor) || 0;\n  return `R$ ${num.toFixed(2).replace('.', ',')}`;\n};\n\nconst formatarCPF = (cpf) => {\n  const nums = String(cpf).replace(/\\D/g, '');\n  if (nums.length !== 11) return cpf;\n  return `${nums.slice(0,3)}.${nums.slice(3,6)}.${nums.slice(6,9)}-${nums.slice(9)}`;\n};\n\nconst formatarData = (data) => {\n  if (!data) return '-';\n  const str = String(data);\n  if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n    const [y, m, d] = str.split('T')[0].split('-');\n    return `${d}/${m}/${y}`;\n  }\n  return str;\n};\n\nconst calcularProgresso = () => {\n  if (honorariosStart <= 0) return 100;\n  const cobrado = honorariosStart - saldoFinal;\n  return Math.min(100, Math.round((cobrado / honorariosStart) * 100));\n};\n\n// Destaques\nconst destaques = [];\nif (saldoFinal <= 0 || regra?.includes('QUIT') || regra?.includes('COBRA_TUDO')) {\n  destaques.push({ emoji: 'ğŸ¯', texto: 'QUITAÃ‡ÃƒO', cor: '#27AE60' });\n}\nif (mr >= 3000) {\n  destaques.push({ emoji: 'â­', texto: 'ALTO VALOR', cor: '#F4D03F' });\n}\n// ğŸ”¥ V7: Mostrar se tem boleto Asaas\nif (asaasPaymentId) {\n  destaques.push({ emoji: 'ğŸ«', texto: 'BOLETO ASAAS', cor: '#2E86AB' });\n}\ndestaques.push({ emoji: 'ğŸ¤–', texto: 'AUTOMÃTICO', cor: '#5D6D7E' });\n\nconst gerarBadges = () => destaques.map(d => \n  `<span style=\"display:inline-block;background:${d.cor}20;color:${d.cor};padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin:2px;\">${d.emoji} ${d.texto}</span>`\n).join(' ');\n\nconst gerarTags = () => {\n  if (tags.length === 0) return '';\n  return tags.slice(0, 8).map(tag => {\n    let cor = '#5D6D7E';\n    if (tag.startsWith('E_')) cor = '#E74C3C';\n    else if (tag.startsWith('A_')) cor = '#F39C12';\n    else if (tag.startsWith('OK_')) cor = '#27AE60';\n    return `<span style=\"background:${cor}15;color:${cor};padding:2px 6px;border-radius:3px;font-size:9px;margin:1px;\">${tag}</span>`;\n  }).join(' ');\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// GERAR HTML\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst progresso = calcularProgresso();\nconst timestamp = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });\nconst statusEmoji = status === 'SUCESSO' ? 'âœ…' : status === 'ALERTA' ? 'âš ï¸' : 'âŒ';\nconst statusCor = status === 'SUCESSO' ? '#27AE60' : status === 'ALERTA' ? '#F39C12' : '#E74C3C';\nconst urlDeal = `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`;\n\n// ğŸ”¥ V7: SeÃ§Ã£o do boleto no HTML (se tiver)\nconst secaoBoleto = asaasPaymentId ? `\n  <div class=\"s\">\n    <div class=\"st\">ğŸ« Boleto Asaas</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">ID Asaas</span><span class=\"fv d\">${asaasPaymentId}</span></div>\n      <div class=\"f\"><span class=\"fl\">Status</span><span class=\"fv\">${asaasStatus || 'PENDING'}</span></div>\n      <div class=\"f\"><span class=\"fl\">Nosso NÃºmero</span><span class=\"fv\">${asaasNossoNumero || '-'}</span></div>\n      <div class=\"f\"><span class=\"fl\">Link Boleto</span><span class=\"fv\"><a href=\"${asaasBoletoUrl}\" target=\"_blank\" style=\"color:#2E86AB\">ğŸ“„ PDF</a></span></div>\n    </div>\n  </div>\n` : '';\n\nconst html = `<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Fatura ${parcelaAtual}/${totalParcelas} - ${nomeCliente}</title>\n  <style>\n    *{margin:0;padding:0;box-sizing:border-box}\n    body{font-family:'Segoe UI',Arial,sans-serif;background:#F4F6F7;padding:12px;color:#5D6D7E;font-size:12px}\n    .c{max-width:700px;margin:0 auto;background:#fff;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow:hidden}\n    .h{background:linear-gradient(135deg,#1A5276,#2E86AB);color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}\n    .h h1{font-size:16px;margin-bottom:3px}\n    .h .sub{font-size:11px;opacity:0.9}\n    .badge{background:#27AE60;color:#fff;padding:5px 10px;border-radius:12px;font-size:11px;font-weight:600}\n    .s{padding:12px 15px;border-bottom:1px solid #AEB6BF}\n    .st{color:#1A5276;font-size:13px;font-weight:600;margin-bottom:10px;padding-bottom:5px;border-bottom:2px solid #F4D03F;display:inline-block}\n    .g{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}\n    .g4{grid-template-columns:repeat(4,1fr)}\n    .f{display:flex;flex-direction:column}\n    .fl{font-size:9px;color:#AEB6BF;text-transform:uppercase;margin-bottom:2px}\n    .fv{font-size:12px;color:#5D6D7E;font-weight:500}\n    .fv.d{color:#2E86AB;font-weight:600}\n    .fv.m{color:#27AE60;font-weight:600}\n    .ds{text-align:center;padding:8px;background:#F4F6F7;border-radius:5px;margin:8px 0}\n    .pb{margin:10px 0}\n    .pbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px}\n    .pbr{height:6px;background:#AEB6BF;border-radius:3px;overflow:hidden}\n    .pbf{height:100%;background:linear-gradient(90deg,#2E86AB,#27AE60);border-radius:3px}\n    .tot{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;padding-top:10px;border-top:2px solid #AEB6BF}\n    .ti{text-align:center;padding:10px;background:#F4F6F7;border-radius:5px}\n    .ti label{font-size:9px;color:#5D6D7E;text-transform:uppercase}\n    .ti .v{font-size:14px;font-weight:700;margin-top:3px}\n    .ti .v.ve{color:#27AE60}\n    .ti .v.vm{color:#E74C3C}\n    .ti .v.az{color:#2E86AB}\n    .tg{margin-top:8px}\n    .ft{background:#5D6D7E;color:#fff;padding:10px 15px;font-size:10px;text-align:center}\n    .ft a{color:#F4D03F;text-decoration:none}\n    @media(max-width:500px){.g,.g4{grid-template-columns:1fr}.tot{grid-template-columns:1fr}}\n  </style>\n</head>\n<body>\n<div class=\"c\">\n  <div class=\"h\">\n    <div>\n      <h1>ğŸ“‹ Fatura ${parcelaAtual}/${totalParcelas}</h1>\n      <div class=\"sub\">Start Assessoria - Workflow AutomÃ¡tico</div>\n    </div>\n    <div style=\"text-align:right\">\n      <span class=\"badge\">${statusEmoji} ${status}</span>\n      <div style=\"font-size:10px;margin-top:5px\">Deal #${dealId}</div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ‘¤ BeneficiÃ¡rio</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">Nome</span><span class=\"fv d\">${nomeCliente}</span></div>\n      <div class=\"f\"><span class=\"fl\">CPF</span><span class=\"fv\">${formatarCPF(cpf)}</span></div>\n      <div class=\"f\"><span class=\"fl\">NB</span><span class=\"fv\">${nb || '-'}</span></div>\n      <div class=\"f\"><span class=\"fl\">NIT</span><span class=\"fv\">${nit || '-'}</span></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ“… Datas</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">DIB</span><span class=\"fv\">${formatarData(dib)}</span></div>\n      <div class=\"f\"><span class=\"fl\">DCB</span><span class=\"fv\">${formatarData(dcb)}</span></div>\n      <div class=\"f\"><span class=\"fl\">DIP</span><span class=\"fv\">${formatarData(dip)}</span></div>\n      <div class=\"f\"><span class=\"fl\">CompetÃªncia</span><span class=\"fv\">${competencia || '-'}</span></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ’° Valores desta Parcela</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">Valor INSS</span><span class=\"fv m\">${formatarMoeda(valorInss)}</span></div>\n      <div class=\"f\"><span class=\"fl\">Valor Start</span><span class=\"fv m\">${formatarMoeda(valorStart)}</span></div>\n      <div class=\"f\"><span class=\"fl\">Valor Cliente</span><span class=\"fv m\">${formatarMoeda(valorCliente)}</span></div>\n      <div class=\"f\"><span class=\"fl\">AlÃ­quota</span><span class=\"fv\">${aliquotaStart || '30%'}</span></div>\n    </div>\n    <div class=\"ds\">${gerarBadges()}</div>\n    <div class=\"pb\">\n      <div class=\"pbl\"><span>Progresso CobranÃ§a</span><span>${progresso}%</span></div>\n      <div class=\"pbr\"><div class=\"pbf\" style=\"width:${progresso}%\"></div></div>\n    </div>\n  </div>\n\n  ${secaoBoleto}\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ“Š Resumo Geral (120 dias)</div>\n    <div class=\"g g4\">\n      <div class=\"f\"><span class=\"fl\">MR Bruto</span><span class=\"fv m\">${mrFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">Total BenefÃ­cio</span><span class=\"fv m\">${totalBeneficioFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">HonorÃ¡rios Start</span><span class=\"fv m\">${honorariosStartFormatado}</span></div>\n      <div class=\"f\"><span class=\"fl\">Saldo Restante</span><span class=\"fv m\">${saldoFinalFormatado}</span></div>\n    </div>\n    <div class=\"tot\">\n      <div class=\"ti\"><label>Total BenefÃ­cio</label><div class=\"v az\">${totalBeneficioFormatado}</div></div>\n      <div class=\"ti\"><label>HonorÃ¡rios Start</label><div class=\"v vm\">${honorariosStartFormatado}</div></div>\n      <div class=\"ti\"><label>Saldo Restante</label><div class=\"v ${saldoFinal <= 0 ? 've' : 'vm'}\">${saldoFinalFormatado}</div></div>\n    </div>\n  </div>\n\n  <div class=\"s\">\n    <div class=\"st\">ğŸ” Auditoria</div>\n    <div class=\"g\">\n      <div class=\"f\"><span class=\"fl\">Problemas</span><span class=\"fv\">${auditoria.total_problemas || 0}</span></div>\n      <div class=\"f\"><span class=\"fl\">Alertas</span><span class=\"fv\">${auditoria.total_alertas || 0}</span></div>\n    </div>\n    <div class=\"tg\">${gerarTags()}</div>\n  </div>\n\n  <div class=\"ft\">\n    ğŸ“… ${timestamp} | <a href=\"${urlDeal}\" target=\"_blank\">Abrir Deal #${dealId}</a> | Regra: ${regra || '-'} | Faturista v8\n  </div>\n</div>\n</body>\n</html>`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ CRÃTICO V8: IDs DOS CAMPOS ASAAS EM CAMELCASE!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// V7 usava UF_CRM_ (uppercase) - Bitrix IGNORAVA esses campos!\n// V8 usa ufCrm_ (camelCase) - Bitrix ACEITA esses campos!\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ğŸ”¥ V8 FIX: CAMELCASE para Smart Process (entityTypeId 31)!\nconst CI_ASAAS_ID = 'ufCrm_SMART_INVOICE_1767292172702';     // âœ… camelCase\nconst CI_BOLETO_URL = 'ufCrm_SMART_INVOICE_1767292205661';   // âœ… camelCase\n\n// 1. ComeÃ§ar com campos_invoice do 6D (tem dn_mamae, dn_filho, etc.)\n// 2. Sobrescrever com fields do nÃ³ 9 (tem campos especÃ­ficos da parcela)\n// 3. Adicionar o HTML\n// 4. ğŸ”¥ V8: Adicionar campos do Asaas COM CAMELCASE!\n\nconst fieldsMesclados = {\n  // ğŸ”¥ PRIMEIRO: Campos do 6D (valores do Deal - dn_mamae, dn_filho, etc.)\n  ...camposInvoice6D,\n  \n  // ğŸ”¥ SEGUNDO: Campos do nÃ³ 9 (sobrescreve se conflitar - sÃ£o mais especÃ­ficos da parcela)\n  ...fieldsNo9,\n  \n  // ğŸ”¥ TERCEIRO: HTML do relatÃ³rio\n  'ufCrm_SMART_INVOICE_1767832451': html,\n  \n  // ğŸ”¥ QUARTO (V8): Campos do Asaas COM CAMELCASE!\n  [CI_ASAAS_ID]: asaasPaymentId,\n  [CI_BOLETO_URL]: asaasBoletoUrl,\n};\n\n// Limpar campos vazios/undefined\nconst fieldsLimpos = {};\nfor (const [key, value] of Object.entries(fieldsMesclados)) {\n  if (value !== null && value !== undefined && value !== '' && value !== 'null') {\n    fieldsLimpos[key] = value;\n  }\n}\n\n// Montar body atualizado\nconst bodyAtualizado = {\n  entityTypeId: bodyNo9.entityTypeId || 31,\n  fields: fieldsLimpos\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNAR - BODY COMPLETO COM TODOS OS CAMPOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn {\n  // ğŸ”¥ CRÃTICO: body para o nÃ³ 10 usar!\n  body: bodyAtualizado,\n  \n  // Manter todos os outros campos do nÃ³ 9\n  anti_dup: dadosNo9.anti_dup,\n  pular: dadosNo9.pular,\n  permitido_criar: dadosNo9.permitido_criar,\n  status: dadosNo9.status,\n  debug: dadosNo9.debug,\n  resumo: dadosNo9.resumo,\n  auditoria: dadosNo9.auditoria,\n  tags: dadosNo9.tags,\n  versao: dadosNo9.versao,\n  \n  // ğŸ”¥ V7: Passar dados do Asaas adiante (para outros nÃ³s que precisem)\n  asaas_payment_id: asaasPaymentId,\n  asaas_boleto_url: asaasBoletoUrl,\n  asaas_invoice_url: asaasInvoiceUrl,\n  asaas_nosso_numero: asaasNossoNumero,\n  asaas_status: asaasStatus,\n  asaas_customer_id: asaasCustomerId,\n  \n  // Debug V8\n  _no12_debug: {\n    versao: 'V8',\n    fix_aplicado: 'CAMELCASE para campos Asaas',\n    campos_do_6D: Object.keys(camposInvoice6D).length,\n    campos_do_no9: Object.keys(fieldsNo9).length,\n    campos_mesclados: Object.keys(fieldsLimpos).length,\n    html_adicionado: true,\n    html_tamanho: html.length,\n    campo_html_id: 'ufCrm_SMART_INVOICE_1767832451',\n    \n    // ğŸ”¥ V8: Status dos campos Asaas COM IDs CORRETOS\n    asaas: {\n      payment_id: asaasPaymentId || 'NÃƒO ENCONTRADO',\n      boleto_url: asaasBoletoUrl || 'NÃƒO ENCONTRADO',\n      invoice_url: asaasInvoiceUrl || 'NÃƒO ENCONTRADO',\n      nosso_numero: asaasNossoNumero || '-',\n      status: asaasStatus || '-',\n      customer_id: asaasCustomerId || '-',\n      campo_id_usado: CI_ASAAS_ID,       // ufCrm_ (camelCase) âœ…\n      campo_url_usado: CI_BOLETO_URL,    // ufCrm_ (camelCase) âœ…\n      adicionado_ao_body: !!asaasPaymentId,\n      formato_corrigido: 'V8 usa ufCrm_ em vez de UF_CRM_'\n    },\n    \n    // Verificar campos crÃ­ticos\n    campos_verificados: {\n      asaas_id: fieldsLimpos[CI_ASAAS_ID] ? 'âœ…' : 'âŒ',\n      boleto_url: fieldsLimpos[CI_BOLETO_URL] ? 'âœ…' : 'âŒ',\n      html: fieldsLimpos['ufCrm_SMART_INVOICE_1767832451'] ? 'âœ…' : 'âŒ',\n    },\n    \n    // Prova do fix\n    prova_fix: {\n      v7_errado: 'UF_CRM_SMART_INVOICE_1767292172702',\n      v8_correto: CI_ASAAS_ID,\n      campo_presente_no_body: !!fieldsLimpos[CI_ASAAS_ID]\n    },\n    \n    fontes: {\n      '6D': !!dados6D.campos_invoice,\n      'no9_body': !!bodyNo9.entityTypeId,\n      '1B': !!dados1B.deal_id,\n      'BUSCAR_DEAL': Object.keys(dealData).length > 0,\n      '9C_asaas': !!asaasPaymentId\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7968,
        26128
      ],
      "id": "16c4832c-0a58-4936-8dc5-bf1f8018c4ff",
      "name": "12. Gerar RelatÃ³rio HTML"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "skip",
              "leftValue": "={{ String($json.permitido_criar).trim().toLowerCase() }}\n",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "93741511-3efc-4a10-88d1-ca54c08b49c5",
      "name": "13A. IF Pular",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        8416,
        26128
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/crm.item.list",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"entityTypeId\": 31,\n  \"filter\": {\n    \"parentId2\": {{ $json.deal_id }}\n  },\n  \"order\": {\n    \"id\": \"DESC\"\n  },\n  \"start\": 0\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7072,
        25840
      ],
      "id": "9b8c7c66-aaa3-45b3-bcd8-35d2752698a1",
      "name": "8B. Buscar Ãšltima Invoice"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 8C - DEFINIR RESPONSÃVEL (V3 - DETERMINÃSTICO POR CPF)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Define responsÃ¡vel para as faturas baseado no CPF do cliente\n// ENTRADA: Output do 8B (nÃ£o usado) + dados do 6D\n// SAÃDA: Dados do 6D + responsÃ¡vel definido\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// CHANGELOG V3.0:\n// âœ… NOVO: AlternÃ¢ncia determinÃ­stica por Ãºltimo dÃ­gito do CPF\n// âœ… REMOVIDO: DependÃªncia de busca de outras invoices\n// âœ… VANTAGEM: Mesmo cliente = sempre mesmo responsÃ¡vel\n// âœ… VANTAGEM: Sem race condition, sem falhas de API\n// âœ… DISTRIBUIÃ‡ÃƒO: 50/50 (dÃ­gitos 0-4 = Beatriz, 5-9 = Larissa)\n// \n// CHANGELOG V2:\n// - Buscava Ãºltima invoice de outro CPF (removido - instÃ¡vel)\n// \n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â• CONFIGURAÃ‡ÃƒO DOS RESPONSÃVEIS â•â•â•\nconst RESPONSAVEIS = {\n  BEATRIZ: {\n    id: 178122,\n    nome: 'Beatriz Farias'\n  },\n  LARISSA: {\n    id: 197562,\n    nome: 'Larissa Aparecida'\n  }\n};\n\n// â•â•â• BUSCAR DADOS DO 6D â•â•â•\nconst dados6D = $('6D. Revisor de Calculos').first()?.json || {};\n\n// â•â•â• EXTRAIR CPF â•â•â•\nconst cpfAtual = (dados6D.resumo?.cpf || '').replace(/\\D/g, '');\n\n// â•â•â• DEFINIR RESPONSÃVEL POR CPF (DETERMINÃSTICO) â•â•â•\n// Ãšltimo dÃ­gito do CPF define o responsÃ¡vel\n// 0,1,2,3,4 â†’ Beatriz (50%)\n// 5,6,7,8,9 â†’ Larissa (50%)\nconst ultimoDigito = parseInt(cpfAtual.slice(-1)) || 0;\nconst responsavelEscolhido = (ultimoDigito < 5) \n  ? RESPONSAVEIS.BEATRIZ \n  : RESPONSAVEIS.LARISSA;\n\n// â•â•â• ATUALIZAR FATURAS COM RESPONSÃVEL â•â•â•\nconst faturasCriar = (dados6D.faturas_criar || []).map(f => ({\n  ...f,\n  responsavel_id: responsavelEscolhido.id,\n  responsavel_nome: responsavelEscolhido.nome\n}));\n\n// â•â•â• RETORNO â•â•â•\nreturn {\n  // Tudo do 6D\n  ...dados6D,\n  \n  // Faturas atualizadas com responsÃ¡vel\n  faturas_criar: faturasCriar,\n  \n  // ResponsÃ¡vel definido\n  responsavel: {\n    id: responsavelEscolhido.id,\n    nome: responsavelEscolhido.nome\n  },\n  \n  // Debug\n  _debug_responsavel: {\n    versao: 'V3.0',\n    metodo: 'DETERMINISTICO_CPF',\n    cpf_atual: cpfAtual,\n    ultimo_digito: ultimoDigito,\n    regra: ultimoDigito < 5 ? '0-4 â†’ Beatriz' : '5-9 â†’ Larissa',\n    responsavel_escolhido: responsavelEscolhido.nome,\n    responsavel_id: responsavelEscolhido.id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7296,
        25840
      ],
      "id": "c461edeb-0416-4929-85e1-acd2262f0411",
      "name": "8C. Definir ResponsÃ¡vel"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "57c6ef77-1fd6-419d-98fe-e2ab3b7bbc6d",
      "name": "26. Responder SKIP",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [
        8640,
        26320
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "bd6be2b2-505c-4a43-9a69-5b494da53680",
              "leftValue": "={{ $json.ok }}",
              "rightValue": "True",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        6848,
        25904
      ],
      "id": "4a889cce-f855-4915-aa25-c50f4ad405b2",
      "name": "7. IF ERRO"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 21 - PREPARAR MENSAGEM DE ERRO (V2.1 - ID CORRIGIDO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 29/12/2025\n// \n// FUNCIONALIDADES:\n// âœ… Detecta automaticamente o tipo de erro\n// âœ… Fallbacks robustos para todos os campos\n// âœ… FormataÃ§Ã£o visual para Bitrix Chat\n// âœ… Link direto para o Deal\n// âœ… Timestamp do erro\n// âœ… Suporte a mÃºltiplos problemas\n// âœ… IdentificaÃ§Ã£o de faturas duplicadas\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// CONFIGURAÃ‡ÃƒO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst CONFIG = {\n  CHAT_ERROS: 'chat282150',  // ERROS / DADOS DIVERGENTES NO BITRIX\n  URL_BITRIX: 'https://startprev.bitrix24.com.br',\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// MAPA DE ERROS (cÃ³digo â†’ mensagem amigÃ¡vel)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst ERROS_MAP = {\n  // Erros de PDF/Arquivo\n  'PDF_NAO_ENCONTRADO': {\n    emoji: 'ğŸ“„',\n    titulo: 'PDF NÃƒO ENCONTRADO',\n    descricao: 'O campo de PDF do extrato estÃ¡ vazio no Deal.'\n  },\n  'PDF_INVALIDO': {\n    emoji: 'ğŸ“„',\n    titulo: 'PDF INVÃLIDO',\n    descricao: 'NÃ£o foi possÃ­vel processar o PDF anexado.'\n  },\n  'GEMINI_ERRO': {\n    emoji: 'ğŸ¤–',\n    titulo: 'ERRO NO GEMINI',\n    descricao: 'Falha ao extrair dados do PDF com IA.'\n  },\n  \n  // Erros de ValidaÃ§Ã£o\n  'CPF_DIVERGENTE': {\n    emoji: 'ğŸ†”',\n    titulo: 'CPF DIVERGENTE',\n    descricao: 'CPF do extrato nÃ£o confere com o CPF do Deal.'\n  },\n  'NB_DIVERGENTE': {\n    emoji: 'ğŸ”¢',\n    titulo: 'NB DIVERGENTE',\n    descricao: 'NÃºmero do BenefÃ­cio nÃ£o confere.'\n  },\n  'DADOS_DIVERGENTES': {\n    emoji: 'âš ï¸',\n    titulo: 'DADOS DIVERGENTES',\n    descricao: 'Dados do extrato nÃ£o conferem com o Deal.'\n  },\n  'EXTRATO_ANTIGO': {\n    emoji: 'ğŸ“…',\n    titulo: 'EXTRATO ANTIGO',\n    descricao: 'Este extrato jÃ¡ foi processado anteriormente.'\n  },\n  \n  // Erros de DuplicaÃ§Ã£o\n  'FATURAS_DUPLICADAS': {\n    emoji: 'ğŸ”„',\n    titulo: 'FATURAS JÃ EXISTEM',\n    descricao: 'JÃ¡ existem faturas criadas para este cliente.'\n  },\n  'COMPETENCIA_DUPLICADA': {\n    emoji: 'ğŸ”„',\n    titulo: 'COMPETÃŠNCIA DUPLICADA',\n    descricao: 'JÃ¡ existe fatura para esta competÃªncia.'\n  },\n  \n  // Erros de Sistema\n  'DEAL_ID_AUSENTE': {\n    emoji: 'ğŸš«',\n    titulo: 'DEAL ID AUSENTE',\n    descricao: 'Webhook chamado sem informar o Deal ID.'\n  },\n  'ERRO_BITRIX': {\n    emoji: 'ğŸ’¥',\n    titulo: 'ERRO NO BITRIX',\n    descricao: 'Falha na comunicaÃ§Ã£o com o Bitrix24.'\n  },\n  'ERRO_DESCONHECIDO': {\n    emoji: 'â“',\n    titulo: 'ERRO DESCONHECIDO',\n    descricao: 'Ocorreu um erro nÃ£o identificado.'\n  },\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// FUNÃ‡Ã•ES AUXILIARES\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/**\n * Formata CPF para exibiÃ§Ã£o\n */\nconst formatarCPF = (cpf) => {\n  if (!cpf) return 'N/A';\n  const nums = String(cpf).replace(/\\D/g, '');\n  if (nums.length !== 11) return cpf;\n  return nums.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/, '$1.$2.$3-$4');\n};\n\n/**\n * Formata valor monetÃ¡rio\n */\nconst formatarMoeda = (valor) => {\n  if (!valor && valor !== 0) return 'N/A';\n  return `R$ ${Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;\n};\n\n/**\n * Formata data/hora atual\n */\nconst getTimestamp = () => {\n  return new Date().toLocaleString('pt-BR', { \n    timeZone: 'America/Sao_Paulo',\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n};\n\n/**\n * ObtÃ©m informaÃ§Ãµes do erro do mapa\n */\nconst getErroInfo = (tipoErro) => {\n  return ERROS_MAP[tipoErro] || ERROS_MAP['ERRO_DESCONHECIDO'];\n};\n\n/**\n * Extrai valor com fallbacks\n */\nconst getValue = (ctx, ...paths) => {\n  for (const path of paths) {\n    const keys = path.split('.');\n    let value = ctx;\n    for (const key of keys) {\n      value = value?.[key];\n      if (value === undefined || value === null) break;\n    }\n    if (value !== undefined && value !== null && value !== '') {\n      return value;\n    }\n  }\n  return null;\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// PROCESSAMENTO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ctx = $json;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 1. IDENTIFICAR TIPO DE ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet tipoErro = getValue(ctx, 'tipo_erro', 'alerta.codigo', 'erro_tipo') || 'ERRO_DESCONHECIDO';\nlet erroInfo = getErroInfo(tipoErro);\n\n// Verificar se Ã© erro de faturas duplicadas\nif (ctx.tem_faturas === true && !ctx.tipo_erro) {\n  tipoErro = 'FATURAS_DUPLICADAS';\n  erroInfo = getErroInfo(tipoErro);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 2. EXTRAIR DADOS DO CLIENTE\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst cliente = {\n  nome: getValue(ctx, 'nome_cliente', 'nome', 'resumo.nome', 'deal.TITLE') || 'N/A',\n  cpf: formatarCPF(getValue(ctx, 'cpf_cliente', 'cpf', 'resumo.cpf')),\n  nb: getValue(ctx, 'nb_cliente', 'nb', 'resumo.nb') || 'N/A',\n  dealId: getValue(ctx, 'deal_id') || 'N/A',\n  contactId: getValue(ctx, 'contact_id') || null,\n};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3. EXTRAIR DETALHES DO ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet detalhesErro = [];\n\n// Caso 1: Erro com alerta estruturado\nif (ctx.alerta?.mensagem) {\n  detalhesErro.push(ctx.alerta.mensagem);\n}\n\n// Caso 2: Erro com auditoria (mÃºltiplos problemas)\nif (ctx.auditoria?.problemas?.length > 0) {\n  for (const p of ctx.auditoria.problemas) {\n    detalhesErro.push(`${p.codigo}: ${p.mensagem}`);\n  }\n}\n\n// Caso 3: Mensagem de erro simples\nif (ctx.mensagem_erro) {\n  detalhesErro.push(ctx.mensagem_erro);\n}\n\n// Caso 4: Faturas duplicadas - mostrar stats\nif (tipoErro === 'FATURAS_DUPLICADAS' && ctx.stats_faturas) {\n  const stats = ctx.stats_faturas;\n  detalhesErro.push(`Total de faturas existentes: ${stats.total || 0}`);\n  detalhesErro.push(`Faturas pagas: ${stats.pagas || 0}`);\n  detalhesErro.push(`Faturas pendentes: ${stats.pendentes || 0}`);\n  detalhesErro.push(`Valor jÃ¡ cobrado: ${formatarMoeda(stats.valor_start_cobrado)}`);\n  \n  if (stats.competencias_existentes?.length > 0) {\n    detalhesErro.push(`CompetÃªncias: ${stats.competencias_existentes.join(', ')}`);\n  }\n}\n\n// Fallback se nÃ£o tiver detalhes\nif (detalhesErro.length === 0) {\n  detalhesErro.push(erroInfo.descricao);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 4. EXTRAIR TAGS DE ERRO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet tagsErro = [];\nif (ctx.tags?.length > 0) {\n  tagsErro = ctx.tags.filter(t => t.startsWith('E_') || t.startsWith('ERRO_'));\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5. MONTAR MENSAGEM FORMATADA\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst emoji = ctx.alerta?.emoji || erroInfo.emoji || 'ğŸš¨';\nconst titulo = ctx.alerta?.titulo || erroInfo.titulo || 'ERRO NO FATURAMENTO';\n\nlet msg = '';\n\n// CabeÃ§alho\nmsg += `${emoji} [B]${titulo}[/B]\\n`;\nmsg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// Dados do Cliente\nmsg += `ğŸ‘¤ [B]Cliente:[/B] ${cliente.nome}\\n`;\nmsg += `ğŸ†” [B]CPF:[/B] ${cliente.cpf}\\n`;\nmsg += `ğŸ”¢ [B]NB:[/B] ${cliente.nb}\\n`;\nmsg += `ğŸ“‹ [B]Deal:[/B] #${cliente.dealId}\\n\\n`;\n\n// Detalhes do Erro\nmsg += `[B]ğŸ“Œ Detalhes:[/B]\\n`;\nfor (const detalhe of detalhesErro) {\n  msg += `â€¢ ${detalhe}\\n`;\n}\n\n// Tags (se existirem)\nif (tagsErro.length > 0) {\n  msg += `\\nğŸ·ï¸ [B]Tags:[/B] ${tagsErro.join(', ')}\\n`;\n}\n\n// Timestamp\nmsg += `\\nâ° ${getTimestamp()}\\n`;\n\n// Link para o Deal\nif (cliente.dealId !== 'N/A') {\n  msg += `\\nğŸ”— [URL=${CONFIG.URL_BITRIX}/crm/deal/details/${cliente.dealId}/]Ver negÃ³cio[/URL]`;\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 6. RETORNO\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nreturn { \n  DIALOG_ID: CONFIG.CHAT_ERROS,\n  MESSAGE: msg,\n  \n  // Dados extras para debug/log\n  _debug: {\n    tipo_erro: tipoErro,\n    deal_id: cliente.dealId,\n    timestamp: getTimestamp(),\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        25568
      ],
      "id": "d34adc1e-b9ac-4b1b-88f0-cc81ae854bbf",
      "name": "ğŸ”§ NÃ“ 21 - PREPARAR MSG ERRO (Code)"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 21B â€” PREPARAR MENSAGEM DE ERRO (V2.0)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MELHORIAS V2:\n// âœ… Busca detalhes de erro de TODOS os nÃ³s (6A, 6B, 6C, 6D)\n// âœ… Mostra valores especÃ­ficos que causaram o erro\n// âœ… Compara valores lado a lado (extrato vs negÃ³cio)\n// âœ… Mensagens mais claras e acionÃ¡veis\n// âœ… Debug detalhado para investigaÃ§Ã£o\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS DE TODOS OS NÃ“S ANTERIORES\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// 1B - ConfiguraÃ§Ã£o inicial\nconst dados1B = (() => {\n  try { return $('1B. Inicializar').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6A - ExtraÃ§Ã£o Gemini\nconst dados6A = (() => {\n  try { return $('6A. Gemini ExtraÃ§Ã£o').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6B - CÃ¡lculo INSS\nconst dados6B = (() => {\n  try { return $('6B. CÃ¡lculo INSS').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6C - DistribuiÃ§Ã£o Parcelas\nconst dados6C = (() => {\n  try { return $('6C. Distribuir Parcelas').first().json || {}; } catch(e) { return {}; }\n})();\n\n// 6D - ValidaÃ§Ã£o (input atual)\nconst dados6D = $json || {};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR INFORMAÃ‡Ã•ES DO ERRO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Identificar qual nÃ³ gerou o erro\nconst identificarFonteErro = () => {\n  // Ordem de prioridade: 6A â†’ 6B â†’ 6C â†’ 6D\n  if (dados6A.ok === false || dados6A.erro) return { no: '6A', dados: dados6A };\n  if (dados6B.ok === false || dados6B.erro) return { no: '6B', dados: dados6B };\n  if (dados6C.ok === false || dados6C.erro) return { no: '6C', dados: dados6C };\n  if (dados6D.ok === false || dados6D.erro) return { no: '6D', dados: dados6D };\n  return { no: '6D', dados: dados6D };\n};\n\nconst fonteErro = identificarFonteErro();\nconst dadosErro = fonteErro.dados;\nconst noErro = fonteErro.no;\n\n// Extrair detalhes do erro\nconst erro = dadosErro.erro || {};\nconst erroTag = erro.tag || erro.codigo || '';\nconst erroMensagem = erro.mensagem || erro.msg || '';\nconst erroDetalhes = erro.detalhes || {};\n\n// Tags e resumo do 6D\nconst tags = dados6D.tags || [];\nconst resumo = dados6D.resumo || dadosErro.resumo || {};\nconst auditoria = dados6D.auditoria || {};\nconst problemas = auditoria.problemas || [];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// DADOS DO NEGÃ“CIO E CLIENTE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config1B = dados1B.config || {};\nconst links1B = dados1B.links || {};\n\n// Dados do NegÃ³cio\nconst dealId = dados1B.deal_id || resumo.deal_id || dadosErro.deal_id || '';\nconst nomeCliente = dados1B.nome || resumo.nome || resumo.nome_cliente || 'Cliente';\nconst cpfNegocio = dados1B.cpf_formatado || dados1B.cpf || resumo.cpf_negocio || '';\nconst nbNegocio = dados1B.nb_formatado || dados1B.nb || resumo.nb_negocio || '';\n\n// Dados do Extrato (extraÃ­dos)\nconst cpfExtrato = resumo.cpf_extrato || resumo.cpf || dadosErro.cliente?.cpf || erroDetalhes.cpf_extrato || '';\nconst nbExtrato = resumo.nb_extrato || resumo.nb || dadosErro.beneficio?.nb || erroDetalhes.nb_extrato || '';\n\n// Chat e Links\nconst chatErro = config1B.chat_erro || 'chat282150';\nconst linkNegocio = links1B.deal || `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MAPEAMENTO DE TAGS â†’ MENSAGENS DETALHADAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst MENSAGENS_TAG = {\n  // â•â•â• ERROS CRÃTICOS - CPF â•â•â•\n  'E_CPF_EXTRATO_AUSENTE': {\n    icone: 'âŒ',\n    titulo: 'CPF NÃƒO ENCONTRADO NO EXTRATO',\n    getMensagem: (ctx) => `O Gemini nÃ£o conseguiu extrair o CPF do PDF.`,\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel. Se estiver ilegÃ­vel, solicitar novo extrato Ã  cliente.'\n  },\n  'E_CPF_DIVERGENTE': {\n    icone: 'âŒ',\n    titulo: 'CPF DO EXTRATO â‰  CPF DO NEGÃ“CIO',\n    getMensagem: (ctx) => `CPF Extrato: ${ctx.cpfExtrato || 'nÃ£o encontrado'}\\nCPF NegÃ³cio: ${ctx.cpfNegocio || 'nÃ£o cadastrado'}\\n\\nOs CPFs nÃ£o conferem!`,\n    getAcao: () => 'Este extrato pode ser de outra pessoa. Verificar se a cliente enviou o documento correto.'\n  },\n  'ERRO_CPF': {\n    icone: 'âŒ',\n    titulo: 'ERRO DE CPF',\n    getMensagem: (ctx) => `CPF Extrato: ${ctx.cpfExtrato || 'nÃ£o encontrado'}\\nCPF NegÃ³cio: ${ctx.cpfNegocio || 'nÃ£o cadastrado'}`,\n    getAcao: () => 'Verificar se o CPF estÃ¡ correto no negÃ³cio e no extrato.'\n  },\n\n  // â•â•â• ERROS CRÃTICOS - NB â•â•â•\n  'E_NB_AUSENTE': {\n    icone: 'âŒ',\n    titulo: 'NB NÃƒO ENCONTRADO NO EXTRATO',\n    getMensagem: (ctx) => `O NÃºmero do BenefÃ­cio nÃ£o foi encontrado no PDF.`,\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel e contÃ©m o NB.'\n  },\n  'E_NB_DIVERGENTE': {\n    icone: 'âŒ',\n    titulo: 'NB DO EXTRATO â‰  NB DO NEGÃ“CIO',\n    getMensagem: (ctx) => `NB Extrato: ${ctx.nbExtrato || 'nÃ£o encontrado'}\\nNB NegÃ³cio: ${ctx.nbNegocio || 'nÃ£o cadastrado'}\\n\\nOs NBs nÃ£o conferem!`,\n    getAcao: () => 'Este extrato Ã© de OUTRO benefÃ­cio! Verificar se a cliente tem mais de um benefÃ­cio ou enviou documento errado.'\n  },\n  'ERRO_NB': {\n    icone: 'âŒ',\n    titulo: 'ERRO NO NÃšMERO DO BENEFÃCIO',\n    getMensagem: (ctx) => `NB Extrato: ${ctx.nbExtrato || 'nÃ£o encontrado'}\\nNB NegÃ³cio: ${ctx.nbNegocio || 'nÃ£o cadastrado'}`,\n    getAcao: () => 'Verificar se o NB estÃ¡ correto.'\n  },\n\n  // â•â•â• ERROS CRÃTICOS - MR â•â•â•\n  'E_MR_INVALIDO': {\n    icone: 'âŒ',\n    titulo: 'MR INVÃLIDO OU ZERADO',\n    getMensagem: (ctx) => {\n      const mr = ctx.erroDetalhes?.mr_recebido || ctx.resumo?.mr || 'nÃ£o encontrado';\n      return `MÃ©dia de RemuneraÃ§Ã£o extraÃ­da: ${mr}\\n\\nValor invÃ¡lido para cÃ¡lculo.`;\n    },\n    getAcao: () => 'Verificar se o Gemini extraiu corretamente. O MR deve estar no extrato HISCREDI.'\n  },\n  'ERRO_MR': {\n    icone: 'âŒ',\n    titulo: 'ERRO NA MÃ‰DIA DE REMUNERAÃ‡ÃƒO',\n    getMensagem: (ctx) => {\n      const mr = ctx.erroDetalhes?.mr_recebido || 'nÃ£o encontrado';\n      return `MR recebido: ${mr}`;\n    },\n    getAcao: () => 'Verificar extraÃ§Ã£o do MR no extrato.'\n  },\n\n  // â•â•â• ERROS DE DATAS â•â•â•\n  'E_DATAS_INCONSISTENTES': {\n    icone: 'âŒ',\n    titulo: 'DATAS INVERTIDAS',\n    getMensagem: (ctx) => {\n      const dib = ctx.resumo?.dib || ctx.erroDetalhes?.dib || '?';\n      const dcb = ctx.resumo?.dcb || ctx.erroDetalhes?.dcb || '?';\n      return `DIB (inÃ­cio): ${dib}\\nDCB (fim): ${dcb}\\n\\nA DCB nÃ£o pode ser anterior Ã  DIB!`;\n    },\n    getAcao: () => 'Datas extraÃ­das incorretamente. Verificar extrato manualmente.'\n  },\n  'E_DIB_INVALIDA': {\n    icone: 'ğŸ”´',\n    titulo: 'DIB COM FORMATO INVÃLIDO',\n    getMensagem: (ctx) => `DIB extraÃ­da: ${ctx.erroDetalhes?.dib || 'formato invÃ¡lido'}`,\n    getAcao: () => 'Verificar se a DIB estÃ¡ legÃ­vel no PDF.'\n  },\n  'E_DCB_INVALIDA': {\n    icone: 'ğŸ”´',\n    titulo: 'DCB COM FORMATO INVÃLIDO',\n    getMensagem: (ctx) => `DCB extraÃ­da: ${ctx.erroDetalhes?.dcb || 'formato invÃ¡lido'}`,\n    getAcao: () => 'Verificar se a DCB estÃ¡ legÃ­vel no PDF.'\n  },\n\n  // â•â•â• ERROS DE PARCELAS â•â•â•\n  'E_ZERO_PARCELAS': {\n    icone: 'âŒ',\n    titulo: 'NENHUMA PARCELA GERADA',\n    getMensagem: (ctx) => `O cÃ¡lculo nÃ£o gerou nenhuma parcela.\\n\\nPossÃ­veis causas:\\n- BenefÃ­cio jÃ¡ quitado\\n- Datas inconsistentes\\n- Erro no cÃ¡lculo`,\n    getAcao: () => 'Verificar se o benefÃ­cio ainda tem parcelas pendentes.'\n  },\n  'E_FATURA_DUPLICADA': {\n    icone: 'âŒ',\n    titulo: 'FATURA JÃ EXISTE',\n    getMensagem: (ctx) => {\n      const comp = ctx.erroDetalhes?.competencia || '';\n      return comp ? `JÃ¡ existe fatura para competÃªncia ${comp}.` : 'JÃ¡ existem faturas para este benefÃ­cio.';\n    },\n    getAcao: () => 'Este extrato pode jÃ¡ ter sido processado. Verificar faturas existentes no negÃ³cio.'\n  },\n  'E_TODAS_DUPLICADAS': {\n    icone: 'âŒ',\n    titulo: 'TODAS AS PARCELAS JÃ EXISTEM',\n    getMensagem: (ctx) => `Todas as parcelas deste extrato jÃ¡ foram faturadas anteriormente.`,\n    getAcao: () => 'Este extrato jÃ¡ foi processado. Nenhuma aÃ§Ã£o necessÃ¡ria.'\n  },\n\n  // â•â•â• ERROS REGRA 50% â•â•â•\n  'E_REGRA50_P1': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 1', getMensagem: (ctx) => `Parcela 1 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P2': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 2', getMensagem: (ctx) => `Parcela 2 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P3': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 3', getMensagem: (ctx) => `Parcela 3 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n  'E_REGRA50_P4': { icone: 'âŒ', titulo: 'REGRA 50% VIOLADA - PARCELA 4', getMensagem: (ctx) => `Parcela 4 deixaria cliente com menos de 50%.`, getAcao: () => 'Erro no cÃ¡lculo do 6C. Verificar lÃ³gica.' },\n\n  // â•â•â• ERROS DE NÃ“S â•â•â•\n  'E_ERRO_6A': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA EXTRAÃ‡ÃƒO (NÃ“ 6A)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Gemini nÃ£o conseguiu processar o PDF';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'PDF pode estar ilegÃ­vel, corrompido ou em formato nÃ£o suportado. Solicitar novo extrato.'\n  },\n  'ERRO_6A': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA EXTRAÃ‡ÃƒO (NÃ“ 6A)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro na extraÃ§Ã£o';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar se o PDF estÃ¡ legÃ­vel.'\n  },\n  'E_ERRO_6B': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NO CÃLCULO INSS (NÃ“ 6B)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro no cÃ¡lculo';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar logs do nÃ³ 6B no n8n.'\n  },\n  'E_ERRO_6C': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NA DISTRIBUIÃ‡ÃƒO (NÃ“ 6C)',\n    getMensagem: (ctx) => {\n      const detalhe = ctx.erroDetalhes?.mensagem || ctx.erroMensagem || 'Erro na distribuiÃ§Ã£o';\n      return `Erro: ${detalhe}`;\n    },\n    getAcao: () => 'Verificar logs do nÃ³ 6C no n8n.'\n  },\n  'E_ERRO_NO_ANTERIOR': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO EM NÃ“ ANTERIOR',\n    getMensagem: (ctx) => {\n      return `NÃ³ com erro: ${ctx.noErro}\\nMensagem: ${ctx.erroMensagem || 'nÃ£o especificada'}`;\n    },\n    getAcao: () => 'Verificar logs do workflow no n8n.'\n  },\n  'ERRO_GEMINI': {\n    icone: 'ğŸ”´',\n    titulo: 'FALHA NO GEMINI',\n    getMensagem: (ctx) => `O Gemini nÃ£o conseguiu processar o documento.\\n\\nDetalhes: ${ctx.erroMensagem || 'erro nÃ£o especificado'}`,\n    getAcao: () => 'PDF pode estar corrompido ou ilegÃ­vel. Solicitar novo extrato Ã  cliente.'\n  },\n  'ERRO_PDF': {\n    icone: 'ğŸ”´',\n    titulo: 'PDF INVÃLIDO',\n    getMensagem: (ctx) => `O arquivo PDF nÃ£o pÃ´de ser processado.`,\n    getAcao: () => 'Verificar se o arquivo Ã© um PDF vÃ¡lido e nÃ£o estÃ¡ corrompido.'\n  },\n  'ERRO_BITRIX': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO DE COMUNICAÃ‡ÃƒO COM BITRIX',\n    getMensagem: (ctx) => `Falha ao comunicar com o Bitrix24.\\n\\nDetalhes: ${ctx.erroMensagem || 'erro de conexÃ£o'}`,\n    getAcao: () => 'Pode ser instabilidade temporÃ¡ria. Tentar novamente em alguns minutos.'\n  },\n  'ERRO_PROJECAO': {\n    icone: 'ğŸ”´',\n    titulo: 'ERRO NA PROJEÃ‡ÃƒO DE PARCELAS',\n    getMensagem: (ctx) => `Detectado pulo de mÃªs na projeÃ§Ã£o.\\n\\nDetalhes: ${ctx.erroMensagem || 'continuidade quebrada'}`,\n    getAcao: () => 'Verificar lÃ³gica de projeÃ§Ã£o no nÃ³ 6B.'\n  },\n\n  // â•â•â• ERROS MATEMÃTICOS â•â•â•\n  'E_SOMA_NAO_BATE': {\n    icone: 'ğŸ”´',\n    titulo: 'SOMA DAS PARCELAS NÃƒO CONFERE',\n    getMensagem: (ctx) => {\n      const soma = ctx.erroDetalhes?.soma_calculada || '?';\n      const total = ctx.erroDetalhes?.total_esperado || '?';\n      return `Soma calculada: ${soma}\\nTotal esperado: ${total}`;\n    },\n    getAcao: () => 'Erro matemÃ¡tico no cÃ¡lculo. Verificar nÃ³ 6C.'\n  },\n\n  // â•â•â• ALERTAS â•â•â•\n  'A_CAMPO_NIT_VAZIO': { icone: 'âš ï¸', titulo: 'NIT VAZIO', getMensagem: () => 'Campo NIT nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_CAMPO_DIB_VAZIO': { icone: 'âš ï¸', titulo: 'DIB VAZIO', getMensagem: () => 'Campo DIB nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_CAMPO_DCB_VAZIO': { icone: 'âš ï¸', titulo: 'DCB VAZIO', getMensagem: () => 'Campo DCB nÃ£o preenchido.', getAcao: () => 'Verificar extraÃ§Ã£o.' },\n  'A_HONORARIOS_DIVERGENTE': { icone: 'âš ï¸', titulo: 'HONORÃRIOS â‰  30%', getMensagem: () => 'HonorÃ¡rios nÃ£o sÃ£o 30%.', getAcao: () => 'Pode ser acordo especial.' }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONTEXTO PARA MENSAGENS DINÃ‚MICAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst contexto = {\n  cpfExtrato,\n  cpfNegocio,\n  nbExtrato,\n  nbNegocio,\n  nomeCliente,\n  dealId,\n  noErro,\n  erroMensagem,\n  erroDetalhes,\n  resumo,\n  dados6A,\n  dados6B,\n  dados6C,\n  dados6D\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CONSTRUIR MENSAGEM\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ğŸ”§ FIX V2.1: tags podem ser strings OU objetos com .codigo\nconst getTagCodigo = (t) => typeof t === 'string' ? t : (t?.codigo || '');\n\nconst gravidade = dados6D.gravidade_maxima || (erro.tag ? 'ERRO' : 'ALERTA');\n\nconst tagsErro = tags.filter(t => {\n  const cod = getTagCodigo(t);\n  return cod.startsWith('E_') || cod.startsWith('ERRO_') || cod.startsWith('TAG_');\n});\n\nconst tagsAlerta = tags.filter(t => {\n  const cod = getTagCodigo(t);\n  return cod.startsWith('A_');\n});\n\n// Se nÃ£o tem tags mas tem erro direto, usar a tag do erro\nlet tagsParaProcessar = tagsErro.length > 0 ? tagsErro : (erroTag ? [erroTag] : []);\n\nlet mensagem = '';\n\n// â•â•â• HEADER â•â•â•\nif (gravidade === 'CRITICO') {\n  mensagem += `ğŸš¨ ERRO CRÃTICO - FLUXO PARADO\\n`;\n} else if (gravidade === 'GRAVE' || tagsParaProcessar.length > 0) {\n  mensagem += `ğŸ”´ ERRO NO PROCESSAMENTO\\n`;\n} else {\n  mensagem += `âš ï¸ ALERTA NO PROCESSAMENTO\\n`;\n}\nmensagem += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// â•â•â• IDENTIFICAÃ‡ÃƒO â•â•â•\nmensagem += `ğŸ‘¤ Cliente: ${nomeCliente}\\n`;\nmensagem += `ğŸ“ NegÃ³cio: #${dealId}\\n`;\nmensagem += `ğŸ”§ NÃ³ com erro: ${noErro}\\n\\n`;\n\n// â•â•â• PROBLEMAS DETALHADOS â•â•â•\nif (tagsParaProcessar.length > 0) {\n  mensagem += `ğŸš¨ PROBLEMA(S) ENCONTRADO(S):\\n`;\n  mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  \n  for (const tag of tagsParaProcessar.slice(0, 3)) {\n    const info = MENSAGENS_TAG[tag];\n    \n    if (info) {\n      mensagem += `${info.icone} ${info.titulo}\\n\\n`;\n      mensagem += `${info.getMensagem(contexto)}\\n\\n`;\n      mensagem += `ğŸ‘‰ AÃ§Ã£o: ${info.getAcao()}\\n\\n`;\n    } else {\n      // Tag nÃ£o mapeada - mostrar cÃ³digo e detalhes disponÃ­veis\n      mensagem += `â“ ${tag}\\n`;\n      if (erroMensagem) mensagem += `Mensagem: ${erroMensagem}\\n`;\n      if (Object.keys(erroDetalhes).length > 0) {\n        mensagem += `Detalhes: ${JSON.stringify(erroDetalhes)}\\n`;\n      }\n      mensagem += `\\n`;\n    }\n    mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  }\n  \n  if (tagsParaProcessar.length > 3) {\n    mensagem += `... e mais ${tagsParaProcessar.length - 3} erro(s)\\n\\n`;\n  }\n} else if (erroMensagem) {\n  // Erro sem tag especÃ­fica\n  mensagem += `ğŸš¨ ERRO:\\n`;\n  mensagem += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n`;\n  mensagem += `${erroMensagem}\\n\\n`;\n  if (Object.keys(erroDetalhes).length > 0) {\n    mensagem += `Detalhes: ${JSON.stringify(erroDetalhes, null, 2)}\\n\\n`;\n  }\n}\n\n// â•â•â• ALERTAS (se poucos erros) â•â•â•\nif (tagsAlerta.length > 0 && tagsParaProcessar.length <= 1) {\n  mensagem += `âš ï¸ ALERTAS:\\n`;\n  for (const tag of tagsAlerta.slice(0, 3)) {\n    const info = MENSAGENS_TAG[tag];\n    mensagem += info ? `  ${info.icone} ${info.titulo}\\n` : `  âš ï¸ ${tag}\\n`;\n  }\n  mensagem += `\\n`;\n}\n\n// â•â•â• COMPARAÃ‡ÃƒO CPF/NB (se relevante) â•â•â•\nconst temErroCPF = tagsParaProcessar.some(t => t.includes('CPF'));\nconst temErroNB = tagsParaProcessar.some(t => t.includes('NB'));\n\nif (!temErroCPF && !temErroNB && (cpfExtrato || nbExtrato)) {\n  mensagem += `ğŸ“‹ DADOS EXTRAÃDOS:\\n`;\n  if (cpfExtrato) mensagem += `  CPF: ${cpfExtrato} ${cpfExtrato === cpfNegocio?.replace(/\\D/g, '') ? 'âœ…' : 'âš ï¸'}\\n`;\n  if (nbExtrato) mensagem += `  NB: ${nbExtrato} ${nbExtrato === nbNegocio?.replace(/\\D/g, '') ? 'âœ…' : 'âš ï¸'}\\n`;\n  mensagem += `\\n`;\n}\n\n// â•â•â• LINK â•â•â•\nmensagem += `ğŸ”— ${linkNegocio}`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Campos para o 22. Chat Erro\n  MESSAGE: mensagem,\n  DIALOG_ID: chatErro,\n  \n  // Metadados\n  _no: '21B',\n  _versao: '2.0',\n  _timestamp: new Date().toISOString(),\n  \n  // Resumo do processamento\n  processamento: {\n    no_origem_erro: noErro,\n    erro_tag: erroTag,\n    erro_mensagem: erroMensagem,\n    total_tags: tags.length,\n    tags_erro: tagsParaProcessar.length,\n    tags_alerta: tagsAlerta.length,\n    gravidade,\n    tags_processadas: tagsParaProcessar.concat(tagsAlerta).slice(0, 10)\n  },\n  \n  // Dados extraÃ­dos (debug completo)\n  dados_extraidos: {\n    cliente: nomeCliente,\n    deal_id: dealId,\n    cpf_extrato: cpfExtrato,\n    cpf_negocio: cpfNegocio,\n    nb_extrato: nbExtrato,\n    nb_negocio: nbNegocio\n  },\n  \n  // Detalhes do erro (para investigaÃ§Ã£o)\n  erro_detalhes: {\n    fonte: noErro,\n    tag: erroTag,\n    mensagem: erroMensagem,\n    detalhes: erroDetalhes,\n    dados_no_erro: {\n      '6A_ok': dados6A.ok,\n      '6A_erro': dados6A.erro?.tag || null,\n      '6B_ok': dados6B.ok,\n      '6B_erro': dados6B.erro?.tag || null,\n      '6C_ok': dados6C.ok,\n      '6C_erro': dados6C.erro?.tag || null,\n      '6D_ok': dados6D.ok,\n      '6D_tags': tags.slice(0, 5)\n    }\n  },\n  \n  // Link\n  link_negocio: linkNegocio\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        26320
      ],
      "id": "2aeea8b2-8566-42f8-bf05-a8bb9186025a",
      "name": "21b preparar msg erro"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        7520,
        26048
      ],
      "id": "d1a9541a-b932-4292-9178-b1da0fd89682",
      "name": "Merge 2"
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        6400,
        26176
      ],
      "id": "8e72b54b-237a-404b-b0fc-587c04addb93",
      "name": "Merge 1"
    },
    {
      "parameters": {
        "url": "=https://startprev.bitrix24.com.br/rest/110798/2itn6qbjhoj6y42x/crm.deal.get",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $('1. Webhook').first().json.query.deal_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3936,
        26720
      ],
      "id": "74ff4e74-b1e0-442a-882a-958133a4485e",
      "name": "BUSCAR DEAL"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 18B - PREPARAR DADOS SUPABASE (V5 - MULTI-CAMINHO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Detecta se veio do fluxo de SUCESSO ou ERRO e monta dados adequadamente\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\nconst parseDate = (d) => {\n  if (!d) return null;\n  if (d instanceof Date) return d.toISOString().split('T')[0];\n  if (typeof d === 'string' && d.includes('/')) {\n    const partes = d.split('/');\n    if (partes.length === 3) {\n      const [dia, mes, ano] = partes;\n      return `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}`;\n    }\n  }\n  return d;\n};\n\nconst somenteNumeros = (v) => v ? String(v).replace(/\\D/g, '') : null;\n\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || null;\n  } catch (e) {\n    return null;\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1. DETECTAR ORIGEM (SUCESSO vs ERRO)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dados21B = buscarNo('21b preparar msg erro');\nconst dados22 = buscarNo('22. Chat Erro');\nconst dados15 = buscarNo('15. Montar itens_criados');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados6A = buscarNo('6A. Calculo do Historico de credito (PDF)');\nconst dados6B = buscarNo('6B.Calculo do INSS');\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\nconst dadosBuscarDeal = buscarNo('BUSCAR DEAL');\nconst dados13A = buscarNo('13A. IF Pular');\n\n// Detectar qual caminho\nconst isErro21B = dados21B && (dados21B.MESSAGE || dados21B.erro || dados21B.tipo_erro);\nconst isErro22 = dados22 && (dados22.erro || dados22.message);\nconst isSucesso = dados15 && (dados15.itens_criados || dados15.total_criadas > 0);\nconst isPular = dados13A && dados13A.pular === true;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2. DEFINIR STATUS E MENSAGEM\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nlet status = 'SUCESSO';\nlet ok = true;\nlet gravidade = null;\nlet tipoErro = null;\nlet mensagemErro = null;\nlet mensagemLog = '';\n\nif (isErro21B) {\n  status = 'ERRO';\n  ok = false;\n  gravidade = dados21B.GRAVIDADE || dados21B.gravidade || 'ALTA';\n  tipoErro = dados21B.TIPO_ERRO || dados21B.tipo_erro || 'ERRO_PROCESSAMENTO';\n  mensagemErro = dados21B.MESSAGE || dados21B.mensagem || 'Erro no processamento';\n  mensagemLog = `[ERRO] ${tipoErro}: ${mensagemErro}`;\n} else if (isErro22) {\n  status = 'ERRO';\n  ok = false;\n  gravidade = 'ALTA';\n  tipoErro = dados22.tipo_erro || 'ERRO_CHAT';\n  mensagemErro = dados22.message || dados22.erro || 'Erro capturado no chat';\n  mensagemLog = `[ERRO] ${mensagemErro}`;\n} else if (isPular) {\n  status = 'PULADO';\n  ok = true;\n  gravidade = null;\n  tipoErro = null;\n  mensagemErro = null;\n  mensagemLog = 'ExecuÃ§Ã£o pulada conforme regra';\n} else if (isSucesso) {\n  const totalCriadas = dados15.total_criadas || 0;\n  const totalErros = dados15.total_erros || 0;\n  \n  if (totalErros > 0 && totalCriadas === 0) {\n    status = 'ERRO';\n    ok = false;\n    tipoErro = 'ERRO_CRIACAO_FATURAS';\n    mensagemErro = `Todas as ${totalErros} fatura(s) falharam`;\n    mensagemLog = mensagemErro;\n  } else if (totalErros > 0) {\n    status = 'PARCIAL';\n    ok = true;\n    mensagemLog = `${totalCriadas} criada(s), ${totalErros} erro(s)`;\n  } else {\n    status = 'SUCESSO';\n    ok = true;\n    mensagemLog = `${totalCriadas} fatura(s) criada(s) com sucesso`;\n  }\n} else {\n  // Fallback - nÃ£o identificou caminho claro\n  status = 'INDEFINIDO';\n  ok = false;\n  tipoErro = 'CAMINHO_NAO_IDENTIFICADO';\n  mensagemErro = 'NÃ£o foi possÃ­vel identificar o resultado da execuÃ§Ã£o';\n  mensagemLog = mensagemErro;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3. EXTRAIR DADOS BÃSICOS (funciona em qualquer caminho)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst dealData = dadosBuscarDeal || dados1B || {};\nconst dealId = dados15?.deal_id || dados21B?.deal_id || dados1B?.deal_id || dealData.deal_id || 0;\n\nconst execucaoId = dados1B?.execucao?.id || \n  dados21B?.execucao_id ||\n  `${dealId}_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;\n\nconst cpfRaw = dados15?.cpf || dados21B?.cpf || dados1B?.cpf || dealData.cpf || '';\nconst nbRaw = dados15?.nb || dados21B?.nb || dados1B?.nb || dealData.nb || '';\nconst nomeCliente = dados15?.nome_cliente || dados21B?.nome_cliente || dados1B?.nome || dealData.nome || 'NÃ£o identificado';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4. EXTRAIR DADOS COMPLETOS (sÃ³ se existirem - caminho sucesso)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst resumo = dados15?.resumo || dados6D?.resumo || {};\nconst dadosBeneficio = dados6A?.dados || dados6D?.dados?.deal || {};\nconst darf = dados15?.darf || {};\nconst asaas = dados15?.asaas || dados9C || {};\n\n// Parcelas (sÃ³ existe no sucesso)\nconst itensCriados = dados15?.itens_criados || [];\nconst parcelas = itensCriados.map((f, idx) => ({\n  parcela_numero: f.parcela || (idx + 1),\n  invoice_id: f.invoice_id || null,\n  competencia: f.competencia,\n  data_pagamento_inss: parseDate(f.data_inss),\n  valor_inss: tr(f.valor_inss),\n  valor_start: tr(f.valor_start),\n  valor_cliente: tr(f.valor_cliente),\n  regra_aplicada: f.regra,\n  saldo_depois: tr(f.saldo_restante_start)\n}));\n\n// Tags e alertas\nlet tags = dados15?.tags || dados21B?.tags || [];\nlet alertas = dados15?.alertas_lista || dados21B?.alertas || [];\n\n// Adicionar tag de erro se for erro\nif (!ok && tipoErro) {\n  tags = [...tags, `ERRO:${tipoErro}`];\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5. RETORNO COM DADOS PARA OS 2 NÃ“S SUPABASE\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nreturn {\n  // Passar dados originais (se existirem)\n  ...(dados15 || {}),\n  \n  // Flag para debug\n  _origem: isErro21B ? '21B_ERRO' : isErro22 ? '22_ERRO' : isPular ? '13A_PULAR' : isSucesso ? 'SUCESSO' : 'INDEFINIDO',\n  _versao_18B: 'V5',\n  \n  // Dados para o nÃ³ Supabase (faturista_execucoes)\n  supabase_execucao: {\n    execucao_id: execucaoId,\n    deal_id: dealId,\n    cpf: somenteNumeros(cpfRaw),\n    cpf_formatado: cpfRaw,\n    nome_cliente: nomeCliente,\n    contact_id: dados1B?.contact_id || null,\n    nb: somenteNumeros(nbRaw),\n    nb_formatado: nbRaw,\n    nit: dadosBeneficio.nit || dados1B?.nit || null,\n    especie: dadosBeneficio.especie || '80',\n    banco: dadosBeneficio.banco || null,\n    agencia: dadosBeneficio.agencia || null,\n    dib: parseDate(dadosBeneficio.dib || resumo.dib),\n    dcb: parseDate(dadosBeneficio.dcb || resumo.dcb),\n    dip: parseDate(dadosBeneficio.dip || resumo.dip),\n    data_extrato: parseDate(dados6A?.data_extrato || dados21B?.data_extrato),\n    mr: tr(resumo.mr || dados15?.mr),\n    desconto_inss: tr(resumo.desconto_inss || dados6B?.desconto_inss),\n    valor_liquido_mensal: tr(resumo.valor_liquido_mensal),\n    valor_total_beneficio: tr(resumo.total_120_dias),\n    aliquota_inss_efetiva: resumo.aliquota_inss || null,\n    honorarios_start: tr(resumo.honorarios_start || dados15?.honorarios_start),\n    saldo_inicial: tr(resumo.saldo_start_inicial),\n    saldo_final: tr(resumo.saldo_start_final || dados15?.saldo_final),\n    aliquota_start: resumo.aliquota_honorarios || null,\n    regra_aplicada: resumo.regra_aplicada || null,\n    tem_darf: darf.tem_darf || false,\n    valor_darf: tr(darf.valor_total),\n    qtd_parcelas_darf: darf.qtd_parcelas || null,\n    tem_boleto: asaas.tem_boleto || false,\n    asaas_customer_id: asaas.customer_id || null,\n    asaas_payment_id: asaas.payment_id || null,\n    asaas_boleto_url: asaas.boleto_url || null,\n    asaas_vencimento: parseDate(asaas.vencimento),\n    \n    // â•â•â• CAMPOS DE STATUS (CRÃTICOS!) â•â•â•\n    status: status,\n    ok: ok,\n    gravidade: gravidade,\n    tipo_erro: tipoErro,\n    mensagem_erro: mensagemErro,\n    \n    // â•â•â• CONTADORES â•â•â•\n    qtd_faturas_criadas: dados15?.total_criadas || 0,\n    qtd_faturas_erro: dados15?.total_erros || 0,\n    qtd_faturas_duplicadas: dados15?.total_puladas || 0,\n    ids_invoices: dados15?.ids_invoices || [],\n    \n    // â•â•â• METADADOS â•â•â•\n    versao_workflow: dados1B?.versao || 'V1',\n    tentativa: dados1B?.tentativa || 1,\n    duracao_ms: dados1B?.duracao_ms || null,\n    file_id: dados1B?.file_id || dados21B?.file_id || null,\n    \n    // â•â•â• DADOS ESTRUTURADOS â•â•â•\n    tags: tags,\n    alertas: alertas,\n    parcelas: parcelas.length > 0 ? parcelas : null,\n    campos_deal: dados15?.campos_deal || dados21B?.campos_deal || null,\n    campos_invoice: dados15?.campos_invoice || null,\n    resumo: Object.keys(resumo).length > 0 ? resumo : null,\n    \n    link_deal: `https://startprev.bitrix24.com.br/crm/deal/details/${dealId}/`\n  },\n  \n  // Dados para o nÃ³ Supabase (execucoes_log)\n  supabase_log: {\n    workflow: 'faturista',\n    execucao_id: execucaoId,\n    deal_id: dealId,\n    cpf: somenteNumeros(cpfRaw),\n    nome_cliente: nomeCliente,\n    status: status,\n    ok: ok,\n    mensagem: mensagemLog,\n    duracao_ms: dados1B?.duracao_ms || null,\n    versao: dados1B?.versao || 'V1',\n    ano_mes: new Date().toISOString().slice(0, 7) // formato: 2026-01\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10208,
        26272
      ],
      "id": "9e22b735-8df2-45ec-8dad-cb35ef640b46",
      "name": "18B.Gravar Supabase"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9760,
        25936
      ],
      "id": "a6bf4e59-badb-4ab1-81cb-c14183e21099",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 19 - PREPARAR DADOS PARA GOOGLE SHEETS (V23)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Formatar dados para append no Google Sheets\n// ENTRADA: Output do 15. Montar itens_criados (via 17 IF Warning)\n// SAÃDA: Array de linhas para a planilha MASTER\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// ATUALIZAÃ‡ÃƒO V23 (08/01/2026):\n// âœ… ORDEM DAS COLUNAS CORRIGIDA (igual Ã  planilha)\n// âœ… Adicionada coluna bloqueia_calculo (faltava)\n// âœ… Captura invoice_id do nÃ³ 10 como fallback\n// âœ… CompatÃ­vel com estrutura MASTER da planilha\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â• FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\nconst buscarTodosNo = (nomeNo) => {\n  try {\n    return $(nomeNo).all() || [];\n  } catch (e) {\n    return [];\n  }\n};\n\n// â•â•â• BUSCAR DADOS DOS NÃ“S â•â•â•\nconst consolidado = buscarNo('15. Montar itens_criados') || $json || {};\nconst responsavelInfo = buscarNo('8C. Definir ResponsÃ¡vel');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst relatorio = buscarNo('12. Gerar RelatÃ³rio HTML');\nconst dados1B = buscarNo('1B. Inicializar');\n\n// â•â•â• CAPTURAR IDS DAS FATURAS DO NÃ“ 10 (FALLBACK) â•â•â•\nconst resultadosNo10 = buscarTodosNo('10. Criar Fatura');\nconst idsFromNo10 = resultadosNo10.map(item => {\n  const invoiceId = item.json?.result?.item?.id;\n  return {\n    invoice_id: invoiceId,\n    link: invoiceId ? `https://startprev.bitrix24.com.br/crm/type/31/details/${invoiceId}/` : null,\n    title: item.json?.result?.item?.title || '',\n    parcela_extraida: (() => {\n      const match = (item.json?.result?.item?.title || '').match(/Parcela (\\d+)/i);\n      return match ? parseInt(match[1]) : null;\n    })()\n  };\n});\n\n// â•â•â• EXTRAIR DADOS â•â•â•\nconst resumo = consolidado.resumo || normalizador.resumo || {};\nconst dadosBeneficio = normalizador.dados_beneficio || {};\nconst camposAtualizarDeal = consolidado.campos_atualizar_deal || normalizador.campos_atualizar_deal || {};\n\n// Alertas\nconst alertas = consolidado.alertas_lista || [];\nconst alertaMax = alertas.sort((a, b) => (b.severidade || 0) - (a.severidade || 0))[0] || {};\n\n// Faturas criadas\nconst criadas = consolidado.itens_criados || [];\nconst faturas = criadas.length > 0 ? criadas : [{ parcela: 0 }];\n\n// ResponsÃ¡vel\nconst responsavel = responsavelInfo.responsavel || {};\n\n// Timestamp\nconst agora = new Date().toISOString();\n\n// Deal ID\nconst dealId = consolidado.deal_id || normalizador.deal_id || dados1B.deal_id || '';\n\n// â•â•â• GERAR LINHAS PARA A PLANILHA (ORDEM CORRETA!) â•â•â•\nreturn faturas.map((f, index) => {\n  // Buscar invoice_id: primeiro do item, depois fallback do nÃ³ 10\n  let invoiceId = f.invoice_id;\n  let invoiceLink = f.link;\n  \n  if (!invoiceId && idsFromNo10.length > 0) {\n    // Tentar por Ã­ndice\n    let idInfo = idsFromNo10[index];\n    // Ou tentar por parcela\n    if (!idInfo?.invoice_id && f.parcela) {\n      idInfo = idsFromNo10.find(i => i.parcela_extraida === f.parcela);\n    }\n    if (idInfo?.invoice_id) {\n      invoiceId = idInfo.invoice_id;\n      invoiceLink = idInfo.link;\n    }\n  }\n  \n  return {\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 1-7: METADADOS\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    timestamp: agora,                                                    // 1\n    deal_id: dealId,                                                     // 2\n    cliente: consolidado.nome_cliente || resumo.nome || '',              // 3\n    versao: 'V23',                                                       // 4\n    tentativa: 1,                                                        // 5\n    status: consolidado.sucesso ? 'SUCESSO' : 'ERRO',                    // 6\n    severidade_max: alertaMax.severidade || 0,                           // 7\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 8-15: DADOS DO BENEFÃCIO\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    nb: consolidado.nb || resumo.nb || dadosBeneficio.nb || '',          // 8\n    nit: dadosBeneficio.nit || '',                                       // 9\n    cpf: consolidado.cpf || resumo.cpf || dadosBeneficio.cpf || '',      // 10\n    dib: dadosBeneficio.dib || '',                                       // 11\n    dip: dadosBeneficio.dip || '',                                       // 12\n    dcb: dadosBeneficio.dcb || '',                                       // 13\n    banco: dadosBeneficio.banco || '',                                   // 14\n    data_pdf: dadosBeneficio.data_atualizacao_extrato || '',             // 15\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 16-23: VALORES DO BENEFÃCIO\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    mr: consolidado.mr || resumo.mr || dadosBeneficio.mr || 0,           // 16\n    aliquota_inss: dadosBeneficio.aliquota_inss_efetiva || 0,            // 17\n    desconto_inss: dadosBeneficio.desconto_inss || 0,                    // 18\n    liquido_mensal: dadosBeneficio.valor_liquido_mensal || 0,            // 19\n    valor_diario: dadosBeneficio.valor_diario || 0,                      // 20\n    total_beneficio: dadosBeneficio.valor_total_beneficio || \n                     resumo.total_120_dias || 0,                         // 21\n    dias_recebidos: 0,                                                   // 22\n    dias_restantes: dadosBeneficio.dias_restantes || 0,                  // 23\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 24-27: HONORÃRIOS START\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    valor_total_start: consolidado.honorarios_start || \n                       resumo.honorarios_start || \n                       dadosBeneficio.valor_total_start || 0,            // 24\n    percentual_start: 30,                                                // 25\n    saldo_inicial: resumo.honorarios_start || 0,                         // 26\n    saldo_final: consolidado.saldo_final || resumo.saldo_start_final || 0, // 27\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 28-37: DADOS DA PARCELA\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    parcela: f.parcela || 0,                                             // 28\n    competencia: f.competencia || dadosBeneficio.competencia_final || '', // 29\n    competencia_final: dadosBeneficio.competencia_final || '',           // 30\n    periodo: '',                                                         // 31\n    data_pagamento: f.data_inss || '',                                   // 32\n    valor_inss: f.valor_inss || 0,                                       // 33\n    valor_start: f.valor_start || 0,                                     // 34\n    valor_cliente: f.valor_cliente || 0,                                 // 35\n    aliquota_aplicada: f.aliquota || 0.3,                                // 36\n    regra_aplicada: f.regra || '',                                       // 37\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 38-40: RESPONSÃVEL E FLAGS\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    responsavel: responsavel.nome || '',                                 // 38\n    is_retroativo: f.is_retroativo || false,                             // 39\n    is_simulado: f.is_simulado || false,                                 // 40\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 41-45: ALERTAS (ANTES DOS INVOICES!)\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    tipo_alerta: alertaMax.tipo || '',                                   // 41\n    titulo_alerta: alertaMax.titulo || '',                               // 42\n    mensagem_alerta: alertaMax.mensagem || '',                           // 43\n    bloqueia: alertaMax.bloqueia || false,                               // 44\n    bloqueia_calculo: alertaMax.bloqueia_calculo || false,               // 45 â† NOVO!\n    \n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    // COLUNAS 46-49: INVOICE E TOTAIS (DEPOIS DOS ALERTAS!)\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n    invoice_id: invoiceId || '',                                         // 46\n    invoice_link: invoiceLink || '',                                     // 47\n    total_criadas: consolidado.total_criadas || 0,                       // 48\n    total_erros: consolidado.total_erros || 0                            // 49\n  };\n});"
      },
      "id": "e9cd65f0-0269-495f-828d-0e9d3efe5091",
      "name": "19. Preparar Sheets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10880,
        26272
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1qZmjKra2NyeygHVC-eyQtLeDzWgeX6ezukLzw8J9130"
        },
        "sheetName": {
          "__rl": true,
          "value": "MASTER",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "deal_id",
              "displayName": "deal_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cliente",
              "displayName": "cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "versao",
              "displayName": "versao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tentativa",
              "displayName": "tentativa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "severidade_max",
              "displayName": "severidade_max",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nb",
              "displayName": "nb",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nit",
              "displayName": "nit",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cpf",
              "displayName": "cpf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dib",
              "displayName": "dib",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dip",
              "displayName": "dip",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dcb",
              "displayName": "dcb",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "banco",
              "displayName": "banco",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "data_pdf",
              "displayName": "data_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mr",
              "displayName": "mr",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "aliquota_inss",
              "displayName": "aliquota_inss",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "desconto_inss",
              "displayName": "desconto_inss",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "liquido_mensal",
              "displayName": "liquido_mensal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valor_diario",
              "displayName": "valor_diario",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_beneficio",
              "displayName": "total_beneficio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dias_recebidos",
              "displayName": "dias_recebidos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dias_restantes",
              "displayName": "dias_restantes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valor_total_start",
              "displayName": "valor_total_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "percentual_start",
              "displayName": "percentual_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "saldo_inicial",
              "displayName": "saldo_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "saldo_final",
              "displayName": "saldo_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "parcela",
              "displayName": "parcela",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "competencia",
              "displayName": "competencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "competencia_final",
              "displayName": "competencia_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "periodo",
              "displayName": "periodo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "data_pagamento",
              "displayName": "data_pagamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valor_inss",
              "displayName": "valor_inss",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valor_start",
              "displayName": "valor_start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valor_cliente",
              "displayName": "valor_cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "aliquota_aplicada",
              "displayName": "aliquota_aplicada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "regra_aplicada",
              "displayName": "regra_aplicada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "responsavel",
              "displayName": "responsavel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "is_retroativo",
              "displayName": "is_retroativo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "is_simulado",
              "displayName": "is_simulado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tipo_alerta",
              "displayName": "tipo_alerta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "titulo_alerta",
              "displayName": "titulo_alerta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mensagem_alerta",
              "displayName": "mensagem_alerta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "bloqueia",
              "displayName": "bloqueia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "383b700e-1792-4e72-938d-8d51ff8d3220",
      "name": "20. Append MASTER",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        11104,
        26272
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "rzK4Kn2nRsBEj5v6",
          "name": "Google Sheets account 3"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "ff424e4b-b20a-4948-8f45-af762698b67e",
      "name": "21. Responder OK",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [
        11328,
        26272
      ]
    },
    {
      "parameters": {
        "tableId": "execucoes",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "execution_id",
              "fieldValue": "={{ $json.execucao?.id || $json.deal_id + '_' + Date.now() }}"
            },
            {
              "fieldId": "workflow_id",
              "fieldValue": "={{$json.supabase_execucao.deal_id}}"
            },
            {
              "fieldId": "cpf_formatado",
              "fieldValue": "{{$json.supabase_execucao.cpf_formatado}}"
            },
            {
              "fieldId": "cpf_formatado",
              "fieldValue": "={{$json.supabase_execucao.cpf}}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $json.nome_cliente }}"
            },
            {
              "fieldId": "nb",
              "fieldValue": "={{ $json.nb }}"
            },
            {
              "fieldId": "nb_formatado",
              "fieldValue": "={{ $json.resumo?.nb_formatado }}"
            },
            {
              "fieldId": "mr",
              "fieldValue": "={{ $json.mr }}"
            },
            {
              "fieldId": "dib",
              "fieldValue": "={{ $json.resumo?.dib }}"
            },
            {
              "fieldId": "dcb",
              "fieldValue": "={{ $json.resumo?.dcb }}"
            },
            {
              "fieldId": "honorarios_start",
              "fieldValue": "={{ $json.honorarios_start }}"
            },
            {
              "fieldId": "saldo_final",
              "fieldValue": "={{ $json.saldo_final }}"
            },
            {
              "fieldId": "status_execucao",
              "fieldValue": "={{ $json.total_erros > 0 ? 'ERRO' : 'SUCESSO' }}"
            },
            {
              "fieldId": "ok",
              "fieldValue": "={{ $json.total_erros === 0 }}"
            },
            {
              "fieldId": "qtd_faturas_criadas",
              "fieldValue": "={{ $json.total_criadas }}"
            },
            {
              "fieldId": "qtd_faturas_erro",
              "fieldValue": "={{ $json.total_erros }}"
            },
            {
              "fieldId": "qtd_faturas_duplicadas",
              "fieldValue": "={{ $json.total_puladas }}"
            },
            {
              "fieldId": "ids_invoices",
              "fieldValue": "={{ $json.ids_invoices }}"
            },
            {
              "fieldId": "tags",
              "fieldValue": "={{ $json.tags }}"
            },
            {
              "fieldId": "alertas",
              "fieldValue": "={{ $json.alertas_lista }}"
            },
            {
              "fieldId": "parcelas",
              "fieldValue": "={{ $json.itens_criados }}"
            },
            {
              "fieldId": "resumo",
              "fieldValue": "={{ $json.resumo }}"
            },
            {
              "fieldId": "link_deal",
              "fieldValue": "={{ $json.links?.deal }}"
            },
            {
              "fieldId": "tem_darf",
              "fieldValue": "={{ $json.tem_darf }}"
            },
            {
              "fieldId": "tem_boleto",
              "fieldValue": "={{ $json.tem_boleto }}"
            },
            {
              "fieldId": "asaas_payment_id",
              "fieldValue": "={{ $json.asaas?.payment_id }}"
            },
            {
              "fieldId": "asaas_boleto_url",
              "fieldValue": "={{ $json.asaas?.boleto_url }}"
            },
            {
              "fieldId": "versao_workflow",
              "fieldValue": "={{ 'V23' }}"
            },
            {
              "fieldId": "execucao_id",
              "fieldValue": "={{$json.supabase_execucao.execucao_id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10432,
        26272
      ],
      "id": "c2b911ef-5a54-43ea-acf5-d6a7d3d82ec0",
      "name": "18C. Supabase faturista_execucoes",
      "credentials": {
        "supabaseApi": {
          "id": "CTj6BAbxoTFRemDe",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "execution_id",
              "fieldValue": "={{ $json.deal_id }}_{{ Date.now() }}"
            },
            {
              "fieldId": "deal_id",
              "fieldValue": "={{ $json.deal_id }}"
            },
            {
              "fieldId": "cpf",
              "fieldValue": "={{ ($json.cpf || '').replace(/\\D/g, '') }}"
            },
            {
              "fieldId": "nome_cliente",
              "fieldValue": "={{ $json.nome_cliente }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $json.total_erros > 0 ? 'ERRO' : 'SUCESSO' }}"
            },
            {
              "fieldId": "ok",
              "fieldValue": "={{ $json.total_erros === 0 }}"
            },
            {
              "fieldId": "mensagem",
              "fieldValue": "={{ $json.total_criadas + ' fatura(s) criada(s)' }}"
            },
            {
              "fieldId": "versao",
              "fieldValue": "V23"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10656,
        26272
      ],
      "id": "2c8801d1-cf7b-4f25-8a71-72f0dcb14ad8",
      "name": "18D - Supabase execucoes_log",
      "credentials": {
        "supabaseApi": {
          "id": "CTj6BAbxoTFRemDe",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 7
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        9984,
        26192
      ],
      "id": "f7269cc4-d1e6-4fd2-ac25-c7feb0c45e40",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 15 - MONTAR ITENS_CRIADOS (V23 - DARF + ASAAS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO: Formatar dados para Chat e Sheets\n// ENTRADA: Output do 14. Processar Resposta Fatura\n// SAÃDA: Dados formatados para 16. Chat Sucesso e 19. Preparar Sheets\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// \n// ATUALIZAÃ‡ÃƒO V23 (12/01/2026):\n// âœ… BASEADO NO V22-COMPATIVEL-ASAAS (mantÃ©m TUDO)\n// ğŸ”¥ ADICIONA dados de DARF do 6D (resumo.darf)\n// ğŸ”¥ PASSA darf para o nÃ³ 16. Chat Sucesso\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FUNÃ‡ÃƒO HELPER: Buscar nÃ³ com seguranÃ§a (nÃ£o quebra se nÃ£o existir)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst buscarNo = (nomeNo) => {\n  try {\n    const resultado = $(nomeNo).first()?.json;\n    return resultado || {};\n  } catch (e) {\n    return {};\n  }\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUSCAR DADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst proc = $json || {};\n\nconst relatorio = buscarNo('12. Gerar RelatÃ³rio HTML');\nconst consolidar = buscarNo('11. Consolidar');\nconst normalizador = buscarNo('8. Normalizador Deal');\nconst dados6D = buscarNo('6D. Revisor de Calculos');\nconst dados6C = buscarNo('6C. Calculo Start');\nconst dados1B = buscarNo('1B. Inicializar');\nconst dados9 = buscarNo('9. Preparar Fatura');\n\n// NÃ“S DO ASAAS\nconst dados9C = buscarNo('9C. Processar Resposta Asaas');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EXTRAIR DADOS COM FALLBACKS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dealId = proc.deal_id || \n               relatorio.deal_id || \n               consolidar.deal_id || \n               dados6D.deal_id ||\n               dados1B.deal_id ||\n               0;\n\nconst faturasCriadas = proc.faturas_criadas || [];\nconst faturasErro = proc.faturas_erro || [];\n\nconst totalCriadas = proc.total_criadas || faturasCriadas.length;\nconst totalErro = proc.total_erro || faturasErro.length;\n\nconst resumo = proc.resumo || \n               relatorio.resumo || \n               dados6D.resumo ||\n               {};\n\nconst camposAtualizarDeal = relatorio.campos_atualizar_deal || \n                            consolidar.campos_atualizar_deal || \n                            normalizador.campos_atualizar_deal || \n                            dados6D.campos_deal ||\n                            {};\n\n// Alertas para IF Warning\nconst alertasLista = [];\nif (totalErro > 0) {\n  alertasLista.push({ \n    tipo: 'WARNING', \n    codigo: 'ERROS_PARCIAIS', \n    mensagem: `${totalErro} fatura(s) com erro` \n  });\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ DADOS DO ASAAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst asaas = proc.asaas || {};\nconst temBoleto = asaas.boleto_criado || proc.tem_boleto || false;\nconst boletoUrl = asaas.boleto_url || asaas.invoice_url || '';\nconst asaasPaymentId = asaas.payment_id || '';\nconst asaasVencimento = asaas.vencimento || '';\nconst asaasVencimentoFormatado = asaas.vencimento_formatado || asaasVencimento || '';\nconst asaasNossoNumero = asaas.nosso_numero || '';\nconst asaasValor = asaas.valor || 0;\nconst asaasStatus = asaas.status || '';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”¥ DADOS DA DARF (NOVO V23!)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// A DARF vem do 6D.resumo.darf ou 6C.resumo\nconst darfResumo6D = dados6D.resumo?.darf || {};\nconst darfResumo6C = dados6C.resumo || {};\n\n// Truncar para 2 casas decimais\nconst tr = (v) => Math.floor((v || 0) * 100) / 100;\n\n// Verificar se Start paga DARF\nconst startPagaDarf = darfResumo6D.start_paga_darf || \n                      darfResumo6C.start_paga_darf || \n                      false;\n\n// Valor total da DARF\nconst valorDarfTotal = tr(\n  darfResumo6D.valor_darf_total || \n  darfResumo6C.valor_darf_original ||\n  0\n);\n\n// Quantidade de parcelas onde DARF foi rateada\nconst qtdParcelasDarf = darfResumo6D.qtd_parcelas_start_recebe || \n                        darfResumo6C.qtd_parcelas_com_darf ||\n                        0;\n\n// Valor aproximado por parcela\nconst valorDarfPorParcela = tr(\n  darfResumo6D.valor_darf_por_parcela_aprox || \n  darfResumo6C.valor_darf_por_parcela_aprox ||\n  0\n);\n\n// Total que Start recebe (honorÃ¡rios + DARF)\nconst totalStartComDarf = tr(\n  darfResumo6C.total_start_com_darf ||\n  resumo.total_start ||\n  0\n);\n\n// Tem DARF vÃ¡lida?\nconst temDarf = startPagaDarf && valorDarfTotal > 0;\n\n// Objeto consolidado de DARF\nconst darf = {\n  start_paga: startPagaDarf,\n  tem_darf: temDarf,\n  valor_total: valorDarfTotal,\n  valor_total_formatado: `R$ ${valorDarfTotal.toFixed(2).replace('.', ',')}`,\n  qtd_parcelas: qtdParcelasDarf,\n  valor_por_parcela: valorDarfPorParcela,\n  valor_por_parcela_formatado: `R$ ${valorDarfPorParcela.toFixed(2).replace('.', ',')}`,\n  total_start_com_darf: totalStartComDarf,\n  total_start_com_darf_formatado: `R$ ${totalStartComDarf.toFixed(2).replace('.', ',')}`\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// MONTAR ITENS_CRIADOS (formato esperado + ASAAS + DARF)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst itensCriados = faturasCriadas.map((f, index) => {\n  const isParcelaAtual = index === 0;\n  \n  return {\n    // Dados originais V21\n    invoice_id: f.invoice_id || f.id,\n    link: (f.invoice_id || f.id) ? `https://startprev.bitrix24.com.br/crm/type/31/details/${f.invoice_id || f.id}/` : null,\n    parcela: f.parcela,\n    total_parcelas: f.total_parcelas || totalCriadas,\n    valor_start: f.valor_start,\n    valor_inss: f.valor_inss,\n    valor_cliente: f.valor_cliente,\n    competencia: f.competencia,\n    data_inss: f.data_inss || f.data_pagamento,\n    saldo_restante_start: f.saldo_depois || f.saldo_start_depois || 0,\n    \n    // DARF rateada nesta parcela (V23)\n    valor_darf_rateado: f.valor_darf_rateado || 0,\n    valor_start_total: f.valor_start_total || f.valor_start || 0,\n    \n    // DADOS DO ASAAS (sÃ³ na parcela atual)\n    tem_boleto: isParcelaAtual && temBoleto,\n    boleto_url: isParcelaAtual ? (f.asaas_boleto_url || boletoUrl) : '',\n    asaas_payment_id: isParcelaAtual ? (f.asaas_payment_id || asaasPaymentId) : '',\n    asaas_vencimento: isParcelaAtual ? (f.asaas_vencimento || asaasVencimentoFormatado) : '',\n    asaas_nosso_numero: isParcelaAtual ? (f.asaas_nosso_numero || asaasNossoNumero) : ''\n  };\n});\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// RETORNO (MESMA ESTRUTURA V22 + DARF)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // Status\n  sucesso: proc.sucesso !== false && totalErro === 0,\n  status: proc.status || 'SUCESSO',\n  deal_atualizado: proc.deal_atualizado !== false,\n  \n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  \n  // Campos (compatibilidade)\n  campos_atualizar_deal: camposAtualizarDeal,\n  \n  // Contagens\n  total_processadas: totalCriadas + totalErro,\n  total_criadas: totalCriadas,\n  total_puladas: 0,\n  total_erros: totalErro,\n  \n  // Itens formatados (agora com Asaas + DARF)\n  itens_criados: itensCriados,\n  itens_pulados: [],\n  itens_com_erro: faturasErro,\n  \n  // Alertas\n  alertas_lista: alertasLista,\n  \n  // Resumo para mensagens\n  resumo: resumo,\n  nome_cliente: proc.nome_cliente || resumo.nome || dados1B.nome || '',\n  cpf: proc.cpf || resumo.cpf || dados1B.cpf_formatado || '',\n  nb: proc.nb || resumo.nb || dados1B.nb_formatado || '',\n  mr: proc.mr || resumo.mr || 0,\n  mr_formatado: proc.mr_formatado || resumo.mr_formatado || '',\n  honorarios_start: proc.honorarios_start || resumo.honorarios_start || resumo.total_start || 0,\n  honorarios_start_formatado: proc.honorarios_start_formatado || resumo.honorarios_start_formatado || '',\n  saldo_final: proc.saldo_final || resumo.saldo_start_final || 0,\n  saldo_final_formatado: proc.saldo_final_formatado || resumo.saldo_start_final_formatado || '',\n  \n  // Auditoria\n  auditoria: proc.auditoria || dados6D.auditoria || {},\n  tags: proc.tags || dados6D.tags || [],\n  \n  // IDs das faturas\n  ids_invoices: proc.ids_invoices || faturasCriadas.map(f => f.invoice_id || f.id).filter(Boolean),\n  \n  // Config e links\n  config: proc.config || dados1B.config || {},\n  links: proc.links || dados1B.links || {},\n  \n  // DADOS DO ASAAS\n  asaas: {\n    tem_boleto: temBoleto,\n    boleto_url: boletoUrl,\n    payment_id: asaasPaymentId,\n    vencimento: asaasVencimentoFormatado,\n    nosso_numero: asaasNossoNumero,\n    valor: asaasValor,\n    status: asaasStatus\n  },\n  tem_boleto: temBoleto,\n  \n  // ğŸ”¥ DADOS DA DARF (NOVO V23!)\n  darf: darf,\n  tem_darf: temDarf,\n  \n  // Debug\n  _debug: {\n    versao: 'V23-DARF',\n    fontes_encontradas: {\n      proc: !!proc.deal_id,\n      relatorio: !!relatorio.deal_id,\n      consolidar: !!consolidar.deal_id,\n      normalizador: !!normalizador.deal_id,\n      dados6D: !!dados6D.deal_id,\n      dados6C: !!dados6C.resumo,\n      dados1B: !!dados1B.deal_id,\n      dados9C: !!dados9C.asaas_boleto_criado\n    },\n    asaas_encontrado: temBoleto,\n    darf_encontrada: temDarf,\n    darf_fonte: darfResumo6D.start_paga_darf ? '6D.resumo.darf' : (darfResumo6C.start_paga_darf ? '6C.resumo' : 'nenhuma')\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8864,
        25936
      ],
      "id": "1a325b0d-cd03-414f-a27c-b1285b1c4099",
      "name": "15. Montar itens_criados"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NÃ“ 1B - INICIALIZAR EXECUÃ‡ÃƒO (V19.2 - CORREÃ‡Ã•ES CRÃTICAS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Data: 02/02/2026\n// Autor: Start Assessoria PrevidenciÃ¡ria\n//\n// FUNÃ‡Ã•ES DESTE NÃ“:\n// âœ… 1. Extrair dados do webhook (deal_id, file_id)\n// âœ… 2. Extrair dados do BUSCAR DEAL (CPF, NB, MR, nome, etc.)\n// âœ… 3. Validar campos obrigatÃ³rios (fail fast)\n// âœ… 4. Normalizar dados (CPF, NB, MR, Nome)\n// âœ… 5. Centralizar configuraÃ§Ãµes (URLs, chats, tokens)\n// âœ… 6. Montar links prÃ©-formatados\n// âœ… 7. Criar contexto de execuÃ§Ã£o (rastreabilidade)\n//\n// CHANGELOG:\n// V19.2 (02/02/2026): ğŸ”§ FIX CRÃTICO - Deal ID e File ID do BUSCAR DEAL\n//                     - Deal ID: input.result.ID\n//                     - File ID: campo UF_CRM_1765924938 do Deal\n//                     - Nome webhook correto: '1. Webhook'\n// V19 (01/02/2026): ğŸ”§ CORREÃ‡ÃƒO CRÃTICA - Busca CPF/NB/MR do nÃ³ BUSCAR DEAL\n// V18 (02/01/2026): VersÃ£o completa com todas as melhorias\n// V17 (26/12/2025): VersÃ£o bÃ¡sica (sÃ³ deal_id)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst inicio = Date.now();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1. CONFIGURAÃ‡Ã•ES CENTRALIZADAS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// IMPORTANTE: Altere aqui se mudar domÃ­nio, token ou chats!\n\nconst CONFIG = {\n  // Bitrix24\n  BITRIX_DOMAIN: 'startprev.bitrix24.com.br',\n  BITRIX_USER_ID: '110798',\n  BITRIX_TOKEN: '2itn6qbjhoj6y42x',\n  \n  // Chats (Open Channels)\n  CHAT_SUCESSO: 'chat282584',\n  CHAT_ERRO: 'chat282150',\n  \n  // Smart Invoice\n  ENTITY_TYPE_ID_INVOICE: 31,\n  \n  // VersÃ£o\n  VERSAO: 'V19.2',\n  \n  // ValidaÃ§Ãµes\n  CPF_MIN_DIGITOS: 11,\n  NB_MIN_DIGITOS: 9,\n};\n\n// URLs derivadas (nÃ£o editar)\nCONFIG.BITRIX_REST = `https://${CONFIG.BITRIX_DOMAIN}/rest/${CONFIG.BITRIX_USER_ID}/${CONFIG.BITRIX_TOKEN}`;\nCONFIG.BITRIX_URL = `https://${CONFIG.BITRIX_DOMAIN}`;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1.1 IDs DOS CAMPOS DO DEAL (BITRIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst CD = {\n  cpf:              'UF_CRM_5F7DD07B0ADB5',\n  nb:               'UF_CRM_1737470444334',\n  nit:              'UF_CRM_1766282969',\n  mr_cliente:       'UF_CRM_1741726157749',\n  categoria:        'UF_CRM_5F7DD07B0295D',\n  banco:            'UF_CRM_1603216440272',\n  endereco_banco:   'UF_CRM_1603216499370',\n  agencia_banco:    'UF_CRM_1762558313',\n  dn_mamae:         'UF_CRM_1602615428011',\n  dn_filho:         'UF_CRM_5F7DD07B1997D',\n  dib:              'UF_CRM_1765928945',\n  dip:              'UF_CRM_1766439387',\n  dcb:              'UF_CRM_1748433331869',\n  file_id:          'UF_CRM_1765924938',  // ğŸ”§ V19.2: Campo do File ID no Deal\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2. FUNÃ‡Ã•ES DE NORMALIZAÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n/**\n * Remove tudo que nÃ£o Ã© nÃºmero\n */\nconst somenteNumeros = (valor) => {\n  if (!valor) return '';\n  return String(valor).replace(/\\D/g, '');\n};\n\n/**\n * Normaliza CPF (remove formataÃ§Ã£o, valida tamanho)\n */\nconst normalizarCPF = (cpf) => {\n  const numeros = somenteNumeros(cpf);\n  if (numeros.length < CONFIG.CPF_MIN_DIGITOS) return null;\n  // Pega os Ãºltimos 11 dÃ­gitos (caso tenha zeros Ã  esquerda extras)\n  return numeros.slice(-11);\n};\n\n/**\n * Formata CPF para exibiÃ§Ã£o: 000.000.000-00\n */\nconst formatarCPF = (cpf) => {\n  const num = normalizarCPF(cpf);\n  if (!num || num.length !== 11) return cpf || '';\n  return `${num.slice(0,3)}.${num.slice(3,6)}.${num.slice(6,9)}-${num.slice(9)}`;\n};\n\n/**\n * Normaliza NB (remove formataÃ§Ã£o)\n */\nconst normalizarNB = (nb) => {\n  const numeros = somenteNumeros(nb);\n  if (numeros.length < CONFIG.NB_MIN_DIGITOS) return null;\n  return numeros;\n};\n\n/**\n * Formata NB para exibiÃ§Ã£o: 000.000.000-0\n */\nconst formatarNB = (nb) => {\n  const num = normalizarNB(nb);\n  if (!num || num.length < 10) return nb || '';\n  return `${num.slice(0,3)}.${num.slice(3,6)}.${num.slice(6,9)}-${num.slice(9)}`;\n};\n\n/**\n * Normaliza NIT (remove formataÃ§Ã£o)\n */\nconst normalizarNIT = (nit) => {\n  return somenteNumeros(nit) || null;\n};\n\n/**\n * Parse de valor monetÃ¡rio â†’ nÃºmero\n * Aceita: \"1518|BRL\", \"R$ 1.518,00\", \"1518.00\", \"1518,00\"\n */\nconst normalizarMR = (valor) => {\n  if (valor === null || valor === undefined) return null;\n  if (typeof valor === 'number') return Math.floor(valor * 100) / 100;\n  \n  let str = String(valor).trim();\n  \n  // Remove \"BRL\", \"R$\", espaÃ§os\n  str = str.replace(/\\|?BRL/gi, '').replace(/R\\$\\s*/gi, '').trim();\n  \n  // Trata formato brasileiro (1.234,56) vs americano (1,234.56)\n  if (str.includes('.') && str.includes(',')) {\n    const lastDot = str.lastIndexOf('.');\n    const lastComma = str.lastIndexOf(',');\n    if (lastComma > lastDot) {\n      // Formato brasileiro: 1.234,56\n      str = str.replace(/\\./g, '').replace(',', '.');\n    } else {\n      // Formato americano: 1,234.56\n      str = str.replace(/,/g, '');\n    }\n  } else if (str.includes(',')) {\n    str = str.replace(',', '.');\n  }\n  \n  const num = parseFloat(str);\n  return Number.isFinite(num) ? Math.floor(num * 100) / 100 : null;\n};\n\n/**\n * Normaliza nome (trim, capitalizaÃ§Ã£o)\n */\nconst normalizarNome = (nome) => {\n  if (!nome) return null;\n  \n  // Remove espaÃ§os extras\n  let n = String(nome).trim().replace(/\\s+/g, ' ');\n  \n  // Capitaliza cada palavra (exceto conectivos)\n  const conectivos = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  n = n.toLowerCase().split(' ').map((palavra, idx) => {\n    if (idx > 0 && conectivos.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n  \n  return n;\n};\n\n/**\n * Gera ID Ãºnico para esta execuÃ§Ã£o\n */\nconst gerarExecucaoId = (dealId) => {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8);\n  return `${dealId}_${timestamp}_${random}`;\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3. EXTRAIR DADOS (MÃšLTIPLAS FONTES)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $json;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.0 BUSCAR DADOS DO DEAL (FONTE PRINCIPAL - V19.2)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ğŸ”§ V19.2: O input do 1B vem do BUSCAR DEAL, entÃ£o os dados estÃ£o em input.result\nconst dealResult = input.result || {};\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.1 EXTRAIR DEAL_ID (mÃºltiplas fontes possÃ­veis)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet dealId = null;\n\n// ğŸ”§ V19.2: FONTE PRINCIPAL - input.result.ID (do BUSCAR DEAL)\nif (dealResult.ID) {\n  dealId = dealResult.ID;\n}\n\n// FONTE 2: Tentar via $() se nÃ£o achou\nif (!dealId) {\n  try {\n    const buscarDealNode = $('BUSCAR DEAL').first()?.json?.result;\n    if (buscarDealNode?.ID) {\n      dealId = buscarDealNode.ID;\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// FONTE 3: Webhook direto (fallback)\nif (!dealId) {\n  try {\n    const wh = $('1. Webhook').first()?.json || {};\n    const whQuery = wh.query || {};\n    const whBody = wh.body || {};\n    dealId = whQuery.deal_id || whBody.deal_id || wh.deal_id;\n    \n    // document_id[2] format\n    if (!dealId && whBody['document_id[2]']) {\n      dealId = String(whBody['document_id[2]']).replace('DEAL_', '');\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// Converter para nÃºmero\ndealId = dealId ? parseInt(String(dealId).replace(/\\D/g, '')) : null;\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.2 EXTRAIR FILE_ID (mÃºltiplas fontes possÃ­veis)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet rawFileId = null;\n\n// ğŸ”§ V19.2: FONTE PRINCIPAL - Campo do Deal (UF_CRM_1765924938)\nrawFileId = dealResult[CD.file_id];\n\n// FONTE 2: Tentar via $() se nÃ£o achou\nif (!rawFileId) {\n  try {\n    const buscarDealNode = $('BUSCAR DEAL').first()?.json?.result;\n    if (buscarDealNode?.[CD.file_id]) {\n      rawFileId = buscarDealNode[CD.file_id];\n    }\n  } catch (e) { /* ignora */ }\n}\n\n// FONTE 3: Webhook direto (fallback)\nif (!rawFileId) {\n  try {\n    const wh = $('1. Webhook').first()?.json || {};\n    const whQuery = wh.query || {};\n    const whBody = wh.body || {};\n    rawFileId = whQuery.file_id || whBody.file_id || wh.file_id;\n  } catch (e) { /* ignora */ }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 3.3 EXTRAIR OUTROS CAMPOS DO WEBHOOK (tentativa, recalcular, telefone)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet rawTentativa = null;\nlet rawRecalcular = null;\nlet rawTelefone = null;\n\ntry {\n  const wh = $('1. Webhook').first()?.json || {};\n  const whQuery = wh.query || {};\n  const whBody = wh.body || {};\n  \n  rawTentativa = whQuery.tentativa || whBody.tentativa || wh.tentativa;\n  rawRecalcular = whQuery.recalcular || whBody.recalcular || whQuery.recalcular_sempre || whBody.recalcular_sempre;\n  rawTelefone = whQuery.telefone || whBody.telefone || wh.telefone;\n} catch (e) { /* ignora */ }\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4. EXTRAIR DADOS DO DEAL (CAMPOS DO BITRIX)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst rawCPF = dealResult[CD.cpf];\nconst rawNB = dealResult[CD.nb];\nconst rawNIT = dealResult[CD.nit];\nconst rawMR = dealResult[CD.mr_cliente];\nconst rawNome = dealResult.TITLE;\nconst rawContactId = dealResult.CONTACT_ID;\nconst rawCategoria = dealResult[CD.categoria];\nconst rawBanco = dealResult[CD.banco];\nconst rawEnderecoBanco = dealResult[CD.endereco_banco];\nconst rawAgenciaBanco = dealResult[CD.agencia_banco];\nconst rawDnMamae = dealResult[CD.dn_mamae];\nconst rawDnFilho = dealResult[CD.dn_filho];\nconst rawDIB = dealResult[CD.dib];\nconst rawDIP = dealResult[CD.dip];\nconst rawDCB = dealResult[CD.dcb];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5. VALIDAÃ‡Ã•ES (FAIL FAST)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst erros = [];\nconst avisos = [];\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.1 VALIDAR DEAL_ID (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!dealId || dealId <= 0) {\n  return {\n    erro: true,\n    tipo_erro: 'DEAL_ID_AUSENTE',\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'DEAL ID NÃƒO INFORMADO',\n      mensagem: 'Webhook chamado sem Deal ID vÃ¡lido. Verifique a automaÃ§Ã£o que dispara o webhook.',\n      severidade: 3,\n      bloqueia: true\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      input_result_ID: input?.result?.ID,\n      input_keys: Object.keys(input || {}).slice(0, 10),\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.2 VALIDAR FILE_ID (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!rawFileId) {\n  return {\n    erro: true,\n    tipo_erro: 'FILE_ID_AUSENTE',\n    deal_id: dealId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'PDF NÃƒO INFORMADO',\n      mensagem: `Deal ${dealId}: Campo file_id nÃ£o encontrado. Verifique se o extrato foi anexado e se o campo UF_CRM_1765924938 estÃ¡ preenchido.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      campo_file_id: CD.file_id,\n      valor_no_deal: dealResult[CD.file_id],\n      deal_result_tem_dados: !!dealResult.ID,\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.3 VALIDAR BUSCAR DEAL (OBRIGATÃ“RIO)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!dealResult || !dealResult.ID) {\n  return {\n    erro: true,\n    tipo_erro: 'DEAL_NAO_ENCONTRADO',\n    deal_id: dealId,\n    file_id: rawFileId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'DEAL NÃƒO ENCONTRADO',\n      mensagem: `Deal ${dealId}: NÃ£o foi possÃ­vel buscar os dados do Deal no Bitrix. Verifique se o Deal existe e se a API estÃ¡ funcionando.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.4 VALIDAR CPF (OBRIGATÃ“RIO para buscar faturas)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst cpfNormalizado = normalizarCPF(rawCPF);\n\nif (!cpfNormalizado) {\n  return {\n    erro: true,\n    tipo_erro: 'CPF_AUSENTE_NO_DEAL',\n    deal_id: dealId,\n    file_id: rawFileId,\n    alerta: {\n      tipo: 'CRITICO',\n      emoji: 'ğŸš¨',\n      titulo: 'CPF NÃƒO PREENCHIDO NO DEAL',\n      mensagem: `Deal ${dealId}: Campo CPF nÃ£o estÃ¡ preenchido no Deal (${rawCPF || 'vazio'}). Preencha o CPF no Bitrix antes de faturar.`,\n      severidade: 3,\n      bloqueia: true\n    },\n    links: {\n      deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`\n    },\n    execucao: {\n      inicio: new Date().toISOString(),\n      versao: CONFIG.VERSAO,\n      duracao_ms: Date.now() - inicio\n    },\n    _debug: {\n      campo_cpf: CD.cpf,\n      valor_bruto: rawCPF,\n    }\n  };\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// 5.5 AVISOS (nÃ£o bloqueiam, mas registram)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (!rawNB) {\n  avisos.push({ campo: 'nb', msg: 'NB nÃ£o preenchido no Deal - serÃ¡ extraÃ­do do PDF' });\n}\nif (!rawMR) {\n  avisos.push({ campo: 'mr', msg: 'MR nÃ£o preenchido no Deal - serÃ¡ extraÃ­do do PDF' });\n}\nif (!rawContactId) {\n  avisos.push({ campo: 'contact_id', msg: 'Contact ID nÃ£o vinculado - fatura pode nÃ£o vincular ao contato' });\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6. NORMALIZAR DADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst dados = {\n  // IdentificaÃ§Ã£o\n  deal_id: dealId,\n  cpf: cpfNormalizado,\n  cpf_formatado: formatarCPF(cpfNormalizado),\n  contact_id: rawContactId ? String(rawContactId) : null,\n  nome: normalizarNome(rawNome),\n  \n  // Arquivos\n  file_id: String(rawFileId),\n  disk_file_id: parseInt(rawFileId),\n  \n  // BenefÃ­cio\n  nb: normalizarNB(rawNB),\n  nb_formatado: formatarNB(rawNB),\n  nit: normalizarNIT(rawNIT),\n  mr: normalizarMR(rawMR),\n  mr_raw: rawMR, // MantÃ©m original para debug\n  \n  // Datas do benefÃ­cio\n  dib: rawDIB || null,\n  dip: rawDIP || null,\n  dcb: rawDCB || null,\n  dn_mamae: rawDnMamae || null,\n  dn_filho: rawDnFilho || null,\n  \n  // Banco\n  banco: rawBanco || null,\n  endereco_banco: rawEnderecoBanco || null,\n  agencia_banco: rawAgenciaBanco || null,\n  \n  // Categoria\n  categoria: rawCategoria || null,\n  \n  // Telefone (do webhook)\n  telefone: rawTelefone ? String(rawTelefone).trim() : null,\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 7. MONTAR LINKS PRÃ‰-FORMATADOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst links = {\n  // Deal\n  deal: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/`,\n  deal_edit: `${CONFIG.BITRIX_URL}/crm/deal/details/${dealId}/?init_mode=edit`,\n  \n  // Contato (se houver)\n  contact: dados.contact_id \n    ? `${CONFIG.BITRIX_URL}/crm/contact/details/${dados.contact_id}/` \n    : null,\n  \n  // Arquivo PDF\n  file: `${CONFIG.BITRIX_URL}/disk/showFile/${dados.file_id}/`,\n  \n  // Chats\n  chat_sucesso: `${CONFIG.BITRIX_URL}/online/?IM_DIALOG=${CONFIG.CHAT_SUCESSO}`,\n  chat_erro: `${CONFIG.BITRIX_URL}/online/?IM_DIALOG=${CONFIG.CHAT_ERRO}`,\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 8. CONTEXTO DE EXECUÃ‡ÃƒO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tentativa = parseInt(rawTentativa) || 1;\nconst isRetry = tentativa > 1;\nconst recalcularSempre = rawRecalcular === true || rawRecalcular === 'true' || rawRecalcular === '1';\n\nconst execucao = {\n  id: gerarExecucaoId(dealId),\n  inicio: new Date().toISOString(),\n  tentativa: tentativa,\n  is_retry: isRetry,\n  recalcular_sempre: recalcularSempre,\n  versao: CONFIG.VERSAO,\n  origem: isRetry ? 'retry' : 'webhook',\n  duracao_ms: Date.now() - inicio\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 9. LOG PARA DEBUG\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst log = {\n  deal_id: dealId,\n  cpf: dados.cpf_formatado,\n  file_id: dados.file_id,\n  nome: dados.nome,\n  nb: dados.nb_formatado,\n  mr: dados.mr,\n  tentativa: tentativa,\n  avisos: avisos.length,\n  versao: CONFIG.VERSAO,\n  fonte_deal_id: 'input.result.ID',\n  fonte_file_id: 'Deal[UF_CRM_1765924938]',\n};\n\nconsole.log('[1B] InicializaÃ§Ã£o V19.2:', JSON.stringify(log, null, 2));\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 10. RETORNO COMPLETO\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn {\n  // â•â•â• STATUS â•â•â•\n  erro: false,\n  validado: true,\n  \n  // â•â•â• METADADOS â•â•â•\n  _no: '1B',\n  _versao: CONFIG.VERSAO,\n  _timestamp: new Date().toISOString(),\n  \n  // â•â•â• IDENTIFICAÃ‡ÃƒO (NORMALIZADOS) â•â•â•\n  deal_id: dados.deal_id,\n  cpf: dados.cpf,\n  cpf_formatado: dados.cpf_formatado,\n  contact_id: dados.contact_id,\n  nome: dados.nome,\n  telefone: dados.telefone,\n  \n  // â•â•â• ARQUIVOS â•â•â•\n  file_id: dados.file_id,\n  disk_file_id: dados.disk_file_id,\n  \n  // â•â•â• BENEFÃCIO (NORMALIZADOS) â•â•â•\n  nb: dados.nb,\n  nb_formatado: dados.nb_formatado,\n  nit: dados.nit,\n  mr: dados.mr,\n  mr_raw: dados.mr_raw,\n  \n  // â•â•â• DATAS DO BENEFÃCIO â•â•â•\n  dib: dados.dib,\n  dip: dados.dip,\n  dcb: dados.dcb,\n  dn_mamae: dados.dn_mamae,\n  dn_filho: dados.dn_filho,\n  \n  // â•â•â• BANCO â•â•â•\n  banco: dados.banco,\n  endereco_banco: dados.endereco_banco,\n  agencia_banco: dados.agencia_banco,\n  \n  // â•â•â• CATEGORIA â•â•â•\n  categoria: dados.categoria,\n  \n  // â•â•â• CONFIGURAÃ‡Ã•ES CENTRALIZADAS â•â•â•\n  config: {\n    bitrix_url: CONFIG.BITRIX_URL,\n    bitrix_rest: CONFIG.BITRIX_REST,\n    chat_sucesso: CONFIG.CHAT_SUCESSO,\n    chat_erro: CONFIG.CHAT_ERRO,\n    entity_type_id_invoice: CONFIG.ENTITY_TYPE_ID_INVOICE,\n  },\n  \n  // â•â•â• IDs DOS CAMPOS (para outros nÃ³s usarem) â•â•â•\n  CAMPOS_DEAL: CD,\n  \n  // â•â•â• LINKS PRÃ‰-MONTADOS â•â•â•\n  links: links,\n  \n  // â•â•â• EXECUÃ‡ÃƒO â•â•â•\n  execucao: execucao,\n  \n  // â•â•â• COMPATIBILIDADE V17/V18 â•â•â•\n  tentativa: tentativa,\n  recalcular_sempre: recalcularSempre,\n  versao: CONFIG.VERSAO,\n  \n  // â•â•â• AVISOS (nÃ£o bloqueiam) â•â•â•\n  avisos: avisos,\n  alertas_lista: [], // SerÃ¡ preenchido por outros nÃ³s\n  destaques: [],     // SerÃ¡ preenchido por outros nÃ³s\n  \n  // â•â•â• DEBUG â•â•â•\n  _debug_1b: log\n};"
      },
      "id": "ba3bb24a-743e-4dd9-ad30-1d7b54378a66",
      "name": "1B. Inicializar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4032,
        26512
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "1. Webhook": {
      "main": [
        [
          {
            "node": "BUSCAR DEAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2B. Buscar Faturas CPF": {
      "main": [
        [
          {
            "node": "2C. Analisar Faturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2C. Analisar Faturas": {
      "main": [
        [
          {
            "node": "3. Buscar File ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Buscar File ID": {
      "main": [
        [
          {
            "node": "3. IF Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. IF Erro": {
      "main": [
        [
          {
            "node": "ğŸ”§ NÃ“ 21 - PREPARAR MSG ERRO (Code)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3B. Obter URL Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3B. Obter URL Disk": {
      "main": [
        [
          {
            "node": "4. Baixar PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Baixar PDF": {
      "main": [
        [
          {
            "node": "5. Gemini Extrair2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. Gemini Extrair2": {
      "main": [
        [
          {
            "node": "6A. Calculo do Historico de credito (PDF)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 6
          }
        ]
      ]
    },
    "6B.Calculo do INSS": {
      "main": [
        [
          {
            "node": "6C. Calculo Start",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge 1",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "6D. Revisor de Calculos": {
      "main": [
        [
          {
            "node": "7. IF ERRO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6A. Calculo do Historico de credito (PDF)": {
      "main": [
        [
          {
            "node": "6B.Calculo do INSS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge 1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "6C. Calculo Start": {
      "main": [
        [
          {
            "node": "Merge 1",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "9. Preparar Fatura": {
      "main": [
        [
          {
            "node": "12. Gerar RelatÃ³rio HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Criar Fatura": {
      "main": [
        [
          {
            "node": "13A. IF Pular",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "14. Processar Resposta Fatura": {
      "main": [
        [
          {
            "node": "15. Montar itens_criados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "16. Chat Sucesso": {
      "main": [
        [
          {
            "node": "17 IF Warning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "17 IF Warning": {
      "main": [
        [
          {
            "node": "18. Chat Warning",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "18. Chat Warning": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "22. Chat Erro": {
      "main": [
        [
          {
            "node": "23. Responder ERRO",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "12. Gerar RelatÃ³rio HTML": {
      "main": [
        [
          {
            "node": "10. Criar Fatura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "13A. IF Pular": {
      "main": [
        [
          {
            "node": "26. Responder SKIP",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "14. Processar Resposta Fatura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8B. Buscar Ãšltima Invoice": {
      "main": [
        [
          {
            "node": "8C. Definir ResponsÃ¡vel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8C. Definir ResponsÃ¡vel": {
      "main": [
        [
          {
            "node": "Merge 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7. IF ERRO": {
      "main": [
        [
          {
            "node": "8B. Buscar Ãšltima Invoice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "21b preparar msg erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ NÃ“ 21 - PREPARAR MSG ERRO (Code)": {
      "main": [
        [
          {
            "node": "22. Chat Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "21b preparar msg erro": {
      "main": [
        [
          {
            "node": "22. Chat Erro",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Merge 2": {
      "main": [
        [
          {
            "node": "9. Preparar Fatura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge 1": {
      "main": [
        [
          {
            "node": "6D. Revisor de Calculos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BUSCAR DEAL": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 5
          },
          {
            "node": "1B. Inicializar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "18B.Gravar Supabase": {
      "main": [
        [
          {
            "node": "18C. Supabase faturista_execucoes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "19. Preparar Sheets": {
      "main": [
        [
          {
            "node": "20. Append MASTER",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "20. Append MASTER": {
      "main": [
        [
          {
            "node": "21. Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "18C. Supabase faturista_execucoes": {
      "main": [
        [
          {
            "node": "18D - Supabase execucoes_log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "18D - Supabase execucoes_log": {
      "main": [
        [
          {
            "node": "19. Preparar Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "18B.Gravar Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "15. Montar itens_criados": {
      "main": [
        [
          {
            "node": "16. Chat Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1B. Inicializar": {
      "main": [
        [
          {
            "node": "2B. Buscar Faturas CPF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedMode": "fixed"
  },
  "versionId": "c66c2705-9eb1-4c04-a899-004be4b0231e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0827eb011b9b1f6a53ac5fece09a3f6e90464c5a4686760523b00c28099aa300"
  },
  "id": "8jrHiz0rEXSunxLH",
  "tags": [
    {
      "updatedAt": "2025-12-26T12:27:17.547Z",
      "createdAt": "2025-12-26T12:27:17.547Z",
      "id": "CP1fXxbnY4vVyu5N",
      "name": "V17"
    },
    {
      "updatedAt": "2025-12-20T20:32:17.337Z",
      "createdAt": "2025-12-20T20:32:17.337Z",
      "id": "LZ2eCTTd9V0NqYdx",
      "name": "Google Sheets"
    },
    {
      "updatedAt": "2025-12-20T19:26:21.473Z",
      "createdAt": "2025-12-20T19:26:21.473Z",
      "id": "o0DajNPcLN0z3A48",
      "name": "V10"
    },
    {
      "updatedAt": "2025-12-20T20:32:17.608Z",
      "createdAt": "2025-12-20T20:32:17.608Z",
      "id": "xZGJGtWCihxH6eY0",
      "name": "V11"
    },
    {
      "updatedAt": "2025-12-17T12:47:06.478Z",
      "createdAt": "2025-12-17T12:47:06.478Z",
      "id": "zocKKge1yw6ZyB6Z",
      "name": "Faturista"
    }
  ]
}